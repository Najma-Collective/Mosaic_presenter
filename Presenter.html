<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noor Community Mentoring Program</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Questrial&display=swap" rel="stylesheet">
    
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script id="lesson-library-embedded" type="application/json">
{
  "digitalSelfDefense": {
    "id": "digital-self-defense",
    "label": "Digital Self-Defense Playbook",
    "meta": {
      "eyebrow": "Digital Wellness",
      "descriptor": "Interactive workshop to recognise, analyse, and respond to online threats with confidence.",
      "pageTitle": "Digital Self-Defense Playbook – Instructional Slides",
      "planner": {
        "title": "Digital self-defense workshop plan",
        "subtitle": "Guide learners through recognising scams, practising response language, and crafting actionable advice.",
        "duration": "Approx. 60 minutes",
        "pacingTitle": "Session flow",
        "pacing": [
          {
            "label": "Launch & story",
            "duration": "10 min"
          },
          {
            "label": "Threat decoding stations",
            "duration": "20 min"
          },
          {
            "label": "Language & prioritisation",
            "duration": "15 min"
          },
          {
            "label": "Infographic task & share",
            "duration": "15 min"
          }
        ],
        "sections": [
          {
            "title": "Learning goals",
            "items": [
              "Spot common digital scam tactics and red flags.",
              "Practise advice language for guiding safer online behaviour.",
              "Collaborate on an actionable digital self-defense resource."
            ]
          },
          {
            "title": "Facilitator moves",
            "items": [
              "Model URL inspection and narrate why the spear-phishing example is convincing.",
              "Circulate during activities to prompt specific evidence for each categorisation.",
              "Coach groups to use imperative language while drafting infographic tips."
            ]
          },
          {
            "title": "Materials & tech",
            "items": [
              "Projector or shared screen for slides and scenario analysis.",
              "Devices with internet access for research and infographic creation.",
              "Shared workspace or chat channel for gallery walk feedback."
            ]
          }
        ],
        "spotlight": "Emphasise the pause-verify habit whenever urgency appears in a message."
      }
    },
    "sections": [
      {
        "title": "Launch",
        "slideKeys": [
          "digital-hero",
          "invoice-incident"
        ]
      },
      {
        "title": "Pre-Task A",
        "slideKeys": [
          "stage1-matching",
          "stage2-cards"
        ]
      },
      {
        "title": "Pre-Task B",
        "slideKeys": [
          "stage1-gapfill",
          "stage2-ranking"
        ]
      },
      {
        "title": "Pre-Task C",
        "slideKeys": [
          "stage1-grouping",
          "stage2-justify"
        ]
      },
      {
        "title": "Task",
        "slideKeys": [
          "digital-task"
        ]
      },
      {
        "title": "Reporting",
        "slideKeys": [
          "gallery-walk"
        ]
      },
      {
        "title": "Reflection",
        "slideKeys": [
          "digital-reflection"
        ]
      }
    ],
    "slides": [
      {
        "key": "digital-hero",
        "type": "hero",
        "title": "The Digital Self-Defense Playbook",
        "subtitle": "Mastering the art of identifying and neutralizing online threats.",
        "image": {
          "src": "https://images.pexels.com/photos/5380664/pexels-photo-5380664.jpeg",
          "alt": "A person's hands typing on a laptop with glowing code overlayed, representing digital activity."
        },
        "nav": {
          "hidePrev": true,
          "nextLabel": "Begin"
        }
      },
      {
        "key": "invoice-incident",
        "type": "story",
        "title": "The Invoice Incident",
        "quote": "It looked exactly like the real thing. I was one click away from a disaster.",
        "narrative": [
          "Maria, a freelance designer, received an email from what appeared to be her biggest client, 'Innovate Corp.' The subject was 'URGENT: Overdue Invoice.' The email used the company's logo and had a professional tone, instructing her to log into their new payment portal via a link to settle a supposed outstanding bill. Panicked about damaging her client relationship, she clicked the link.",
          "The login page looked perfect. But as she was about to enter her banking password, she noticed the URL: 'innovate-corp.secure-login.net.' The real client's URL was just 'innovate.com.' It was a sophisticated 'spear phishing' attack, targeting her specifically. She closed the window, took a deep breath, and called her client directly. There was no overdue invoice."
        ],
        "takeaways": {
          "process": "The scammer used urgency, impersonation, and a highly convincing fake website.",
          "outcome": "Maria learned that verifying through a separate, trusted channel (like a phone call) is the ultimate security check."
        }
      },
      {
        "key": "stage1-matching",
        "type": "matching",
        "title": "Stage 1: Decoding the Threats",
        "instructions": "Match the cybersecurity terms to their official definitions. Understanding these is your first line of defense.",
        "columns": [
          {
            "id": "term",
            "label": "Threat Term"
          },
          {
            "id": "definition",
            "label": "Definition"
          }
        ],
        "rows": [
          {
            "id": "phishing",
            "label": "Phishing",
            "correctColumn": "definition"
          },
          {
            "id": "vishing",
            "label": "Vishing",
            "correctColumn": "definition"
          },
          {
            "id": "spear_phishing",
            "label": "Spear Phishing",
            "correctColumn": "definition"
          },
          {
            "id": "malware",
            "label": "Malware",
            "correctColumn": "definition"
          },
          {
            "id": "2fa",
            "label": "2FA (Two-Factor Authentication)",
            "correctColumn": "definition"
          }
        ],
        "answers": [
          {
            "id": "phishing",
            "text": "A broad attack using fraudulent emails or texts to trick many people into revealing sensitive information."
          },
          {
            "id": "vishing",
            "text": "Voice phishing; using fraudulent phone calls to trick people into giving away personal data."
          },
          {
            "id": "spear_phishing",
            "text": "A highly targeted attack that uses personalized information to trick a specific individual or organization."
          },
          {
            "id": "malware",
            "text": "Malicious software (like viruses, ransomware) designed to damage or gain unauthorized access to computer systems."
          },
          {
            "id": "2fa",
            "text": "A security method requiring two forms of identification to access an account, like a password and a code sent to your phone."
          }
        ],
        "rationales": [
          {
            "id": "phishing",
            "text": "Phishing casts a wide net—attackers send deceptive emails or texts hoping that someone will click."
          },
          {
            "id": "vishing",
            "text": "'V' for voice—attackers mimic legitimate callers to pressure victims into giving up information."
          },
          {
            "id": "spear_phishing",
            "text": "Spear phishing uses personal details to look believable and single out an individual or organisation."
          },
          {
            "id": "malware",
            "text": "The goal is to infiltrate or harm computer systems—think of malware as the 'toolkit' hackers install."
          },
          {
            "id": "2fa",
            "text": "Two layers of verification keep attackers locked out even if they steal one credential."
          }
        ]
      },
      {
        "key": "stage2-cards",
        "type": "cardSort",
        "title": "Stage 2: Threat Response Cards",
        "instructions": "Sort the scenario cards into the correct response strategy. Each group will justify their classifications.",
        "categories": [
          {
            "id": "verify",
            "label": "Pause & verify"
          },
          {
            "id": "protect",
            "label": "Protect your data"
          },
          {
            "id": "report",
            "label": "Report it"
          }
        ],
        "cards": [
          {
            "id": "urgent_transfer",
            "text": "A text from your 'CEO' urgently requests a gift card purchase."
          },
          {
            "id": "password_reset",
            "text": "An email claims your bank password expires in 30 minutes unless you click the link."
          },
          {
            "id": "wifi_share",
            "text": "Someone you just met at a conference asks to use your hotspot to download a file."
          },
          {
            "id": "suspicious_attachment",
            "text": "Your cousin sends an attachment titled 'FamilyPhotos2024.zip' with no context."
          },
          {
            "id": "social_media_dm",
            "text": "A social media 'friend' requests your phone number to 'secure' your account."
          }
        ],
        "debrief": {
          "prompts": [
            "Which scenarios felt the most convincing, and why?",
            "What evidence tipped you towards each response category?",
            "Where might a real person hesitate—and how can you coach them through it?"
          ]
        }
      },
      {
        "key": "stage1-gapfill",
        "type": "gapFill",
        "title": "Stage 1: Signal Spotting",
        "instructions": "Fill in the missing words to reveal the telltale signs of digital deception.",
        "paragraph": "Attackers often manufacture a sense of ____ to push you into quick decisions. Always double-check the ____ before clicking links, and look for subtle ____ or tone shifts that suggest the sender isn't who they claim.",
        "blanks": [
          {
            "id": "urgency",
            "answer": "urgency"
          },
          {
            "id": "url",
            "answer": "URL"
          },
          {
            "id": "typos",
            "answer": "typos"
          }
        ],
        "hints": [
          "Think about the pressure tactics used in phishing emails.",
          "What part of a message reveals its true destination?",
          "Scammers often rush and make mistakes—what should you look for?"
        ]
      },
      {
        "key": "stage2-ranking",
        "type": "ranking",
        "title": "Stage 2: Prioritise Your Response",
        "instructions": "Rank the first actions you should take after spotting a suspicious digital interaction.",
        "items": [
          {
            "id": "pause",
            "label": "Pause and breathe"
          },
          {
            "id": "verify_source",
            "label": "Verify the source through an independent channel"
          },
          {
            "id": "document",
            "label": "Document what happened"
          },
          {
            "id": "report",
            "label": "Report to the appropriate platform or authority"
          },
          {
            "id": "educate",
            "label": "Share the pattern with your community"
          }
        ],
        "explanation": "Start with a pause, then verify before taking protective or reporting actions—finally, spread awareness to build collective resilience."
      },
      {
        "key": "stage1-grouping",
        "type": "grouping",
        "title": "Stage 1: Categorise the Clues",
        "instructions": "Group the signals by the tactic the scammer is using.",
        "groups": [
          {
            "id": "urgency",
            "label": "Urgency / pressure"
          },
          {
            "id": "authority",
            "label": "Authority / impersonation"
          },
          {
            "id": "reward",
            "label": "Rewards / too good to be true"
          }
        ],
        "items": [
          {
            "id": "timer",
            "label": "A countdown clock warns your account will be deleted in 5 minutes."
          },
          {
            "id": "ceo",
            "label": "An email claims to be from the CEO needing 'confidential help.'"
          },
          {
            "id": "prize",
            "label": "A message says you've won an international lottery you never entered."
          },
          {
            "id": "verify",
            "label": "A message requests you 'verify your credentials' to unlock a payment."
          },
          {
            "id": "gift",
            "label": "A DM promises a free gift card if you share the code immediately."
          }
        ],
        "debrief": {
          "questions": [
            "Which clues felt ambiguous, and how did you decide?",
            "What other evidence would you look for?",
            "How could you coach a peer to slow down in each scenario?"
          ]
        }
      },
      {
        "key": "stage2-justify",
        "type": "justify",
        "title": "Stage 2: Justify Your Defence",
        "prompt": "Choose one scenario your group sorted and craft a short justification for your recommended response. Use evidence from the message to support your reasoning.",
        "scaffolds": [
          "We noticed ____, which signals ____.",
          "Our recommended response is ____ because ____.",
          "To coach others, we'd remind them to ____ before they _____."
        ]
      },
      {
        "key": "digital-task",
        "type": "task",
        "title": "Task: Build a Self-Defense Infographic",
        "objective": "Create a one-page infographic that equips teens with a repeatable process for spotting and neutralizing digital scams.",
        "steps": [
          "Choose a real or fictional scam scenario to anchor your infographic.",
          "List the critical warning signs and the recommended responses for each stage.",
          "Draft persuasive but accessible language aimed at your peers.",
          "Design an easy-to-follow checklist or flowchart to reinforce the habit."
        ],
        "successCriteria": [
          "Includes at least three verified warning signs with evidence from the scenario.",
          "Provides clear, sequential response steps that empower rather than scare the reader.",
          "Uses language that is empathetic, peer-to-peer, and actionable."
        ],
        "extensions": [
          "Create a carousel post version for social media with the key messages.",
          "Draft a short role-play to accompany your infographic for a live workshop.",
          "Identify one local resource or hotline to include for reporting."
        ]
      },
      {
        "key": "gallery-walk",
        "type": "gallery",
        "title": "Gallery Walk: Infographic Feedback",
        "instructions": "Display your infographic and rotate around the room. Use sticky notes (or the digital board) to leave feedback for peers.",
        "feedbackPrompts": [
          "One element that makes the advice memorable…",
          "A question I still have about this scenario is…",
          "A suggestion to make the warning signs even clearer…"
        ],
        "shareOut": [
          "Select one insight from the feedback you received and share how you'll incorporate it.",
          "Nominate a 'most actionable' infographic and explain why."
        ]
      },
      {
        "key": "digital-reflection",
        "type": "reflection",
        "title": "Reflection: Commit to a Security Habit",
        "prompts": [
          {
            "id": "action_plan",
            "label": "Based on today's lesson, what is ONE specific action you will take this week to improve your personal online security? (e.g., 'I will enable 2FA on my Instagram.')",
            "placeholder": "My commitment is to..."
          },
          {
            "id": "language_takeaway",
            "label": "What phrase or language structure from today (e.g., 'You should verify...', 'Be wary of...') will be most useful for you in other contexts?",
            "placeholder": "The language I'll remember is..."
          },
          {
            "id": "remaining_questions",
            "label": "What's one question you still have about cybersecurity?",
            "placeholder": "I'm still curious about..."
          }
        ]
      }
    ]
  }
}
    </script>
    <script src="data/lesson-library.js" defer></script>

    <style>
        /* =====================================================================
           Organic Sage UI — Mobile-first, stable, and soothing
           Palette preserved; accessibility + mobile ergonomics improved.
           (Strictly adhering to provided CSS)
           ===================================================================== */

        /* ------------------------------- Design tokens ----------------------------------*/
        :root {
            --primary-sage: #7A8471;
            --secondary-sage: #9CAF88;
            --tertiary-sage: #B8C5A6;
            --warm-cream: #F8F6F0;
            --soft-white: #FEFCF7;
            --forest-shadow: #5A6B52;
            --border-sage: rgba(122, 132, 113, 0.20);
            --hover-sage: rgba(156, 175, 136, 0.15);

            --deep-forest: #3E4A3A;
            --moss: #6E7A67;
            --fern: #8FA081;
            --dried-clay: #D9CDB4;
            --amber: #C6AA77;
            --ink: #2F3A2B;
            --ink-muted: #5A6B52;

            --font-display: 'Questrial', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-body: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;

            --step--2: clamp(0.75rem, 0.7rem + 0.12vw, 0.84rem);
            --step--1: clamp(0.875rem, 0.84rem + 0.15vw, 0.95rem);
            --step-0: clamp(1rem, 0.96rem + 0.22vw, 1.1rem);
            --step-1: clamp(1.125rem, 1.07rem + 0.35vw, 1.3rem);
            --step-2: clamp(1.375rem, 1.28rem + 0.55vw, 1.6rem);
            --step-3: clamp(1.75rem, 1.58rem + 0.95vw, 2.1rem);
            --step-4: clamp(2.25rem, 1.98rem + 1.35vw, 2.7rem);
            --step-5: clamp(2.85rem, 2.4rem + 1.9vw, 3.6rem);

            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-7: 2rem;
            --space-8: 2.5rem;
            --space-9: 3rem;

            --radius-sm: 10px;
            --radius: 16px;
            --radius-lg: 20px;
            --radius-xl: 28px;

            --shadow-1: 0 1px 2px rgba(34, 41, 32, 0.05), 0 2px 8px rgba(34, 41, 32, 0.06);
            --shadow-2: 0 4px 18px rgba(34, 41, 32, 0.08), 0 12px 28px rgba(34, 41, 32, 0.06);
            --shadow-3: 0 10px 40px rgba(34, 41, 32, 0.10), 0 20px 60px rgba(34, 41, 32, 0.08);

            --ring: 0 0 0 3px color-mix(in oklab, var(--soft-white) 60%, transparent), 0 0 0 5px color-mix(in srgb, var(--secondary-sage), #2F3A2B 15%);

            --ease-ambient: cubic-bezier(.2,.8,.2,1);
            --dur-1: 120ms;
            --dur-2: 200ms;
            --dur-3: 320ms;

            --target-min: 44px;
            --container-max: clamp(720px, 64vw, 1080px);
            --workspace-max: 1500px;
        }

        /* ------------------------------- Global reset / mobile stability ----------------------------------*/
        *, *::before, *::after { box-sizing: border-box; }
        html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; hanging-punctuation: first last; }
        html, body {
            margin: 0; padding: 0; width: 100%; min-height: 100dvh;
            font-family: var(--font-body); font-size: var(--step-0); line-height: 1.6;
            color: var(--forest-shadow);
            background: radial-gradient(1200px 1200px at -10% -10%, #FFFFFF 0%, transparent 50%),
                        radial-gradient(1200px 1000px at 110% 10%, #FFF8F0 0%, transparent 50%),
                        linear-gradient(135deg, #F8F6F0 0%, #F5F3ED 100%);
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; overflow-x: hidden;
        }
        @media (prefers-reduced-motion: no-preference) { html { scroll-behavior: smooth; } }
        :where(p, h1, h2, h3, h4, h5, h6) { text-wrap: pretty; overflow-wrap: anywhere; }
        img, svg, video, canvas, audio, iframe { display: block; max-width: 100%; height: auto; }
        a { color: var(--primary-sage); text-decoration-thickness: 1px; text-underline-offset: 2px; }
        a:hover { color: var(--deep-forest); }
        .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }

        /* ------------------------------- App shell ----------------------------------*/
        #app-wrapper {
            display: flex; justify-content: center; align-items: stretch;
            padding: max(var(--space-7), env(safe-area-inset-top)) var(--space-4) var(--space-7);
            width: 100%; min-height: 100dvh;
            background: radial-gradient(800px 600px at 20% 0%, rgba(156,175,136,0.08) 0%, transparent 70%),
                        radial-gradient(700px 500px at 80% 100%, rgba(90,107,82,0.06) 0%, transparent 65%);
        }
        .skip-link {
            position: absolute;
            top: var(--space-3);
            left: 50%;
            transform: translate(-50%, -150%);
            background: var(--forest-shadow);
            color: #fff;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            font-weight: 700;
            z-index: 1000;
            transition: transform var(--dur-1) var(--ease-ambient);
        }
        .skip-link:focus {
            transform: translate(-50%, 0);
        }
        #activity-shell {
            width: min(100%, var(--workspace-max));
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-6);
            align-items: start;
        }
        #activity-container {
            width: 100%; max-width: var(--container-max);
            background: color-mix(in srgb, var(--soft-white) 88%, white 12%);
            padding: clamp(24px, 3.2vw, 48px); border-radius: var(--radius-lg);
            border: 1px solid rgba(122, 132, 113, 0.12); box-shadow: var(--shadow-2);
            position: relative; isolation: isolate; container-type: inline-size;
        }
        @supports (backdrop-filter: blur(6px)) {
            #activity-container {
                background: color-mix(in srgb, var(--soft-white) 76%, white 24%);
                backdrop-filter: blur(6px) saturate(1.02);
            }
        }
        #activity-container::before {
            content: ""; position: absolute; inset: -1px; border-radius: inherit;
            background: radial-gradient(1200px 200px at 50% -5%, rgba(156,175,136,0.12), transparent 60%),
                        radial-gradient(800px 1000px at 50% 110%, rgba(122,132,113,0.08), transparent 70%);
            z-index: -1; pointer-events: none;
        }
        .screen { display: none; scroll-margin-top: clamp(90px, 12vh, 140px); } /* Hide screens initially */
        .screen.active { display: block; } /* Show active screen */
        .data-status-message {
            margin: var(--space-7) auto;
            padding: var(--space-6);
            max-width: 60ch;
            text-align: center;
            background: color-mix(in srgb, var(--soft-white) 85%, white 15%);
            border: 1px solid var(--border-sage);
            border-radius: var(--radius);
            box-shadow: var(--shadow-1);
            font-weight: 700;
            color: var(--forest-shadow);
        }

        /* ------------------------------- Interactive annotations ----------------------------------*/
        .highlight-annotation {
            background: color-mix(in srgb, var(--secondary-sage) 35%, white 65%);
            border-radius: var(--radius-sm);
            padding: 0 0.15em;
            cursor: pointer;
            transition: box-shadow var(--dur-1) var(--ease-ambient), background-color var(--dur-1) var(--ease-ambient);
            box-shadow: inset 0 -0.35em 0 rgba(198, 170, 119, 0.35);
            outline: none;
        }
        .highlight-annotation:focus-visible,
        .highlight-annotation:hover {
            box-shadow: inset 0 -0.35em 0 rgba(122, 132, 113, 0.4);
            background: color-mix(in srgb, var(--secondary-sage) 45%, white 55%);
        }
        .highlight-annotation[aria-expanded="true"] {
            box-shadow: inset 0 -0.35em 0 rgba(90, 107, 82, 0.45);
        }

        #highlight-toolbar {
            position: absolute;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--soft-white);
            border: 1px solid var(--border-sage);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-1);
            transform: translate(-50%, -120%);
            z-index: 2000;
            min-width: max-content;
        }
        #highlight-toolbar[hidden] {
            display: none;
        }
        .highlight-toolbar__btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            font: inherit;
            background: var(--secondary-sage);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--space-2) var(--space-4);
            cursor: pointer;
            transition: background-color var(--dur-1) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
        }
        .highlight-toolbar__btn:hover,
        .highlight-toolbar__btn:focus-visible {
            background: var(--forest-shadow);
        }
        .highlight-toolbar__btn:active {
            transform: scale(0.97);
        }

        .annotation-popover {
            position: absolute;
            max-width: min(320px, 80vw);
            padding: var(--space-4);
            background: var(--soft-white);
            border-radius: var(--radius);
            border: 1px solid var(--border-sage);
            box-shadow: var(--shadow-2);
            z-index: 2100;
            transform: translate(-50%, 0);
        }
        .annotation-popover[hidden] {
            display: none;
        }
        .annotation-popover::before {
            content: "";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 10px 10px 10px;
            border-style: solid;
            border-color: transparent transparent var(--soft-white) transparent;
        }
        .annotation-popover__close {
            background: none;
            border: none;
            color: var(--forest-shadow);
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius-sm);
        }
        .annotation-popover__close:hover,
        .annotation-popover__close:focus-visible {
            background: var(--hover-sage);
        }
        .annotation-popover__body {
            margin: 0;
            font-size: var(--step-0);
            color: var(--forest-shadow);
        }

        .annotation-composer {
            position: absolute;
            width: min(340px, 82vw);
            padding: var(--space-4);
            background: var(--soft-white);
            border-radius: var(--radius);
            border: 1px solid var(--border-sage);
            box-shadow: var(--shadow-2);
            z-index: 2050;
            transform: translate(-50%, 0);
        }
        .annotation-composer[hidden] {
            display: none;
        }
        .annotation-composer__label {
            display: block;
            font-weight: 700;
            margin-bottom: var(--space-2);
            color: var(--forest-shadow);
        }
        .annotation-composer__input {
            width: 100%;
            min-height: 96px;
            padding: var(--space-3);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-sage);
            font: inherit;
            resize: vertical;
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            color: var(--forest-shadow);
        }
        .annotation-composer__input:focus-visible {
            outline: none;
            box-shadow: var(--ring);
            border-color: var(--secondary-sage);
        }
        .annotation-composer__actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-2);
            margin-top: var(--space-3);
        }
        .annotation-composer__btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            font: inherit;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            transition: background-color var(--dur-1) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
        }
        .annotation-composer__btn:hover,
        .annotation-composer__btn:focus-visible {
            transform: translateY(-1px);
        }
        .annotation-composer__btn:active {
            transform: scale(0.97);
        }
        .annotation-composer__btn--primary {
            background: var(--secondary-sage);
            color: white;
        }
        .annotation-composer__btn--primary:hover,
        .annotation-composer__btn--primary:focus-visible {
            background: var(--forest-shadow);
        }
        .annotation-composer__btn--secondary {
            background: transparent;
            color: var(--forest-shadow);
            border: 1px solid var(--border-sage);
        }
        .annotation-composer__btn--secondary:hover,
        .annotation-composer__btn--secondary:focus-visible {
            background: var(--hover-sage);
        }

        /* ------------------------------- Headings / text ----------------------------------*/
        h1 {
            font-family: var(--font-display); font-size: var(--step-4); letter-spacing: 0.2px;
            color: var(--forest-shadow); margin: 0 0 var(--space-2) 0; text-align: center;
        }
        h2.rubric {
            font-family: var(--font-body); font-size: var(--step-0); font-weight: 500;
            color: var(--secondary-sage); margin: 0 0 var(--space-6) 0; text-align: center; line-height: 1.5;
        }
        h3 {
            font-family: var(--font-display); font-size: var(--step-2); color: var(--forest-shadow);
            margin: var(--space-6) 0 var(--space-3) 0;
        }

        /* ------------------------------- Typography utility helpers ----------------------------------*/
        .text-xs { font-size: var(--step--2); }
        .text-sm { font-size: var(--step--1); }
        .text-base { font-size: var(--step-0); }
        .text-lg { font-size: var(--step-1); }
        .text-xl { font-size: var(--step-2); }
        .text-xxl { font-size: var(--step-3); }
        .text-display { font-size: var(--step-5); letter-spacing: -0.01em; }
        .fw-light { font-weight: 300; }
        .fw-regular { font-weight: 400; }
        .fw-semibold { font-weight: 600; }
        .fw-bold { font-weight: 700; }
        .fw-black { font-weight: 800; }
        .text-uppercase { text-transform: uppercase; letter-spacing: 0.12em; font-weight: 700; }
        .text-italic { font-style: italic; }
        .text-underline { text-decoration-line: underline; text-decoration-thickness: 0.18em; text-underline-offset: 0.22em; }
        .text-underline-sage { text-decoration-color: var(--secondary-sage); }
        .text-underline-gold { text-decoration-color: var(--amber); }
        .text-underline-ink { text-decoration-color: var(--ink); }
        .text-sage { color: var(--secondary-sage); }
        .text-fern { color: var(--fern); }
        .text-amber { color: var(--amber); }
        .text-ink { color: var(--ink); }
        .text-muted { color: var(--ink-muted); }
        .text-soft { color: color-mix(in srgb, var(--soft-white) 90%, #fff 10%); }
        .text-shadow { text-shadow: 0 4px 18px rgba(34, 41, 32, 0.25); }
        .text-highlight { background: linear-gradient(120deg, rgba(198, 170, 119, 0.25), rgba(156, 175, 136, 0.35)); padding: 0 0.2em; border-radius: var(--radius-sm); }

        /* ------------------------------- Accent containers ----------------------------------*/
        .accent-chip { display: inline-flex; align-items: center; gap: var(--space-2); padding: 0.3em 0.8em; border-radius: 999px; background: rgba(122, 132, 113, 0.16); font-weight: 700; font-size: var(--step--1); }
        .accent-chip--glow { background: linear-gradient(135deg, rgba(198, 170, 119, 0.55), rgba(156, 175, 136, 0.45)); color: var(--deep-forest); box-shadow: 0 6px 16px rgba(198, 170, 119, 0.35); }
        .accent-card { position: relative; padding: clamp(20px, 3vw, 40px); border-radius: var(--radius-lg); background: color-mix(in srgb, var(--soft-white) 88%, rgba(198, 170, 119, 0.25) 12%); box-shadow: var(--shadow-2); overflow: hidden; }
        .accent-card::after { content: ""; position: absolute; inset: 0; pointer-events: none; background: radial-gradient(260px 260px at 90% 10%, rgba(198, 170, 119, 0.22), transparent 60%); }
        .accent-card--frost { background: color-mix(in srgb, rgba(122, 132, 113, 0.12) 40%, white 60%); backdrop-filter: blur(12px); }

        .presentation-header {
            position: sticky;
            top: 0;
            z-index: 3;
            background: linear-gradient(180deg, rgba(248, 246, 240, 0.92) 0%, rgba(248, 246, 240, 0.65) 85%, transparent 100%);
            backdrop-filter: blur(6px);
            padding: clamp(12px, 1.6vw, 18px) clamp(24px, 3vw, 36px);
            margin: calc(var(--space-6) * -1) calc(clamp(24px, 3.2vw, 48px) * -1) var(--space-4);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            border-bottom: 1px solid rgba(122, 132, 113, 0.12);
            box-shadow: 0 12px 28px rgba(62, 74, 58, 0.16);
        }
        .workspace-menu {
            display: block;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(122, 132, 113, 0.16);
            background: rgba(255, 255, 255, 0.88);
            box-shadow: var(--shadow-1);
            overflow: hidden;
        }
        .workspace-menu[open] {
            box-shadow: var(--shadow-2);
        }
        .workspace-menu__summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
            padding: var(--space-4);
            cursor: pointer;
            list-style: none;
        }
        .workspace-menu__summary::-webkit-details-marker { display: none; }
        .workspace-menu__summary:focus-visible {
            outline: none;
            box-shadow: var(--ring);
        }
        .workspace-menu__summary-text {
            display: grid;
            gap: var(--space-1);
            min-width: 0;
        }
        .workspace-menu__summary-eyebrow {
            font-size: var(--step--2);
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--primary-sage);
        }
        .workspace-menu__summary-title {
            font-family: var(--font-display);
            font-size: var(--step-1);
            font-weight: 700;
            color: var(--forest-shadow);
        }
        .workspace-menu__summary-descriptor {
            font-size: var(--step--1);
            color: var(--ink-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: clamp(220px, 40vw, 520px);
        }
        .workspace-menu__summary-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            font-weight: 700;
            color: var(--forest-shadow);
        }
        .workspace-menu__summary-indicator i { color: var(--primary-sage); }
        .workspace-menu__summary-hint {
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .workspace-menu__summary i {
            transition: transform var(--dur-2) var(--ease-ambient);
        }
        .workspace-menu[open] .workspace-menu__summary i {
            transform: rotate(-180deg);
        }
        .workspace-menu__panel {
            display: grid;
            gap: var(--space-5);
            padding: 0 var(--space-4) var(--space-5);
        }
        .workspace-menu__intro {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--space-4);
            padding: 0 var(--space-1);
        }
        .workspace-menu__descriptor {
            flex: 1 1 280px;
            margin: 0;
            font-size: var(--step--1);
            color: var(--forest-shadow);
            max-width: 62ch;
        }
        .lesson-selector {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            align-items: flex-start;
        }
        .lesson-selector label {
            font-size: var(--step--1);
            font-weight: 700;
            color: var(--forest-shadow);
        }
        .lesson-selector select {
            appearance: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-sage);
            background: rgba(255, 255, 255, 0.9);
            font: inherit;
            color: var(--forest-shadow);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.45);
            min-width: clamp(200px, 24vw, 260px);
        }
        .lesson-selector select:focus-visible {
            outline: none;
            box-shadow: var(--ring);
            border-color: var(--secondary-sage);
        }
        .workspace-tools {
            display: grid;
            gap: var(--space-4);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(122, 132, 113, 0.16);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
            box-shadow: var(--shadow-1);
        }
        .workspace-tools__header {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        .workspace-tools__title {
            margin: 0;
            font-size: var(--step-1);
            color: var(--forest-shadow);
        }
        .workspace-tools__hint {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .workspace-tools__actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
        }
        .workspace-tools__actions .activity-btn {
            min-height: 40px;
            padding: 8px 14px;
            font-size: 0.9rem;
            border-radius: 10px;
        }
        .workspace-tools__map {
            display: grid;
            gap: var(--space-3);
        }
        .workspace-tools__subtitle {
            margin: 0;
            font-size: var(--step-0);
            color: var(--forest-shadow);
        }
        .workspace-tools nav { max-height: 420px; overflow-y: auto; }

        .lesson-overview { margin: 0 0 var(--space-6); }
        .lesson-overview[hidden] { display: none; }
        .lesson-overview__collapsible {
            border-radius: var(--radius-lg);
            border: 1px solid rgba(122, 132, 113, 0.18);
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            box-shadow: var(--shadow-1);
            transition: box-shadow var(--dur-2) var(--ease-ambient), transform var(--dur-2) var(--ease-ambient);
            overflow: hidden;
        }
        .lesson-overview__collapsible[open] {
            box-shadow: var(--shadow-2);
            transform: translateY(-2px);
        }
        .lesson-overview__summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
            padding: var(--space-3) var(--space-4);
            list-style: none;
            cursor: pointer;
            font-size: var(--step-0);
            font-weight: 700;
            color: var(--forest-shadow);
            transition: background-color var(--dur-2) var(--ease-ambient);
        }
        .lesson-overview__summary::-webkit-details-marker { display: none; }
        .lesson-overview__summary::after {
            content: "\f107";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: var(--step-1);
            color: var(--primary-sage);
            transition: transform var(--dur-2) var(--ease-ambient);
        }
        .lesson-overview__summary:hover,
        .lesson-overview__summary:focus-visible {
            outline: none;
            background: rgba(156, 175, 136, 0.12);
        }
        .lesson-overview__collapsible[open] .lesson-overview__summary::after {
            transform: rotate(180deg);
        }
        .lesson-overview__header {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            flex: 1 1 auto;
        }
        .lesson-overview__title {
            margin: 0;
            font-family: var(--font-display);
            font-size: var(--step-1);
            color: var(--forest-shadow);
        }
        .lesson-overview__meta {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .lesson-overview__badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(122, 132, 113, 0.12);
            color: var(--forest-shadow);
            font-weight: 700;
            font-size: var(--step--1);
        }
        .lesson-overview__panel {
            padding: 0 var(--space-4) var(--space-4);
            display: grid;
            gap: var(--space-4);
        }
        .lesson-overview__subtitle {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .lesson-overview__summary-hint {
            font-size: var(--step--1);
            font-weight: 500;
            color: var(--ink-muted);
            max-width: clamp(180px, 40vw, 420px);
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }
        @media (max-width: 640px) {
            .lesson-overview__summary { flex-direction: column; align-items: flex-start; }
            .lesson-overview__summary::after { align-self: flex-end; }
            .lesson-overview__summary-hint { white-space: normal; max-width: 100%; }
        }
        .lesson-overview__body {
            display: grid;
            gap: var(--space-4);
        }
        .lesson-overview__pacing {
            margin: 0;
            padding: 0;
            list-style: none;
            display: grid;
            gap: var(--space-2);
        }
        .lesson-overview__pacing-item {
            display: flex;
            justify-content: space-between;
            gap: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-sm);
            background: rgba(122, 132, 113, 0.08);
            font-size: var(--step--1);
        }
        .lesson-overview__pacing-label {
            font-weight: 600;
            color: var(--forest-shadow);
        }
        .lesson-overview__pacing-duration {
            font-variant-numeric: tabular-nums;
            color: var(--ink-muted);
        }
        .lesson-overview__section {
            display: grid;
            gap: var(--space-2);
        }
        .lesson-overview__section-title {
            margin: 0;
            font-size: var(--step-0);
            font-weight: 700;
            color: var(--forest-shadow);
        }
        .lesson-overview__list {
            margin: 0;
            padding-left: 1.1em;
            display: grid;
            gap: var(--space-1);
        }
        .lesson-overview__callout {
            margin: 0;
            padding: var(--space-3);
            border-left: 4px solid var(--secondary-sage);
            background: rgba(156, 175, 136, 0.1);
            border-radius: var(--radius-sm);
            font-size: var(--step--1);
            color: var(--forest-shadow);
        }
        @media (min-width: 768px) {
            .lesson-overview__body {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }
        #slide-map { margin: 0; }
        #slide-map-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .slide-map-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .slide-map-group__title {
            margin: 0;
            font-size: var(--step-0);
            font-weight: 800;
            color: var(--forest-shadow);
            letter-spacing: 0.3px;
        }
        .slide-map-group__list {
            display: grid;
            gap: var(--space-2);
            margin: 0;
            padding: 0;
            list-style: none;
        }
        @container (min-width: 720px) {
            .slide-map-group__list {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }
        .slide-map-item { min-width: 0; }
        .slide-map-button {
            border: 1px solid rgba(122, 132, 113, 0.25);
            background: rgba(255, 255, 255, 0.88);
            border-radius: var(--radius-sm);
            padding: var(--space-3);
            font-size: var(--step--1);
            font-weight: 600;
            color: var(--forest-shadow);
            cursor: pointer;
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: var(--space-3);
            width: 100%;
            min-height: var(--target-min);
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient), background var(--dur-2) var(--ease-ambient);
            white-space: normal;
            overflow-wrap: anywhere;
            text-align: left;
        }
        .slide-map-button:hover,
        .slide-map-button:focus-visible {
            outline: none;
            transform: translateY(-1px);
            border-color: var(--secondary-sage);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.15);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
        }
        .slide-map-item.is-active .slide-map-button {
            background: linear-gradient(180deg, color-mix(in srgb, var(--secondary-sage) 92%, white 8%), var(--secondary-sage));
            color: var(--soft-white);
            border-color: var(--secondary-sage);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.18);
        }
        .slide-map-item.is-active .slide-map-button:hover,
        .slide-map-item.is-active .slide-map-button:focus-visible {
            transform: translateY(-1px);
        }
        .slide-map-button__number {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 999px;
            background: color-mix(in srgb, var(--secondary-sage) 25%, white 75%);
            color: var(--forest-shadow);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
        }
        .slide-map-button__label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .slide-map-button__title {
            font-size: var(--step--1);
            font-weight: 700;
            color: inherit;
        }
        .slide-map-button__subtitle {
            font-size: 0.85rem;
            color: var(--ink-muted);
        }
        .slide-map-item.is-active .slide-map-button__number {
            background: color-mix(in srgb, var(--soft-white) 20%, var(--forest-shadow) 80%);
            color: var(--soft-white);
        }

        /* ------------------------------- Buttons ----------------------------------*/
        .activity-btn {
            min-height: var(--target-min); padding: 12px 20px; border-radius: 12px;
            border: 1px solid var(--primary-sage);
            background: linear-gradient(180deg, color-mix(in srgb, var(--primary-sage) 92%, white 8%), var(--primary-sage));
            color: #fff; font-weight: 700; font-size: 1rem; letter-spacing: 0.2px; cursor: pointer;
            text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation; user-select: none;
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), background var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient), opacity var(--dur-1) var(--ease-ambient);
            box-shadow: 0 1px 0 rgba(255,255,255,0.25) inset, 0 8px 16px rgba(90, 107, 82, 0.20);
        }
        .activity-btn:hover {
            background: linear-gradient(180deg, color-mix(in srgb, var(--forest-shadow) 92%, white 8%), var(--forest-shadow));
            transform: translateY(-1px); box-shadow: 0 1px 0 rgba(255,255,255,0.25) inset, 0 10px 20px rgba(90, 107, 82, 0.22);
        }
        .activity-btn:active {
            transform: translateY(0); box-shadow: 0 1px 0 rgba(255,255,255,0.2) inset, 0 4px 10px rgba(90, 107, 82, 0.20);
        }
        .activity-btn:focus-visible { outline: none; box-shadow: var(--ring), 0 8px 16px rgba(90, 107, 82, 0.20); }
        .activity-btn:disabled, .activity-btn[disabled] {
            background: var(--tertiary-sage); border-color: var(--tertiary-sage);
            color: color-mix(in srgb, #fff 70%, var(--soft-white) 30%); cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none;
        }
        .activity-btn.secondary {
            background: transparent; color: var(--primary-sage); border-color: color-mix(in srgb, var(--tertiary-sage) 70%, var(--primary-sage) 30%); box-shadow: none;
        }
        .activity-btn.secondary:hover { background-color: var(--hover-sage); }
        .activity-btn.secondary:focus-visible { outline: none; box-shadow: var(--ring); }
        .controls { margin-top: var(--space-7); text-align: center; display: grid; gap: var(--space-3); grid-auto-flow: row; }

        /* ------------------------------- Forms / inputs ----------------------------------*/
        .input-group { margin: var(--space-6) 0; }
        .input-group label { display: block; font-weight: 700; margin-bottom: var(--space-2); color: var(--primary-sage); letter-spacing: 0.2px; }
        input[type="text"], input[type="date"], textarea, select {
            width: 100%; min-height: var(--target-min); padding: 12px 14px; border-radius: 10px;
            border: 1px solid var(--tertiary-sage); background: #fff; font-size: 1rem; font-family: var(--font-body);
            color: var(--ink); box-shadow: 0 1px 0 rgba(255,255,255,0.6) inset; appearance: none; -webkit-appearance: none;
            transition: border-color var(--dur-2) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), background var(--dur-2) var(--ease-ambient);
        }
        input::placeholder, textarea::placeholder { color: color-mix(in srgb, var(--ink-muted) 60%, #fff 40%); opacity: 0.9; }
        input:focus-visible, textarea:focus-visible, select:focus-visible {
            outline: none; border-color: var(--secondary-sage); box-shadow: var(--ring);
            background: color-mix(in srgb, #fff 92%, var(--warm-cream) 8%);
        }
        input:disabled, textarea:disabled, select:disabled {
            background: color-mix(in srgb, #fff 85%, var(--warm-cream) 15%); color: var(--ink-muted); cursor: not-allowed;
        }
        input[type="date"] { -webkit-tap-highlight-color: transparent; }
        textarea { resize: vertical; }
        :root { accent-color: var(--primary-sage); }

        /* ------------------------------- Responsive / container queries ----------------------------------*/
        @media (min-width: 768px) {
            #app-wrapper { padding-inline: var(--space-7); }
            .controls { grid-auto-flow: column; justify-content: center; }
            .workspace-tools__actions { justify-content: flex-start; }
        }
        @media (min-width: 1024px) {
            #activity-container { box-shadow: var(--shadow-3); }
            h1 { letter-spacing: 0.3px; }
            .presentation-header { padding: clamp(20px, 2.4vw, 32px) clamp(28px, 3.2vw, 48px); margin: calc(var(--space-6) * -1) calc(clamp(28px, 3.2vw, 48px) * -1) var(--space-5); }
            #slide-map-list { gap: var(--space-4); }
        }
        @media (min-width: 1180px) {
            #activity-shell { grid-template-columns: minmax(0, 2.35fr) minmax(280px, 1fr); gap: var(--space-7); }
            #activity-container { max-width: none; }
            #notes-dock {
                align-self: start;
                max-width: 440px;
                position: sticky;
                top: clamp(24px, 3.5vw, 48px);
                max-height: calc(100dvh - (clamp(24px, 3.5vw, 48px) * 2));
                overflow: hidden;
            }
            #notes-panels {
                flex: 1 1 auto;
                overflow: auto;
                padding-right: var(--space-1);
            }
        }
        @media (max-width: 767px) {
            #app-wrapper { padding: var(--space-4); }
            #activity-container { padding: 24px; }
            h1 { font-size: clamp(1.75rem, 5vw, 2rem); }
            h2.rubric { font-size: var(--step--1); margin-bottom: 20px; }
            .slide-map-button { padding-inline: var(--space-3); }
            .workspace-menu__summary { flex-direction: column; align-items: flex-start; gap: var(--space-2); }
            .workspace-menu__summary-indicator { width: 100%; justify-content: space-between; }
            .workspace-menu__summary-descriptor { max-width: 100%; white-space: normal; }
            .lesson-selector { width: 100%; }
            .lesson-selector select { width: 100%; min-width: 0; }
        }

        /* ------------------------------- Accessibility / motion / scroll ----------------------------------*/
        :focus-visible { outline: none; box-shadow: var(--ring); }
        @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; scroll-behavior: auto !important; } }
        ::selection { background: color-mix(in srgb, var(--secondary-sage) 30%, #fff 70%); color: var(--deep-forest); }
        html, body { overscroll-behavior-y: none; }

        /* ------------------------------- Scrollbars (subtle, optional) ----------------------------------*/
        *::-webkit-scrollbar { width: 10px; height: 10px; }
        *::-webkit-scrollbar-thumb { background: color-mix(in srgb, var(--primary-sage) 50%, var(--tertiary-sage) 50%); border-radius: 999px; border: 2px solid transparent; background-clip: padding-box; }
        *::-webkit-scrollbar-track { background: transparent; }

        /* ------------------------------- Dark mode (gentle, earthy) ----------------------------------*/
        @media (prefers-color-scheme: dark) {
            :root {
                --soft-white: #1E211C; --warm-cream: #23261F; --forest-shadow: #DDE6D4;
                --ink: #E9EFE5; --ink-muted: #AEB9AA; --border-sage: rgba(184, 197, 166, 0.25);
            }
            html, body {
                background: radial-gradient(1100px 900px at 15% 10%, rgba(156,175,136,0.06), transparent 60%),
                            radial-gradient(900px 900px at 85% 90%, rgba(122,132,113,0.08), transparent 65%),
                            linear-gradient(135deg, #191D18 0%, #1B1E19 100%);
            }
            #activity-container { background: color-mix(in srgb, #23261F 92%, #1B1E19 8%); border-color: rgba(184, 197, 166, 0.18); box-shadow: 0 12px 36px rgba(0,0,0,0.35); }
            .presentation-header { background: linear-gradient(180deg, rgba(31, 33, 28, 0.92) 0%, rgba(31, 33, 28, 0.6) 85%, transparent 100%); border-bottom-color: rgba(184, 197, 166, 0.2); }
            .workspace-menu { background: rgba(28, 31, 26, 0.88); border-color: rgba(184, 197, 166, 0.28); box-shadow: 0 16px 32px rgba(0,0,0,0.35); }
            .workspace-menu__summary { color: var(--forest-shadow); }
            .workspace-menu__summary-indicator { color: var(--forest-shadow); }
            .workspace-menu__summary-hint { color: color-mix(in srgb, var(--ink-muted) 85%, #fff 15%); }
            .workspace-menu__descriptor { color: color-mix(in srgb, var(--ink-muted) 85%, #fff 15%); }
            .workspace-tools { background: rgba(28, 31, 26, 0.78); border-color: rgba(184, 197, 166, 0.28); box-shadow: 0 16px 32px rgba(0,0,0,0.35); }
            .workspace-tools__hint { color: color-mix(in srgb, var(--ink-muted) 85%, #fff 15%); }
            .lesson-selector label { color: var(--forest-shadow); }
            .lesson-selector select { background: rgba(28, 31, 26, 0.85); border-color: rgba(184, 197, 166, 0.28); color: var(--forest-shadow); box-shadow: none; }
            .lesson-overview { background: rgba(28, 31, 26, 0.82); border-color: rgba(184, 197, 166, 0.26); box-shadow: 0 16px 28px rgba(0,0,0,0.35); }
            .lesson-overview__badge { background: rgba(156, 175, 136, 0.18); color: var(--forest-shadow); }
            .lesson-overview__pacing-item { background: rgba(122, 132, 113, 0.16); }
            .lesson-overview__callout { background: rgba(156, 175, 136, 0.18); border-left-color: color-mix(in srgb, var(--secondary-sage) 80%, #0F120E 20%); }
            a { color: color-mix(in srgb, var(--secondary-sage) 80%, #C7D3C0 20%); }
            .mc-question { background: linear-gradient(180deg, #20241E 0%, #191D18 100%); border-color: rgba(184, 197, 166, 0.20); box-shadow: 0 1px 0 rgba(255,255,255,0.03) inset, 0 10px 30px rgba(0,0,0,0.35); }
            .activity-btn { background: linear-gradient(180deg, color-mix(in srgb, var(--primary-sage) 80%, #0F120E 20%), var(--primary-sage)); box-shadow: 0 1px 0 rgba(255,255,255,0.08) inset, 0 8px 18px rgba(0,0,0,0.35); }
            .activity-btn:hover { background: linear-gradient(180deg, color-mix(in srgb, var(--forest-shadow) 80%, #0F120E 20%), var(--forest-shadow)); }
            input, textarea, select { background: #141713; border-color: rgba(184, 197, 166, 0.25); color: var(--ink); }
            .notes-dock-header { background: rgba(28, 31, 26, 0.78); border-color: rgba(184, 197, 166, 0.28); box-shadow: 0 12px 28px rgba(0,0,0,0.35); }
            .notes-dock-subtitle { color: color-mix(in srgb, var(--ink-muted) 85%, #fff 15%); }
            .slide-map-group__title { color: color-mix(in srgb, var(--secondary-sage) 70%, #C7D3C0 30%); }
            .slide-map-button { background: rgba(28, 31, 26, 0.75); border-color: rgba(184, 197, 166, 0.28); color: var(--forest-shadow); }
            .slide-map-button__number { background: color-mix(in srgb, var(--secondary-sage) 55%, #0F120E 45%); color: var(--soft-white); }
            .slide-map-button__subtitle { color: color-mix(in srgb, var(--ink-muted) 80%, #fff 20%); }
            .slide-map-item.is-active .slide-map-button { background: linear-gradient(180deg, color-mix(in srgb, var(--secondary-sage) 85%, #0F120E 15%), var(--secondary-sage)); color: var(--soft-white); border-color: color-mix(in srgb, var(--secondary-sage) 85%, #0F120E 15%); }
            .slide-map-item.is-active .slide-map-button__number { background: color-mix(in srgb, var(--soft-white) 15%, var(--forest-shadow) 85%); }
            .textbox-color-picker { background: rgba(28, 31, 26, 0.75); border-color: rgba(184, 197, 166, 0.28); }
            .textbox-color-picker__swatch { border-color: rgba(184, 197, 166, 0.28); }
            .textbox-color-picker__swatch.is-selected { box-shadow: 0 0 0 3px rgba(20, 23, 19, 0.85), 0 0 0 5px rgba(184, 197, 166, 0.35); }
        }

        /* ------------------------------- Slide-specific styles ----------------------------------*/
        /* Custom styles for the presentation content */
        .slide-content { margin-top: var(--space-6); }
        .slide-content.is-centered {
            text-align: center;
        }
        .slide-content.is-centered > * {
            margin-left: auto;
            margin-right: auto;
        }
        .slide-content.is-centered .activity-block {
            text-align: left;
        }
        .slide-content img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: var(--radius);
            margin-bottom: var(--space-6);
        }
        .slide-content.is-centered img { margin-left: auto; margin-right: auto; }
        .slide-content.is-right-aligned { text-align: right; }
        .slide-content.is-right-aligned > * { margin-left: auto; }
        .slide-content.is-right-aligned .activity-block { text-align: left; }

        .slide-content.layout--columns { display: grid; gap: clamp(var(--space-5), 4vw, var(--space-7)); }
        @media (min-width: 768px) {
            .slide-content.layout--columns { grid-template-columns: repeat(2, minmax(0, 1fr)); align-items: start; }
        }
        .slide-content.layout--columns > *:first-child { order: 0; }
        .slide-content.layout--columns > img { height: auto; max-height: 360px; }

        .slide-content.layout--poster { padding: clamp(24px, 3vw, 44px); border-radius: var(--radius-xl); background: linear-gradient(135deg, rgba(248, 246, 240, 0.85), rgba(198, 170, 119, 0.25)); box-shadow: var(--shadow-3); position: relative; overflow: hidden; }
        .slide-content.layout--poster::before { content: ""; position: absolute; inset: -20% 40% auto -20%; height: 140%; background: radial-gradient(280px 280px at 40% 20%, rgba(156, 175, 136, 0.32), transparent 72%); pointer-events: none; }
        .slide-content.layout--poster > * { position: relative; }

        .slide-content.layout--spotlight { position: relative; padding: clamp(20px, 3vw, 36px); border-radius: var(--radius-lg); background: color-mix(in srgb, rgba(122, 132, 113, 0.16) 35%, #fff 65%); border: 1px solid rgba(122, 132, 113, 0.22); box-shadow: 0 22px 45px rgba(34, 41, 32, 0.12); }
        .slide-content.layout--spotlight::before { content: ""; position: absolute; inset: 0; background: radial-gradient(320px 220px at 20% 0%, rgba(198, 170, 119, 0.28), transparent 75%); pointer-events: none; mix-blend-mode: multiply; }
        .slide-content.layout--spotlight > * { position: relative; }

        .slide-content.layout--timeline { display: grid; gap: var(--space-4); padding: clamp(20px, 3vw, 36px); border-left: 4px solid rgba(156, 175, 136, 0.6); }
        .slide-content.layout--timeline > * { padding-left: var(--space-4); position: relative; }
        .slide-content.layout--timeline > *::before { content: ""; position: absolute; left: calc(-1 * var(--space-4) - 10px); top: 0.5em; width: 12px; height: 12px; border-radius: 999px; background: var(--secondary-sage); box-shadow: 0 0 0 4px rgba(156, 175, 136, 0.2); }

        .theme--sunrise { background: linear-gradient(140deg, rgba(255, 243, 226, 0.92), rgba(198, 170, 119, 0.45)); color: var(--deep-forest); border-radius: var(--radius-lg); padding: clamp(24px, 3vw, 40px); box-shadow: var(--shadow-2); }
        .theme--sunrise :where(p, li) { color: inherit; }
        .theme--midnight { background: linear-gradient(160deg, rgba(34, 41, 32, 0.9), rgba(34, 41, 32, 0.75)); color: var(--soft-white); border-radius: var(--radius-lg); padding: clamp(24px, 3vw, 40px); box-shadow: 0 20px 60px rgba(34, 41, 32, 0.45); }
        .theme--midnight :where(p, li, h1, h2, h3, h4) { color: inherit; }
        .theme--midnight .text-muted { color: color-mix(in srgb, var(--soft-white) 65%, rgba(255, 255, 255, 0.72) 35%); }
        .theme--aurora { background: radial-gradient(220px 220px at 10% 10%, rgba(156, 175, 136, 0.4), transparent 65%), radial-gradient(220px 260px at 90% 15%, rgba(198, 170, 119, 0.36), transparent 70%), color-mix(in srgb, var(--soft-white) 92%, rgba(122, 132, 113, 0.22) 8%); border-radius: var(--radius-xl); padding: clamp(24px, 3vw, 44px); box-shadow: var(--shadow-3); }

        .activity-block {
            margin-top: var(--space-7);
            padding: var(--space-5);
            border-radius: var(--radius);
            border: 1px solid var(--border-sage);
            background: color-mix(in srgb, #ffffff 92%, var(--warm-cream) 8%);
            display: grid;
            gap: var(--space-3);
        }
        .activity-block__title {
            margin: 0;
            font-family: var(--font-display);
            font-size: var(--step-1);
            color: var(--forest-shadow);
        }
        .activity-block__description {
            margin: 0;
            color: var(--forest-shadow);
        }
        .activity-block__list {
            margin: 0;
        }
        .activity-block .slide-list {
            margin-bottom: 0;
        }
        .activity-block .slide-list li {
            font-size: var(--step-0);
            margin-bottom: var(--space-2);
        }
        .activity-block__inputs {
            display: grid;
            gap: var(--space-3);
        }
        .activity-block__inputs label {
            display: block;
            font-weight: 700;
            color: var(--primary-sage);
            margin-bottom: var(--space-1);
        }
        .activity-block__inputs input[type="text"] {
            width: 100%;
            border-radius: 10px;
            padding: 12px 14px;
            border: 1px solid var(--border-sage);
            font: inherit;
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
            transition: border-color var(--dur-2) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient);
        }
        .activity-block__inputs input[type="text"]:focus-visible {
            outline: none;
            border-color: var(--secondary-sage);
            box-shadow: var(--ring);
        }

        .reference-grid {
            display: grid;
            gap: var(--space-4);
        }
        @container (min-width: 640px) {
            .reference-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
        }
        .reference-card {
            border-radius: var(--radius);
            border: 1px solid rgba(122, 132, 113, 0.18);
            background: var(--soft-white);
            padding: var(--space-4);
            display: grid;
            gap: var(--space-3);
        }
        .reference-card h4 {
            margin: 0;
            font-size: var(--step-0);
            font-weight: 700;
            color: var(--primary-sage);
        }
        .reference-card .slide-list {
            margin: 0;
        }
        .reference-card .slide-list li {
            font-size: var(--step--1);
            margin-bottom: var(--space-2);
        }

        .mc-option-group {
            display: grid;
            gap: var(--space-3);
        }
        .mc-option-item {
            border-radius: var(--radius);
            border: 1px solid rgba(122, 132, 113, 0.18);
            background: color-mix(in srgb, var(--soft-white) 96%, white 4%);
            transition: border-color var(--dur-2) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient);
        }
        .mc-option-label {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            width: 100%;
            padding: var(--space-4);
            cursor: pointer;
        }
        .mc-option-input { display: none; }
        .option-control {
            flex: 0 0 auto;
            width: 20px;
            height: 20px;
            border-radius: 999px;
            border: 2px solid var(--tertiary-sage);
            margin-top: 4px;
            position: relative;
            transition: border-color var(--dur-2) var(--ease-ambient);
        }
        .option-control::after {
            content: "";
            position: absolute;
            inset: 3px;
            border-radius: inherit;
            background: var(--primary-sage);
            transform: scale(0);
            transition: transform var(--dur-2) var(--ease-ambient);
        }
        .mc-option-text {
            flex: 1;
            font-size: var(--step-0);
            color: var(--forest-shadow);
        }
        .mc-option-item:hover {
            border-color: var(--secondary-sage);
            box-shadow: var(--shadow-1);
        }
        .mc-option-input:checked + .option-control {
            border-color: var(--secondary-sage);
        }
        .mc-option-input:checked + .option-control::after {
            transform: scale(1);
        }

        .gallery-grid {
            display: grid;
            gap: var(--space-5);
            margin-top: var(--space-6);
        }
        @container (min-width: 720px) {
            .gallery-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            }
        }
        .gallery-card {
            background: linear-gradient(180deg, color-mix(in srgb, var(--soft-white) 94%, white 6%), color-mix(in srgb, var(--soft-white) 88%, white 12%));
            border-radius: var(--radius);
            box-shadow: var(--shadow-1);
            overflow: hidden;
            border: 1px solid rgba(122, 132, 113, 0.16);
            display: grid;
        }
        .gallery-card img {
            height: 180px;
            object-fit: cover;
            border-radius: 0;
            margin: 0;
            width: 100%;
        }
        .gallery-card__body {
            padding: var(--space-4);
            display: grid;
            gap: var(--space-2);
        }
        .gallery-card__title {
            margin: 0;
            font-size: var(--step-0);
            font-weight: 700;
            color: var(--forest-shadow);
        }
        .gallery-card__meta {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .gallery-card__body p {
            margin: 0;
        }

        .reporting-layout {
            display: grid;
            gap: var(--space-6);
        }
        .reporting-sections {
            display: grid;
            gap: var(--space-6);
        }
        .reporting-section {
            border-radius: var(--radius);
            border: 1px solid rgba(122, 132, 113, 0.18);
            background: color-mix(in srgb, var(--soft-white) 95%, white 5%);
            padding: var(--space-5);
            display: grid;
            gap: var(--space-3);
        }
        .reporting-section h4 {
            margin: 0;
            font-size: var(--step-1);
            color: var(--primary-sage);
        }
        .reporting-image-placeholder {
            border-radius: var(--radius-sm);
            border: 2px dashed rgba(122, 132, 113, 0.4);
            padding: var(--space-4);
            text-align: center;
            font-weight: 700;
            color: var(--ink-muted);
        }
        .reporting-field {
            display: grid;
            gap: var(--space-2);
        }
        .reporting-field label {
            font-weight: 700;
            color: var(--primary-sage);
        }
        .reporting-field input[type="text"],
        .reporting-field textarea {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border-sage);
            padding: 12px 14px;
            font: inherit;
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
            transition: border-color var(--dur-2) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient);
        }
        .reporting-field textarea { min-height: 120px; }
        .reporting-field textarea.statement { min-height: 150px; }
        .reporting-field input[type="text"]:focus-visible,
        .reporting-field textarea:focus-visible {
            outline: none;
            border-color: var(--secondary-sage);
            box-shadow: var(--ring);
        }

        .statement-section {
            border-radius: var(--radius);
            border: 1px solid rgba(122, 132, 113, 0.18);
            background: color-mix(in srgb, var(--soft-white) 93%, white 7%);
            padding: var(--space-5);
            display: grid;
            gap: var(--space-3);
        }

        .activity-feedback {
            margin-top: var(--space-6);
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            border: 1px solid rgba(122, 132, 113, 0.16);
            border-radius: var(--radius);
            padding: clamp(20px, 3vw, 32px);
            display: grid;
            gap: var(--space-4);
        }
        .activity-feedback__summary {
            margin: 0;
            font-weight: 700;
            color: var(--forest-shadow);
        }
        .activity-feedback__list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: var(--space-4);
        }
        .activity-feedback__item {
            border-left: 4px solid color-mix(in srgb, var(--secondary-sage) 70%, var(--primary-sage) 30%);
            padding-left: var(--space-4);
        }
        .activity-feedback__item strong { color: var(--forest-shadow); }
        .activity-feedback__item p { margin: 0; }
        .activity-feedback__item p + p { margin-top: var(--space-2); }
        .activity-feedback__item.is-incorrect { border-left-color: #C76B5E; }
        .activity-feedback__item.is-correct { border-left-color: var(--secondary-sage); }

        /* Gap-fill activity */
        .gapfill-activity {
            display: grid;
            gap: var(--space-5);
        }
        .gapfill-paragraph {
            background: color-mix(in srgb, var(--warm-cream) 85%, white 15%);
            border: 1px solid rgba(122, 132, 113, 0.18);
            border-radius: var(--radius);
            padding: clamp(20px, 3vw, 32px);
            font-size: var(--step-1);
            line-height: 1.8;
        }
        .gapfill-gap {
            display: inline-flex;
            align-items: center;
            margin: 0 var(--space-1);
            border-radius: 10px;
            padding: 0 var(--space-1);
        }
        .gapfill-gap select {
            min-width: 140px;
            padding: 10px 16px;
            border-radius: 10px;
            border: 2px solid var(--tertiary-sage);
            background: #fff;
            font-weight: 600;
            color: var(--primary-sage);
            cursor: pointer;
            transition: border-color var(--dur-2) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient);
        }
        .gapfill-gap select:focus-visible {
            border-color: var(--secondary-sage);
            box-shadow: var(--ring);
            outline: none;
        }
        .gapfill-gap.is-correct select {
            border-color: color-mix(in srgb, var(--secondary-sage) 80%, var(--primary-sage) 20%);
            background: color-mix(in srgb, var(--soft-white) 85%, var(--secondary-sage) 15%);
        }
        .gapfill-gap.is-incorrect select {
            border-color: #C76B5E;
            background: color-mix(in srgb, #fff 85%, #F7D8D6 15%);
        }

        /* Ranking activity */
        .ranking-activity {
            display: grid;
            gap: var(--space-5);
        }
        .ranking-intro { margin: 0; font-size: var(--step-0); color: var(--ink-muted); }
        .ranking-list {
            list-style: none;
            counter-reset: ranking-counter;
            padding: 0;
            margin: 0;
            display: grid;
            gap: var(--space-4);
        }
        .ranking-item {
            counter-increment: ranking-counter;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
            padding: var(--space-4);
            padding-left: clamp(56px, 6vw, 72px);
            border: 1px solid rgba(122, 132, 113, 0.18);
            border-radius: var(--radius);
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            box-shadow: var(--shadow-1);
        }
        .ranking-item::before {
            content: counter(ranking-counter);
            position: absolute;
            left: clamp(16px, 2vw, 24px);
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border-radius: 999px;
            background: color-mix(in srgb, var(--secondary-sage) 85%, var(--primary-sage) 15%);
            color: var(--soft-white);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
        }
        .ranking-item.is-correct {
            border-color: color-mix(in srgb, var(--secondary-sage) 80%, var(--primary-sage) 20%);
            background: color-mix(in srgb, var(--soft-white) 85%, var(--secondary-sage) 15%);
        }
        .ranking-item.is-incorrect {
            border-color: #C76B5E;
            background: color-mix(in srgb, #fff 85%, #F7D8D6 15%);
        }
        .ranking-label { font-weight: 700; font-size: var(--step-0); color: var(--forest-shadow); }
        .ranking-controls { display: inline-flex; gap: var(--space-2); }
        .ranking-controls button {
            min-height: var(--target-min);
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--tertiary-sage);
            background: #fff;
            color: var(--primary-sage);
            cursor: pointer;
            font-weight: 600;
            transition: background var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
        }
        .ranking-controls button:hover { background: var(--hover-sage); }
        .ranking-controls button:focus-visible { outline: none; box-shadow: var(--ring); }

        /* Grouping activity */
        .grouping-activity {
            display: grid;
            gap: var(--space-5);
        }
        .grouping-grid {
            display: grid;
            gap: var(--space-4);
        }
        @media (min-width: 720px) {
            .grouping-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        .grouping-item {
            display: grid;
            gap: var(--space-2);
            border: 1px solid rgba(122, 132, 113, 0.18);
            border-radius: var(--radius);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
            padding: var(--space-4);
        }
        .grouping-item strong { font-size: var(--step-0); }
        .grouping-item.is-correct { border-color: color-mix(in srgb, var(--secondary-sage) 80%, var(--primary-sage) 20%); background: color-mix(in srgb, var(--soft-white) 85%, var(--secondary-sage) 15%); }
        .grouping-item.is-incorrect { border-color: #C76B5E; background: color-mix(in srgb, #fff 85%, #F7D8D6 15%); }

        /* Matching grid activity */
        .matching-activity { display: grid; gap: var(--space-5); }
        .matching-table-wrapper { overflow-x: auto; }
        .matching-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 520px;
        }
        .matching-table th,
        .matching-table td {
            padding: var(--space-3);
            border-bottom: 1px solid rgba(122, 132, 113, 0.16);
            text-align: center;
        }
        .matching-table thead th {
            text-transform: uppercase;
            letter-spacing: 0.4px;
            font-size: 0.85rem;
            color: var(--ink-muted);
        }
        .matching-table tbody th {
            text-align: left;
            color: var(--forest-shadow);
            font-weight: 700;
        }
        .matching-table tbody tr.is-correct { background: color-mix(in srgb, var(--soft-white) 85%, var(--secondary-sage) 15%); }
        .matching-table tbody tr.is-incorrect { background: color-mix(in srgb, #fff 85%, #F7D8D6 15%); }
        .matching-radio { display: inline-flex; align-items: center; justify-content: center; cursor: pointer; width: 28px; height: 28px; }
        .matching-radio input { display: none; }
        .matching-radio-indicator {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            border: 2px solid var(--tertiary-sage);
            transition: border-color var(--dur-2) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
            position: relative;
        }
        .matching-radio:hover .matching-radio-indicator { border-color: var(--primary-sage); }
        .matching-radio input:checked + .matching-radio-indicator {
            border-color: var(--primary-sage);
        }
        .matching-radio-indicator::after {
            content: "";
            position: absolute;
            inset: 4px;
            border-radius: inherit;
            background: var(--primary-sage);
            transform: scale(0);
            transition: transform var(--dur-2) var(--ease-ambient);
        }
        .matching-radio input:checked + .matching-radio-indicator::after { transform: scale(1); }

        @media (max-width: 767px) {
            .ranking-item { flex-direction: column; align-items: flex-start; }
            .ranking-controls { justify-content: flex-start; }
        }
        .slide-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: var(--space-6);
        }
        .slide-list.plain { list-style: none; }
        .slide-list.ordered {
            list-style: decimal;
            list-style-position: outside;
            padding-left: var(--space-6);
        }
        .slide-list li {
            position: relative;
            padding-left: var(--space-7);
            margin-bottom: var(--space-4);
            font-size: var(--step-1);
            line-height: 1.5;
        }
        .slide-list li::before {
            content: "";
            position: absolute;
            left: 0;
            top: var(--space-1);
            width: var(--space-3);
            height: var(--space-3);
            background-color: var(--primary-sage);
            border-radius: 50%;
        }
        .slide-list.plain li,
        .slide-list.ordered li {
            padding-left: 0;
        }
        .slide-list.plain li::before,
        .slide-list.ordered li::before {
            display: none;
        }
        .slide-list.smart li::before {
            content: attr(data-letter);
            background-color: var(--secondary-sage);
            color: var(--soft-white);
            font-weight: 700;
            font-size: var(--step--1);
            text-align: center;
            line-height: var(--space-7);
        }
        .process-flow {
            display: grid;
            gap: var(--space-4);
        }
        .process-step {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-sage);
            background: #fff;
        }
        .process-step-number {
            font-family: var(--font-display);
            font-size: var(--step-3);
            color: var(--primary-sage);
            font-weight: 700;
            flex-shrink: 0;
            width: 50px;
            text-align: center;
        }
        .process-step-content {
            font-size: var(--step-0);
        }
        .process-step-content strong { color: var(--forest-shadow); }

        /* Navigation controls styling */
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: var(--space-7);
        }
        .navigation button {
            width: 150px;
        }
        .navigation button:first-child { justify-content: flex-start; }
        .navigation button:last-child { justify-content: flex-end; }

        .slide-content p { margin-bottom: var(--space-4); }
        .slide-content ul { padding-left: var(--space-6); }
        .slide-content ul li { margin-bottom: var(--space-2); }
        
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-6);
        }
        .card {
            background: #fff;
            border: 1px solid var(--border-sage);
            border-radius: var(--radius);
            padding: var(--space-5);
            box-shadow: var(--shadow-1);
            text-align: center;
        }
        .card .icon {
            font-size: var(--step-3);
            color: var(--primary-sage);
            margin-bottom: var(--space-3);
        }
        .card h3 {
            font-size: var(--step-1);
            margin: 0;
        }
        .quiz-card {
            background: var(--warm-cream);
            border: 1px solid var(--border-sage);
            border-radius: var(--radius);
            padding: var(--space-5);
            margin-bottom: var(--space-5);
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        .quiz-question-text {
            font-weight: 700;
            font-size: var(--step-1);
            color: var(--forest-shadow);
            margin: 0;
        }
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .quiz-option {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            border: 1px solid rgba(122, 132, 113, 0.18);
            border-radius: var(--radius-sm);
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            transition: background var(--dur-2) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
        }
        .quiz-option:hover {
            background: var(--hover-sage);
            transform: translateY(-1px);
        }
        .quiz-option input[type="radio"] {
            margin-top: 4px;
        }
        .quiz-option span {
            flex: 1;
        }
        .activity-btn.quiz-btn {
            align-self: flex-start;
            background: linear-gradient(180deg, color-mix(in srgb, var(--secondary-sage) 92%, white 8%), var(--secondary-sage));
            border-color: var(--secondary-sage);
            color: var(--soft-white);
        }
        .activity-btn.quiz-btn:hover {
            background: linear-gradient(180deg, color-mix(in srgb, var(--forest-shadow) 88%, white 12%), var(--forest-shadow));
        }
        .quiz-feedback {
            margin: 0;
            font-weight: 600;
        }
        .quiz-feedback.correct {
            color: var(--secondary-sage);
        }
        .quiz-feedback.incorrect {
            color: #C4665A;
        }
        .quiz-feedback.notice {
            color: var(--forest-shadow);
        }
        .reflection-form {
            display: grid;
            gap: var(--space-5);
        }
        .reflection-field label {
            display: block;
            font-weight: 700;
            color: var(--forest-shadow);
            margin-bottom: var(--space-2);
        }
        .reflection-field textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--space-4);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(122, 132, 113, 0.28);
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            font-family: var(--font-body);
            font-size: var(--step-0);
            resize: vertical;
        }
        /* ------------------------------- Collaborative text boxes ----------------------------------*/
        #notes-dock {
            width: 100%;
            max-width: min(100%, 460px);
            background: color-mix(in srgb, var(--soft-white) 90%, white 10%);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(122, 132, 113, 0.14);
            box-shadow: var(--shadow-1);
            padding: clamp(20px, 2.8vw, 32px);
            display: flex;
            flex-direction: column;
            gap: var(--space-5);
            min-height: 0;
        }
        .notes-dock-header {
            display: grid;
            gap: var(--space-2);
            padding: var(--space-4);
            border-radius: var(--radius);
            border: 1px solid rgba(122, 132, 113, 0.16);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
            box-shadow: var(--shadow-1);
        }
        .notes-dock-title {
            margin: 0;
            font-family: var(--font-display);
            font-size: var(--step-1);
            color: var(--forest-shadow);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .notes-dock-subtitle {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        #notes-panels {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            flex: 1 1 auto;
            min-height: 0;
        }
        .notes-panel {
            display: none;
            flex-direction: column;
            gap: var(--space-4);
            background: color-mix(in srgb, var(--soft-white) 96%, white 4%);
            border: 1px solid rgba(122, 132, 113, 0.14);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-1);
        }
        .notes-panel.active {
            display: flex;
        }
        .notes-panel-title {
            margin: 0;
            font-family: var(--font-display);
            font-size: var(--step-1);
            color: var(--forest-shadow);
        }
        .textbox-toolbar {
            margin-top: var(--space-6);
            margin-bottom: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(122, 132, 113, 0.18);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .textbox-swatch-group {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        .textbox-swatch-group button {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 2px solid rgba(62, 74, 58, 0.15);
            background: var(--swatch-color);
            cursor: pointer;
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient);
        }
        .textbox-swatch-group button:hover {
            transform: translateY(-1px);
            border-color: rgba(62, 74, 58, 0.3);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.15);
        }
        .textbox-swatch-group button:focus-visible {
            outline: none;
            box-shadow: var(--ring), 0 6px 12px rgba(62, 74, 58, 0.18);
        }
        .textbox-toolbar .toolbar-caption {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .notes-panel .textbox-toolbar {
            margin-top: 0;
            margin-bottom: 0;
        }
        .textbox-collection {
            display: grid;
            gap: var(--space-3);
        }
        .notes-panel .textbox-collection {
            min-width: 0;
        }
        .custom-textbox {
            position: relative;
            border-radius: var(--radius);
            padding: var(--space-4);
            box-shadow: var(--shadow-1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: #1F2B1B;
        }
        .custom-textbox .textbox-content {
            min-height: 80px;
            outline: none;
            font-family: var(--font-body);
            font-size: var(--step-0);
            line-height: 1.5;
        }
        .custom-textbox .textbox-content:empty::before {
            content: attr(data-placeholder);
            color: rgba(47, 58, 43, 0.5);
        }
        .textbox-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }
        .textbox-color-picker {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(122, 132, 113, 0.18);
            background: rgba(255, 255, 255, 0.65);
        }
        .textbox-color-picker__swatch {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid rgba(62, 74, 58, 0.18);
            background: var(--swatch-color);
            cursor: pointer;
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient);
        }
        .textbox-color-picker__swatch:hover {
            transform: translateY(-1px);
            border-color: rgba(62, 74, 58, 0.32);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.16);
        }
        .textbox-color-picker__swatch:focus-visible {
            outline: none;
            box-shadow: var(--ring), 0 6px 12px rgba(62, 74, 58, 0.2);
        }
        .textbox-color-picker__swatch.is-selected {
            border-color: rgba(62, 74, 58, 0.45);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8), 0 0 0 5px rgba(62, 74, 58, 0.25);
        }
        .textbox-remove-btn {
            border: none;
            background: transparent;
            color: var(--forest-shadow);
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .textbox-remove-btn:hover {
            color: #C4665A;
        }
        @media (max-width: 767px) {
            .textbox-toolbar {
                align-items: stretch;
            }
            .textbox-swatch-group {
                flex-wrap: wrap;
            }
            .textbox-actions {
                flex-direction: column;
                align-items: stretch;
            }
            .textbox-remove-btn {
                justify-content: center;
            }
        }
        .animate-on-scroll {
            opacity: 0;
            transform: translate3d(0, 24px, 0);
            transition: opacity var(--dur-3) var(--ease-ambient), transform var(--dur-3) var(--ease-ambient);
            transition-delay: var(--stagger-delay, 0ms);
        }
        .animate-on-scroll.is-visible {
            opacity: 1;
            transform: translate3d(0, 0, 0);
        }
    </style>
</head>
<body>

    <a class="skip-link" href="#activity-container">Skip to presentation content</a>

    <div id="app-wrapper">
        <main id="activity-shell" role="main">
            <div id="activity-container">

            <header class="presentation-header" id="presentation-header">
                <details class="workspace-menu" id="workspace-menu">
                    <summary class="workspace-menu__summary">
                        <span class="workspace-menu__summary-text">
                            <span class="workspace-menu__summary-eyebrow" id="presentation-eyebrow">Instructional Session</span>
                            <span class="workspace-menu__summary-title" id="workspace-summary-title">Select a lesson template</span>
                            <span class="workspace-menu__summary-descriptor" id="presentation-descriptor">Choose a template to populate the slides.</span>
                        </span>
                        <span class="workspace-menu__summary-indicator" aria-hidden="true">
                            <span class="workspace-menu__summary-hint">Open workspace menu</span>
                            <i class="fas fa-chevron-down"></i>
                        </span>
                    </summary>
                    <div class="workspace-menu__panel">
                        <div class="workspace-menu__intro">
                            <p class="workspace-menu__descriptor" id="workspace-menu-descriptor">Choose a template to populate the slides.</p>
                            <div class="lesson-selector">
                                <label for="lesson-template">Lesson template</label>
                                <select id="lesson-template" aria-label="Select a lesson template"></select>
                            </div>
                        </div>
                        <section class="workspace-tools" id="notes-io-controls" aria-labelledby="workspace-tools-heading">
                            <div class="workspace-tools__header">
                                <h2 class="workspace-tools__title" id="workspace-tools-heading">Session tools</h2>
                                <p class="workspace-tools__hint">Slide map &amp; notes backup</p>
                            </div>
                            <div class="workspace-tools__actions">
                                <button type="button" class="activity-btn secondary" id="save-notes-btn"><i class="fas fa-file-arrow-down"></i> Save Notes (JSON)</button>
                                <button type="button" class="activity-btn secondary" id="load-notes-btn"><i class="fas fa-file-arrow-up"></i> Load Notes (JSON)</button>
                                <input type="file" id="notes-file-input" accept="application/json" hidden>
                            </div>
                            <div class="workspace-tools__map" aria-labelledby="presentation-slide-map-heading">
                                <h2 class="workspace-tools__subtitle" id="presentation-slide-map-heading">Slide map</h2>
                                <nav id="slide-map" aria-label="Slide overview">
                                    <ul id="slide-map-list"></ul>
                                </nav>
                            </div>
                        </section>
                        <section class="lesson-overview" id="lesson-overview" aria-label="Lesson overview" hidden aria-hidden="true"></section>
                    </div>
                </details>
            </header>

                <div id="slides-root" role="presentation"></div>

        </div>
        <aside id="notes-dock" aria-label="Collaborative slide notes workspace">
            <div class="notes-dock-header">
                <p class="notes-dock-title"><i class="fas fa-note-sticky" aria-hidden="true"></i> Slide Text Boxes</p>
                <p class="notes-dock-subtitle">Use the session tools foldout to save or load your notes at any time.</p>
            </div>
            <div id="notes-panels" aria-live="polite"></div>
        </aside>
    </main>
    </div>

    <script>
        let lessonLibrary = {};
        const textboxColorOptions = [
            { label: "Sunlit Sand", value: "#FDF5D6" },
            { label: "Mint Mist", value: "#E6F4F1" },
            { label: "Lavender Veil", value: "#F3E9FB" },
            { label: "Peach Glow", value: "#FFEDE5" },
            { label: "Sky Wash", value: "#E9F0FF" }
        ];

        const storageKeyBase = "instructional-slide-textboxes";
        let activeLessonKey = null;
        let activeLesson = null;
        let slides = [];
        let currentSlideIndex = 0;
        let slideNotes = {};
        const textboxContainers = {};
        const notesPanels = {};
        let notesPanelsHost = null;
        const slideMapButtons = [];
        let keyboardHandlerAttached = false;

        const slidesRoot = document.getElementById("slides-root");
        const presentationEyebrow = document.getElementById("presentation-eyebrow");
        const presentationDescriptor = document.getElementById("presentation-descriptor");
        const workspaceSummaryTitle = document.getElementById("workspace-summary-title");
        const workspaceMenuDescriptor = document.getElementById("workspace-menu-descriptor");
        const lessonOverview = document.getElementById("lesson-overview");
        const lessonSelector = document.getElementById("lesson-template");
        const workspaceMenu = document.getElementById("workspace-menu");
        const workspaceSummaryHint = workspaceMenu ? workspaceMenu.querySelector(".workspace-menu__summary-hint") : null;
        const slideMapList = document.getElementById("slide-map-list");
        const embeddedLessonLibraryElement = document.getElementById("lesson-library-embedded");
        let embeddedLessonLibrary = null;
        if (workspaceMenu && workspaceSummaryHint) {
            const updateWorkspaceSummaryHint = () => {
                workspaceSummaryHint.textContent = workspaceMenu.open ? "Close workspace menu" : "Open workspace menu";
            };
            workspaceMenu.addEventListener("toggle", updateWorkspaceSummaryHint);
            updateWorkspaceSummaryHint();
        }
        if (embeddedLessonLibraryElement) {
            try {
                embeddedLessonLibrary = JSON.parse(embeddedLessonLibraryElement.textContent);
                if (typeof window !== "undefined" && window && typeof window === "object") {
                    window.__LESSON_LIBRARY__ = window.__LESSON_LIBRARY__ || embeddedLessonLibrary;
                }
            } catch (error) {
                console.error("Embedded lesson library JSON could not be parsed.", error);
            }
        }
        const motionQuery = typeof window !== "undefined" && window.matchMedia ? window.matchMedia("(prefers-reduced-motion: reduce)") : null;
        let prefersReducedMotion = motionQuery ? motionQuery.matches : false;

        function setPresentationDescriptor(message) {
            if (presentationDescriptor) {
                presentationDescriptor.textContent = message;
            }
            if (workspaceMenuDescriptor) {
                workspaceMenuDescriptor.textContent = message;
            }
        }

        function displayStatusMessage(message) {
            if (!slidesRoot) {
                return;
            }
            slidesRoot.innerHTML = "";
            if (!message) {
                return;
            }
            const status = document.createElement("p");
            status.className = "data-status-message";
            status.setAttribute("role", "status");
            status.textContent = message;
            slidesRoot.appendChild(status);
        }

        async function fetchLessonLibraryData() {
            const fallbackData = embeddedLessonLibrary || (typeof window !== "undefined" ? window.__LESSON_LIBRARY__ : null);
            const isFileProtocol = typeof window !== "undefined" && window.location?.protocol === "file:";

            if (isFileProtocol) {
                if (fallbackData && typeof fallbackData === "object" && !Array.isArray(fallbackData)) {
                    return fallbackData;
                }
                console.warn("Lesson library fallback data was not found when using the file protocol.");
            }

            try {
                const requestUrl = new URL("./data/lesson-library.json", window.location?.href || document.baseURI);
                const response = await fetch(requestUrl, {
                    headers: {
                        "Accept": "application/json"
                    }
                });
                if (!response.ok) {
                    throw new Error(`Lesson library request failed: ${response.status}`);
                }
                const data = await response.json();
                if (!data || typeof data !== "object" || Array.isArray(data)) {
                    throw new Error("Lesson library response was not a valid object");
                }
                return data;
            } catch (error) {
                if (fallbackData && typeof fallbackData === "object" && !Array.isArray(fallbackData)) {
                    console.warn("Falling back to embedded lesson library data due to a fetch error.", error);
                    return fallbackData;
                }
                throw error;
            }
        }

        const highlightScope = document.getElementById("activity-container");
        const highlightToolbar = document.createElement("div");
        highlightToolbar.id = "highlight-toolbar";
        highlightToolbar.setAttribute("role", "group");
        highlightToolbar.setAttribute("aria-label", "Text annotation tools");
        highlightToolbar.setAttribute("aria-hidden", "true");
        highlightToolbar.hidden = true;

        const highlightToolbarButton = document.createElement("button");
        highlightToolbarButton.type = "button";
        highlightToolbarButton.className = "highlight-toolbar__btn";
        highlightToolbarButton.innerHTML = '<i class="fas fa-highlighter" aria-hidden="true"></i><span>Highlight &amp; annotate</span>';
        highlightToolbar.appendChild(highlightToolbarButton);
        document.body.appendChild(highlightToolbar);

        const annotationPopover = document.createElement("div");
        annotationPopover.className = "annotation-popover";
        annotationPopover.id = "annotation-popover";
        annotationPopover.setAttribute("role", "dialog");
        annotationPopover.setAttribute("aria-modal", "false");
        annotationPopover.setAttribute("aria-hidden", "true");
        annotationPopover.hidden = true;
        annotationPopover.setAttribute("tabindex", "-1");

        const annotationCloseButton = document.createElement("button");
        annotationCloseButton.type = "button";
        annotationCloseButton.className = "annotation-popover__close";
        annotationCloseButton.innerHTML = '<i class="fas fa-times" aria-hidden="true"></i><span class="visually-hidden">Close annotation</span>';

        const annotationBody = document.createElement("p");
        annotationBody.className = "annotation-popover__body";

        annotationPopover.appendChild(annotationCloseButton);
        annotationPopover.appendChild(annotationBody);
        document.body.appendChild(annotationPopover);

        const annotationComposer = document.createElement("form");
        annotationComposer.className = "annotation-composer";
        annotationComposer.id = "annotation-composer";
        annotationComposer.hidden = true;
        annotationComposer.setAttribute("aria-hidden", "true");
        annotationComposer.setAttribute("role", "dialog");
        annotationComposer.setAttribute("aria-modal", "false");
        annotationComposer.noValidate = true;

        const annotationComposerLabel = document.createElement("label");
        annotationComposerLabel.className = "annotation-composer__label";
        annotationComposerLabel.setAttribute("for", "annotation-composer-input");
        annotationComposerLabel.textContent = "Add an annotation";
        annotationComposerLabel.id = "annotation-composer-label";
        annotationComposer.setAttribute("aria-labelledby", "annotation-composer-label");

        const annotationComposerTextarea = document.createElement("textarea");
        annotationComposerTextarea.id = "annotation-composer-input";
        annotationComposerTextarea.className = "annotation-composer__input";
        annotationComposerTextarea.rows = 4;
        annotationComposerTextarea.placeholder = "Type your note here…";

        const annotationComposerActions = document.createElement("div");
        annotationComposerActions.className = "annotation-composer__actions";

        const annotationComposerCancel = document.createElement("button");
        annotationComposerCancel.type = "button";
        annotationComposerCancel.className = "annotation-composer__btn annotation-composer__btn--secondary";
        annotationComposerCancel.textContent = "Cancel";

        const annotationComposerSubmit = document.createElement("button");
        annotationComposerSubmit.type = "submit";
        annotationComposerSubmit.className = "annotation-composer__btn annotation-composer__btn--primary";
        annotationComposerSubmit.textContent = "Save note";

        annotationComposerActions.appendChild(annotationComposerCancel);
        annotationComposerActions.appendChild(annotationComposerSubmit);

        annotationComposer.appendChild(annotationComposerLabel);
        annotationComposer.appendChild(annotationComposerTextarea);
        annotationComposer.appendChild(annotationComposerActions);
        document.body.appendChild(annotationComposer);

        let pendingSelectionRange = null;
        let activeAnnotationTarget = null;
        let composerActiveRange = null;

        if (motionQuery) {
            const updatePreference = (event) => {
                prefersReducedMotion = event.matches;
                const activeSlide = slides[currentSlideIndex];
                if (activeSlide) {
                    animateSlideContents(activeSlide);
                }
            };
            if (typeof motionQuery.addEventListener === "function") {
                motionQuery.addEventListener("change", updatePreference);
            } else if (typeof motionQuery.addListener === "function") {
                motionQuery.addListener(updatePreference);
            }
        }
        function isNodeWithinActiveSlide(node) {
            const activeSlide = slides[currentSlideIndex];
            if (!activeSlide || !node) {
                return false;
            }
            let current = node.nodeType === Node.ELEMENT_NODE ? node : node.parentNode;
            while (current) {
                if (current === activeSlide) {
                    return true;
                }
                current = current.parentNode;
            }
            return false;
        }

        function isInsideExistingHighlight(node) {
            if (!node) {
                return false;
            }
            const element = node.nodeType === Node.ELEMENT_NODE ? node : node.parentElement;
            return element ? Boolean(element.closest(".highlight-annotation")) : false;
        }

        function hideHighlightToolbar(options = {}) {
            const { clearSelection = true } = options;
            if (highlightToolbar.hidden) {
                return;
            }
            highlightToolbar.hidden = true;
            highlightToolbar.setAttribute("aria-hidden", "true");
            if (clearSelection) {
                pendingSelectionRange = null;
            }
        }

        function positionHighlightToolbar(range) {
            const rect = range.getBoundingClientRect();
            const top = window.scrollY + rect.top;
            const left = window.scrollX + rect.left + rect.width / 2;
            highlightToolbar.style.top = `${Math.max(top, 0)}px`;
            highlightToolbar.style.left = `${left}px`;
        }

        function isRangeAnnotatable(range) {
            if (!range || range.collapsed) {
                return false;
            }
            if (!isNodeWithinActiveSlide(range.startContainer) || !isNodeWithinActiveSlide(range.endContainer)) {
                return false;
            }
            if (isInsideExistingHighlight(range.startContainer) || isInsideExistingHighlight(range.endContainer)) {
                return false;
            }
            const fragment = range.cloneContents();
            if (fragment.querySelector && fragment.querySelector("p, li, div, section, article, ul, ol, table, tr, td, th, h1, h2, h3, h4, h5, h6, blockquote")) {
                return false;
            }
            return range.toString().trim().length > 0;
        }

        function showHighlightToolbar(range) {
            pendingSelectionRange = range.cloneRange();
            positionHighlightToolbar(range);
            highlightToolbar.hidden = false;
            highlightToolbar.setAttribute("aria-hidden", "false");
        }

        function positionAnnotationComposer(range) {
            const rect = range.getBoundingClientRect();
            const top = window.scrollY + rect.bottom + 12;
            const left = window.scrollX + rect.left + rect.width / 2;
            annotationComposer.style.top = `${Math.max(top, 0)}px`;
            annotationComposer.style.left = `${left}px`;
        }

        function openAnnotationComposer(range) {
            if (!range) {
                return;
            }
            composerActiveRange = range.cloneRange();
            positionAnnotationComposer(range);
            annotationComposer.hidden = false;
            annotationComposer.setAttribute("aria-hidden", "false");
            annotationComposerTextarea.value = "";
            window.requestAnimationFrame(() => {
                annotationComposerTextarea.focus({ preventScroll: true });
            });
        }

        function closeAnnotationComposer({ restoreToolbar = false, clearRange = true } = {}) {
            if (!annotationComposer.hidden) {
                annotationComposer.hidden = true;
                annotationComposer.setAttribute("aria-hidden", "true");
                annotationComposerTextarea.value = "";
            }
            if (clearRange) {
                composerActiveRange = null;
            }
            if (restoreToolbar && pendingSelectionRange) {
                showHighlightToolbar(pendingSelectionRange);
            }
        }

        function updateHighlightToolbar() {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) {
                hideHighlightToolbar();
                return;
            }
            const range = selection.getRangeAt(0);
            if (!isRangeAnnotatable(range)) {
                hideHighlightToolbar();
                return;
            }
            hideAnnotationPopover();
            showHighlightToolbar(range);
        }

        function hideAnnotationPopover() {
            if (annotationPopover.hidden) {
                return;
            }
            annotationPopover.hidden = true;
            annotationPopover.setAttribute("aria-hidden", "true");
            if (activeAnnotationTarget) {
                activeAnnotationTarget.setAttribute("aria-expanded", "false");
                activeAnnotationTarget = null;
            }
        }

        function positionAnnotationPopover(target) {
            const rect = target.getBoundingClientRect();
            const top = window.scrollY + rect.bottom + 12;
            const left = window.scrollX + rect.left + rect.width / 2;
            annotationPopover.style.top = `${top}px`;
            annotationPopover.style.left = `${left}px`;
        }

        function showAnnotationPopover(target) {
            const annotationText = target?.dataset?.annotation;
            if (!annotationText) {
                hideAnnotationPopover();
                return;
            }
            if (activeAnnotationTarget && activeAnnotationTarget !== target) {
                activeAnnotationTarget.setAttribute("aria-expanded", "false");
            }
            activeAnnotationTarget = target;
            annotationBody.textContent = annotationText;
            positionAnnotationPopover(target);
            annotationPopover.hidden = false;
            annotationPopover.setAttribute("aria-hidden", "false");
            target.setAttribute("aria-expanded", "true");
        }

        function toggleAnnotationPopover(target) {
            if (annotationPopover.hidden || target !== activeAnnotationTarget) {
                showAnnotationPopover(target);
            } else {
                hideAnnotationPopover();
            }
        }

        function applyAnnotation(range, annotationText) {
            if (!range) {
                return;
            }
            const trimmed = annotationText.trim();
            if (!trimmed) {
                return;
            }
            const workingRange = range.cloneRange();
            const highlight = document.createElement("mark");
            highlight.className = "highlight-annotation";
            highlight.tabIndex = 0;
            highlight.setAttribute("role", "button");
            highlight.setAttribute("aria-expanded", "false");
            highlight.setAttribute("aria-controls", "annotation-popover");
            highlight.setAttribute("aria-haspopup", "dialog");
            highlight.dataset.annotation = trimmed;
            const contents = workingRange.extractContents();
            highlight.appendChild(contents);
            workingRange.insertNode(highlight);
            highlight.normalize();
            if (highlight.parentNode) {
                highlight.parentNode.normalize();
            }
            const selection = window.getSelection();
            if (selection) {
                selection.removeAllRanges();
            }
            hideHighlightToolbar();
            window.requestAnimationFrame(() => {
                showAnnotationPopover(highlight);
                highlight.focus({ preventScroll: true });
            });
        }

        highlightToolbarButton.addEventListener("mousedown", (event) => {
            event.preventDefault();
        });

        highlightToolbarButton.addEventListener("click", () => {
            if (!pendingSelectionRange) {
                hideHighlightToolbar();
                closeAnnotationComposer();
                return;
            }
            const rangeToAnnotate = pendingSelectionRange.cloneRange();
            hideHighlightToolbar({ clearSelection: false });
            openAnnotationComposer(rangeToAnnotate);
        });

        annotationComposer.addEventListener("submit", (event) => {
            event.preventDefault();
            if (!composerActiveRange) {
                closeAnnotationComposer();
                hideHighlightToolbar();
                return;
            }
            const note = annotationComposerTextarea.value.trim();
            if (!note) {
                annotationComposerTextarea.focus({ preventScroll: true });
                return;
            }
            const rangeToAnnotate = composerActiveRange.cloneRange();
            closeAnnotationComposer();
            applyAnnotation(rangeToAnnotate, note);
        });

        annotationComposerCancel.addEventListener("click", () => {
            closeAnnotationComposer({ restoreToolbar: true });
        });

        annotationCloseButton.addEventListener("click", () => {
            hideAnnotationPopover();
            if (activeAnnotationTarget) {
                activeAnnotationTarget.focus({ preventScroll: true });
            }
        });

        document.addEventListener("selectionchange", () => {
            const activeElement = document.activeElement;
            if (!annotationComposer.hidden && annotationComposer.contains(activeElement)) {
                return;
            }
            closeAnnotationComposer();
            window.requestAnimationFrame(updateHighlightToolbar);
        });

        document.addEventListener("mousedown", (event) => {
            const isToolbar = highlightToolbar.contains(event.target);
            const isComposer = annotationComposer.contains(event.target);
            if (!isToolbar && !isComposer) {
                hideHighlightToolbar();
                closeAnnotationComposer();
            }
        });

        document.addEventListener("click", (event) => {
            if (!annotationPopover.hidden) {
                const isHighlight = event.target.closest?.(".highlight-annotation");
                const isPopover = annotationPopover.contains(event.target);
                if (!isHighlight && !isPopover) {
                    hideAnnotationPopover();
                }
            }
            if (!annotationComposer.hidden) {
                const isComposer = annotationComposer.contains(event.target);
                if (!isComposer && !highlightToolbar.contains(event.target)) {
                    closeAnnotationComposer();
                    hideHighlightToolbar();
                }
            }
        });

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                hideAnnotationPopover();
                hideHighlightToolbar();
                closeAnnotationComposer();
            }
        });

        if (highlightScope) {
            highlightScope.addEventListener("click", (event) => {
                const highlight = event.target.closest?.(".highlight-annotation");
                if (!highlight) {
                    return;
                }
                event.preventDefault();
                hideHighlightToolbar();
                toggleAnnotationPopover(highlight);
            });

            highlightScope.addEventListener("keydown", (event) => {
                if (event.key !== "Enter" && event.key !== " ") {
                    return;
                }
                const highlight = event.target.closest?.(".highlight-annotation");
                if (!highlight) {
                    return;
                }
                event.preventDefault();
                hideHighlightToolbar();
                toggleAnnotationPopover(highlight);
            });
        }

        window.addEventListener("scroll", () => {
            hideHighlightToolbar();
            hideAnnotationPopover();
            closeAnnotationComposer();
        }, true);

        window.addEventListener("resize", () => {
            hideHighlightToolbar();
            hideAnnotationPopover();
            closeAnnotationComposer();
        });
        function generateNoteId() {
            return `note-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
        }

        function createColorPicker(currentColor, onChange) {
            const palette = document.createElement("div");
            palette.className = "textbox-color-picker";
            palette.setAttribute("role", "group");
            palette.setAttribute("aria-label", "Change text box colour");
            const swatches = [];
            const updateSelection = (selectedColor) => {
                swatches.forEach((button) => {
                    const isActive = button.dataset.value === selectedColor;
                    button.classList.toggle("is-selected", isActive);
                    button.setAttribute("aria-pressed", isActive ? "true" : "false");
                });
            };
            textboxColorOptions.forEach((option) => {
                const swatchButton = document.createElement("button");
                swatchButton.type = "button";
                swatchButton.className = "textbox-color-picker__swatch";
                swatchButton.dataset.value = option.value;
                swatchButton.style.setProperty("--swatch-color", option.value);
                swatchButton.setAttribute("aria-label", option.label);
                swatchButton.title = option.label;
                swatchButton.setAttribute("aria-pressed", "false");
                swatchButton.addEventListener("click", () => {
                    if (typeof onChange === "function") {
                        onChange(option.value);
                    }
                    updateSelection(option.value);
                });
                palette.appendChild(swatchButton);
                swatches.push(swatchButton);
            });
            updateSelection(currentColor);
            return palette;
        }

        function getSlideLabel(slide, index) {
            const rawTitle = slide?.querySelector(".slide-title")?.textContent?.trim() || "";
            const label = rawTitle ? `${rawTitle}` : "";
            const prefix = `Slide ${index + 1}`;
            return label ? `${prefix}: ${label}` : prefix;
        }

        function isValidNotesData(data) {
            if (!data || typeof data !== "object" || Array.isArray(data)) {
                return false;
            }
            return Object.values(data).every((value) => Array.isArray(value) && value.every((note) => {
                return note && typeof note === "object" && "id" in note && "color" in note && ("content" in note || "text" in note);
            }));
        }

        function getStorageKey() {
            const suffix = activeLesson?.id ? `:${activeLesson.id}` : "";
            return `${storageKeyBase}${suffix}`;
        }

        function loadStoredNotes() {
            if (typeof window === "undefined" || !window.localStorage) {
                return {};
            }
            const stored = window.localStorage.getItem(getStorageKey());
            if (!stored) {
                return {};
            }
            try {
                const parsed = JSON.parse(stored);
                return isValidNotesData(parsed) ? parsed : {};
            } catch (error) {
                console.warn("Unable to parse stored slide notes.", error);
                return {};
            }
        }

        function persistNotes() {
            if (typeof window === "undefined" || !window.localStorage) {
                return;
            }
            try {
                window.localStorage.setItem(getStorageKey(), JSON.stringify(slideNotes));
            } catch (error) {
                console.warn("Unable to save slide notes.", error);
            }
        }

        function buildSlideMap() {
            if (!slideMapList) {
                return;
            }
            slideMapList.innerHTML = "";
            slideMapButtons.length = 0;
            slideMapList.setAttribute("role", "list");

            const slideMeta = slides.map((slide, index) => ({
                slide,
                index,
                id: slide.id || `slide-${index + 1}`,
                key: slide.dataset.slideKey || slide.id || `slide-${index + 1}`
            }));
            const slidesByKey = new Map(slideMeta.map((meta) => [meta.key, meta]));
            const usedIndices = new Set();
            const sectionDefinitions = Array.isArray(activeLesson?.sections) ? activeLesson.sections : [];

            const createSlideMapEntry = (slide, index) => {
                const listItem = document.createElement("li");
                listItem.className = "slide-map-item";

                const button = document.createElement("button");
                button.type = "button";
                button.className = "slide-map-button";
                const slideNumber = index + 1;
                const rawTitle = slide?.querySelector(".slide-title")?.textContent?.trim() || "";
                const cleanTitle = rawTitle.replace(/\s+/g, " ").trim();
                const colonIndex = cleanTitle.indexOf(":");
                const mainTitle = colonIndex > -1 ? cleanTitle.slice(0, colonIndex).trim() : cleanTitle;
                const subtitle = colonIndex > -1 ? cleanTitle.slice(colonIndex + 1).trim() : "";

                const numberSpan = document.createElement("span");
                numberSpan.className = "slide-map-button__number";
                numberSpan.textContent = slideNumber.toString().padStart(2, "0");

                const label = document.createElement("span");
                label.className = "slide-map-button__label";

                const titleSpan = document.createElement("span");
                titleSpan.className = "slide-map-button__title";
                titleSpan.textContent = mainTitle || `Slide ${slideNumber}`;
                label.appendChild(titleSpan);

                if (subtitle) {
                    const subtitleSpan = document.createElement("span");
                    subtitleSpan.className = "slide-map-button__subtitle";
                    subtitleSpan.textContent = subtitle;
                    label.appendChild(subtitleSpan);
                }

                const ariaLabelParts = [`Slide ${slideNumber}`];
                if (cleanTitle) {
                    ariaLabelParts.push(cleanTitle);
                }
                button.setAttribute("aria-label", `Go to ${ariaLabelParts.join(": ")}`);
                button.dataset.slideIndex = index;
                button.appendChild(numberSpan);
                button.appendChild(label);
                button.addEventListener("click", () => showSlide(index));

                listItem.appendChild(button);
                return { listItem, button };
            };

            const appendSection = (title, entries) => {
                if (!entries.length) {
                    return;
                }
                const sectionItem = document.createElement("li");
                sectionItem.className = "slide-map-group";

                const sectionTitle = document.createElement("h3");
                sectionTitle.className = "slide-map-group__title";
                sectionTitle.textContent = title;
                sectionItem.appendChild(sectionTitle);

                const sectionList = document.createElement("ol");
                sectionList.className = "slide-map-group__list";
                sectionList.setAttribute("role", "list");

                entries.forEach(({ slide, index }) => {
                    const { listItem, button } = createSlideMapEntry(slide, index);
                    sectionList.appendChild(listItem);
                    slideMapButtons.push(button);
                    usedIndices.add(index);
                });

                sectionItem.appendChild(sectionList);
                slideMapList.appendChild(sectionItem);
            };

            sectionDefinitions.forEach((section) => {
                let entries = [];
                if (Array.isArray(section.slideKeys)) {
                    entries = section.slideKeys.map((key) => slidesByKey.get(key)).filter(Boolean);
                } else if (Array.isArray(section.slideIndices)) {
                    entries = section.slideIndices.map((i) => slideMeta[i]).filter(Boolean);
                } else if (section.range && Array.isArray(section.range) && section.range.length === 2) {
                    entries = slideMeta.filter((meta) => meta.index >= section.range[0] && meta.index <= section.range[1]);
                }
                appendSection(section.title || "Slides", entries);
            });

            const remainingEntries = slideMeta.filter((meta) => !usedIndices.has(meta.index));
            if (remainingEntries.length) {
                appendSection("Additional slides", remainingEntries);
            }

            updateSlideMapIndicator(currentSlideIndex);
        }

        function updateSlideMapIndicator(index) {
            if (!slideMapButtons.length) {
                return;
            }
            slideMapButtons.forEach((button, buttonIndex) => {
                const listItem = button.parentElement;
                const isActive = buttonIndex === index;
                if (listItem) {
                    listItem.classList.toggle("is-active", isActive);
                }
                if (isActive) {
                    button.setAttribute("aria-current", "step");
                    if (listItem && typeof listItem.scrollIntoView === "function") {
                        try {
                            listItem.scrollIntoView({ behavior: prefersReducedMotion ? "auto" : "smooth", block: "nearest", inline: "nearest" });
                        } catch (error) {
                            if (!prefersReducedMotion) {
                                listItem.scrollIntoView();
                            }
                        }
                    }
                } else {
                    button.removeAttribute("aria-current");
                }
            });
        }

        function animateSlideContents(slide) {
            const elementsToAnimate = slide.querySelectorAll(".animate-on-scroll");
            elementsToAnimate.forEach((el, index) => {
                el.classList.remove("animate__animated", "animate__fadeInUp");
                if (prefersReducedMotion) {
                    el.classList.add("is-visible");
                    el.style.removeProperty("--stagger-delay");
                    return;
                }
                el.classList.remove("is-visible");
                el.style.setProperty("--stagger-delay", `${Math.min(index * 90, 900)}ms`);
                requestAnimationFrame(() => {
                    el.classList.add("is-visible");
                });
            });
        }

        function handleKeyboardNavigation(event) {
            if (event.defaultPrevented) {
                return;
            }
            const target = event.target;
            const isFormField = target && (
                target.isContentEditable ||
                ["INPUT", "TEXTAREA", "SELECT", "BUTTON"].includes(target.tagName)
            );
            if (isFormField) {
                return;
            }
            if (event.key === "ArrowRight" || event.key === "PageDown") {
                event.preventDefault();
                nextSlide();
            } else if (event.key === "ArrowLeft" || event.key === "PageUp") {
                event.preventDefault();
                prevSlide();
            } else if (event.key === "Home") {
                event.preventDefault();
                showSlide(0);
            } else if (event.key === "End") {
                event.preventDefault();
                showSlide(slides.length - 1);
            }
        }
        function renderSlideTextboxes(slideId) {
            const container = textboxContainers[slideId];
            if (!container) {
                return;
            }
            container.innerHTML = "";
            const notes = Array.isArray(slideNotes[slideId]) ? slideNotes[slideId] : [];
            const panel = notesPanels[slideId];
            if (panel) {
                panel.classList.toggle("empty", notes.length === 0);
            }
            notes.forEach((note) => {
                if (!note.content && note.text) {
                    note.content = note.text;
                    delete note.text;
                }
                container.appendChild(createTextboxElement(slideId, note));
            });
        }

        function renderAllSlides() {
            if (!slides.length) {
                setupNotesIoControls();
                return;
            }
            if (!notesPanelsHost) {
                return;
            }
            slides.forEach((slide, index) => {
                const slideId = slide.dataset.slideId || slide.id || `slide-${index + 1}`;
                if (!Array.isArray(slideNotes[slideId])) {
                    slideNotes[slideId] = [];
                }
                renderSlideTextboxes(slideId);
            });
            const activeSlide = slides[currentSlideIndex];
            if (activeSlide) {
                activateNotesPanel(activeSlide.dataset.slideId);
            }
        }

        function activateNotesPanel(slideId) {
            Object.values(notesPanels).forEach((panel) => {
                panel.classList.remove("active");
                panel.setAttribute("aria-hidden", "true");
                panel.hidden = true;
            });
            const panel = notesPanels[slideId];
            if (panel) {
                panel.classList.add("active");
                panel.setAttribute("aria-hidden", "false");
                panel.hidden = false;
                if (notesPanelsHost) {
                    notesPanelsHost.scrollTop = 0;
                }
            }
        }

        function createTextboxElement(slideId, note) {
            const wrapper = document.createElement("div");
            wrapper.className = "custom-textbox";
            wrapper.dataset.noteId = note.id;
            wrapper.style.backgroundColor = note.color;

            const actions = document.createElement("div");
            actions.className = "textbox-actions";

            const colorPicker = createColorPicker(note.color, (newColor) => {
                if (!newColor || note.color === newColor) {
                    return;
                }
                note.color = newColor;
                wrapper.style.backgroundColor = newColor;
                persistNotes();
            });

            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.className = "textbox-remove-btn";
            removeButton.innerHTML = '<i class="fas fa-trash"></i> Remove';
            removeButton.addEventListener("click", () => {
                slideNotes[slideId] = (slideNotes[slideId] || []).filter((existing) => existing.id !== note.id);
                persistNotes();
                renderSlideTextboxes(slideId);
            });

            actions.appendChild(colorPicker);
            actions.appendChild(removeButton);

            const content = document.createElement("div");
            content.className = "textbox-content";
            content.contentEditable = "true";
            content.dataset.placeholder = "Type your notes here...";
            content.innerHTML = note.content || "";
            content.addEventListener("input", () => {
                note.content = content.innerHTML;
                persistNotes();
            });

            wrapper.appendChild(actions);
            wrapper.appendChild(content);
            return wrapper;
        }

        function setupNotesIoControls() {
            const saveButton = document.getElementById("save-notes-btn");
            const loadButton = document.getElementById("load-notes-btn");
            const fileInput = document.getElementById("notes-file-input");

            if (saveButton && !saveButton.dataset.initialized) {
                saveButton.addEventListener("click", () => {
                    const data = JSON.stringify(slideNotes, null, 2);
                    const blob = new Blob([data], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    const fileId = activeLesson?.id ? activeLesson.id : "lesson";
                    link.download = `${fileId}-slide-notes.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                });
                saveButton.dataset.initialized = "true";
            }

            if (loadButton && !loadButton.dataset.initialized) {
                loadButton.addEventListener("click", () => fileInput?.click());
                loadButton.dataset.initialized = "true";
            }

            if (fileInput && !fileInput.dataset.initialized) {
                fileInput.addEventListener("change", (event) => {
                    const file = event.target.files && event.target.files[0];
                    if (!file) {
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (loadEvent) => {
                        try {
                            const parsed = JSON.parse(loadEvent.target.result);
                            if (isValidNotesData(parsed)) {
                                slideNotes = parsed;
                                slides.forEach((slide, index) => {
                                    const slideId = slide.dataset.slideId || slide.id || `slide-${index + 1}`;
                                    if (!Array.isArray(slideNotes[slideId])) {
                                        slideNotes[slideId] = [];
                                    }
                                });
                                persistNotes();
                                renderAllSlides();
                            } else {
                                alert("The selected file does not contain valid notes data.");
                            }
                        } catch (error) {
                            alert("Unable to read that JSON file. Please check the format and try again.");
                        }
                    };
                    reader.onerror = () => {
                        alert("We could not read that file. Please try again with a different JSON export.");
                    };
                    reader.readAsText(file);
                    event.target.value = "";
                });
                fileInput.dataset.initialized = "true";
            }
        }

        function initializeTextboxes() {
            notesPanelsHost = document.getElementById("notes-panels");
            if (!notesPanelsHost) {
                setupNotesIoControls();
                return;
            }

            notesPanelsHost.innerHTML = "";
            for (const key of Object.keys(textboxContainers)) {
                delete textboxContainers[key];
            }
            for (const key of Object.keys(notesPanels)) {
                delete notesPanels[key];
            }

            slides.forEach((slide, index) => {
                const slideId = slide.id || `slide-${index + 1}`;
                slide.dataset.slideId = slideId;
                if (!Array.isArray(slideNotes[slideId])) {
                    slideNotes[slideId] = [];
                }

                const panel = document.createElement("section");
                panel.className = "notes-panel empty";
                panel.dataset.slideId = slideId;
                panel.setAttribute("aria-hidden", "true");
                panel.hidden = true;

                const heading = document.createElement("h3");
                heading.className = "notes-panel-title visually-hidden";
                const headingId = `notes-panel-title-${slideId}`;
                heading.id = headingId;
                heading.textContent = getSlideLabel(slide, index);
                panel.setAttribute("aria-labelledby", headingId);

                const toolbar = document.createElement("div");
                toolbar.className = "textbox-toolbar";

                const toolbarCaption = document.createElement("p");
                toolbarCaption.className = "toolbar-caption visually-hidden";
                toolbarCaption.textContent = "Add a new text box by choosing a colour.";

                const swatchGroup = document.createElement("div");
                swatchGroup.className = "textbox-swatch-group";

                textboxColorOptions.forEach((option) => {
                    const swatchButton = document.createElement("button");
                    swatchButton.type = "button";
                    swatchButton.className = "textbox-swatch";
                    swatchButton.style.setProperty("--swatch-color", option.value);
                    swatchButton.setAttribute("aria-label", `Add a ${option.label} text box`);
                    swatchButton.title = option.label;
                    swatchButton.addEventListener("click", () => {
                        const newNote = { id: generateNoteId(), color: option.value, content: "" };
                        slideNotes[slideId].push(newNote);
                        persistNotes();
                        renderSlideTextboxes(slideId);
                        const latestTextbox = textboxContainers[slideId]?.lastElementChild?.querySelector(".textbox-content");
                        if (latestTextbox) {
                            latestTextbox.focus();
                        }
                    });
                    swatchGroup.appendChild(swatchButton);
                });

                toolbar.appendChild(toolbarCaption);
                toolbar.appendChild(swatchGroup);

                const collection = document.createElement("div");
                collection.className = "textbox-collection";
                textboxContainers[slideId] = collection;

                panel.appendChild(heading);
                panel.appendChild(toolbar);
                panel.appendChild(collection);

                notesPanelsHost.appendChild(panel);
                notesPanels[slideId] = panel;

                renderSlideTextboxes(slideId);
            });

            setupNotesIoControls();
        }
        function createIconHeading(icon, text) {
            const heading = document.createElement("h1");
            heading.className = "slide-title";
            if (icon) {
                heading.innerHTML = `<i class="${icon}"></i> ${text}`;
            } else {
                heading.textContent = text;
            }
            return heading;
        }

        function createRubric(text) {
            const rubric = document.createElement("h2");
            rubric.className = "rubric";
            rubric.textContent = text;
            return rubric;
        }

        function createImageElement(image) {
            if (!image || !image.src) {
                return null;
            }
            const img = document.createElement("img");
            img.src = image.src;
            img.alt = image.alt || "";
            return img;
        }

        function createParagraph(text, className) {
            const paragraph = document.createElement("p");
            if (text && typeof text === "object" && text.html) {
                paragraph.innerHTML = text.html;
            } else {
                paragraph.textContent = text ?? "";
            }
            paragraph.classList.add("animate-on-scroll");
            if (className) {
                paragraph.classList.add(className);
            }
            return paragraph;
        }

        function applyLayoutOptions(target, layout) {
            if (!target || !layout) {
                return;
            }
            const alignment = layout.alignment || layout.align;
            if (alignment === "center") {
                target.classList.add("is-centered");
            }
            if (alignment === "end" || alignment === "right") {
                target.classList.add("is-right-aligned");
            }
            const rawClassNames = Array.isArray(layout.className)
                ? layout.className.flatMap((value) => (typeof value === "string" ? value.split(/\s+/) : []))
                : typeof layout.className === "string"
                ? layout.className.split(/\s+/)
                : [];
            rawClassNames.filter(Boolean).forEach((name) => {
                target.classList.add(name);
            });
            const themes = Array.isArray(layout.theme) ? layout.theme : layout.theme ? [layout.theme] : [];
            themes
                .map((theme) => (typeof theme === "string" ? theme.trim() : ""))
                .filter(Boolean)
                .forEach((theme) => {
                    target.classList.add(`theme--${theme}`);
                });
        }

        function createListElement(items = [], options = "bullets") {
            if (!Array.isArray(items) || !items.length) {
                return null;
            }
            const resolved = typeof options === "string" ? { style: options } : { ...(options || {}) };
            const style = resolved.style || "bullets";
            const typeHint = resolved.type || resolved.listType;
            const listType = typeHint === "ol" || typeHint === "ordered" || style === "ordered" ? "ol" : "ul";
            const list = document.createElement(listType);
            list.classList.add("slide-list");
            if (style === "smart") {
                list.classList.add("smart");
            }
            if (style === "plain") {
                list.classList.add("plain");
            }
            if (listType === "ol" || style === "ordered") {
                list.classList.add("ordered");
            }
            if (resolved.className) {
                list.classList.add(resolved.className);
            }
            items.forEach((item) => {
                const li = document.createElement("li");
                li.classList.add("animate-on-scroll");
                if (style === "smart" && item && typeof item === "object" && item.letter) {
                    li.dataset.letter = item.letter;
                }
                if (typeof item === "string") {
                    li.textContent = item;
                } else if (item && typeof item === "object") {
                    const fragments = [];
                    if (item.icon) {
                        fragments.push(`<i class="${item.icon}"></i>`);
                    }
                    if (item.strong) {
                        fragments.push(`<strong>${item.strong}</strong>`);
                    }
                    if (item.text) {
                        fragments.push(item.text);
                    }
                    li.innerHTML = fragments.join(" ");
                }
                list.appendChild(li);
            });
            return list;
        }

        function createChoiceGroup(options = [], idPrefix = "choice") {
            if (!Array.isArray(options) || !options.length) {
                return null;
            }
            const group = document.createElement("div");
            group.className = "mc-option-group animate-on-scroll";
            const name = `${idPrefix}-options`;
            options.forEach((option, index) => {
                const item = document.createElement("div");
                item.className = "mc-option-item";

                const label = document.createElement("label");
                label.className = "mc-option-label";

                const input = document.createElement("input");
                input.type = "radio";
                input.name = name;
                input.value = option.value || option.id || `option-${index + 1}`;
                input.className = "mc-option-input";

                const control = document.createElement("span");
                control.className = "option-control";

                const text = document.createElement("span");
                text.className = "mc-option-text";
                text.textContent = option.label || option.text || option;

                label.appendChild(input);
                label.appendChild(control);
                label.appendChild(text);

                item.appendChild(label);
                group.appendChild(item);
            });
            return group;
        }

        function createActivityBlock(activity, idPrefix = "activity") {
            if (!activity) {
                return null;
            }
            const block = document.createElement("section");
            block.className = "activity-block animate-on-scroll";

            if (activity.title) {
                const heading = document.createElement("h3");
                heading.className = "activity-block__title";
                heading.textContent = activity.title;
                block.appendChild(heading);
            }

            (activity.description || []).forEach((paragraph) => {
                const paragraphElement = createParagraph(paragraph, "activity-block__description");
                if (paragraphElement) {
                    block.appendChild(paragraphElement);
                }
            });

            if (Array.isArray(activity.steps) && activity.steps.length) {
                const list = createListElement(activity.steps, {
                    style: activity.stepsStyle || (activity.stepsType === "unordered" ? "plain" : "ordered"),
                    type: activity.stepsType === "unordered" ? "ul" : "ol",
                    className: "activity-block__list"
                });
                if (list) {
                    block.appendChild(list);
                }
            }

            if (Array.isArray(activity.inputs) && activity.inputs.length) {
                const inputsWrapper = document.createElement("div");
                inputsWrapper.className = "activity-block__inputs";
                activity.inputs.forEach((inputConfig, index) => {
                    const fieldId = `${idPrefix}-input-${index + 1}`;
                    if (inputConfig.label) {
                        const label = document.createElement("label");
                        label.setAttribute("for", fieldId);
                        label.textContent = inputConfig.label;
                        inputsWrapper.appendChild(label);
                    }
                    const input = document.createElement("input");
                    input.type = "text";
                    input.id = fieldId;
                    input.placeholder = inputConfig.placeholder || "";
                    inputsWrapper.appendChild(input);
                });
                block.appendChild(inputsWrapper);
            }

            if (Array.isArray(activity.options) && activity.options.length) {
                const choiceGroup = createChoiceGroup(activity.options, idPrefix);
                if (choiceGroup) {
                    block.appendChild(choiceGroup);
                }
            }

            return block;
        }

        function createActivityControls({ onCheck, onReset, checkLabel = "Check answers", resetLabel = "Reset" } = {}) {
            const wrapper = document.createElement("div");
            wrapper.className = "activity-controls animate-on-scroll";

            let checkButton = null;
            if (typeof onCheck === "function") {
                checkButton = document.createElement("button");
                checkButton.type = "button";
                checkButton.className = "activity-btn";
                checkButton.textContent = checkLabel;
                checkButton.addEventListener("click", onCheck);
                wrapper.appendChild(checkButton);
            }

            let resetButton = null;
            if (typeof onReset === "function") {
                resetButton = document.createElement("button");
                resetButton.type = "button";
                resetButton.className = "activity-btn secondary";
                resetButton.textContent = resetLabel;
                resetButton.addEventListener("click", onReset);
                wrapper.appendChild(resetButton);
            }

            return { wrapper, checkButton, resetButton };
        }

        function createActivityFeedback(initialSummary = "Check your work to see detailed feedback.") {
            const wrapper = document.createElement("div");
            wrapper.className = "activity-feedback animate-on-scroll";

            const summary = document.createElement("p");
            summary.className = "activity-feedback__summary";
            summary.textContent = initialSummary;

            const list = document.createElement("ul");
            list.className = "activity-feedback__list";

            wrapper.appendChild(summary);
            wrapper.appendChild(list);

            return { wrapper, summary, list };
        }

        function formatOrdinal(value) {
            const number = Number(value);
            if (!Number.isFinite(number)) {
                return String(value);
            }
            const absValue = Math.abs(number);
            const suffix = absValue % 100 >= 11 && absValue % 100 <= 13
                ? "th"
                : { 1: "st", 2: "nd", 3: "rd" }[absValue % 10] || "th";
            return `${number}${suffix}`;
        }

        function shuffleArray(sourceArray = []) {
            const array = Array.from(sourceArray);
            for (let i = array.length - 1; i > 0; i -= 1) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderHeroSlide(slideElement, config) {
            if (config.image) {
                const wrapper = document.createElement("div");
                wrapper.className = "animate-on-scroll";
                const img = createImageElement(config.image);
                if (img) {
                    wrapper.appendChild(img);
                    slideElement.appendChild(wrapper);
                }
            }
            if (config.title) {
                const wrapper = document.createElement("div");
                wrapper.className = "animate-on-scroll";
                wrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(wrapper);
            }
            if (config.subtitle) {
                const wrapper = document.createElement("div");
                wrapper.className = "animate-on-scroll";
                wrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(wrapper);
            }
        }

        function renderContentSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            applyLayoutOptions(content, config.layout);
            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }
            (config.body || []).forEach((paragraph) => {
                const paragraphElement = createParagraph(paragraph);
                if (paragraphElement) {
                    content.appendChild(paragraphElement);
                }
            });
            const list = createListElement(config.list, config.listOptions || config.listStyle);
            if (list) {
                content.appendChild(list);
            }
            const activityBlock = createActivityBlock(config.activity, slideElement.id || config.key || "activity");
            if (activityBlock) {
                content.appendChild(activityBlock);
            }
            slideElement.appendChild(content);
        }

        function renderGridSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            applyLayoutOptions(content, config.layout);
            (config.body || []).forEach((paragraph) => {
                const paragraphElement = createParagraph(paragraph);
                if (paragraphElement) {
                    content.appendChild(paragraphElement);
                }
            });
            if (Array.isArray(config.grid) && config.grid.length) {
                const grid = document.createElement("div");
                grid.className = "reference-grid";
                config.grid.forEach((column) => {
                    const card = document.createElement("section");
                    card.className = "reference-card animate-on-scroll";
                    if (column.title) {
                        const title = document.createElement("h4");
                        title.textContent = column.title;
                        card.appendChild(title);
                    }
                    const list = createListElement(column.items, column.listOptions || column.listStyle || "plain");
                    if (list) {
                        card.appendChild(list);
                    }
                    grid.appendChild(card);
                });
                content.appendChild(grid);
            }
            const activityBlock = createActivityBlock(config.activity, slideElement.id || config.key || "grid-activity");
            if (activityBlock) {
                content.appendChild(activityBlock);
            }
            slideElement.appendChild(content);
        }

        function renderGallerySlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            applyLayoutOptions(content, config.layout);
            (config.body || []).forEach((paragraph) => {
                const paragraphElement = createParagraph(paragraph);
                if (paragraphElement) {
                    content.appendChild(paragraphElement);
                }
            });
            const list = createListElement(config.list, config.listOptions || config.listStyle);
            if (list) {
                content.appendChild(list);
            }
            if (Array.isArray(config.items) && config.items.length) {
                const gallery = document.createElement("div");
                gallery.className = "gallery-grid";
                config.items.forEach((item, index) => {
                    const card = document.createElement("article");
                    card.className = "gallery-card animate-on-scroll";
                    if (item.image) {
                        const img = createImageElement(item.image);
                        if (img) {
                            card.appendChild(img);
                        }
                    }
                    const cardBody = document.createElement("div");
                    cardBody.className = "gallery-card__body";
                    if (item.title) {
                        const title = document.createElement("h4");
                        title.className = "gallery-card__title";
                        title.textContent = item.title;
                        cardBody.appendChild(title);
                    }
                    if (item.meta) {
                        const meta = document.createElement("p");
                        meta.className = "gallery-card__meta";
                        meta.textContent = item.meta;
                        cardBody.appendChild(meta);
                    }
                    if (item.description) {
                        const description = document.createElement("p");
                        description.textContent = item.description;
                        cardBody.appendChild(description);
                    }
                    card.appendChild(cardBody);
                    gallery.appendChild(card);
                });
                content.appendChild(gallery);
            }
            const activityBlock = createActivityBlock(config.activity, slideElement.id || config.key || "gallery-activity");
            if (activityBlock) {
                content.appendChild(activityBlock);
            }
            slideElement.appendChild(content);
        }

        function renderReportingSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content reporting-layout";
            applyLayoutOptions(content, config.layout);
            (config.body || []).forEach((paragraph) => {
                const paragraphElement = createParagraph(paragraph);
                if (paragraphElement) {
                    content.appendChild(paragraphElement);
                }
            });
            if (Array.isArray(config.sections) && config.sections.length) {
                const sectionsWrapper = document.createElement("div");
                sectionsWrapper.className = "reporting-sections";
                config.sections.forEach((section, sectionIndex) => {
                    const sectionElement = document.createElement("section");
                    sectionElement.className = "reporting-section animate-on-scroll";
                    if (section.title) {
                        const heading = document.createElement("h4");
                        heading.textContent = section.title;
                        sectionElement.appendChild(heading);
                    }
                    if (section.placeholder) {
                        const placeholder = document.createElement("div");
                        placeholder.className = "reporting-image-placeholder";
                        placeholder.textContent = section.placeholder;
                        sectionElement.appendChild(placeholder);
                    }
                    (section.fields || []).forEach((field, fieldIndex) => {
                        const fieldWrapper = document.createElement("div");
                        fieldWrapper.className = "reporting-field";
                        const fieldId = `${slideElement.id || config.key || "report"}-section-${sectionIndex + 1}-field-${fieldIndex + 1}`;
                        if (field.label) {
                            const label = document.createElement("label");
                            label.setAttribute("for", fieldId);
                            label.textContent = field.label;
                            fieldWrapper.appendChild(label);
                        }
                        let control;
                        if (!field.type || field.type === "textarea") {
                            control = document.createElement("textarea");
                        } else {
                            control = document.createElement("input");
                            control.type = field.type;
                        }
                        control.id = fieldId;
                        if (field.placeholder) {
                            control.placeholder = field.placeholder;
                        }
                        if (field.className) {
                            const classes = Array.isArray(field.className)
                                ? field.className
                                : String(field.className).split(/\s+/).filter(Boolean);
                            if (classes.length) {
                                control.classList.add(...classes);
                            }
                        }
                        fieldWrapper.appendChild(control);
                        sectionElement.appendChild(fieldWrapper);
                    });
                    sectionsWrapper.appendChild(sectionElement);
                });
                content.appendChild(sectionsWrapper);
            }
            if (config.statementField) {
                const statement = document.createElement("div");
                statement.className = "statement-section animate-on-scroll";
                const statementId = `${slideElement.id || config.key || "report"}-statement`;
                if (config.statementField.label) {
                    const label = document.createElement("label");
                    label.setAttribute("for", statementId);
                    label.textContent = config.statementField.label;
                    statement.appendChild(label);
                }
                const textarea = document.createElement("textarea");
                textarea.id = statementId;
                textarea.placeholder = config.statementField.placeholder || "";
                textarea.classList.add("statement");
                statement.appendChild(textarea);
                content.appendChild(statement);
            }
            slideElement.appendChild(content);
        }

        function renderGapfillSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }

            const content = document.createElement("div");
            content.className = "slide-content gapfill-activity";
            applyLayoutOptions(content, config.layout);

            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }

            if (config.instructions) {
                content.appendChild(createParagraph(config.instructions));
            }

            const paragraph = document.createElement("p");
            paragraph.className = "gapfill-paragraph animate-on-scroll";
            const segments = Array.isArray(config.paragraph) ? config.paragraph : [];
            const gaps = [];
            segments.forEach((segment, index) => {
                if (typeof segment === "string") {
                    paragraph.appendChild(document.createTextNode(segment));
                } else if (segment && segment.type === "text") {
                    paragraph.appendChild(document.createTextNode(segment.content || ""));
                } else if (segment && segment.type === "gap") {
                    const wrapper = document.createElement("span");
                    wrapper.className = "gapfill-gap";
                    const select = document.createElement("select");
                    const placeholder = document.createElement("option");
                    placeholder.value = "";
                    placeholder.textContent = segment.placeholder || "Select an option";
                    select.appendChild(placeholder);
                    (segment.options || []).forEach((option) => {
                        const optionElement = document.createElement("option");
                        if (typeof option === "string") {
                            optionElement.value = option;
                            optionElement.textContent = option;
                        } else if (option && typeof option === "object") {
                            optionElement.value = option.value;
                            optionElement.textContent = option.label || option.value;
                        }
                        select.appendChild(optionElement);
                    });
                    wrapper.appendChild(select);
                    paragraph.appendChild(wrapper);
                    gaps.push({
                        wrapper,
                        select,
                        data: {
                            id: segment.id || `${config.key || "gapfill"}-gap-${index + 1}`,
                            answer: segment.answer,
                            feedbackTitle: segment.feedbackTitle || segment.label,
                            explanation: segment.explanation
                        }
                    });
                }
            });
            content.appendChild(paragraph);

            const initialSummary = config.feedbackSummary || "Check your work to see detailed feedback.";
            const feedback = createActivityFeedback(initialSummary);

            const evaluate = () => {
                let attempted = 0;
                let correct = 0;
                feedback.list.innerHTML = "";
                gaps.forEach((gap) => {
                    const { wrapper, select, data } = gap;
                    wrapper.classList.remove("is-correct", "is-incorrect");
                    const value = select.value;
                    if (!value) {
                        return;
                    }
                    attempted += 1;
                    const isCorrect = value === data.answer;
                    if (isCorrect) {
                        correct += 1;
                    }
                    wrapper.classList.add(isCorrect ? "is-correct" : "is-incorrect");
                    const selectedLabel = select.options[select.selectedIndex]?.textContent || value;

                    const item = document.createElement("li");
                    item.className = `activity-feedback__item ${isCorrect ? "is-correct" : "is-incorrect"}`;

                    const title = document.createElement("p");
                    const strong = document.createElement("strong");
                    strong.textContent = data.feedbackTitle || `Blank ${data.id}`;
                    title.appendChild(strong);
                    item.appendChild(title);

                    const yourAnswer = document.createElement("p");
                    yourAnswer.innerHTML = `<strong>Your answer:</strong> ${selectedLabel}`;
                    item.appendChild(yourAnswer);

                    if (!isCorrect) {
                        const correctAnswer = document.createElement("p");
                        correctAnswer.innerHTML = `<strong>Correct answer:</strong> ${data.answer}`;
                        item.appendChild(correctAnswer);
                    }

                    if (data.explanation) {
                        const explanation = document.createElement("p");
                        explanation.textContent = data.explanation;
                        item.appendChild(explanation);
                    }

                    feedback.list.appendChild(item);
                });

                feedback.summary.textContent = attempted
                    ? `You answered ${correct} of ${attempted} correctly.`
                    : "Choose an answer for at least one blank to see feedback.";
            };

            const reset = () => {
                gaps.forEach((gap) => {
                    gap.wrapper.classList.remove("is-correct", "is-incorrect");
                    gap.select.value = "";
                });
                feedback.list.innerHTML = "";
                feedback.summary.textContent = initialSummary;
            };

            const controls = createActivityControls({
                onCheck: evaluate,
                onReset: reset,
                checkLabel: config.checkLabel || "Check answers",
                resetLabel: config.resetLabel || "Reset"
            });

            content.appendChild(controls.wrapper);
            content.appendChild(feedback.wrapper);

            slideElement.appendChild(content);
        }

        function renderRankingSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }

            const content = document.createElement("div");
            content.className = "slide-content ranking-activity";
            applyLayoutOptions(content, config.layout);

            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }

            if (config.instructions) {
                const intro = document.createElement("p");
                intro.className = "ranking-intro animate-on-scroll";
                intro.textContent = config.instructions;
                content.appendChild(intro);
            }

            const list = document.createElement("ol");
            list.className = "ranking-list";

            const items = Array.isArray(config.items) ? config.items : [];
            const itemMap = new Map();
            items.forEach((item) => {
                if (item && item.id) {
                    itemMap.set(item.id, item);
                }
            });
            const correctOrder = items
                .slice()
                .sort((a, b) => (a.correctRank ?? 0) - (b.correctRank ?? 0))
                .map((item) => item.id);
            const initialOrder = Array.isArray(config.initialOrder) && config.initialOrder.length === correctOrder.length
                ? config.initialOrder.filter((id) => itemMap.has(id))
                : shuffleArray(correctOrder);
            const resolvedOrder = initialOrder.length === correctOrder.length ? initialOrder : correctOrder;

            const createListItem = (item) => {
                const li = document.createElement("li");
                li.className = "ranking-item animate-on-scroll";
                li.dataset.itemId = item.id;

                const label = document.createElement("span");
                label.className = "ranking-label";
                label.textContent = item.label;
                li.appendChild(label);

                const controls = document.createElement("div");
                controls.className = "ranking-controls";

                const moveUp = document.createElement("button");
                moveUp.type = "button";
                moveUp.textContent = "Move up";
                moveUp.setAttribute("aria-label", `Move ${item.label} up`);
                moveUp.addEventListener("click", () => {
                    const previous = li.previousElementSibling;
                    if (previous) {
                        list.insertBefore(li, previous);
                    }
                });

                const moveDown = document.createElement("button");
                moveDown.type = "button";
                moveDown.textContent = "Move down";
                moveDown.setAttribute("aria-label", `Move ${item.label} down`);
                moveDown.addEventListener("click", () => {
                    const next = li.nextElementSibling?.nextElementSibling;
                    if (next) {
                        list.insertBefore(li, next);
                    } else {
                        list.appendChild(li);
                    }
                });

                controls.appendChild(moveUp);
                controls.appendChild(moveDown);
                li.appendChild(controls);
                return li;
            };

            resolvedOrder.forEach((id) => {
                const item = itemMap.get(id);
                if (item) {
                    list.appendChild(createListItem(item));
                }
            });

            const baselineOrder = Array.from(list.children).map((child) => child.dataset.itemId);
            content.appendChild(list);

            const initialSummary = config.feedbackSummary || "Check your work to see detailed feedback.";
            const feedback = createActivityFeedback(initialSummary);

            const evaluate = () => {
                const itemsInDom = Array.from(list.children);
                let correct = 0;
                feedback.list.innerHTML = "";
                itemsInDom.forEach((element, index) => {
                    const itemId = element.dataset.itemId;
                    const item = itemMap.get(itemId);
                    if (!item) {
                        return;
                    }
                    element.classList.remove("is-correct", "is-incorrect");
                    const expectedId = correctOrder[index];
                    const isCorrect = expectedId === itemId;
                    if (isCorrect) {
                        correct += 1;
                    }
                    element.classList.add(isCorrect ? "is-correct" : "is-incorrect");

                    const detail = document.createElement("li");
                    detail.className = `activity-feedback__item ${isCorrect ? "is-correct" : "is-incorrect"}`;

                    const heading = document.createElement("p");
                    const strong = document.createElement("strong");
                    strong.textContent = item.label;
                    heading.appendChild(strong);
                    detail.appendChild(heading);

                    const yourAnswer = document.createElement("p");
                    yourAnswer.innerHTML = `<strong>Your order:</strong> ${formatOrdinal(index + 1)}`;
                    detail.appendChild(yourAnswer);

                    if (!isCorrect) {
                        const correctAnswer = document.createElement("p");
                        const targetPosition = item.correctRank ?? (correctOrder.indexOf(itemId) + 1);
                        correctAnswer.innerHTML = `<strong>Correct order:</strong> ${formatOrdinal(targetPosition)}`;
                        detail.appendChild(correctAnswer);
                    }

                    if (item.explanation) {
                        const explanation = document.createElement("p");
                        explanation.textContent = item.explanation;
                        detail.appendChild(explanation);
                    }

                    feedback.list.appendChild(detail);
                });

                const attempted = itemsInDom.length;
                feedback.summary.textContent = attempted
                    ? `You placed ${correct} of ${attempted} stages correctly.`
                    : "Reorder the stages to check your understanding.";
            };

            const reset = () => {
                baselineOrder.forEach((itemId) => {
                    const element = Array.from(list.children).find((child) => child.dataset.itemId === itemId);
                    if (element) {
                        element.classList.remove("is-correct", "is-incorrect");
                        list.appendChild(element);
                    }
                });
                feedback.list.innerHTML = "";
                feedback.summary.textContent = initialSummary;
            };

            const controls = createActivityControls({
                onCheck: evaluate,
                onReset: reset,
                checkLabel: config.checkLabel || "Check order",
                resetLabel: config.resetLabel || "Reset order"
            });

            content.appendChild(controls.wrapper);
            content.appendChild(feedback.wrapper);

            slideElement.appendChild(content);
        }

        function renderGroupingSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }

            const content = document.createElement("div");
            content.className = "slide-content grouping-activity";
            applyLayoutOptions(content, config.layout);

            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }

            if (config.instructions) {
                content.appendChild(createParagraph(config.instructions));
            }

            const grid = document.createElement("div");
            grid.className = "grouping-grid";

            const categories = Array.isArray(config.categories) ? config.categories : [];
            const categoryMap = new Map();
            categories.forEach((category) => {
                if (category && category.id) {
                    categoryMap.set(category.id, category.label || category.id);
                }
            });

            const items = Array.isArray(config.items) ? config.items : [];
            const itemEntries = [];
            items.forEach((item, index) => {
                if (!item || !item.id) {
                    return;
                }
                const wrapper = document.createElement("div");
                wrapper.className = "grouping-item animate-on-scroll";

                const label = document.createElement("strong");
                label.textContent = item.label;
                wrapper.appendChild(label);

                const select = document.createElement("select");
                select.id = `${slideElement.id}-grouping-${index + 1}`;
                const placeholder = document.createElement("option");
                placeholder.value = "";
                placeholder.textContent = config.placeholder || "Choose a category";
                select.appendChild(placeholder);
                categories.forEach((category) => {
                    const option = document.createElement("option");
                    option.value = category.id;
                    option.textContent = category.label;
                    select.appendChild(option);
                });
                wrapper.appendChild(select);
                grid.appendChild(wrapper);
                itemEntries.push({ wrapper, select, item });
            });

            content.appendChild(grid);

            const initialSummary = config.feedbackSummary || "Check your work to see detailed feedback.";
            const feedback = createActivityFeedback(initialSummary);

            const evaluate = () => {
                let attempted = 0;
                let correct = 0;
                feedback.list.innerHTML = "";
                itemEntries.forEach(({ wrapper, select, item }) => {
                    wrapper.classList.remove("is-correct", "is-incorrect");
                    const value = select.value;
                    if (!value) {
                        return;
                    }
                    attempted += 1;
                    const isCorrect = value === item.category;
                    if (isCorrect) {
                        correct += 1;
                    }
                    wrapper.classList.add(isCorrect ? "is-correct" : "is-incorrect");

                    const detail = document.createElement("li");
                    detail.className = `activity-feedback__item ${isCorrect ? "is-correct" : "is-incorrect"}`;

                    const heading = document.createElement("p");
                    const strong = document.createElement("strong");
                    strong.textContent = item.label;
                    heading.appendChild(strong);
                    detail.appendChild(heading);

                    const yourAnswer = document.createElement("p");
                    yourAnswer.innerHTML = `<strong>Your category:</strong> ${categoryMap.get(value) || value}`;
                    detail.appendChild(yourAnswer);

                    if (!isCorrect) {
                        const correctAnswer = document.createElement("p");
                        correctAnswer.innerHTML = `<strong>Correct category:</strong> ${categoryMap.get(item.category) || item.category}`;
                        detail.appendChild(correctAnswer);
                    }

                    if (item.explanation) {
                        const explanation = document.createElement("p");
                        explanation.textContent = item.explanation;
                        detail.appendChild(explanation);
                    }

                    feedback.list.appendChild(detail);
                });

                feedback.summary.textContent = attempted
                    ? `You sorted ${correct} of ${attempted} items correctly.`
                    : "Choose a category for at least one item to see feedback.";
            };

            const reset = () => {
                itemEntries.forEach(({ wrapper, select }) => {
                    wrapper.classList.remove("is-correct", "is-incorrect");
                    select.value = "";
                });
                feedback.list.innerHTML = "";
                feedback.summary.textContent = initialSummary;
            };

            const controls = createActivityControls({
                onCheck: evaluate,
                onReset: reset,
                checkLabel: config.checkLabel || "Check categories",
                resetLabel: config.resetLabel || "Reset"
            });

            content.appendChild(controls.wrapper);
            content.appendChild(feedback.wrapper);

            slideElement.appendChild(content);
        }

        function renderMatchingSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }

            const content = document.createElement("div");
            content.className = "slide-content matching-activity";
            applyLayoutOptions(content, config.layout);

            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }

            if (config.instructions) {
                content.appendChild(createParagraph(config.instructions));
            }

            const tableWrapper = document.createElement("div");
            tableWrapper.className = "matching-table-wrapper";
            const table = document.createElement("table");
            table.className = "matching-table animate-on-scroll";

            const columns = Array.isArray(config.columns) ? config.columns : [];
            const rows = Array.isArray(config.rows) ? config.rows : [];
            const columnMap = new Map(columns.map((column) => [column.id, column.label]));

            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");
            const blankHeader = document.createElement("th");
            blankHeader.scope = "col";
            blankHeader.textContent = "";
            headerRow.appendChild(blankHeader);
            columns.forEach((column) => {
                const th = document.createElement("th");
                th.scope = "col";
                th.textContent = column.label;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");
            const rowEntries = [];
            rows.forEach((row, rowIndex) => {
                const tr = document.createElement("tr");
                tr.dataset.correctColumn = row.correctColumn;

                const th = document.createElement("th");
                th.scope = "row";
                th.textContent = row.label;
                tr.appendChild(th);

                columns.forEach((column) => {
                    const td = document.createElement("td");
                    const label = document.createElement("label");
                    label.className = "matching-radio";

                    const input = document.createElement("input");
                    input.type = "radio";
                    input.name = `${slideElement.id}-row-${rowIndex + 1}`;
                    input.value = column.id;

                    const indicator = document.createElement("span");
                    indicator.className = "matching-radio-indicator";

                    label.appendChild(input);
                    label.appendChild(indicator);
                    td.appendChild(label);
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
                rowEntries.push({ row, element: tr });
            });
            table.appendChild(tbody);
            tableWrapper.appendChild(table);
            content.appendChild(tableWrapper);

            const initialSummary = config.feedbackSummary || "Check your work to see detailed feedback.";
            const feedback = createActivityFeedback(initialSummary);

            const evaluate = () => {
                let attempted = 0;
                let correct = 0;
                feedback.list.innerHTML = "";
                rowEntries.forEach(({ row, element }) => {
                    element.classList.remove("is-correct", "is-incorrect");
                    const selected = element.querySelector("input[type=\"radio\"]:checked");
                    if (!selected) {
                        return;
                    }
                    attempted += 1;
                    const isCorrect = selected.value === row.correctColumn;
                    if (isCorrect) {
                        correct += 1;
                    }
                    element.classList.add(isCorrect ? "is-correct" : "is-incorrect");

                    const detail = document.createElement("li");
                    detail.className = `activity-feedback__item ${isCorrect ? "is-correct" : "is-incorrect"}`;

                    const heading = document.createElement("p");
                    const strong = document.createElement("strong");
                    strong.textContent = row.label;
                    heading.appendChild(strong);
                    detail.appendChild(heading);

                    const yourAnswer = document.createElement("p");
                    yourAnswer.innerHTML = `<strong>Your answer:</strong> ${columnMap.get(selected.value) || selected.value}`;
                    detail.appendChild(yourAnswer);

                    if (!isCorrect) {
                        const correctAnswer = document.createElement("p");
                        correctAnswer.innerHTML = `<strong>Correct answer:</strong> ${columnMap.get(row.correctColumn) || row.correctColumn}`;
                        detail.appendChild(correctAnswer);
                    }

                    if (row.explanation) {
                        const explanation = document.createElement("p");
                        explanation.textContent = row.explanation;
                        detail.appendChild(explanation);
                    }

                    feedback.list.appendChild(detail);
                });

                feedback.summary.textContent = attempted
                    ? `You answered ${correct} of ${attempted} correctly.`
                    : "Select an answer for at least one row to see feedback.";
            };

            const reset = () => {
                rowEntries.forEach(({ element }) => {
                    element.classList.remove("is-correct", "is-incorrect");
                    element.querySelectorAll("input[type=\"radio\"]").forEach((input) => {
                        input.checked = false;
                    });
                });
                feedback.list.innerHTML = "";
                feedback.summary.textContent = initialSummary;
            };

            const controls = createActivityControls({
                onCheck: evaluate,
                onReset: reset,
                checkLabel: config.checkLabel || "Check answers",
                resetLabel: config.resetLabel || "Reset"
            });

            content.appendChild(controls.wrapper);
            content.appendChild(feedback.wrapper);

            slideElement.appendChild(content);
        }

        function renderCardsSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content card-container";
            applyLayoutOptions(content, config.layout);
            (config.cards || []).forEach((cardConfig) => {
                const card = document.createElement("div");
                card.className = "card animate-on-scroll";
                if (cardConfig.icon) {
                    const icon = document.createElement("div");
                    icon.className = "icon";
                    icon.innerHTML = `<i class="${cardConfig.icon}"></i>`;
                    card.appendChild(icon);
                }
                if (cardConfig.title) {
                    const title = document.createElement("h3");
                    title.textContent = cardConfig.title;
                    card.appendChild(title);
                }
                if (cardConfig.description) {
                    const description = document.createElement("p");
                    description.textContent = cardConfig.description;
                    card.appendChild(description);
                }
                content.appendChild(card);
            });
            slideElement.appendChild(content);
        }

        function renderStorySlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.quote) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.quote));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            applyLayoutOptions(content, config.layout);
            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }
            if (config.process) {
                const paragraph = document.createElement("p");
                paragraph.className = "animate-on-scroll";
                const strong = document.createElement("strong");
                strong.textContent = config.process.label || "Process:";
                paragraph.appendChild(strong);
                paragraph.appendChild(document.createTextNode(` ${config.process.text || ""}`));
                content.appendChild(paragraph);
            }
            if (config.outcome) {
                const paragraph = document.createElement("p");
                paragraph.className = "animate-on-scroll";
                const strong = document.createElement("strong");
                strong.textContent = config.outcome.label || "Outcome:";
                paragraph.appendChild(strong);
                paragraph.appendChild(document.createTextNode(` ${config.outcome.text || ""}`));
                content.appendChild(paragraph);
            }
            slideElement.appendChild(content);
        }

        function renderProcessSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            applyLayoutOptions(content, config.layout);
            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }
            (config.body || []).forEach((paragraph) => {
                content.appendChild(createParagraph(paragraph));
            });
            const flow = document.createElement("div");
            flow.className = "process-flow";
            (config.steps || []).forEach((step, index) => {
                const stepElement = document.createElement("div");
                stepElement.className = "process-step animate-on-scroll";

                const number = document.createElement("div");
                number.className = "process-step-number";
                number.textContent = step.number ? String(step.number) : String(index + 1);
                stepElement.appendChild(number);

                const stepContent = document.createElement("div");
                stepContent.className = "process-step-content";
                if (step.title) {
                    const strong = document.createElement("strong");
                    strong.textContent = step.title;
                    stepContent.appendChild(strong);
                }
                if (step.description) {
                    const paragraph = document.createElement("p");
                    paragraph.textContent = step.description;
                    stepContent.appendChild(paragraph);
                }
                stepElement.appendChild(stepContent);
                flow.appendChild(stepElement);
            });
            content.appendChild(flow);
            slideElement.appendChild(content);
        }

        function renderQuizSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            applyLayoutOptions(content, config.layout);
            (config.questions || []).forEach((question) => {
                const card = document.createElement("div");
                card.className = "quiz-card animate-on-scroll";

                const prompt = document.createElement("p");
                prompt.className = "quiz-question-text";
                prompt.textContent = question.prompt;
                card.appendChild(prompt);

                const optionsContainer = document.createElement("div");
                optionsContainer.className = "quiz-options";
                const groupName = question.id;
                const feedbackId = question.feedbackId || `${groupName}-feedback`;

                (question.options || []).forEach((option, index) => {
                    const label = document.createElement("label");
                    label.className = "quiz-option";

                    const input = document.createElement("input");
                    input.type = "radio";
                    input.name = groupName;
                    input.value = option.value;
                    input.id = `${groupName}-option-${index}`;

                    const span = document.createElement("span");
                    span.textContent = option.label;

                    label.appendChild(input);
                    label.appendChild(span);
                    optionsContainer.appendChild(label);
                });

                card.appendChild(optionsContainer);

                const button = document.createElement("button");
                button.type = "button";
                button.className = "activity-btn quiz-btn";
                button.textContent = "Check Answer";
                button.addEventListener("click", () => {
                    checkSingleChoice(groupName, feedbackId, question.answer, question.correctFeedback, question.incorrectFeedback);
                });
                card.appendChild(button);

                const feedback = document.createElement("p");
                feedback.className = "quiz-feedback";
                feedback.id = feedbackId;
                card.appendChild(feedback);

                content.appendChild(card);
            });
            slideElement.appendChild(content);
        }

        function renderReflectionSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content reflection-form";
            applyLayoutOptions(content, config.layout);
            (config.fields || []).forEach((field, index) => {
                const wrapper = document.createElement("div");
                wrapper.className = "reflection-field animate-on-scroll";

                const label = document.createElement("label");
                const fieldId = field.id || `reflection-field-${index}`;
                label.setAttribute("for", fieldId);
                label.textContent = field.label || "Reflection";

                const textarea = document.createElement("textarea");
                textarea.id = fieldId;
                textarea.placeholder = field.placeholder || "";

                wrapper.appendChild(label);
                wrapper.appendChild(textarea);
                content.appendChild(wrapper);
            });
            slideElement.appendChild(content);
        }
        function createNavigationControls(index, total, config) {
            const navConfig = config?.nav || {};
            const controls = document.createElement("div");
            controls.className = "controls animate-on-scroll";
            let buttonsAdded = 0;

            const showPrev = !navConfig.hidePrev && index > 0;
            if (showPrev) {
                const prevButton = document.createElement("button");
                prevButton.type = "button";
                prevButton.className = "activity-btn secondary";
                const prevLabel = navConfig.prevLabel || "Back";
                const prevIcon = navConfig.prevIcon || "fas fa-arrow-left";
                prevButton.innerHTML = `<i class="${prevIcon}"></i> ${prevLabel}`;
                prevButton.addEventListener("click", () => {
                    prevSlide();
                });
                controls.appendChild(prevButton);
                buttonsAdded += 1;
            }

            const isLastSlide = index === total - 1;
            const hideNext = navConfig.hideNext || false;
            if (!hideNext) {
                const nextButton = document.createElement("button");
                nextButton.type = "button";
                const nextVariant = navConfig.nextVariant === "secondary" ? "secondary" : "";
                nextButton.className = `activity-btn ${nextVariant}`.trim();
                const nextAction = navConfig.nextAction || (isLastSlide ? "restart" : "next");
                const nextLabel = navConfig.nextLabel || (isLastSlide ? "Finish & Restart" : "Next");
                const nextIcon = navConfig.nextIcon || (isLastSlide ? "fas fa-check" : "fas fa-arrow-right");
                nextButton.innerHTML = nextVariant === "secondary"
                    ? `${nextLabel}`
                    : `${nextLabel} <i class="${nextIcon}"></i>`;
                nextButton.addEventListener("click", () => {
                    if (nextAction === "restart") {
                        showSlide(0);
                    } else {
                        nextSlide();
                    }
                });
                controls.appendChild(nextButton);
                buttonsAdded += 1;
            }

            if (!buttonsAdded) {
                return null;
            }
            return controls;
        }

        function buildSlideElement(config, index, total) {
            const slideElement = document.createElement("div");
            slideElement.className = "screen";
            slideElement.id = `slide-${index + 1}`;
            slideElement.dataset.slideKey = config.key || slideElement.id;

            switch (config.type) {
                case "hero":
                    renderHeroSlide(slideElement, config);
                    break;
                case "gapfill":
                    renderGapfillSlide(slideElement, config);
                    break;
                case "ranking":
                    renderRankingSlide(slideElement, config);
                    break;
                case "grouping":
                    renderGroupingSlide(slideElement, config);
                    break;
                case "matching":
                    renderMatchingSlide(slideElement, config);
                    break;
                case "grid":
                    renderGridSlide(slideElement, config);
                    break;
                case "gallery":
                    renderGallerySlide(slideElement, config);
                    break;
                case "reporting":
                    renderReportingSlide(slideElement, config);
                    break;
                case "cards":
                    renderCardsSlide(slideElement, config);
                    break;
                case "story":
                    renderStorySlide(slideElement, config);
                    break;
                case "process":
                    renderProcessSlide(slideElement, config);
                    break;
                case "quiz":
                    renderQuizSlide(slideElement, config);
                    break;
                case "reflection":
                    renderReflectionSlide(slideElement, config);
                    break;
                case "content":
                default:
                    renderContentSlide(slideElement, config);
                    break;
            }

            const controls = createNavigationControls(index, total, config);
            if (controls) {
                slideElement.appendChild(controls);
            }
            return slideElement;
        }

        function renderSlidesFromLesson(lesson) {
            if (!slidesRoot) {
                return;
            }
            slidesRoot.innerHTML = "";
            const slideConfigs = Array.isArray(lesson?.slides) ? lesson.slides : [];
            slideConfigs.forEach((config, index) => {
                const slideElement = buildSlideElement(config, index, slideConfigs.length);
                slidesRoot.appendChild(slideElement);
            });
            slides = Array.from(slidesRoot.querySelectorAll(".screen"));
        }

        function renderLessonOverview(lesson) {
            if (!lessonOverview) {
                return;
            }
            const planner = lesson?.meta?.planner;
            lessonOverview.innerHTML = "";
            if (!planner) {
                lessonOverview.hidden = true;
                lessonOverview.setAttribute("aria-hidden", "true");
                return;
            }

            const details = document.createElement("details");
            details.className = "lesson-overview__collapsible";
            details.setAttribute("data-collapsible", "planner");

            const summary = document.createElement("summary");
            summary.className = "lesson-overview__summary";

            const header = document.createElement("div");
            header.className = "lesson-overview__header";

            const title = document.createElement("h2");
            title.className = "lesson-overview__title";
            title.textContent = planner.title || "Lesson overview";
            header.appendChild(title);

            if (planner.duration || planner.subtitle) {
                const meta = document.createElement("div");
                meta.className = "lesson-overview__meta";
                if (planner.duration) {
                    const badge = document.createElement("span");
                    badge.className = "lesson-overview__badge";
                    badge.innerHTML = `<i class="fas fa-clock" aria-hidden="true"></i> ${planner.duration}`;
                    meta.appendChild(badge);
                }
                if (planner.subtitle) {
                    const hint = document.createElement("span");
                    hint.className = "lesson-overview__summary-hint";
                    hint.textContent = planner.subtitle;
                    meta.appendChild(hint);
                }
                if (meta.childNodes.length) {
                    header.appendChild(meta);
                }
            }

            summary.appendChild(header);
            details.appendChild(summary);

            const panel = document.createElement("div");
            panel.className = "lesson-overview__panel";

            if (planner.subtitle) {
                const subtitleParagraph = document.createElement("p");
                subtitleParagraph.className = "lesson-overview__subtitle";
                subtitleParagraph.textContent = planner.subtitle;
                panel.appendChild(subtitleParagraph);
            }

            const body = document.createElement("div");
            body.className = "lesson-overview__body";

            if (Array.isArray(planner.pacing) && planner.pacing.length) {
                const pacingWrapper = document.createElement("section");
                pacingWrapper.className = "lesson-overview__section";
                const pacingTitle = document.createElement("h3");
                pacingTitle.className = "lesson-overview__section-title";
                pacingTitle.textContent = planner.pacingTitle || "Suggested pacing";
                pacingWrapper.appendChild(pacingTitle);

                const pacingList = document.createElement("ul");
                pacingList.className = "lesson-overview__pacing";
                planner.pacing.forEach((segment) => {
                    if (!segment) {
                        return;
                    }
                    const item = document.createElement("li");
                    item.className = "lesson-overview__pacing-item";

                    const label = document.createElement("span");
                    label.className = "lesson-overview__pacing-label";
                    label.textContent = segment.label || segment.title || "Segment";
                    item.appendChild(label);

                    if (segment.duration) {
                        const duration = document.createElement("span");
                        duration.className = "lesson-overview__pacing-duration";
                        duration.textContent = segment.duration;
                        item.appendChild(duration);
                    }

                    pacingList.appendChild(item);
                });
                pacingWrapper.appendChild(pacingList);
                body.appendChild(pacingWrapper);
            }

            if (Array.isArray(planner.sections)) {
                planner.sections.forEach((section) => {
                    if (!section) {
                        return;
                    }
                    const sectionElement = document.createElement("section");
                    sectionElement.className = "lesson-overview__section";

                    const sectionTitle = document.createElement("h3");
                    sectionTitle.className = "lesson-overview__section-title";
                    sectionTitle.textContent = section.title || "Key points";
                    sectionElement.appendChild(sectionTitle);

                    const items = Array.isArray(section.items) ? section.items : [];
                    if (items.length) {
                        const list = document.createElement("ul");
                        list.className = "lesson-overview__list";
                        items.forEach((itemText) => {
                            const listItem = document.createElement("li");
                            listItem.textContent = itemText;
                            list.appendChild(listItem);
                        });
                        sectionElement.appendChild(list);
                    } else if (section.description) {
                        const paragraph = document.createElement("p");
                        paragraph.textContent = section.description;
                        sectionElement.appendChild(paragraph);
                    }

                    body.appendChild(sectionElement);
                });
            }

            if (planner.spotlight) {
                const callout = document.createElement("p");
                callout.className = "lesson-overview__callout";
                const calloutLabel = document.createElement("strong");
                calloutLabel.textContent = "Facilitation spotlight:";
                callout.appendChild(calloutLabel);
                callout.appendChild(document.createTextNode(` ${planner.spotlight}`));
                panel.appendChild(callout);
            }

            if (body.childNodes.length) {
                panel.appendChild(body);
            }

            if (panel.childNodes.length) {
                details.appendChild(panel);
            }

            details.open = false;
            lessonOverview.appendChild(details);
            lessonOverview.hidden = false;
            lessonOverview.setAttribute("aria-hidden", "false");
        }

        function renderLesson(lessonKey) {
            const availableLessons = Object.keys(lessonLibrary || {});
            if (!availableLessons.length) {
                console.warn("No lessons available to render.");
                return;
            }
            const resolvedKey = lessonLibrary[lessonKey] ? lessonKey : availableLessons[0];
            const lesson = lessonLibrary[resolvedKey];
            if (!lesson) {
                return;
            }
            activeLessonKey = resolvedKey;
            activeLesson = lesson;

            if (presentationEyebrow) {
                presentationEyebrow.textContent = lesson.meta?.eyebrow || lesson.label || "Instructional Session";
            }
            if (workspaceSummaryTitle) {
                workspaceSummaryTitle.textContent = lesson.label || "Lesson template";
            }
            setPresentationDescriptor(lesson.meta?.descriptor || "Choose a template to populate the slides.");
            renderLessonOverview(lesson);
            if (typeof document !== "undefined") {
                const fallbackTitle = `${lesson.label || "Lesson"} – Instructional Slides`;
                document.title = lesson.meta?.pageTitle || fallbackTitle;
            }

            hideHighlightToolbar();
            hideAnnotationPopover();
            closeAnnotationComposer();

            renderSlidesFromLesson(lesson);
            currentSlideIndex = 0;
            slideNotes = loadStoredNotes();
            initializeTextboxes();
            renderAllSlides();
            buildSlideMap();
            showSlide(0);

            if (lessonSelector && lessonSelector.value !== resolvedKey) {
                lessonSelector.value = resolvedKey;
            }
        }

        function populateLessonSelector() {
            if (!lessonSelector) {
                return;
            }
            if (!lessonSelector.dataset.initialized) {
                lessonSelector.addEventListener("change", (event) => {
                    renderLesson(event.target.value);
                });
                lessonSelector.dataset.initialized = "true";
            }
            const entries = Object.entries(lessonLibrary || {});
            const previousValue = lessonSelector.value;
            lessonSelector.innerHTML = "";
            if (!entries.length) {
                return;
            }
            entries.forEach(([key, lesson]) => {
                const option = document.createElement("option");
                option.value = key;
                option.textContent = lesson.label || key;
                lessonSelector.appendChild(option);
            });
            const hasPrevious = entries.some(([key]) => key === previousValue);
            const defaultValue = hasPrevious ? previousValue : entries[0][0];
            lessonSelector.value = defaultValue;
        }

        function attachKeyboardNavigation() {
            if (keyboardHandlerAttached) {
                return;
            }
            try {
                document.addEventListener("keydown", handleKeyboardNavigation, { passive: false });
            } catch (error) {
                document.addEventListener("keydown", handleKeyboardNavigation);
            }
            keyboardHandlerAttached = true;
        }

        function showSlide(index) {
            if (!Number.isInteger(index) || index < 0 || index >= slides.length) {
                return;
            }
            slides.forEach((slide, i) => {
                slide.classList.toggle("active", i === index);
            });
            currentSlideIndex = index;
            hideHighlightToolbar();
            hideAnnotationPopover();
            const activeSlide = slides[index];
            if (activeSlide) {
                animateSlideContents(activeSlide);
                activateNotesPanel(activeSlide.dataset.slideId);
            }
            updateSlideMapIndicator(index);
        }

        function nextSlide() {
            if (currentSlideIndex < slides.length - 1) {
                showSlide(currentSlideIndex + 1);
            }
        }

        function prevSlide() {
            if (currentSlideIndex > 0) {
                showSlide(currentSlideIndex - 1);
            }
        }

        function updateQuizFeedback(feedbackId, message, status) {
            const feedback = document.getElementById(feedbackId);
            if (!feedback) {
                return;
            }
            feedback.textContent = message;
            feedback.classList.remove("correct", "incorrect", "notice");
            feedback.classList.add(status);
        }

        function checkSingleChoice(groupName, feedbackId, correctValue, successMessage, errorMessage) {
            const selected = document.querySelector(`input[name="${groupName}"]:checked`);
            if (!selected) {
                updateQuizFeedback(feedbackId, "Please choose an option before checking your answer.", "notice");
                return;
            }
            if (selected.value === correctValue) {
                updateQuizFeedback(feedbackId, successMessage, "correct");
            } else {
                updateQuizFeedback(feedbackId, errorMessage, "incorrect");
            }
        }

        async function initializePresenter() {
            if (lessonSelector) {
                lessonSelector.disabled = true;
            }
            setPresentationDescriptor("Loading lesson templates…");
            displayStatusMessage("Loading lesson templates…");

            try {
                lessonLibrary = await fetchLessonLibraryData();
                populateLessonSelector();
                if (lessonSelector) {
                    lessonSelector.disabled = false;
                }
                const defaultLessonKey = lessonSelector?.value || Object.keys(lessonLibrary)[0];
                if (defaultLessonKey) {
                    renderLesson(defaultLessonKey);
                    attachKeyboardNavigation();
                } else {
                    setPresentationDescriptor("No lesson templates are available yet.");
                    displayStatusMessage("No lesson templates are available yet.");
                }
            } catch (error) {
                console.error("Unable to load the lesson library.", error);
                lessonLibrary = {};
                setPresentationDescriptor("Unable to load lesson templates right now.");
                displayStatusMessage("Unable to load lesson templates. Please refresh or try again later.");
                if (lessonSelector) {
                    lessonSelector.innerHTML = "";
                    const option = document.createElement("option");
                    option.value = "";
                    option.textContent = "Unavailable";
                    lessonSelector.appendChild(option);
                    lessonSelector.disabled = true;
                }
                if (workspaceSummaryTitle) {
                    workspaceSummaryTitle.textContent = "Lesson templates";
                }
            } finally {
                const notesPanel = document.getElementById("notes-io-controls");
                if (notesPanel) {
                    notesPanel.classList.add("animate__animated", "animate__fadeInDown");
                    notesPanel.style.opacity = "1";
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            initializePresenter();
        });
    </script>

</body>
</html>
