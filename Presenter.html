
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Eco-Activist's Toolkit</title>
    <!-- External Dependencies: Font Awesome Kit for icons and Google Fonts for typography -->
    <script src="https://kit.fontawesome.com/58a810656e.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Questrial&display=swap" rel="stylesheet">
    
    <style>
   /* =====================================================================
           Organic Sage UI â€” Mobile-first, stable, and soothing
           Palette preserved; accessibility + mobile ergonomics improved.
           (Strictly adhering to provided CSS)
           ===================================================================== */

      /* ------------------------------- Design tokens ----------------------------------*/
      :root {
        --primary-sage: #7a8471;
        --secondary-sage: #9caf88;
        --tertiary-sage: #b8c5a6;
        --warm-cream: #f8f6f0;
        --soft-white: #fefcf7;
        --forest-shadow: #5a6b52;
        --border-sage: rgba(122, 132, 113, 0.2);
        --hover-sage: rgba(156, 175, 136, 0.15);

        --deep-forest: #3e4a3a;
        --moss: #6e7a67;
        --fern: #8fa081;
        --dried-clay: #d9cdb4;
        --amber: #c6aa77;
        --ink: #2f3a2b;
        --ink-muted: #5a6b52;

        --font-display:
          "Questrial", system-ui, -apple-system, Segoe UI, Roboto,
          "Helvetica Neue", Arial, sans-serif;
        --font-body:
          "Nunito", system-ui, -apple-system, Segoe UI, Roboto,
          "Helvetica Neue", Arial, sans-serif;

        --step--2: clamp(0.75rem, 0.7rem + 0.12vw, 0.84rem);
        --step--1: clamp(0.875rem, 0.84rem + 0.15vw, 0.95rem);
        --step-0: clamp(1rem, 0.96rem + 0.22vw, 1.1rem);
        --step-1: clamp(1.125rem, 1.07rem + 0.35vw, 1.3rem);
        --step-2: clamp(1.375rem, 1.28rem + 0.55vw, 1.6rem);
        --step-3: clamp(1.75rem, 1.58rem + 0.95vw, 2.1rem);
        --step-4: clamp(2.25rem, 1.98rem + 1.35vw, 2.7rem);
        --step-5: clamp(2.85rem, 2.4rem + 1.9vw, 3.6rem);

        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.25rem;
        --space-6: 1.5rem;
        --space-7: 2rem;
        --space-8: 2.5rem;
        --space-9: 3rem;

        --radius-sm: 10px;
        --radius: 16px;
        --radius-lg: 20px;
        --radius-xl: 28px;

        --shadow-1:
          0 1px 2px rgba(34, 41, 32, 0.05), 0 2px 8px rgba(34, 41, 32, 0.06);
        --shadow-2:
          0 4px 18px rgba(34, 41, 32, 0.08), 0 12px 28px rgba(34, 41, 32, 0.06);
        --shadow-3:
          0 10px 40px rgba(34, 41, 32, 0.1), 0 20px 60px rgba(34, 41, 32, 0.08);

        --ring:
          0 0 0 3px color-mix(in oklab, var(--soft-white) 60%, transparent),
          0 0 0 5px color-mix(in srgb, var(--secondary-sage), #2f3a2b 15%);

        --ease-ambient: cubic-bezier(0.2, 0.8, 0.2, 1);
        --dur-1: 120ms;
        --dur-2: 200ms;
        --dur-3: 320ms;

        --target-min: 44px;
        --container-max: clamp(720px, 64vw, 1080px);
        --workspace-max: 1500px;
      }

      /* ------------------------------- Global reset / mobile stability ----------------------------------*/
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      html {
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
        hanging-punctuation: first last;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        min-height: 100dvh;
        font-family: var(--font-body);
        font-size: var(--step-0);
        line-height: 1.6;
        color: var(--forest-shadow);
        background:
          radial-gradient(
            1200px 1200px at -10% -10%,
            #ffffff 0%,
            transparent 50%
          ),
          radial-gradient(
            1200px 1000px at 110% 10%,
            #fff8f0 0%,
            transparent 50%
          ),
          linear-gradient(135deg, #f8f6f0 0%, #f5f3ed 100%);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
        overflow-x: hidden;
      }
      @media (prefers-reduced-motion: no-preference) {
        html {
          scroll-behavior: smooth;
        }
      }
      :where(p, h1, h2, h3, h4, h5, h6) {
        text-wrap: pretty;
        overflow-wrap: anywhere;
      }
      img,
      svg,
      video,
      canvas,
      audio,
      iframe {
        display: block;
        max-width: 100%;
        height: auto;
      }
      a {
        color: var(--primary-sage);
        text-decoration-thickness: 1px;
        text-underline-offset: 2px;
      }
      a:hover {
        color: var(--deep-forest);
      }
      .visually-hidden {
        position: absolute !important;
        height: 1px;
        width: 1px;
        overflow: hidden;
        clip: rect(1px, 1px, 1px, 1px);
        white-space: nowrap;
      }

      /* ------------------------------- App shell ----------------------------------*/
      #app-wrapper {
        display: flex;
        justify-content: center;
        align-items: stretch;
        padding: max(var(--space-7), env(safe-area-inset-top)) var(--space-4)
          var(--space-7);
        width: 100%;
        min-height: 100dvh;
        background:
          radial-gradient(
            800px 600px at 20% 0%,
            rgba(156, 175, 136, 0.08) 0%,
            transparent 70%
          ),
          radial-gradient(
            700px 500px at 80% 100%,
            rgba(90, 107, 82, 0.06) 0%,
            transparent 65%
          );
      }
      .skip-link {
        position: absolute;
        top: var(--space-3);
        left: 50%;
        transform: translate(-50%, -150%);
        background: var(--forest-shadow);
        color: #fff;
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-sm);
        font-weight: 700;
        z-index: 1000;
        transition: transform var(--dur-1) var(--ease-ambient);
      }
      .skip-link:focus {
        transform: translate(-50%, 0);
      }
      #activity-shell {
        width: min(100%, var(--workspace-max));
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-6);
        align-items: stretch;
      }
      #activity-container {
        width: min(100%, clamp(960px, 96vw, var(--workspace-max)));
        background: color-mix(in srgb, var(--soft-white) 88%, white 12%);
        padding: clamp(20px, 2.5vw, 40px);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.12);
        box-shadow: var(--shadow-2);
        position: relative;
        isolation: isolate;
        container-type: inline-size;
        display: flex;
        flex-direction: column;
        min-height: 0;
        height: auto;
        min-width: 0;
      }
      .session-hero {
        position: relative;
        overflow: hidden;
        display: grid;
        gap: clamp(20px, 3vw, 40px);
        grid-template-columns: minmax(0, 1fr);
        align-items: center;
        margin-top: clamp(8px, 1.5vw, 16px);
        padding: clamp(28px, 4vw, 48px);
        border-radius: var(--radius-xl);
        background:
          linear-gradient(
            140deg,
            rgba(255, 246, 233, 0.88),
            rgba(156, 175, 136, 0.25)
          ),
          radial-gradient(
            320px 220px at 10% 15%,
            rgba(198, 170, 119, 0.35),
            transparent 70%
          ),
          linear-gradient(160deg, rgba(122, 132, 113, 0.12), transparent 60%);
        box-shadow: var(--shadow-3);
        color: var(--deep-forest);
        isolation: isolate;
      }
      .session-hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          420px 280px at 85% 15%,
          rgba(255, 255, 255, 0.5),
          transparent 72%
        );
        opacity: 0.7;
        pointer-events: none;
      }
      .session-hero__content {
        position: relative;
        z-index: 1;
        display: grid;
        gap: clamp(12px, 2vw, 20px);
        max-width: clamp(320px, 55%, 520px);
      }
      .session-hero__eyebrow {
        margin: 0;
        font-size: var(--step--1);
        letter-spacing: 0.24em;
        text-transform: uppercase;
        font-weight: 800;
        color: color-mix(in srgb, var(--deep-forest) 80%, white 20%);
      }
      .session-hero__title {
        margin: 0;
        font-family: var(--font-display);
        font-size: clamp(2.2rem, 2.6vw, 3rem);
        line-height: 1.15;
        color: var(--deep-forest);
        text-wrap: balance;
      }
      .session-hero__descriptor {
        margin: 0;
        font-size: var(--step-1);
        color: color-mix(
          in srgb,
          var(--deep-forest) 72%,
          rgba(255, 255, 255, 0.2) 28%
        );
        max-width: 52ch;
      }
      .session-hero__meta {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: var(--space-2);
      }
      .session-hero__meta[hidden] {
        display: none;
      }
      .session-hero__badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(47, 58, 43, 0.16);
        font-weight: 700;
        font-size: var(--step--1);
        letter-spacing: 0.02em;
      }
      .session-hero__badge i {
        font-size: 0.85em;
      }
      .session-hero__subtitle {
        font-size: var(--step--1);
        color: color-mix(
          in srgb,
          var(--deep-forest) 70%,
          rgba(255, 255, 255, 0.25) 30%
        );
        padding: 6px 0;
      }
      .session-hero__subtitle[hidden] {
        display: none;
      }
      .session-hero__media {
        position: relative;
        z-index: 1;
        margin: 0;
        justify-self: center;
        max-width: min(380px, 60vw);
        border-radius: clamp(18px, 3vw, 32px);
        overflow: hidden;
        box-shadow: 0 24px 50px rgba(62, 74, 58, 0.28);
      }
      .session-hero__media img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .session-hero__media img[hidden] {
        display: none;
      }
      .session-hero--no-image .session-hero__media {
        display: none;
      }
      @media (min-width: 1024px) {
        .session-hero {
          grid-template-columns: 1fr minmax(240px, 360px);
        }
        .session-hero__content {
          max-width: 520px;
        }
      }
      @supports (backdrop-filter: blur(6px)) {
        #activity-container {
          background: color-mix(in srgb, var(--soft-white) 76%, white 24%);
          backdrop-filter: blur(6px) saturate(1.02);
        }
      }
      #slide-stage {
        flex: 1 1 auto;
        width: 100%;
        min-width: 0;
        min-height: 0;
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: clamp(16px, 2.5vw, 32px);
        margin-top: clamp(16px, 2vw, 28px);
      }
      #slide-stage-shell {
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
        width: 100%;
        min-height: 0;
      }
      #slides-root {
        position: relative;
        width: 100%;
        max-width: 100%;
        flex: 1 1 auto;
        min-height: 0;
        background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2);
        padding: clamp(24px, 3vw, 44px);
        overflow: visible;
      }
      #slides-root::-webkit-scrollbar {
        width: 10px;
      }
      #slides-root::-webkit-scrollbar-track {
        background: rgba(122, 132, 113, 0.1);
        border-radius: 999px;
      }
      #slides-root::-webkit-scrollbar-thumb {
        background: color-mix(
          in srgb,
          var(--tertiary-sage) 70%,
          var(--secondary-sage) 30%
        );
        border-radius: 999px;
      }
      .slide-status-bar {
        display: grid;
        gap: var(--space-3);
        padding: clamp(16px, 2.2vw, 24px);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.18);
        background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
        box-shadow: var(--shadow-1);
        margin-top: var(--space-6);
      }
      .slide-status-bar__row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-3);
      }
      .slide-status-bar__count {
        margin: 0;
        font-weight: 700;
        font-size: var(--step-1);
        color: var(--forest-shadow);
      }
      .slide-status-bar__actions {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        flex-wrap: wrap;
      }
      .slide-status-bar__actions button {
        white-space: nowrap;
      }
      .slide-status-bar__actions .activity-btn {
        padding: 10px 16px;
        font-size: var(--step--1);
        font-weight: 700;
        min-height: 40px;
      }
      .slide-status-bar__progress {
        display: grid;
        gap: var(--space-3);
      }
      .slide-status-bar__progress-track {
        position: relative;
        width: 100%;
        height: 12px;
        background: rgba(122, 132, 113, 0.18);
        border-radius: 999px;
        overflow: hidden;
      }
      .slide-status-bar__progress-fill {
        position: absolute;
        inset: 0;
        width: var(--progress, 0%);
        background: linear-gradient(
          90deg,
          rgba(156, 175, 136, 0.85),
          rgba(122, 132, 113, 0.95)
        );
        border-radius: inherit;
        transition: width var(--dur-3) var(--ease-ambient);
      }
      .slide-status-bar__progress-label {
        margin: 0;
        font-size: var(--step--1);
        color: var(--ink-muted);
        display: flex;
        justify-content: space-between;
      }
      #focus-mode-toggle[aria-pressed="false"] .focus-on-icon {
        display: inline-flex;
      }
      #focus-mode-toggle[aria-pressed="false"] .focus-off-icon {
        display: none;
      }
      #focus-mode-toggle[aria-pressed="true"] .focus-on-icon {
        display: none;
      }
      #focus-mode-toggle[aria-pressed="true"] .focus-off-icon {
        display: inline-flex;
      }
      @media (max-width: 720px) {
        .slide-status-bar__row {
          flex-direction: column;
          align-items: stretch;
        }
        .slide-status-bar__actions {
          justify-content: center;
        }
      }

      /* ------------------------------- Presentation shell ----------------------------------*/
      .presentation-header {
        position: relative;
        margin: 0 0 var(--space-3);
        padding: 0;
        background: none;
        border: none;
        box-shadow: none;
        z-index: 2;
      }
      .workspace-menu {
        position: absolute;
        top: clamp(16px, 2vw, 28px);
        left: clamp(16px, 2vw, 28px);
        z-index: 30;
      }
      .workspace-menu__summary {
        appearance: none;
        border: none;
        background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 1px solid rgba(122, 132, 113, 0.22);
        box-shadow: var(--shadow-1);
        cursor: pointer;
        color: var(--forest-shadow);
        transition:
          transform var(--dur-2) var(--ease-ambient),
          box-shadow var(--dur-2) var(--ease-ambient),
          background var(--dur-2) var(--ease-ambient);
      }
      .workspace-menu__summary::-webkit-details-marker {
        display: none;
      }
      .workspace-menu__summary:focus-visible {
        outline: none;
        box-shadow: var(--ring);
      }
      .workspace-menu[open] .workspace-menu__summary {
        background: color-mix(in srgb, var(--soft-white) 88%, white 12%);
        box-shadow: var(--shadow-2);
        transform: scale(1.04);
      }
      .workspace-menu__summary-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
      }
      .workspace-menu__summary-icon i {
        font-size: 1.2rem;
      }
      .workspace-menu__panel {
        position: absolute;
        top: calc(100% + var(--space-3));
        left: 0;
        width: min(420px, max(280px, 42vw));
        max-height: min(70vh, 540px);
        overflow: auto;
        display: grid;
        gap: var(--space-5);
        padding: clamp(20px, 2.6vw, 32px);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.18);
        background: color-mix(in srgb, var(--soft-white) 90%, white 10%);
        box-shadow: var(--shadow-3);
        backdrop-filter: blur(12px);
      }
      .workspace-menu__descriptor {
        margin: 0;
        font-size: var(--step-0);
        color: var(--forest-shadow);
        line-height: 1.5;
      }
      .workspace-menu__summary-text {
        display: inline-flex;
        flex-direction: column;
        gap: 4px;
        margin-left: var(--space-3);
      }
      .workspace-menu__summary-eyebrow {
        font-size: var(--step--2);
        font-weight: 700;
        letter-spacing: 0.2em;
        text-transform: uppercase;
      }
      .workspace-menu__summary-title {
        font-weight: 800;
        font-size: var(--step-0);
      }
      .workspace-menu__summary-descriptor {
        font-size: var(--step--1);
      }
      .workspace-menu__summary-hint {
        font-size: var(--step--2);
        color: var(--ink-muted);
      }
      .lesson-selector {
        display: grid;
        gap: var(--space-2);
      }
      .lesson-selector label {
        font-size: var(--step--1);
        color: var(--ink-muted);
        font-weight: 700;
      }
      .lesson-selector select {
        width: 100%;
        min-height: var(--target-min);
        border-radius: var(--radius-sm);
        border: 1px solid rgba(122, 132, 113, 0.2);
        padding: var(--space-3);
        font: inherit;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: inset 0 1px 2px rgba(122, 132, 113, 0.1);
        transition:
          border-color var(--dur-1) var(--ease-ambient),
          box-shadow var(--dur-1) var(--ease-ambient);
      }
      .lesson-selector select:focus-visible {
        outline: none;
        border-color: var(--secondary-sage);
        box-shadow: var(--ring);
      }
      .workspace-tools {
        display: grid;
        gap: var(--space-4);
      }
      .workspace-tools__header {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
      }
      .workspace-tools__title {
        margin: 0;
        font-size: var(--step-1);
        font-weight: 800;
        color: var(--forest-shadow);
      }
      .workspace-tools__hint {
        margin: 0;
        font-size: var(--step--1);
        color: var(--ink-muted);
      }
      .workspace-tools__actions {
        display: grid;
        gap: var(--space-3);
      }
      .workspace-tools__map {
        display: grid;
        gap: var(--space-3);
      }
      .workspace-tools__subtitle {
        margin: 0;
        font-size: var(--step--1);
        font-weight: 700;
        color: var(--forest-shadow);
      }
      .lesson-overview__body {
        display: grid;
        gap: var(--space-4);
        margin: 0;
      }
      .lesson-overview__section {
        display: grid;
        gap: var(--space-2);
      }
      .lesson-overview__section-title {
        margin: 0;
        font-size: var(--step-0);
        font-weight: 700;
        color: var(--forest-shadow);
      }
      .lesson-overview__list {
        margin: 0;
        padding-left: 1.1em;
        display: grid;
        gap: var(--space-1);
      }
      .lesson-overview__callout {
        margin: 0;
        padding: var(--space-3);
        border-left: 4px solid var(--secondary-sage);
        background: rgba(156, 175, 136, 0.1);
        border-radius: var(--radius-sm);
        font-size: var(--step--1);
        color: var(--forest-shadow);
      }
      @media (min-width: 768px) {
        .lesson-overview__body {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }
      #slide-map {
        margin: 0;
      }
      #slide-map-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .slide-map-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
      }
      .slide-map-group__title {
        margin: 0;
        font-size: var(--step-0);
        font-weight: 800;
        color: var(--forest-shadow);
        letter-spacing: 0.3px;
      }
      .slide-map-group__list {
        display: grid;
        gap: var(--space-2);
        margin: 0;
        padding: 0;
        list-style: none;
      }
      @container (min-width: 720px) {
        .slide-map-group__list {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }
      .slide-map-item {
        min-width: 0;
      }
      .slide-map-button {
        border: 1px solid rgba(122, 132, 113, 0.25);
        background: rgba(255, 255, 255, 0.88);
        border-radius: var(--radius-sm);
        padding: var(--space-3);
        font-size: var(--step--1);
        font-weight: 600;
        color: var(--forest-shadow);
        cursor: pointer;
        display: grid;
        grid-template-columns: auto 1fr;
        align-items: center;
        gap: var(--space-3);
        width: 100%;
        min-height: var(--target-min);
        transition:
          transform var(--dur-1) var(--ease-ambient),
          box-shadow var(--dur-2) var(--ease-ambient),
          border-color var(--dur-2) var(--ease-ambient),
          background var(--dur-2) var(--ease-ambient);
        white-space: normal;
        overflow-wrap: anywhere;
        text-align: left;
      }
      .slide-map-button:hover,
      .slide-map-button:focus-visible {
        outline: none;
        transform: translateY(-1px);
        border-color: var(--secondary-sage);
        box-shadow: 0 6px 12px rgba(62, 74, 58, 0.15);
        background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
      }
      .slide-map-item.is-active .slide-map-button {
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--secondary-sage) 92%, white 8%),
          var(--secondary-sage)
        );
        color: var(--soft-white);
        border-color: var(--secondary-sage);
        box-shadow: 0 6px 12px rgba(62, 74, 58, 0.18);
      }
      .slide-map-item.is-active .slide-map-button:hover,
      .slide-map-item.is-active .slide-map-button:focus-visible {
        transform: translateY(-1px);
      }
      .slide-map-button__number {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 999px;
        background: color-mix(in srgb, var(--secondary-sage) 25%, white 75%);
        color: var(--forest-shadow);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.95rem;
        letter-spacing: 0.3px;
      }
      .slide-map-button__label {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .slide-map-button__title {
        font-size: var(--step--1);
        font-weight: 700;
        color: inherit;
      }
      .slide-map-button__subtitle {
        font-size: 0.85rem;
        color: var(--ink-muted);
      }
      .slide-map-item.is-active .slide-map-button__number {
        background: color-mix(
          in srgb,
          var(--soft-white) 20%,
          var(--forest-shadow) 80%
        );
        color: var(--soft-white);
      }

      /* ------------------------------- Buttons ----------------------------------*/
      .activity-btn {
        min-height: var(--target-min);
        padding: 12px 20px;
        border-radius: 12px;
        border: 1px solid var(--primary-sage);
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--primary-sage) 92%, white 8%),
          var(--primary-sage)
        );
        color: #fff;
        font-weight: 700;
        font-size: 1rem;
        letter-spacing: 0.2px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        user-select: none;
        transition:
          transform var(--dur-1) var(--ease-ambient),
          box-shadow var(--dur-2) var(--ease-ambient),
          background var(--dur-2) var(--ease-ambient),
          border-color var(--dur-2) var(--ease-ambient),
          opacity var(--dur-1) var(--ease-ambient);
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.25) inset,
          0 8px 16px rgba(90, 107, 82, 0.2);
      }
      .activity-btn:hover {
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--forest-shadow) 92%, white 8%),
          var(--forest-shadow)
        );
        transform: translateY(-1px);
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.25) inset,
          0 10px 20px rgba(90, 107, 82, 0.22);
      }
      .activity-btn:active {
        transform: translateY(0);
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.2) inset,
          0 4px 10px rgba(90, 107, 82, 0.2);
      }
      .activity-btn:focus-visible {
        outline: none;
        box-shadow:
          var(--ring),
          0 8px 16px rgba(90, 107, 82, 0.2);
      }
      .activity-btn:disabled,
      .activity-btn[disabled] {
        background: var(--tertiary-sage);
        border-color: var(--tertiary-sage);
        color: color-mix(in srgb, #fff 70%, var(--soft-white) 30%);
        cursor: not-allowed;
        opacity: 0.8;
        transform: none;
        box-shadow: none;
      }
      .activity-btn.secondary {
        background: transparent;
        color: var(--primary-sage);
        border-color: color-mix(
          in srgb,
          var(--tertiary-sage) 70%,
          var(--primary-sage) 30%
        );
        box-shadow: none;
      }
      .activity-btn.secondary:hover {
        background-color: var(--hover-sage);
      }
      .activity-btn.secondary:focus-visible {
        outline: none;
        box-shadow: var(--ring);
      }
      .controls {
        margin-top: var(--space-7);
        text-align: center;
        display: grid;
        gap: var(--space-3);
        grid-auto-flow: row;
      }
      .controls .activity-btn {
        justify-self: center;
        padding-inline: clamp(24px, 3vw, 36px);
      }
      .controls__hint {
        margin: 0;
        font-size: var(--step--1);
        color: var(--ink-muted);
      }
      .controls__hint strong {
        color: var(--forest-shadow);
      }
      .activity-actions {
        display: grid;
        gap: var(--space-3);
        justify-items: center;
        margin-top: var(--space-6);
      }
      .activity-actions .activity-btn {
        width: min(100%, 260px);
      }
      .activity-actions__hint {
        font-size: var(--step--1);
        color: var(--ink-muted);
        margin: 0;
      }

      /* ------------------------------- Slide content wrappers ----------------------------------*/
      .slide {
        display: none;
      }
      .slide.active {
        display: block;
      }
      .slide-content {
        display: grid;
        gap: var(--space-5);
        background: rgba(255, 255, 255, 0.82);
        border-radius: var(--radius-lg);
        padding: clamp(28px, 4vw, 42px);
        border: 1px solid rgba(122, 132, 113, 0.12);
        box-shadow: var(--shadow-2);
      }
      .slide-content.layout--poster {
        position: relative;
        overflow: hidden;
      }
      .slide-content.layout--poster::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          320px 220px at 20% 15%,
          rgba(198, 170, 119, 0.28),
          transparent 70%
        );
        opacity: 0.75;
        pointer-events: none;
      }
      .slide-content.layout--columns {
        display: grid;
        gap: clamp(24px, 3vw, 36px);
        align-items: start;
      }
      @media (min-width: 1024px) {
        .slide-content.layout--columns {
          grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        }
      }
      .layout-grid {
        display: grid;
        gap: clamp(24px, 3vw, 36px);
      }
      @media (min-width: 1024px) {
        .layout-grid {
          grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
          align-items: start;
        }
        .layout-grid__column {
          display: grid;
          gap: clamp(20px, 3vw, 32px);
        }
      }

      /* ------------------------------- Slide typography & badges ----------------------------------*/
      .slide-title {
        font-family: var(--font-display);
        font-size: clamp(1.75rem, 2.4vw, 2.4rem);
        color: var(--forest-shadow);
        display: inline-flex;
        align-items: center;
        gap: var(--space-3);
        margin: 0;
      }
      .slide-title i {
        font-size: 1.3em;
        color: var(--secondary-sage);
      }
      .section-eyebrow {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--step--1);
        font-weight: 700;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: rgba(47, 58, 43, 0.65);
      }
      .section-eyebrow::before {
        content: "";
        width: 24px;
        height: 2px;
        background: rgba(47, 58, 43, 0.35);
      }
      .session-summary__title {
        font-family: var(--font-display);
        font-size: clamp(1.5rem, 2vw, 1.9rem);
        margin: 0;
        color: var(--forest-shadow);
      }
      .session-summary__subtitle {
        margin: 0;
        font-size: var(--step--1);
        color: var(--ink-muted);
      }
      .session-summary__intro {
        display: grid;
        gap: var(--space-3);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        background: color-mix(
          in srgb,
          rgba(156, 175, 136, 0.18) 65%,
          rgba(255, 246, 233, 0.4) 35%
        );
        border: 1px solid rgba(156, 175, 136, 0.32);
      }
      .session-summary__highlights {
        display: grid;
        gap: var(--space-3);
      }
      .highlight-tag {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: 0.35em 0.9em;
        border-radius: 999px;
        background: rgba(122, 132, 113, 0.18);
        color: var(--forest-shadow);
        font-size: var(--step--1);
        font-weight: 700;
      }
      .highlight-tag i {
        font-size: 0.9em;
      }

      /* ------------------------------- Pedagogy cards ----------------------------------*/
      .session-pedagogy__grid {
        display: grid;
        gap: clamp(20px, 3vw, 28px);
      }
      @media (min-width: 768px) {
        .session-pedagogy__grid {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }
      .pedagogy-card {
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(122, 132, 113, 0.12);
        padding: clamp(20px, 2.6vw, 28px);
        display: grid;
        gap: var(--space-3);
        box-shadow: var(--shadow-1);
        transition:
          transform var(--dur-2) var(--ease-ambient),
          box-shadow var(--dur-2) var(--ease-ambient);
      }
      .pedagogy-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-2);
      }
      .pedagogy-card__header {
        display: inline-flex;
        align-items: center;
        gap: var(--space-3);
      }
      .pedagogy-card__icon {
        width: 52px;
        height: 52px;
        border-radius: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          135deg,
          rgba(156, 175, 136, 0.22),
          rgba(255, 246, 233, 0.55)
        );
        color: var(--forest-shadow);
        font-size: 1.4rem;
      }
      .pedagogy-card__title {
        margin: 0;
        font-size: var(--step-1);
        color: var(--forest-shadow);
      }
      .pedagogy-card p {
        margin: 0;
        color: var(--ink-muted);
      }

      /* ------------------------------- Guide cards ----------------------------------*/
      .session-guide__grid {
        display: grid;
        gap: clamp(20px, 3vw, 28px);
      }
      @media (min-width: 768px) {
        .session-guide__grid {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }
      .guide-card {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.15);
        padding: clamp(20px, 2.6vw, 28px);
        background: color-mix(
          in srgb,
          rgba(255, 246, 233, 0.8) 65%,
          rgba(156, 175, 136, 0.35) 35%
        );
        box-shadow: var(--shadow-1);
        display: grid;
        gap: var(--space-3);
      }
      .guide-card h3 {
        margin: 0;
        font-size: var(--step-1);
        color: var(--forest-shadow);
        display: inline-flex;
        align-items: center;
        gap: var(--space-3);
      }
      .guide-card h3 i {
        font-size: 1.2em;
        color: var(--secondary-sage);
      }
      .guide-card p {
        margin: 0;
        color: var(--ink-muted);
      }

      /* ------------------------------- Session grounding ----------------------------------*/
      .session-grounding {
        display: grid;
        gap: var(--space-3);
      }
      .grounding-slide {
        position: relative;
        display: grid;
        overflow: hidden;
        border-radius: var(--radius-xl);
        min-height: clamp(280px, 50vw, 420px);
      }
      .grounding-slide img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: saturate(0.92) brightness(0.95);
      }
      .grounding-overlay {
        position: relative;
        z-index: 1;
        display: grid;
        gap: var(--space-3);
        padding: clamp(24px, 5vw, 40px);
        background: linear-gradient(
          140deg,
          rgba(47, 58, 43, 0.85),
          rgba(47, 58, 43, 0.55)
        );
        color: rgba(255, 255, 255, 0.95);
      }
      .grounding-overlay .text-lg {
        margin: 0;
        color: rgba(255, 255, 255, 0.92);
      }
      .grounding-overlay h3 {
        margin: 0;
        font-size: clamp(1.5rem, 2.2vw, 2rem);
        color: #fff;
      }
      .grounding-prompts {
        margin: 0;
        padding-left: 1.2em;
        display: grid;
        gap: var(--space-2);
      }
      .grounding-prompts li {
        line-height: 1.6;
      }
      .grounding-prompts i {
        color: rgba(255, 255, 255, 0.85);
        margin-right: 0.5em;
      }
      .grounding-overlay .text-sm {
        color: rgba(255, 255, 255, 0.7);
        margin: 0;
      }

      /* ------------------------------- Question prompts ----------------------------------*/
      .question-prompts {
        display: grid;
        gap: var(--space-4);
      }
      @media (min-width: 768px) {
        .question-prompts {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }
      .question-card {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.18);
        padding: clamp(20px, 2.8vw, 28px);
        background: color-mix(
          in srgb,
          rgba(255, 246, 233, 0.85) 55%,
          rgba(156, 175, 136, 0.22) 45%
        );
        box-shadow: var(--shadow-1);
        display: grid;
        gap: var(--space-2);
      }
      .question-card h4 {
        margin: 0;
        font-size: var(--step-0);
        font-weight: 800;
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        color: var(--forest-shadow);
      }
      .question-card h4 i {
        font-size: 1.1em;
        color: var(--secondary-sage);
      }
      .question-card p {
        margin: 0;
        color: var(--ink-muted);
      }

      /* ------------------------------- Session overview image ----------------------------------*/
      figure {
        margin: 0;
      }
      figure img {
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-3);
        overflow: hidden;
      }
      figure figcaption {
        margin-top: var(--space-2);
        font-size: var(--step--2);
        color: var(--ink-muted);
        text-align: center;
      }
      figure a {
        color: var(--secondary-sage);
      }

      /* ------------------------------- Slide layout utilities ----------------------------------*/
      .slide-section {
        display: grid;
        gap: clamp(24px, 3vw, 36px);
      }
      .section-intro {
        display: grid;
        gap: var(--space-2);
      }
      .section-intro__title {
        margin: 0;
        font-family: var(--font-display);
        font-size: clamp(1.6rem, 2.2vw, 2rem);
        color: var(--forest-shadow);
      }
      .section-intro__descriptor {
        margin: 0;
        color: var(--ink-muted);
        font-size: var(--step-0);
      }
      .section-intro__eyebrow {
        margin: 0;
        font-size: var(--step--1);
        font-weight: 700;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: rgba(47, 58, 43, 0.65);
      }
      .checklist {
        display: grid;
        gap: var(--space-3);
        padding: 0;
        margin: 0;
        list-style: none;
      }
      .checklist-item {
        position: relative;
        padding-left: clamp(36px, 4vw, 42px);
        font-size: var(--step-0);
        color: var(--forest-shadow);
      }
      .checklist-item::before {
        content: "\f00c";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        position: absolute;
        left: 0;
        top: 0.1em;
        color: var(--secondary-sage);
      }
      .callout-card {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.18);
        background: color-mix(in srgb, var(--soft-white) 90%, white 10%);
        padding: clamp(20px, 3vw, 32px);
        box-shadow: var(--shadow-2);
        display: grid;
        gap: var(--space-3);
      }
      .callout-card__title {
        margin: 0;
        font-size: var(--step-1);
        font-weight: 800;
        color: var(--forest-shadow);
      }
      .callout-card__body {
        margin: 0;
        color: var(--ink-muted);
        font-size: var(--step-0);
      }
      .callout-card__footer {
        margin: 0;
        font-size: var(--step--1);
        color: rgba(47, 58, 43, 0.6);
      }
      .callout-card__footer i {
        color: var(--secondary-sage);
        margin-right: 0.5em;
      }
      .inline-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: 0.3em 0.8em;
        border-radius: 999px;
        background: rgba(122, 132, 113, 0.16);
        font-size: var(--step--1);
        font-weight: 700;
        color: var(--forest-shadow);
      }
      .inline-badge i {
        color: var(--secondary-sage);
      }

      /* ------------------------------- Timeline / agenda ----------------------------------*/
      .agenda {
        display: grid;
        gap: clamp(20px, 3vw, 28px);
      }
      .agenda__item {
        display: grid;
        gap: var(--space-2);
        border-left: 4px solid rgba(122, 132, 113, 0.32);
        padding-left: var(--space-4);
      }
      .agenda__item.is-active {
        border-color: var(--secondary-sage);
      }
      .agenda__time {
        margin: 0;
        font-size: var(--step--1);
        font-weight: 700;
        color: var(--ink-muted);
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      .agenda__title {
        margin: 0;
        font-size: var(--step-1);
        font-weight: 800;
        color: var(--forest-shadow);
      }
      .agenda__descriptor {
        margin: 0;
        font-size: var(--step-0);
        color: var(--ink-muted);
      }
      .agenda__actions {
        display: inline-flex;
        flex-wrap: wrap;
        gap: var(--space-2);
      }
      .agenda__action {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        font-size: var(--step--1);
        padding: 0.2em 0.6em;
        border-radius: 999px;
        background: rgba(156, 175, 136, 0.18);
        color: var(--forest-shadow);
        font-weight: 700;
      }

      /* ------------------------------- Graphic prompts ----------------------------------*/
      .prompt-tiles {
        display: grid;
        gap: clamp(16px, 2.4vw, 24px);
      }
      @media (min-width: 600px) {
        .prompt-tiles {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }
      .prompt-tile {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.15);
        padding: clamp(20px, 2.6vw, 28px);
        background: rgba(255, 255, 255, 0.85);
        box-shadow: var(--shadow-1);
        display: grid;
        gap: var(--space-3);
      }
      .prompt-tile__icon {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: color-mix(
          in srgb,
          rgba(156, 175, 136, 0.35) 60%,
          rgba(255, 246, 233, 0.6) 40%
        );
        color: var(--forest-shadow);
        font-size: 1.3rem;
      }
      .prompt-tile__title {
        margin: 0;
        font-size: var(--step-0);
        font-weight: 800;
        color: var(--forest-shadow);
      }
      .prompt-tile__body {
        margin: 0;
        color: var(--ink-muted);
      }

      /* ------------------------------- Reflection prompts ----------------------------------*/
      .reflection-grid {
        display: grid;
        gap: clamp(20px, 3vw, 28px);
      }
      @media (min-width: 768px) {
        .reflection-grid {
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }
      }
      .reflection-card {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.2);
        padding: clamp(20px, 2.6vw, 28px);
        display: grid;
        gap: var(--space-3);
        background: rgba(255, 255, 255, 0.8);
        box-shadow: var(--shadow-1);
      }
      .reflection-card__title {
        margin: 0;
        font-size: var(--step-0);
        font-weight: 800;
        color: var(--forest-shadow);
      }
      .reflection-card__body {
        margin: 0;
        color: var(--ink-muted);
      }

      /* ------------------------------- Note-taking utilities ----------------------------------*/
      .note-card {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.2);
        background: rgba(255, 255, 255, 0.9);
        box-shadow: var(--shadow-1);
        padding: clamp(20px, 3vw, 32px);
        display: grid;
        gap: var(--space-3);
      }
      .note-card__header {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        color: var(--forest-shadow);
        font-size: var(--step-0);
        font-weight: 800;
      }
      .note-card__header i {
        color: var(--secondary-sage);
      }
      .note-card__body {
        margin: 0;
        color: var(--ink-muted);
        font-size: var(--step--1);
      }
      .note-card__footer {
        display: inline-flex;
        gap: var(--space-2);
        align-items: center;
      }
      .note-card__footer .inline-badge {
        background: rgba(156, 175, 136, 0.15);
      }
      .note-card textarea {
        width: 100%;
        min-height: 160px;
        border-radius: var(--radius-sm);
        border: 1px solid rgba(122, 132, 113, 0.22);
        padding: var(--space-3);
        font: inherit;
        background: rgba(255, 255, 255, 0.92);
        color: var(--forest-shadow);
        resize: vertical;
        transition:
          border-color var(--dur-1) var(--ease-ambient),
          box-shadow var(--dur-1) var(--ease-ambient);
      }
      .note-card textarea:focus-visible {
        outline: none;
        border-color: var(--secondary-sage);
        box-shadow: var(--ring);
      }

      /* ------------------------------- Table styling ----------------------------------*/
      table {
        width: 100%;
        border-collapse: collapse;
        border-spacing: 0;
        border: 1px solid rgba(122, 132, 113, 0.2);
        border-radius: var(--radius-lg);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: var(--shadow-1);
      }
      thead {
        background: color-mix(in srgb, var(--secondary-sage) 25%, white 75%);
        color: var(--forest-shadow);
      }
      th,
      td {
        padding: clamp(12px, 1.5vw, 18px);
        text-align: left;
        font-size: var(--step--1);
        color: var(--forest-shadow);
        border-bottom: 1px solid rgba(122, 132, 113, 0.15);
      }
      th {
        font-weight: 800;
        font-size: var(--step-0);
      }
      tbody tr:nth-child(odd) {
        background: rgba(122, 132, 113, 0.06);
      }
      tbody tr:hover {
        background: rgba(156, 175, 136, 0.12);
      }
      caption {
        caption-side: bottom;
        padding: var(--space-3);
        font-size: var(--step--2);
        color: var(--ink-muted);
        text-align: left;
      }

      /* ------------------------------- Check-in modules ----------------------------------*/
      .check-in-grid {
        display: grid;
        gap: clamp(16px, 2.4vw, 24px);
      }
      @media (min-width: 768px) {
        .check-in-grid {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }
      .check-in-card {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.16);
        padding: clamp(20px, 2.6vw, 28px);
        background: rgba(255, 255, 255, 0.85);
        display: grid;
        gap: var(--space-3);
        box-shadow: var(--shadow-1);
      }
      .check-in-card__title {
        margin: 0;
        font-size: var(--step-0);
        font-weight: 800;
        color: var(--forest-shadow);
      }
      .check-in-card__body {
        margin: 0;
        color: var(--ink-muted);
      }
      .emoji-row {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        font-size: 1.4rem;
      }

      /* ------------------------------- Activity tiles ----------------------------------*/
      .activity-grid {
        display: grid;
        gap: clamp(20px, 3vw, 30px);
      }
      @media (min-width: 768px) {
        .activity-grid {
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }
      }
      .activity-tile {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.16);
        background: rgba(255, 255, 255, 0.9);
        padding: clamp(20px, 3vw, 32px);
        display: grid;
        gap: var(--space-3);
        box-shadow: var(--shadow-2);
        transition:
          transform var(--dur-2) var(--ease-ambient),
          box-shadow var(--dur-2) var(--ease-ambient);
      }
      .activity-tile:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-3);
      }
      .activity-tile__title {
        margin: 0;
        font-size: var(--step-1);
        font-weight: 800;
        color: var(--forest-shadow);
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
      }
      .activity-tile__title i {
        color: var(--secondary-sage);
      }
      .activity-tile__descriptor {
        margin: 0;
        color: var(--ink-muted);
        font-size: var(--step-0);
      }
      .activity-tile__meta {
        display: inline-flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        font-size: var(--step--2);
        color: rgba(47, 58, 43, 0.65);
      }
      .activity-tile__meta span {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 0.2em 0.6em;
        border-radius: 999px;
        background: rgba(156, 175, 136, 0.18);
        font-weight: 700;
      }

      /* ------------------------------- Poll modules ----------------------------------*/
      .poll-grid {
        display: grid;
        gap: clamp(20px, 3vw, 28px);
      }
      .poll-question {
        margin: 0;
        font-size: var(--step-0);
        font-weight: 800;
        color: var(--forest-shadow);
      }
      .poll-options {
        display: grid;
        gap: var(--space-2);
      }
      .poll-option {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-3);
        border-radius: var(--radius-sm);
        border: 1px solid rgba(122, 132, 113, 0.18);
        background: rgba(255, 255, 255, 0.85);
        box-shadow: inset 0 1px 2px rgba(122, 132, 113, 0.08);
        font-size: var(--step--1);
        color: var(--forest-shadow);
      }
      .poll-option i {
        color: var(--secondary-sage);
      }

      /* ------------------------------- Story cards ----------------------------------*/
      .story-grid {
        display: grid;
        gap: clamp(24px, 3vw, 36px);
      }
      @media (min-width: 768px) {
        .story-grid {
          grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }
      }
      .story-card {
        border-radius: var(--radius-xl);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(122, 132, 113, 0.18);
        box-shadow: var(--shadow-2);
        display: grid;
        grid-template-rows: 220px 1fr;
      }
      .story-card__image {
        background-size: cover;
        background-position: center;
      }
      .story-card__body {
        padding: clamp(20px, 3vw, 30px);
        display: grid;
        gap: var(--space-2);
      }
      .story-card__title {
        margin: 0;
        font-size: var(--step-0);
        font-weight: 800;
        color: var(--forest-shadow);
      }
      .story-card__subtitle {
        margin: 0;
        font-size: var(--step--1);
        color: var(--ink-muted);
      }
      .story-card__quote {
        margin: 0;
        font-style: italic;
        color: var(--forest-shadow);
      }

      /* ------------------------------- Interactive activities ----------------------------------*/
      .interactive-module {
        display: grid;
        gap: clamp(24px, 3vw, 36px);
      }
      .interactive-module__header {
        display: grid;
        gap: var(--space-2);
      }
      .interactive-module__title {
        margin: 0;
        font-size: clamp(1.6rem, 2.2vw, 2rem);
        font-family: var(--font-display);
        color: var(--forest-shadow);
      }
      .interactive-module__descriptor {
        margin: 0;
        color: var(--ink-muted);
        font-size: var(--step-0);
      }
      .interactive-module__steps {
        display: grid;
        gap: clamp(20px, 3vw, 28px);
      }
      .interactive-step {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.18);
        background: rgba(255, 255, 255, 0.85);
        padding: clamp(20px, 2.8vw, 32px);
        display: grid;
        gap: var(--space-3);
        box-shadow: var(--shadow-1);
      }
      .interactive-step__eyebrow {
        margin: 0;
        font-size: var(--step--2);
        font-weight: 800;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: rgba(47, 58, 43, 0.65);
      }
      .interactive-step__title {
        margin: 0;
        font-size: var(--step-1);
        font-weight: 800;
        color: var(--forest-shadow);
      }
      .interactive-step__body {
        margin: 0;
        color: var(--ink-muted);
      }
      .interactive-step__meta {
        display: inline-flex;
        gap: var(--space-2);
        font-size: var(--step--1);
        color: rgba(47, 58, 43, 0.6);
      }
      .interactive-step__meta span {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      .interactive-step__meta i {
        color: var(--secondary-sage);
      }

      /* ------------------------------- Breakout prompts ----------------------------------*/
      .breakout-grid {
        display: grid;
        gap: clamp(20px, 3vw, 28px);
      }
      @media (min-width: 768px) {
        .breakout-grid {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }
      .breakout-card {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.2);
        background: rgba(255, 255, 255, 0.85);
        padding: clamp(20px, 2.6vw, 28px);
        display: grid;
        gap: var(--space-3);
        box-shadow: var(--shadow-1);
      }
      .breakout-card__title {
        margin: 0;
        font-size: var(--step-0);
        font-weight: 800;
        color: var(--forest-shadow);
      }
      .breakout-card__body {
        margin: 0;
        color: var(--ink-muted);
      }
      .breakout-card__footer {
        margin: 0;
        font-size: var(--step--2);
        color: rgba(47, 58, 43, 0.6);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-weight: 700;
      }

      /* ------------------------------- Data table slides ----------------------------------*/
      .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border: 1px solid rgba(122, 132, 113, 0.18);
        border-radius: var(--radius-lg);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: var(--shadow-2);
      }
      .data-table thead {
        background: color-mix(in srgb, var(--secondary-sage) 20%, white 80%);
        color: var(--forest-shadow);
      }
      .data-table th,
      .data-table td {
        padding: clamp(12px, 1.6vw, 18px);
        font-size: var(--step--1);
        color: var(--forest-shadow);
        border-bottom: 1px solid rgba(122, 132, 113, 0.12);
      }
      .data-table th {
        font-weight: 800;
        font-size: var(--step-0);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .data-table tbody tr:nth-child(odd) {
        background: rgba(122, 132, 113, 0.06);
      }
      .data-table tbody tr:hover {
        background: rgba(156, 175, 136, 0.14);
      }

      /* ------------------------------- Chat prompts ----------------------------------*/
      .chat-prompts {
        display: grid;
        gap: clamp(20px, 3vw, 28px);
      }
      .chat-message {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.18);
        background: rgba(255, 255, 255, 0.85);
        padding: clamp(18px, 2.5vw, 26px);
        display: grid;
        gap: var(--space-2);
        box-shadow: var(--shadow-1);
      }
      .chat-message__sender {
        margin: 0;
        font-size: var(--step--1);
        font-weight: 800;
        color: var(--forest-shadow);
        text-transform: uppercase;
        letter-spacing: 0.12em;
      }
      .chat-message__body {
        margin: 0;
        color: var(--ink-muted);
        font-size: var(--step-0);
      }

      /* ------------------------------- Resource cards ----------------------------------*/
      .resource-grid {
        display: grid;
        gap: clamp(20px, 3vw, 28px);
      }
      @media (min-width: 768px) {
        .resource-grid {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }
      .resource-card {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(122, 132, 113, 0.18);
        background: rgba(255, 255, 255, 0.88);
        padding: clamp(20px, 2.8vw, 28px);
        display: grid;
        gap: var(--space-3);
        box-shadow: var(--shadow-1);
      }
      .resource-card__title {
        margin: 0;
        font-size: var(--step-0);
        font-weight: 800;
        color: var(--forest-shadow);
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
      }
      .resource-card__title i {
        color: var(--secondary-sage);
      }
      .resource-card__body {
        margin: 0;
        color: var(--ink-muted);
      }
      .resource-card__link {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        font-weight: 700;
        color: var(--primary-sage);
        text-decoration: none;
      }
      .resource-card__link:hover {
        text-decoration: underline;
      }
      
      /* --- Custom styles for interactive elements --- */
        .matching-activity {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
            align-items: start;
        }
        .matching-list { list-style: none; padding: 0; margin: 0; display: grid; gap: var(--space-3); }
        .match-item {
            padding: var(--space-3);
            border-radius: var(--radius-sm);
            border: 2px solid var(--border-sage);
            background: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all var(--dur-2) var(--ease-ambient);
        }
        .match-item:hover { background: var(--hover-sage); border-color: var(--secondary-sage); }
        .match-item.selected { background: var(--tertiary-sage); color: var(--deep-forest); border-color: var(--primary-sage); font-weight: bold; }
        .match-item.correct { border-color: #28a745; background-color: #e9f5ec; }
        .match-item.incorrect { border-color: #dc3545; background-color: #fbe9eb; }

        .ranking-list { list-style-type: none; padding: 0; margin: 0; display: grid; gap: var(--space-3); }
        .ranking-item { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); border-radius: var(--radius-sm); border: 1px solid var(--border-sage); background: rgba(255,255,255,0.8); }
        .rank-handle { cursor: grab; color: var(--tertiary-sage); }
        .rank-number { font-weight: 800; color: var(--primary-sage); font-size: var(--step-1); }

        .drop-zone-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-top: var(--space-4); }
        .drop-zone { border: 2px dashed var(--tertiary-sage); border-radius: var(--radius-lg); padding: var(--space-4); min-height: 150px; background: rgba(156, 175, 136, 0.05); }
        .drop-zone h4 { margin: 0 0 var(--space-3); }
        .draggable { padding: var(--space-2) var(--space-3); background: var(--warm-cream); border: 1px solid var(--dried-clay); border-radius: var(--radius-sm); cursor: grab; margin-bottom: var(--space-2); }
        .draggable-bank { padding: var(--space-3); border: 1px solid var(--border-sage); border-radius: var(--radius-lg); display: flex; flex-wrap: wrap; gap: var(--space-2); }

        .ordering-list { list-style: none; padding: 0; margin: 0; display: grid; gap: var(--space-3); }
        .order-item { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); border-radius: var(--radius-sm); border: 1px solid var(--border-sage); background: rgba(255,255,255,0.8); }
        .order-handle { cursor: grab; color: var(--tertiary-sage); }

        .gap-fill-box { border: 1px solid var(--border-sage); border-radius: var(--radius-lg); padding: var(--space-4); background: var(--warm-cream); }
        .gap-fill-box p { font-weight: bold; margin: 0 0 var(--space-2); }
        .gap-fill-box span { display: inline-block; margin: var(--space-1); }

        .feedback { margin-top: var(--space-4); font-weight: bold; padding: var(--space-3); border-radius: var(--radius-sm); display: none; }
        .feedback.correct { background: #e9f5ec; color: #28a745; }
        .feedback.incorrect { background: #fbe9eb; color: #dc3545; }

        .annotation-highlight {
          background: var(--annotation-color, rgba(198, 170, 119, 0.35));
          color: var(--ink);
          border-radius: 6px;
          padding: 0 2px;
          box-decoration-break: clone;
          cursor: pointer;
          transition:
            box-shadow var(--dur-2) var(--ease-ambient),
            background var(--dur-2) var(--ease-ambient);
        }
        .annotation-highlight:hover {
          box-shadow: 0 0 0 2px rgba(47, 58, 43, 0.15);
        }
        .annotation-highlight:focus-visible {
          outline: none;
          box-shadow: var(--ring);
        }

        #annotation-popover {
          position: fixed;
          z-index: 70;
          display: none;
          width: min(360px, 92vw);
          padding: clamp(20px, 3vw, 28px);
          border-radius: var(--radius-lg);
          border: 1px solid rgba(122, 132, 113, 0.2);
          background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
          box-shadow: var(--shadow-3);
        }
        #annotation-popover[aria-hidden="true"] {
          display: none;
        }
        .annotation-popover__form {
          display: grid;
          gap: var(--space-4);
        }
        .annotation-popover__field {
          display: grid;
          gap: var(--space-2);
        }
        .annotation-popover__label {
          font-size: var(--step--1);
          font-weight: 700;
          color: var(--forest-shadow);
        }
        .annotation-popover__textarea {
          min-height: 96px;
          resize: vertical;
          border-radius: var(--radius-sm);
          border: 1px solid rgba(122, 132, 113, 0.24);
          padding: var(--space-3);
          font: inherit;
          background: rgba(255, 255, 255, 0.92);
        }
        .annotation-popover__color-input {
          display: flex;
          align-items: center;
          gap: var(--space-3);
          flex-wrap: wrap;
        }
        .annotation-popover__color-picker {
          width: 48px;
          height: 48px;
          border-radius: var(--radius-sm);
          border: 1px solid rgba(122, 132, 113, 0.24);
          background: rgba(255, 255, 255, 0.95);
          cursor: pointer;
        }
        .annotation-popover__hint {
          margin: 0;
          font-size: var(--step--2);
          color: var(--ink-muted);
        }
        .annotation-popover__actions {
          display: flex;
          justify-content: flex-end;
          flex-wrap: wrap;
          gap: var(--space-2);
        }

        #annotation-tooltip {
          position: fixed;
          z-index: 60;
          display: none;
          max-width: min(320px, 70vw);
          padding: var(--space-3);
          border-radius: var(--radius-sm);
          border: 1px solid rgba(122, 132, 113, 0.24);
          background: color-mix(in srgb, var(--soft-white) 95%, white 5%);
          box-shadow: var(--shadow-2);
          font-size: var(--step--1);
          color: var(--forest-shadow);
          pointer-events: none;
        }

    </style>
</head>
<body>
    <div id="app-wrapper">
        <div id="activity-shell">
            <main id="activity-container">

                <header class="presentation-header" aria-label="Session tools">
                    <details class="workspace-menu" id="presentation-tools">
                        <summary class="workspace-menu__summary" aria-label="Open session tools">
                            <span class="workspace-menu__summary-icon">
                                <i class="fa-solid fa-gear" aria-hidden="true"></i>
                                <span class="visually-hidden">Open session tools</span>
                            </span>
                        </summary>
                        <div class="workspace-menu__panel">
                            <div class="workspace-tools">
                                <div class="workspace-tools__header">
                                    <h2 class="workspace-tools__title">Session tools</h2>
                                    <p class="workspace-tools__hint">Save or restore your annotated slides.</p>
                                </div>
                                <div class="workspace-tools__actions">
                                    <button type="button" class="activity-btn" id="save-annotations-btn">
                                        <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> Save annotations
                                    </button>
                                    <button type="button" class="activity-btn secondary" id="load-annotations-btn">
                                        <i class="fa-solid fa-folder-open" aria-hidden="true"></i> Load annotations
                                    </button>
                                    <input type="file" id="load-annotations-input" accept="application/json" hidden>
                                    <p class="workspace-tools__hint">Loading will replace the current slide content.</p>
                                </div>
                            </div>
                        </div>
                    </details>
                </header>

                <div id="slides-root">
                    <!-- SLIDE 1: Title Slide -->
                    <div class="slide active" id="slide-1">
                        <header class="session-hero">
                            <div class="session-hero__content">
                                <h1 class="session-hero__title">The Eco-Activist's Toolkit</h1>
                                <p class="session-hero__descriptor">Learning to make a difference, one step at a time.</p>
                                <div class="session-hero__meta">
                                    <span class="session-hero__badge"><i class="fa-solid fa-earth-americas"></i> B2 Level</span>
                                    <span class="session-hero__badge"><i class="fa-solid fa-bullhorn"></i> Eco-Activism</span>
                                </div>
                            </div>
                            <figure class="session-hero__media">
                                <img src="https://images.unsplash.com/photo-1593113646773-533cfa4502d3?q=80&w=1170&auto=format&fit=crop" alt="People planting trees in a community garden.">
                            </figure>
                        </header>
                    </div>

                    <!-- SLIDE 2: Dialogic Lead-In -->
                    <div class="slide" id="slide-2">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-comments"></i> Let's Talk About Our Planet</h2>
                            <p class="section-intro__descriptor">In pairs, discuss the following questions. Be ready to share your ideas with the class.</p>
                            
                            <!-- Activity Type: Open-ended discussion -->
                            <div class="question-prompts">
                                <div class="question-card">
                                    <h4><i class="fa-solid fa-triangle-exclamation"></i> Most Urgent Problem</h4>
                                    <p>What do you think is the most urgent environmental problem facing the world today? Why?</p>
                                </div>
                                <div class="question-card">
                                    <h4><i class="fa-solid fa-leaf"></i> Going "Green"</h4>
                                    <p>Have you ever tried to live a more "green" lifestyle? What changes did you make?</p>
                                </div>
                                <div class="question-card">
                                    <h4><i class="fa-solid fa-person-rays"></i> The word "Activist"</h4>
                                    <p>What does the word "activist" mean to you? Does it have a positive or negative connotation?</p>
                                </div>
                                <div class="question-card">
                                    <h4><i class="fa-solid fa-image"></i> Protest Image</h4>
                                    <p>Look at the image of the climate protest. What emotions or ideas come to mind when you see it?</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 3: Vocabulary Matching -->
                    <div class="slide" id="slide-3">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-layer-group"></i> Key Campaign Vocabulary</h2>
                            <div class="section-intro">
                                <h3 class="section-intro__title">Match the Core Concepts</h3>
                                <p class="section-intro__descriptor">Match the words to their definitions. Click a word, then click its definition.</p>
                            </div>
                            <div class="matching-activity" id="matching-activity-1">
                                <ul class="matching-list">
                                    <li class="match-item" data-match="1">1. Petition</li>
                                    <li class="match-item" data-match="2">2. Boycott</li>
                                    <li class="match-item" data-match="3">3. Protest</li>
                                    <li class="match-item" data-match="4">4. Conservation</li>
                                    <li class="match-item" data-match="5">5. Awareness</li>
                                </ul>
                                <ul class="matching-list">
                                    <li class="match-item" data-match="2">a. To refuse to buy, use, or participate in something as a form of protest.</li>
                                    <li class="match-item" data-match="3">b. A public event where people show their opposition to something.</li>
                                    <li class="match-item" data-match="5">c. Knowledge or perception of a situation or fact.</li>
                                    <li class="match-item" data-match="4">d. The protection of animals, plants, and natural resources.</li>
                                    <li class="match-item" data-match="1">e. A formal written request, typically signed by many people, appealing to authority.</li>
                                </ul>
                            </div>
                            <div class="feedback"></div>
                        </div>
                    </div>

                    <!-- SLIDE 4: Contextual Practice -->
                    <div class="slide" id="slide-4">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-book-open-reader"></i> Words in Action</h2>
                            <p class="section-intro__descriptor">Choose the best word to complete each sentence.</p>
                            <div class="interactive-module__steps" id="mcq-activity-1">
                                <p>6. The main goal of their campaign is to raise _______ about the dangers of single-use plastics.
                                    <select data-answer="awareness"><option>Select...</option><option>awareness</option><option>conservation</option><option>petition</option></select>
                                </p>
                                <p>7. Thousands of people joined the _______ in the city centre to demand government action on climate change.
                                    <select data-answer="protest"><option>Select...</option><option>boycott</option><option>protest</option><option>conservation</option></select>
                                </p>
                                <p>8. Many consumers are starting to _______ brands that use unsustainable palm oil in their products.
                                    <select data-answer="boycott"><option>Select...</option><option>boycott</option><option>protest</option><option>petition</option></select>
                                </p>
                                <p>9. The online _______ to save the local forest has already gathered over 50,000 signatures.
                                    <select data-answer="petition"><option>Select...</option><option>awareness</option><option>conservation</option><option>petition</option></select>
                                </p>
                                <p>10. The national park is dedicated to the _______ of endangered species and their habitats.
                                    <select data-answer="conservation"><option>Select...</option><option>boycott</option><option>protest</option><option>conservation</option></select>
                                </p>
                            </div>
                            <div class="activity-actions">
                                <button class="activity-btn" onclick="checkSelectAnswers('mcq-activity-1')">Check Answers</button>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 5: Task 1 - Ranking Actions -->
                    <div class="slide" id="slide-5">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-arrow-up-9-1"></i> What's Most Effective?</h2>
                            <p class="section-intro__descriptor">With a partner, rank these actions from 1 (most effective) to 5 (least effective) for creating real change. Drag and drop to reorder. Be prepared to justify your ranking.</p>
                            
                            <!-- Activity Type: Ranking and Justification -->
                            <ol class="ranking-list" id="ranking-list-1">
                                <li class="ranking-item" draggable="true"><i class="fa-solid fa-grip-vertical rank-handle"></i> <span class="rank-number">1.</span> Signing an online petition.</li>
                                <li class="ranking-item" draggable="true"><i class="fa-solid fa-grip-vertical rank-handle"></i> <span class="rank-number">2.</span> Organizing a public protest.</li>
                                <li class="ranking-item" draggable="true"><i class="fa-solid fa-grip-vertical rank-handle"></i> <span class="rank-number">3.</span> Starting a boycott of a major company.</li>
                                <li class="ranking-item" draggable="true"><i class="fa-solid fa-grip-vertical rank-handle"></i> <span class="rank-number">4.</span> Volunteering for a conservation group.</li>
                                <li class="ranking-item" draggable="true"><i class="fa-solid fa-grip-vertical rank-handle"></i> <span class="rank-number">5.</span> Creating a social media campaign to raise awareness.</li>
                            </ol>
                            <div class="callout-card">
                                <h4 class="callout-card__title">Justify Your Choice</h4>
                                <p class="callout-card__body">Example: "We think a <strong>boycott</strong> is most effective because it directly affects a company's profits, which forces them to listen."</p>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 6: Classifying Actions -->
                    <div class="slide" id="slide-6">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-diagram-project"></i> Sort the Strategies</h2>
                            <div class="section-intro">
                                <h3 class="section-intro__title">Types of Action</h3>
                                <p class="section-intro__descriptor">Drag the actions from the bank into the correct category.</p>
                            </div>
                            <div id="drag-drop-activity-1">
                                <div class="draggable-bank">
                                    <div class="draggable" draggable="true" data-category="political">lobbying politicians</div>
                                    <div class="draggable" draggable="true" data-category="community">organizing a beach clean-up</div>
                                    <div class="draggable" draggable="true" data-category="political">writing to an MP</div>
                                    <div class="draggable" draggable="true" data-category="consumer">choosing fair-trade coffee</div>
                                    <div class="draggable" draggable="true" data-category="community">starting a community garden</div>
                                    <div class="draggable" draggable="true" data-category="consumer">avoiding fast fashion</div>
                                </div>
                                <div class="drop-zone-container">
                                    <div class="drop-zone" data-category="political"><h4>Political Action</h4></div>
                                    <div class="drop-zone" data-category="community"><h4>Community Action</h4></div>
                                    <div class="drop-zone" data-category="consumer"><h4>Consumer Action</h4></div>
                                </div>
                            </div>
                            <div class="activity-actions">
                                <button class="activity-btn" onclick="checkDragDrop('drag-drop-activity-1')">Check Answers</button>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 7: Collocation Practice -->
                    <div class="slide" id="slide-7">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-spell-check"></i> Speak Like an Activist</h2>
                            <div class="section-intro">
                                <h3 class="section-intro__title">Common Collocations</h3>
                                <p class="section-intro__descriptor">Choose the correct verb to complete each phrase.</p>
                            </div>
                            <div class="interactive-module__steps" id="collocation-activity-1">
                                <p>7. <select data-answer="Launch"><option>Select...</option><option>Launch</option><option>Hold</option><option>Write</option></select> a campaign</p>
                                <p>8. <select data-answer="Stage"><option>Select...</option><option>Stage</option><option>Raise</option><option>Write</option></select> a demonstration</p>
                                <p>9. <select data-answer="Hold"><option>Select...</option><option>Hold</option><option>Launch</option><option>Lobby</option></select> a company accountable</p>
                                <p>10. <select data-answer="Distribute"><option>Select...</option><option>Distribute</option><option>Stage</option><option>Raise</option></select> leaflets</p>
                            </div>
                            <div class="activity-actions">
                                <button class="activity-btn" onclick="checkSelectAnswers('collocation-activity-1')">Check Answers</button>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 8: Task 2 - Personal Activist Profile -->
                    <div class="slide" id="slide-8">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-user-check"></i> What Kind of Activist Are You?</h2>
                            <p class="section-intro__descriptor">Rate how likely you would be to do each action. Then, discuss your choices with a partner, explaining why some actions appeal to you more than others.</p>
                            
                            <!-- Activity Type: Matrix Grid completion followed by personalized discussion -->
                            <div class="data-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Action</th>
                                            <th style="text-align: center;">Very Likely</th>
                                            <th style="text-align: center;">Perhaps</th>
                                            <th style="text-align: center;">Unlikely</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Write to an MP</td>
                                            <td style="text-align: center;"><input type="radio" name="action1"></td>
                                            <td style="text-align: center;"><input type="radio" name="action1"></td>
                                            <td style="text-align: center;"><input type="radio" name="action1"></td>
                                        </tr>
                                        <tr>
                                            <td>Launch an online campaign</td>
                                            <td style="text-align: center;"><input type="radio" name="action2"></td>
                                            <td style="text-align: center;"><input type="radio" name="action2"></td>
                                            <td style="text-align: center;"><input type="radio" name="action2"></td>
                                        </tr>
                                        <tr>
                                            <td>Boycott a brand</td>
                                            <td style="text-align: center;"><input type="radio" name="action3"></td>
                                            <td style="text-align: center;"><input type="radio" name="action3"></td>
                                            <td style="text-align: center;"><input type="radio" name="action3"></td>
                                        </tr>
                                        <tr>
                                            <td>Organize a community clean-up</td>
                                            <td style="text-align: center;"><input type="radio" name="action4"></td>
                                            <td style="text-align: center;"><input type="radio" name="action4"></td>
                                            <td style="text-align: center;"><input type="radio" name="action4"></td>
                                        </tr>
                                        <tr>
                                            <td>Stage a peaceful demonstration</td>
                                            <td style="text-align: center;"><input type="radio" name="action5"></td>
                                            <td style="text-align: center;"><input type="radio" name="action5"></td>
                                            <td style="text-align: center;"><input type="radio" name="action5"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 9: Case Study - The Riverwood Cleanup -->
                    <div class="slide" id="slide-9">
                        <div class="slide-content layout--columns">
                            <div class="slide-section">
                                <h2 class="slide-title"><i class="fa-solid fa-people-group"></i> The Riverwood Guardians</h2>
                                <p class="section-intro__descriptor">Explore how one community combined different actions to drive change.</p>
                                <div class="callout-card">
                                    <p class="callout-card__body">The town of Riverwood faced a polluted river caused by a local factory. A citizen group, the "Riverwood Guardians," organized weekly clean-ups to raise awareness, gathered 10,000 signatures on a petition demanding better filters, and lobbied politicians with scientific evidence. After six months of pressure, the factory installed cleaner technology, proving how coordinated action can deliver results.</p>
                                </div>
                            </div>
                            <div class="slide-section" id="table-completion-1">
                                <h3 class="section-intro__title">Complete the Campaign Snapshot</h3>
                                <p>Who: <input type="text" data-answer="Riverwood Guardians"></p>
                                <p>What was the problem: <input type="text" data-answer="river was polluted"></p>
                                <p>When did it start: <input type="text" data-answer="2022"></p>
                                <p>Methods Used: <input type="text" data-answer="clean-ups, petition, lobbying"></p>
                                <p>Final Result: <input type="text" data-answer="factory installed cleaner technology"></p>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 10: Reading for Detail -->
                    <div class="slide" id="slide-10">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-magnifying-glass-chart"></i> Check Your Understanding</h2>
                            <p class="section-intro__descriptor">Answer the questions about the Riverwood campaign.</p>
                            <div class="interactive-module__steps" id="mcq-activity-2">
                                <p>6. What was the first action the Riverwood Guardians took?
                                    <select data-answer="c"><option>Select...</option><option value="a">a) They started a petition.</option><option value="b">b) They lobbied politicians.</option><option value="c">c) They organized clean-ups.</option></select>
                                </p>
                                <p>7. The main purpose of the petition was to:
                                    <select data-answer="b"><option>Select...</option><option value="a">a) Raise awareness.</option><option value="b">b) Demand the factory install filters.</option><option value="c">c) Get media attention.</option></select>
                                </p>
                                <p>8. What did they use when lobbying politicians?
                                    <select data-answer="b"><option>Select...</option><option value="a">a) Media articles.</option><option value="b">b) Scientific evidence.</option><option value="c">c) The petition signatures.</option></select>
                                </p>
                                <p>9. How long did the campaign last?
                                    <select data-answer="b"><option>Select...</option><option value="a">a) One year.</option><option value="b">b) Six months.</option><option value="c">c) A few weeks.</option></select>
                                </p>
                                <p>10. The campaign's success shows that:
                                    <select data-answer="c"><option>Select...</option><option value="a">a) Lobbying is the only effective method.</option><option value="b">b) Factories are always willing to change.</option><option value="c">c) Persistent community action can work.</option></select>
                                </p>
                            </div>
                            <div class="activity-actions">
                                <button class="activity-btn" onclick="checkSelectAnswers('mcq-activity-2')">Check Answers</button>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 11: Task 3 - Interview an Activist -->
                    <div class="slide" id="slide-11">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-microphone-lines"></i> Behind the Campaign</h2>
                            <p class="section-intro__descriptor">Work in pairs. Student A: You are a journalist. Student B: You are a member of the Riverwood Guardians. The journalist will interview the activist about the campaign. Use the prompts to help you. Swap roles after 5 minutes.</p>
                            
                            <!-- Activity Type: Role-play -->
                            <div class="chat-prompts layout--columns">
                                <div class="chat-message">
                                    <h4 class="chat-message__sender">Journalist (Student A)</h4>
                                    <ul class="chat-message__body">
                                        <li>What was the biggest challenge you faced?</li>
                                        <li>Which method do you think was most effective? Why?</li>
                                        <li>What advice would you give to other communities?</li>
                                        <li>How did you keep your group motivated?</li>
                                    </ul>
                                </div>
                                <div class="chat-message">
                                    <h4 class="chat-message__sender">Activist (Student B)</h4>
                                    <ul class="chat-message__body">
                                        <li>To begin with, we felt...</li>
                                        <li>The key to our success was...</li>
                                        <li>It was difficult, but we managed to...</li>
                                        <li>My advice would be to never give up and to...</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 12: Planning the Conversation -->
                    <div class="slide" id="slide-12">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-people-arrows"></i> Sequence the Strategy Talk</h2>
                            <p class="section-intro__descriptor">Put the sentences in order to build a logical planning conversation.</p>
                            <ul class="ordering-list" id="ordering-list-1">
                                <li class="order-item" draggable="true" data-order="4"><i class="fa-solid fa-grip-vertical order-handle"></i> B: I agree. So, we should focus on raising awareness first.</li>
                                <li class="order-item" draggable="true" data-order="2"><i class="fa-solid fa-grip-vertical order-handle"></i> A: How about we start a petition to ban plastic bags in our town?</li>
                                <li class="order-item" draggable="true" data-order="3"><i class="fa-solid fa-grip-vertical order-handle"></i> B: That's a good idea, but maybe we should start with something smaller.</li>
                                <li class="order-item" draggable="true" data-order="1"><i class="fa-solid fa-grip-vertical order-handle"></i> A: Okay, so the first issue to tackle is plastic waste.</li>
                                <li class="order-item" draggable="true" data-order="5"><i class="fa-solid fa-grip-vertical order-handle"></i> A: Exactly. We could create some posters for local shops.</li>
                            </ul>
                            <div class="activity-actions">
                                <button class="activity-btn" onclick="checkOrdering('ordering-list-1')">Check Order</button>
                                <div class="feedback"></div>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 13: Functional Language Focus -->
                    <div class="slide" id="slide-13">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-language"></i> Choose the Best Phrase</h2>
                            <p class="section-intro__descriptor">Complete each sentence with the most appropriate planning phrase.</p>
                            <div class="gap-fill-box">
                                <p>Phrases:</p>
                                <span>What if we...</span>
                                <span>We need to consider...</span>
                                <span>My main concern is...</span>
                                <span>I suggest that...</span>
                                <span>Another point is that...</span>
                            </div>
                            <div class="interactive-module__steps" id="gap-fill-1">
                                <p>6. <select data-answer="My main concern is..."><option>Select...</option><option>What if we...</option><option>We need to consider...</option><option>My main concern is...</option><option>I suggest that...</option><option>Another point is that...</option></select> we don't have enough volunteers.</p>
                                <p>7. <select data-answer="We need to consider..."><option>Select...</option><option>What if we...</option><option>We need to consider...</option><option>My main concern is...</option><option>I suggest that...</option><option>Another point is that...</option></select> the budget for printing materials.</p>
                                <p>8. <select data-answer="I suggest that..."><option>Select...</option><option>What if we...</option><option>We need to consider...</option><option>My main concern is...</option><option>I suggest that...</option><option>Another point is that...</option></select> we create a social media page first.</p>
                                <p>9. <select data-answer="What if we..."><option>Select...</option><option>What if we...</option><option>We need to consider...</option><option>My main concern is...</option><option>I suggest that...</option><option>Another point is that...</option></select> organized a community litter pick?</p>
                                <p>10. <select data-answer="Another point is that..."><option>Select...</option><option>What if we...</option><option>We need to consider...</option><option>My main concern is...</option><option>I suggest that...</option><option>Another point is that...</option></select> we need permission from the council for some activities.</p>
                            </div>
                            <div class="activity-actions">
                                <button class="activity-btn" onclick="checkSelectAnswers('gap-fill-1')">Check Answers</button>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 14: Task 4 - Your Eco-Action Plan -->
                    <div class="slide" id="slide-14">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-clipboard-list"></i> Design Your Campaign</h2>
                            <p class="section-intro__descriptor">In small groups, choose a local environmental issue (e.g., too much traffic, not enough recycling bins, a park in need of care). Use the framework below to create a simple action plan for a campaign. Prepare to present your main ideas to the class.</p>
                            
                            <!-- Activity Type: Collaborative Project Planning and Presentation -->
                            <div class="note-card">
                                <h3 class="note-card__header"><i class="fa-solid fa-pen-ruler"></i> Our Campaign Plan</h3>
                                <div class="layout-grid">
                                    <div class="layout-grid__column">
                                        <label for="issue"><strong>The Issue:</strong> What is the problem? Why is it important?</label>
                                        <textarea id="issue" placeholder="e.g., Not enough recycling bins on High Street..."></textarea>
                                        
                                        <label for="goal"><strong>Campaign Goal:</strong> What is your specific, achievable goal?</label>
                                        <textarea id="goal" placeholder="e.g., To get 3 new recycling bins installed on High Street."></textarea>
                                        
                                        <label for="target"><strong>Target Audience:</strong> Who are you trying to influence?</label>
                                        <textarea id="target" placeholder="e.g., The local council, a specific business, the public..."></textarea>
                                    </div>
                                    <div class="layout-grid__column">
                                        <label for="name"><strong>Campaign Name & Slogan:</strong></label>
                                        <textarea id="name" placeholder="e.g., High Street Recycles! / A greener street for a greener town."></textarea>
                                        
                                        <label for="actions"><strong>Action Plan (Methods):</strong> What 2-3 actions will you take?</label>
                                        <textarea id="actions" placeholder="Use language from the lesson: petition, raise awareness, lobby, organize, etc..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 15: Lesson Reflection -->
                    <div class="slide" id="slide-15">
                        <div class="slide-content">
                            <h2 class="slide-title"><i class="fa-solid fa-lightbulb"></i> Final Thoughts</h2>
                            <p class="section-intro__descriptor">Individually, think about these questions. Share one thought with your partner.</p>
                            
                            <!-- Activity Type: Individual Reflection -->
                            <div class="reflection-grid">
                                <div class="reflection-card">
                                    <h3 class="reflection-card__title">New Language</h3>
                                    <p class="reflection-card__body">What was the most interesting new word or phrase you learned today?</p>
                                </div>
                                <div class="reflection-card">
                                    <h3 class="reflection-card__title">Confidence</h3>
                                    <p class="reflection-card__body">Do you feel more confident discussing environmental issues in English?</p>
                                </div>
                                <div class="reflection-card">
                                    <h3 class="reflection-card__title">Next Step</h3>
                                    <p class="reflection-card__body">What is one small "eco-activist" step you could take in your own life this week?</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="annotation-popover" role="dialog" aria-hidden="true" aria-label="Add or edit annotation">
                    <form id="annotation-form" class="annotation-popover__form" autocomplete="off">
                        <div class="annotation-popover__field">
                            <label class="annotation-popover__label" for="annotation-comment">Annotation</label>
                            <textarea id="annotation-comment" class="annotation-popover__textarea" placeholder="Add a note about this highlight"></textarea>
                        </div>
                        <div class="annotation-popover__field">
                            <span class="annotation-popover__label">Highlight colour</span>
                            <div class="annotation-popover__color-input">
                                <input type="color" id="annotation-color" class="annotation-popover__color-picker" value="#d9cdb4" aria-label="Choose highlight colour">
                                <span class="annotation-popover__hint">Adjust the shade to organise your notes.</span>
                            </div>
                        </div>
                        <p class="annotation-popover__hint">Select text to create a highlight. Click an existing highlight to edit or remove it.</p>
                        <div class="annotation-popover__actions">
                            <button type="button" class="activity-btn secondary" id="annotation-delete" hidden>
                                <i class="fa-solid fa-trash-can" aria-hidden="true"></i> Remove
                            </button>
                            <button type="button" class="activity-btn secondary" id="annotation-cancel">
                                <i class="fa-solid fa-xmark" aria-hidden="true"></i> Cancel
                            </button>
                            <button type="submit" class="activity-btn" id="annotation-save">
                                <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> Save
                            </button>
                        </div>
                    </form>
                </div>
                <div id="annotation-tooltip" role="tooltip" aria-hidden="true"></div>

                <!-- SLIDE NAVIGATION -->
                <div class="slide-status-bar">
                    <div class="slide-status-bar__progress">
                        <div class="slide-status-bar__progress-track">
                            <div class="slide-status-bar__progress-fill" id="progress-fill"></div>
                        </div>
                    </div>
                    <div class="slide-status-bar__row">
                        <p class="slide-status-bar__count" id="slide-counter">Slide 1 of 15</p>
                        <div class="slide-status-bar__actions">
                            <button class="activity-btn secondary" id="prev-btn" disabled><i class="fa-solid fa-arrow-left"></i> Previous</button>
                            <button class="activity-btn" id="next-btn">Next <i class="fa-solid fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const slidesRoot = document.getElementById('slides-root');
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const slideCounter = document.getElementById('slide-counter');
    const progressFill = document.getElementById('progress-fill');
    const saveAnnotationsBtn = document.getElementById('save-annotations-btn');
    const loadAnnotationsBtn = document.getElementById('load-annotations-btn');
    const loadAnnotationsInput = document.getElementById('load-annotations-input');
    const annotationPopover = document.getElementById('annotation-popover');
    const annotationForm = document.getElementById('annotation-form');
    const annotationComment = document.getElementById('annotation-comment');
    const annotationColor = document.getElementById('annotation-color');
    const annotationCancelBtn = document.getElementById('annotation-cancel');
    const annotationDeleteBtn = document.getElementById('annotation-delete');
    const annotationTooltip = document.getElementById('annotation-tooltip');
    const defaultHighlightColor = '#d9cdb4';

    let slides = [];
    let totalSlides = 0;
    let currentSlide = 0;
    let pendingRange = null;
    let activeHighlight = null;
    let annotationMode = 'create';

    function refreshSlides() {
        slides = Array.from(slidesRoot.querySelectorAll('.slide'));
        totalSlides = slides.length;
        if (!totalSlides) {
            slideCounter.textContent = 'Slide 0 of 0';
            progressFill.style.setProperty('--progress', '0%');
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
        }

        const activeIndex = slides.findIndex(slide => slide.classList.contains('active'));
        currentSlide = activeIndex >= 0 ? activeIndex : Math.min(currentSlide, totalSlides - 1);
        updateSlideView();
    }

    function updateSlideView() {
        if (!slides.length) return;

        slides.forEach((slide, index) => {
            slide.classList.toggle('active', index === currentSlide);
        });

        slideCounter.textContent = `Slide ${currentSlide + 1} of ${totalSlides}`;
        const progressPercentage = totalSlides <= 1 ? 100 : (currentSlide / (totalSlides - 1)) * 100;
        progressFill.style.setProperty('--progress', `${progressPercentage}%`);

        prevBtn.disabled = currentSlide === 0;
        nextBtn.disabled = currentSlide === totalSlides - 1;
    }

    nextBtn.addEventListener('click', () => {
        if (currentSlide < totalSlides - 1) {
            currentSlide += 1;
            updateSlideView();
        }
    });

    prevBtn.addEventListener('click', () => {
        if (currentSlide > 0) {
            currentSlide -= 1;
            updateSlideView();
        }
    });

    refreshSlides();
    initializeActivities();

    if (saveAnnotationsBtn) {
        saveAnnotationsBtn.addEventListener('click', () => {
            const exportPayload = {
                savedAt: new Date().toISOString(),
                documentTitle: document.title,
                slidesHtml: slidesRoot.innerHTML
            };
            const blob = new Blob([JSON.stringify(exportPayload, null, 2)], {
                type: 'application/json'
            });
            const fileName = `eco-activist-annotations-${Date.now()}.json`;
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        });
    }

    if (loadAnnotationsBtn && loadAnnotationsInput) {
        loadAnnotationsBtn.addEventListener('click', () => {
            loadAnnotationsInput.click();
        });

        loadAnnotationsInput.addEventListener('change', event => {
            const [file] = event.target.files || [];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = loadEvent => {
                try {
                    const payload = JSON.parse(loadEvent.target.result);
                    if (payload && typeof payload.slidesHtml === 'string') {
                        if (isPopoverOpen()) {
                            closeAnnotationPopover();
                        }
                        hideAnnotationTooltip();
                        slidesRoot.innerHTML = payload.slidesHtml;
                        refreshSlides();
                        initializeActivities();
                    } else {
                        window.alert('The selected file does not contain any slides to load.');
                    }
                } catch (error) {
                    console.error('Unable to load annotations', error);
                    window.alert('We could not load that file. Please choose a valid annotations export.');
                } finally {
                    loadAnnotationsInput.value = '';
                }
            };
            reader.readAsText(file);
        });
    }

    if (
        annotationPopover &&
        annotationForm &&
        annotationComment &&
        annotationColor &&
        annotationCancelBtn &&
        annotationDeleteBtn &&
        annotationTooltip
    ) {
        annotationPopover.setAttribute('aria-hidden', 'true');
        annotationTooltip.setAttribute('aria-hidden', 'true');

        slidesRoot.addEventListener('mouseup', handleSelectionMouseUp);
        slidesRoot.addEventListener('click', handleHighlightClick);
        slidesRoot.addEventListener('mouseover', handleHighlightHover);
        slidesRoot.addEventListener('mouseout', handleHighlightLeave);
        slidesRoot.addEventListener('focusin', handleHighlightFocus);
        slidesRoot.addEventListener('focusout', handleHighlightBlur);

        annotationForm.addEventListener('submit', handleAnnotationSave);
        annotationCancelBtn.addEventListener('click', () => closeAnnotationPopover());
        annotationDeleteBtn.addEventListener('click', handleAnnotationDelete);

        document.addEventListener('click', handleDocumentClick);
        document.addEventListener('keydown', handleKeydown);
        document.addEventListener('scroll', handleViewportShift, true);
        window.addEventListener('resize', handleViewportShift);
    }

    function initializeActivities() {
        initializeMatching();
        enableDragSort('ranking-list-1');
        enableDragSort('ordering-list-1');
        initializeDragDropCategories();
    }

    function initializeMatching() {
        const matchingActivity = document.getElementById('matching-activity-1');
        if (!matchingActivity || matchingActivity.dataset.initialized === 'true') return;

        const items = matchingActivity.querySelectorAll('.match-item');
        let selected = null;

        items.forEach(item => {
            item.addEventListener('click', () => {
                if (!selected) {
                    selected = item;
                    item.classList.add('selected');
                } else {
                    if (selected.dataset.match === item.dataset.match && selected !== item) {
                        selected.classList.add('correct');
                        item.classList.add('correct');
                        selected.classList.remove('selected');
                        selected.style.pointerEvents = 'none';
                        item.style.pointerEvents = 'none';
                        selected = null;
                    } else {
                        selected.classList.add('incorrect');
                        item.classList.add('incorrect');
                        setTimeout(() => {
                            if (selected) {
                                selected.classList.remove('incorrect', 'selected');
                            }
                            item.classList.remove('incorrect');
                            selected = null;
                        }, 800);
                    }
                }
            });
        });

        matchingActivity.dataset.initialized = 'true';
    }

    function enableDragSort(listId) {
        const list = document.getElementById(listId);
        if (!list || list.dataset.dragSortBound === 'true') return;

        let draggingItem = null;

        list.querySelectorAll('li').forEach(item => {
            item.addEventListener('dragstart', event => {
                draggingItem = event.target;
                event.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragover', event => {
                event.preventDefault();
                const targetItem = event.target.closest('li');
                if (!draggingItem || !targetItem || draggingItem === targetItem) return;

                const bounding = targetItem.getBoundingClientRect();
                const offset = bounding.y + bounding.height / 2;
                if (event.clientY - offset > 0) {
                    targetItem.after(draggingItem);
                } else {
                    targetItem.before(draggingItem);
                }
                updateRankingNumbers(listId);
            });
        });

        list.dataset.dragSortBound = 'true';
    }

    function updateRankingNumbers(listId) {
        const list = document.getElementById(listId);
        if (!list) return;
        const items = list.querySelectorAll('.rank-number');
        items.forEach((num, index) => {
            num.textContent = `${index + 1}.`;
        });
    }

    function initializeDragDropCategories() {
        const container = document.getElementById('drag-drop-activity-1');
        if (!container || container.dataset.dragBound === 'true') return;

        const draggables = container.querySelectorAll('.draggable');
        const dropZones = container.querySelectorAll('.drop-zone');

        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', () => {
                draggable.classList.add('dragging');
            });
            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('dragging');
            });
        });

        dropZones.forEach(zone => {
            zone.addEventListener('dragover', event => {
                event.preventDefault();
                const draggable = container.querySelector('.dragging');
                if (draggable) {
                    zone.appendChild(draggable);
                }
            });

            zone.addEventListener('drop', event => {
                event.preventDefault();
                const draggable = container.querySelector('.dragging');
                if (draggable) {
                    zone.appendChild(draggable);
                }
            });
        });

        container.dataset.dragBound = 'true';
    }

    function handleSelectionMouseUp() {
        if (!annotationPopover || annotationPopover.getAttribute('aria-hidden') === 'false') return;

        setTimeout(() => {
            const range = getValidRange();
            if (!range) return;

            const startHighlight = range.startContainer.parentElement && range.startContainer.parentElement.closest('.annotation-highlight');
            const endHighlight = range.endContainer.parentElement && range.endContainer.parentElement.closest('.annotation-highlight');

            if (startHighlight && startHighlight === endHighlight) {
                openEditPopover(startHighlight);
                window.getSelection().removeAllRanges();
                return;
            }

            pendingRange = range;
            openCreatePopover(range);
        }, 0);
    }

    function getValidRange() {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0 || selection.isCollapsed) return null;

        const range = selection.getRangeAt(0).cloneRange();
        if (!slidesRoot.contains(range.startContainer) || !slidesRoot.contains(range.endContainer)) {
            return null;
        }

        return range.toString().trim() ? range : null;
    }

    function openCreatePopover(range) {
        annotationMode = 'create';
        activeHighlight = null;
        annotationForm.reset();
        annotationColor.value = defaultHighlightColor;
        annotationDeleteBtn.hidden = true;
        hideAnnotationTooltip();
        showPopover(getRectFromRange(range));
        window.getSelection().removeAllRanges();
    }

    function openEditPopover(highlight) {
        annotationMode = 'edit';
        activeHighlight = highlight;
        pendingRange = null;
        annotationComment.value = highlight.dataset.comment || '';
        annotationColor.value = highlight.dataset.color || defaultHighlightColor;
        annotationDeleteBtn.hidden = false;
        hideAnnotationTooltip();
        showPopover(highlight.getBoundingClientRect());
        window.getSelection().removeAllRanges();
    }

    function showPopover(rect) {
        if (!rect) return;
        annotationPopover.style.display = 'block';
        annotationPopover.setAttribute('aria-hidden', 'false');
        requestAnimationFrame(() => {
            positionPopover(rect);
            annotationComment.focus({ preventScroll: true });
        });
    }

    function positionPopover(rect) {
        const padding = 16;
        const popoverWidth = annotationPopover.offsetWidth;
        const popoverHeight = annotationPopover.offsetHeight;
        let top = rect.bottom + window.scrollY + 12;
        if (top + popoverHeight > window.scrollY + window.innerHeight - padding) {
            top = rect.top + window.scrollY - popoverHeight - 12;
        }
        top = Math.max(window.scrollY + padding, top);

        let left = rect.left + window.scrollX;
        if (left + popoverWidth > window.scrollX + window.innerWidth - padding) {
            left = window.scrollX + window.innerWidth - popoverWidth - padding;
        }
        left = Math.max(window.scrollX + padding, left);

        annotationPopover.style.top = `${top}px`;
        annotationPopover.style.left = `${left}px`;
    }

    function getRectFromRange(range) {
        const rects = range.getClientRects();
        if (rects.length) {
            return rects[0];
        }
        return range.getBoundingClientRect();
    }

    function closeAnnotationPopover() {
        annotationPopover.style.display = 'none';
        annotationPopover.setAttribute('aria-hidden', 'true');
        annotationForm.reset();
        annotationColor.value = defaultHighlightColor;
        annotationDeleteBtn.hidden = true;
        pendingRange = null;
        activeHighlight = null;
        annotationMode = 'create';
    }

    function handleAnnotationSave(event) {
        event.preventDefault();
        const comment = annotationComment.value.trim();
        const color = annotationColor.value || defaultHighlightColor;

        if (annotationMode === 'create' && pendingRange) {
            createHighlight(pendingRange, comment, color);
        } else if (annotationMode === 'edit' && activeHighlight) {
            updateHighlight(activeHighlight, comment, color);
        }

        hideAnnotationTooltip();
        window.getSelection().removeAllRanges();
        closeAnnotationPopover();
    }

    function createHighlight(range, comment, color) {
        const highlight = document.createElement('span');
        highlight.className = 'annotation-highlight';
        highlight.dataset.annotationId = `annotation-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
        highlight.dataset.comment = comment;
        highlight.dataset.color = color;
        highlight.style.setProperty('--annotation-color', color || defaultHighlightColor);
        highlight.setAttribute('tabindex', '0');
        highlight.setAttribute('role', 'note');
        highlight.setAttribute('aria-label', comment ? `Annotation: ${comment}` : 'Annotation highlight');

        const fragment = range.extractContents();
        highlight.appendChild(fragment);
        range.insertNode(highlight);
        highlight.normalize();
        slidesRoot.normalize();
    }

    function updateHighlight(highlight, comment, color) {
        highlight.dataset.comment = comment;
        highlight.dataset.color = color;
        highlight.style.setProperty('--annotation-color', color || defaultHighlightColor);
        highlight.setAttribute('aria-label', comment ? `Annotation: ${comment}` : 'Annotation highlight');
    }

    function handleAnnotationDelete() {
        if (!activeHighlight) return;
        const highlight = activeHighlight;
        closeAnnotationPopover();
        unwrapHighlight(highlight);
        hideAnnotationTooltip();
    }

    function unwrapHighlight(highlight) {
        const parent = highlight.parentNode;
        while (highlight.firstChild) {
            parent.insertBefore(highlight.firstChild, highlight);
        }
        highlight.remove();
        parent.normalize();
    }

    function handleHighlightClick(event) {
        const highlight = event.target.closest('.annotation-highlight');
        if (!highlight || !annotationPopover) return;
        event.preventDefault();
        openEditPopover(highlight);
    }

    function handleHighlightHover(event) {
        if (!annotationTooltip || isPopoverOpen()) return;
        const highlight = event.target.closest('.annotation-highlight');
        if (!highlight) return;
        showAnnotationTooltip(highlight);
    }

    function handleHighlightLeave(event) {
        if (!annotationTooltip) return;
        const highlight = event.target.closest('.annotation-highlight');
        if (!highlight) return;
        const relatedHighlight = event.relatedTarget && event.relatedTarget.closest('.annotation-highlight');
        if (relatedHighlight === highlight) return;
        hideAnnotationTooltip();
    }

    function handleHighlightFocus(event) {
        const highlight = event.target.closest('.annotation-highlight');
        if (!highlight || !annotationTooltip) return;
        showAnnotationTooltip(highlight);
    }

    function handleHighlightBlur() {
        hideAnnotationTooltip();
    }

    function showAnnotationTooltip(highlight) {
        const comment = highlight.dataset.comment;
        if (!comment) {
            hideAnnotationTooltip();
            return;
        }
        annotationTooltip.textContent = comment;
        annotationTooltip.style.display = 'block';
        annotationTooltip.setAttribute('aria-hidden', 'false');
        requestAnimationFrame(() => {
            positionTooltip(highlight.getBoundingClientRect());
        });
    }

    function hideAnnotationTooltip() {
        if (!annotationTooltip) return;
        annotationTooltip.style.display = 'none';
        annotationTooltip.setAttribute('aria-hidden', 'true');
        annotationTooltip.textContent = '';
    }

    function positionTooltip(rect) {
        const padding = 12;
        const tooltipWidth = annotationTooltip.offsetWidth;
        const tooltipHeight = annotationTooltip.offsetHeight;
        let top = rect.top + window.scrollY - tooltipHeight - 12;
        if (top < window.scrollY + padding) {
            top = rect.bottom + window.scrollY + 12;
        }
        let left = rect.left + window.scrollX;
        if (left + tooltipWidth > window.scrollX + window.innerWidth - padding) {
            left = window.scrollX + window.innerWidth - tooltipWidth - padding;
        }
        left = Math.max(window.scrollX + padding, left);
        annotationTooltip.style.top = `${top}px`;
        annotationTooltip.style.left = `${left}px`;
    }

    function handleDocumentClick(event) {
        if (!isPopoverOpen()) return;
        if (annotationPopover.contains(event.target)) return;
        if (event.target.closest('.annotation-highlight')) return;
        closeAnnotationPopover();
    }

    function handleKeydown(event) {
        if (event.key === 'Escape' && isPopoverOpen()) {
            closeAnnotationPopover();
            hideAnnotationTooltip();
        }
    }

    function handleViewportShift() {
        if (isPopoverOpen()) {
            if (annotationMode === 'edit' && activeHighlight) {
                positionPopover(activeHighlight.getBoundingClientRect());
            } else if (annotationMode === 'create' && pendingRange) {
                const rect = getRectFromRange(pendingRange);
                if (rect) {
                    positionPopover(rect);
                }
            }
        }
        hideAnnotationTooltip();
    }

    function isPopoverOpen() {
        return annotationPopover && annotationPopover.getAttribute('aria-hidden') === 'false';
    }
});

// --- GLOBAL CHECKING FUNCTIONS ---
function checkSelectAnswers(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const selects = container.querySelectorAll('select');
    let allCorrect = true;
    selects.forEach(select => {
        const isCorrect = select.value === select.dataset.answer;
        select.style.borderColor = isCorrect ? '#28a745' : '#dc3545';
        select.style.backgroundColor = isCorrect ? '#e9f5ec' : '#fbe9eb';
        if (!isCorrect) allCorrect = false;
    });
}

function checkDragDrop(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const dropZones = container.querySelectorAll('.drop-zone');
    dropZones.forEach(zone => {
        const items = zone.querySelectorAll('.draggable');
        items.forEach(item => {
            const isCorrect = item.dataset.category === zone.dataset.category;
            item.style.borderColor = isCorrect ? '#28a745' : '#dc3545';
            item.style.backgroundColor = isCorrect ? '#e9f5ec' : '#fbe9eb';
        });
    });
}

function checkOrdering(listId) {
    const list = document.getElementById(listId);
    if (!list) return;
    const items = list.querySelectorAll('li');
    let allCorrect = true;
    items.forEach((item, index) => {
        const isCorrect = parseInt(item.dataset.order) === (index + 1);
        item.style.borderColor = isCorrect ? '#28a745' : '#dc3545';
        item.style.backgroundColor = isCorrect ? '#e9f5ec' : '#fbe9eb';
        if (!isCorrect) allCorrect = false;
    });
    
    const feedbackEl = list.parentElement.querySelector('.feedback');
    if(feedbackEl){
        feedbackEl.style.display = 'block';
        if(allCorrect){
            feedbackEl.textContent = 'Perfect! The conversation is in the correct order.';
            feedbackEl.className = 'feedback correct';
        } else {
            feedbackEl.textContent = 'Not quite right. Try reordering the sentences.';
            feedbackEl.className = 'feedback incorrect';
        }
    }
}
</script>

</body>
</html>
