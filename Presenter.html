<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noor Community Mentoring Program</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Questrial&display=swap" rel="stylesheet">
    
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        /* =====================================================================
           Organic Sage UI â€” Mobile-first, stable, and soothing
           Palette preserved; accessibility + mobile ergonomics improved.
           (Strictly adhering to provided CSS)
           ===================================================================== */

        /* ------------------------------- Design tokens ----------------------------------*/
        :root {
            --primary-sage: #7A8471;
            --secondary-sage: #9CAF88;
            --tertiary-sage: #B8C5A6;
            --warm-cream: #F8F6F0;
            --soft-white: #FEFCF7;
            --forest-shadow: #5A6B52;
            --border-sage: rgba(122, 132, 113, 0.20);
            --hover-sage: rgba(156, 175, 136, 0.15);

            --deep-forest: #3E4A3A;
            --moss: #6E7A67;
            --fern: #8FA081;
            --dried-clay: #D9CDB4;
            --amber: #C6AA77;
            --ink: #2F3A2B;
            --ink-muted: #5A6B52;

            --font-display: 'Questrial', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-body: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;

            --step--1: clamp(0.875rem, 0.84rem + 0.15vw, 0.95rem);
            --step-0: clamp(1rem, 0.96rem + 0.22vw, 1.1rem);
            --step-1: clamp(1.125rem, 1.07rem + 0.35vw, 1.3rem);
            --step-2: clamp(1.375rem, 1.28rem + 0.55vw, 1.6rem);
            --step-3: clamp(1.75rem, 1.58rem + 0.95vw, 2.1rem);
            --step-4: clamp(2.25rem, 1.98rem + 1.35vw, 2.7rem);

            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-7: 2rem;
            --space-8: 2.5rem;
            --space-9: 3rem;

            --radius-sm: 10px;
            --radius: 16px;
            --radius-lg: 20px;
            --radius-xl: 28px;

            --shadow-1: 0 1px 2px rgba(34, 41, 32, 0.05), 0 2px 8px rgba(34, 41, 32, 0.06);
            --shadow-2: 0 4px 18px rgba(34, 41, 32, 0.08), 0 12px 28px rgba(34, 41, 32, 0.06);
            --shadow-3: 0 10px 40px rgba(34, 41, 32, 0.10), 0 20px 60px rgba(34, 41, 32, 0.08);

            --ring: 0 0 0 3px color-mix(in oklab, var(--soft-white) 60%, transparent), 0 0 0 5px color-mix(in srgb, var(--secondary-sage), #2F3A2B 15%);

            --ease-ambient: cubic-bezier(.2,.8,.2,1);
            --dur-1: 120ms;
            --dur-2: 200ms;
            --dur-3: 320ms;

            --target-min: 44px;
            --container-max: clamp(720px, 64vw, 1080px);
            --workspace-max: 1500px;
        }

        /* ------------------------------- Global reset / mobile stability ----------------------------------*/
        *, *::before, *::after { box-sizing: border-box; }
        html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; hanging-punctuation: first last; }
        html, body {
            margin: 0; padding: 0; width: 100%; min-height: 100dvh;
            font-family: var(--font-body); font-size: var(--step-0); line-height: 1.6;
            color: var(--forest-shadow);
            background: radial-gradient(1200px 1200px at -10% -10%, #FFFFFF 0%, transparent 50%),
                        radial-gradient(1200px 1000px at 110% 10%, #FFF8F0 0%, transparent 50%),
                        linear-gradient(135deg, #F8F6F0 0%, #F5F3ED 100%);
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; overflow-x: hidden;
        }
        @media (prefers-reduced-motion: no-preference) { html { scroll-behavior: smooth; } }
        :where(p, h1, h2, h3, h4, h5, h6) { text-wrap: pretty; overflow-wrap: anywhere; }
        img, svg, video, canvas, audio, iframe { display: block; max-width: 100%; height: auto; }
        a { color: var(--primary-sage); text-decoration-thickness: 1px; text-underline-offset: 2px; }
        a:hover { color: var(--deep-forest); }
        .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }

        /* ------------------------------- App shell ----------------------------------*/
        #app-wrapper {
            display: flex; justify-content: center; align-items: stretch;
            padding: max(var(--space-7), env(safe-area-inset-top)) var(--space-4) var(--space-7);
            width: 100%; min-height: 100dvh;
            background: radial-gradient(800px 600px at 20% 0%, rgba(156,175,136,0.08) 0%, transparent 70%),
                        radial-gradient(700px 500px at 80% 100%, rgba(90,107,82,0.06) 0%, transparent 65%);
        }
        .skip-link {
            position: absolute;
            top: var(--space-3);
            left: 50%;
            transform: translate(-50%, -150%);
            background: var(--forest-shadow);
            color: #fff;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            font-weight: 700;
            z-index: 1000;
            transition: transform var(--dur-1) var(--ease-ambient);
        }
        .skip-link:focus {
            transform: translate(-50%, 0);
        }
        #activity-shell {
            width: min(100%, var(--workspace-max));
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
        }
        #activity-container {
            width: 100%; max-width: var(--container-max);
            background: color-mix(in srgb, var(--soft-white) 88%, white 12%);
            padding: clamp(24px, 3.2vw, 48px); border-radius: var(--radius-lg);
            border: 1px solid rgba(122, 132, 113, 0.12); box-shadow: var(--shadow-2);
            position: relative; isolation: isolate; container-type: inline-size;
        }
        @supports (backdrop-filter: blur(6px)) {
            #activity-container {
                background: color-mix(in srgb, var(--soft-white) 76%, white 24%);
                backdrop-filter: blur(6px) saturate(1.02);
            }
        }
        #activity-container::before {
            content: ""; position: absolute; inset: -1px; border-radius: inherit;
            background: radial-gradient(1200px 200px at 50% -5%, rgba(156,175,136,0.12), transparent 60%),
                        radial-gradient(800px 1000px at 50% 110%, rgba(122,132,113,0.08), transparent 70%);
            z-index: -1; pointer-events: none;
        }
        .screen { display: none; scroll-margin-top: clamp(90px, 12vh, 140px); } /* Hide screens initially */
        .screen.active { display: block; } /* Show active screen */

        /* ------------------------------- Interactive annotations ----------------------------------*/
        .highlight-annotation {
            background: color-mix(in srgb, var(--secondary-sage) 35%, white 65%);
            border-radius: var(--radius-sm);
            padding: 0 0.15em;
            cursor: pointer;
            transition: box-shadow var(--dur-1) var(--ease-ambient), background-color var(--dur-1) var(--ease-ambient);
            box-shadow: inset 0 -0.35em 0 rgba(198, 170, 119, 0.35);
            outline: none;
        }
        .highlight-annotation:focus-visible,
        .highlight-annotation:hover {
            box-shadow: inset 0 -0.35em 0 rgba(122, 132, 113, 0.4);
            background: color-mix(in srgb, var(--secondary-sage) 45%, white 55%);
        }
        .highlight-annotation[aria-expanded="true"] {
            box-shadow: inset 0 -0.35em 0 rgba(90, 107, 82, 0.45);
        }

        #highlight-toolbar {
            position: absolute;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--soft-white);
            border: 1px solid var(--border-sage);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-1);
            transform: translate(-50%, -120%);
            z-index: 2000;
            min-width: max-content;
        }
        #highlight-toolbar[hidden] {
            display: none;
        }
        .highlight-toolbar__btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            font: inherit;
            background: var(--secondary-sage);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--space-2) var(--space-4);
            cursor: pointer;
            transition: background-color var(--dur-1) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
        }
        .highlight-toolbar__btn:hover,
        .highlight-toolbar__btn:focus-visible {
            background: var(--forest-shadow);
        }
        .highlight-toolbar__btn:active {
            transform: scale(0.97);
        }

        .annotation-popover {
            position: absolute;
            max-width: min(320px, 80vw);
            padding: var(--space-4);
            background: var(--soft-white);
            border-radius: var(--radius);
            border: 1px solid var(--border-sage);
            box-shadow: var(--shadow-2);
            z-index: 2100;
            transform: translate(-50%, 0);
        }
        .annotation-popover[hidden] {
            display: none;
        }
        .annotation-popover::before {
            content: "";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 10px 10px 10px;
            border-style: solid;
            border-color: transparent transparent var(--soft-white) transparent;
        }
        .annotation-popover__close {
            background: none;
            border: none;
            color: var(--forest-shadow);
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius-sm);
        }
        .annotation-popover__close:hover,
        .annotation-popover__close:focus-visible {
            background: var(--hover-sage);
        }
        .annotation-popover__body {
            margin: 0;
            font-size: var(--step-0);
            color: var(--forest-shadow);
        }

        .annotation-composer {
            position: absolute;
            width: min(340px, 82vw);
            padding: var(--space-4);
            background: var(--soft-white);
            border-radius: var(--radius);
            border: 1px solid var(--border-sage);
            box-shadow: var(--shadow-2);
            z-index: 2050;
            transform: translate(-50%, 0);
        }
        .annotation-composer[hidden] {
            display: none;
        }
        .annotation-composer__label {
            display: block;
            font-weight: 700;
            margin-bottom: var(--space-2);
            color: var(--forest-shadow);
        }
        .annotation-composer__input {
            width: 100%;
            min-height: 96px;
            padding: var(--space-3);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-sage);
            font: inherit;
            resize: vertical;
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            color: var(--forest-shadow);
        }
        .annotation-composer__input:focus-visible {
            outline: none;
            box-shadow: var(--ring);
            border-color: var(--secondary-sage);
        }
        .annotation-composer__actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-2);
            margin-top: var(--space-3);
        }
        .annotation-composer__btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            font: inherit;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            transition: background-color var(--dur-1) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
        }
        .annotation-composer__btn:hover,
        .annotation-composer__btn:focus-visible {
            transform: translateY(-1px);
        }
        .annotation-composer__btn:active {
            transform: scale(0.97);
        }
        .annotation-composer__btn--primary {
            background: var(--secondary-sage);
            color: white;
        }
        .annotation-composer__btn--primary:hover,
        .annotation-composer__btn--primary:focus-visible {
            background: var(--forest-shadow);
        }
        .annotation-composer__btn--secondary {
            background: transparent;
            color: var(--forest-shadow);
            border: 1px solid var(--border-sage);
        }
        .annotation-composer__btn--secondary:hover,
        .annotation-composer__btn--secondary:focus-visible {
            background: var(--hover-sage);
        }

        /* ------------------------------- Headings / text ----------------------------------*/
        h1 {
            font-family: var(--font-display); font-size: var(--step-4); letter-spacing: 0.2px;
            color: var(--forest-shadow); margin: 0 0 var(--space-2) 0; text-align: center;
        }
        h2.rubric {
            font-family: var(--font-body); font-size: var(--step-0); font-weight: 500;
            color: var(--secondary-sage); margin: 0 0 var(--space-6) 0; text-align: center; line-height: 1.5;
        }
        h3 {
            font-family: var(--font-display); font-size: var(--step-2); color: var(--forest-shadow);
            margin: var(--space-6) 0 var(--space-3) 0;
        }

        .presentation-header {
            position: sticky;
            top: 0;
            z-index: 2;
            background: linear-gradient(180deg, rgba(248, 246, 240, 0.92) 0%, rgba(248, 246, 240, 0.65) 85%, transparent 100%);
            backdrop-filter: blur(6px);
            padding: clamp(16px, 2vw, 24px);
            margin: calc(var(--space-6) * -1) calc(clamp(24px, 3.2vw, 48px) * -1) var(--space-4);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            border-bottom: 1px solid rgba(122, 132, 113, 0.12);
            box-shadow: 0 10px 25px rgba(62, 74, 58, 0.12);
        }
        .presentation-header__topline {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--space-4);
            margin-bottom: var(--space-3);
        }
        .presentation-header__identity {
            flex: 1 1 auto;
            min-width: 220px;
        }
        .presentation-header .presentation-eyebrow {
            font-size: var(--step--1);
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--primary-sage);
            margin: 0 0 var(--space-2) 0;
        }
        .presentation-descriptor {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
            max-width: 60ch;
        }
        .lesson-selector {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            align-items: flex-start;
        }
        .lesson-selector label {
            font-size: var(--step--1);
            font-weight: 700;
            color: var(--forest-shadow);
        }
        .lesson-selector select {
            appearance: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-sage);
            background: rgba(255, 255, 255, 0.9);
            font: inherit;
            color: var(--forest-shadow);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.45);
            min-width: clamp(200px, 24vw, 260px);
        }
        .lesson-selector select:focus-visible {
            outline: none;
            box-shadow: var(--ring);
            border-color: var(--secondary-sage);
        }
        .presentation-menu {
            border-radius: var(--radius-lg);
            border: 1px solid rgba(122, 132, 113, 0.16);
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 8px 22px rgba(62, 74, 58, 0.12);
            overflow: hidden;
        }
        .presentation-menu[open] {
            box-shadow: 0 18px 36px rgba(62, 74, 58, 0.18);
        }
        .presentation-menu__summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-3);
            padding: var(--space-4);
            list-style: none;
            cursor: pointer;
            font-weight: 700;
            font-size: var(--step-0);
            color: var(--forest-shadow);
        }
        .presentation-menu__summary::-webkit-details-marker { display: none; }
        .presentation-menu__summary:focus-visible {
            outline: none;
            box-shadow: var(--ring);
        }
        .presentation-menu__summary-icon {
            font-size: var(--step-1);
            color: var(--primary-sage);
        }
        .presentation-menu__summary-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .presentation-menu__summary-hint {
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .presentation-menu__content {
            padding: 0 var(--space-4) var(--space-4);
            display: grid;
            gap: var(--space-5);
        }
        .presentation-menu__card,
        .presentation-menu__section {
            display: grid;
            gap: var(--space-3);
        }
        .presentation-menu__card {
            padding: var(--space-4);
            background: color-mix(in srgb, var(--soft-white) 92%, #fff 8%);
            border: 1px solid var(--border-sage);
            border-radius: var(--radius);
            box-shadow: var(--shadow-1);
            grid-column: 1 / -1;
        }
        .presentation-menu__card-text {
            display: grid;
            gap: var(--space-2);
        }
        .presentation-menu__heading {
            margin: 0;
            font-size: var(--step--1);
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--primary-sage);
        }
        .presentation-menu__actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
        }
        .presentation-menu__actions .activity-btn {
            min-height: 40px;
            padding: 8px 14px;
            font-size: 0.9rem;
            border-radius: 10px;
        }
        .presentation-menu__hint {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .presentation-menu__card .presentation-menu__hint {
            line-height: 1.5;
        }
        #slide-map { margin: 0; }
        #slide-map-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .slide-map-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .slide-map-group__title {
            margin: 0;
            font-size: var(--step-0);
            font-weight: 800;
            color: var(--forest-shadow);
            letter-spacing: 0.3px;
        }
        .slide-map-group__list {
            display: grid;
            gap: var(--space-2);
            margin: 0;
            padding: 0;
            list-style: none;
        }
        @container (min-width: 720px) {
            .slide-map-group__list {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }
        .slide-map-item { min-width: 0; }
        .slide-map-button {
            border: 1px solid rgba(122, 132, 113, 0.25);
            background: rgba(255, 255, 255, 0.88);
            border-radius: var(--radius-sm);
            padding: var(--space-3);
            font-size: var(--step--1);
            font-weight: 600;
            color: var(--forest-shadow);
            cursor: pointer;
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: var(--space-3);
            width: 100%;
            min-height: var(--target-min);
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient), background var(--dur-2) var(--ease-ambient);
            white-space: normal;
            overflow-wrap: anywhere;
            text-align: left;
        }
        .slide-map-button:hover,
        .slide-map-button:focus-visible {
            outline: none;
            transform: translateY(-1px);
            border-color: var(--secondary-sage);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.15);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
        }
        .slide-map-item.is-active .slide-map-button {
            background: linear-gradient(180deg, color-mix(in srgb, var(--secondary-sage) 92%, white 8%), var(--secondary-sage));
            color: var(--soft-white);
            border-color: var(--secondary-sage);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.18);
        }
        .slide-map-item.is-active .slide-map-button:hover,
        .slide-map-item.is-active .slide-map-button:focus-visible {
            transform: translateY(-1px);
        }
        .slide-map-button__number {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 999px;
            background: color-mix(in srgb, var(--secondary-sage) 25%, white 75%);
            color: var(--forest-shadow);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
        }
        .slide-map-button__label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .slide-map-button__title {
            font-size: var(--step--1);
            font-weight: 700;
            color: inherit;
        }
        .slide-map-button__subtitle {
            font-size: 0.85rem;
            color: var(--ink-muted);
        }
        .slide-map-item.is-active .slide-map-button__number {
            background: color-mix(in srgb, var(--soft-white) 20%, var(--forest-shadow) 80%);
            color: var(--soft-white);
        }

        /* ------------------------------- Buttons ----------------------------------*/
        .activity-btn {
            min-height: var(--target-min); padding: 12px 20px; border-radius: 12px;
            border: 1px solid var(--primary-sage);
            background: linear-gradient(180deg, color-mix(in srgb, var(--primary-sage) 92%, white 8%), var(--primary-sage));
            color: #fff; font-weight: 700; font-size: 1rem; letter-spacing: 0.2px; cursor: pointer;
            text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation; user-select: none;
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), background var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient), opacity var(--dur-1) var(--ease-ambient);
            box-shadow: 0 1px 0 rgba(255,255,255,0.25) inset, 0 8px 16px rgba(90, 107, 82, 0.20);
        }
        .activity-btn:hover {
            background: linear-gradient(180deg, color-mix(in srgb, var(--forest-shadow) 92%, white 8%), var(--forest-shadow));
            transform: translateY(-1px); box-shadow: 0 1px 0 rgba(255,255,255,0.25) inset, 0 10px 20px rgba(90, 107, 82, 0.22);
        }
        .activity-btn:active {
            transform: translateY(0); box-shadow: 0 1px 0 rgba(255,255,255,0.2) inset, 0 4px 10px rgba(90, 107, 82, 0.20);
        }
        .activity-btn:focus-visible { outline: none; box-shadow: var(--ring), 0 8px 16px rgba(90, 107, 82, 0.20); }
        .activity-btn:disabled, .activity-btn[disabled] {
            background: var(--tertiary-sage); border-color: var(--tertiary-sage);
            color: color-mix(in srgb, #fff 70%, var(--soft-white) 30%); cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none;
        }
        .activity-btn.secondary {
            background: transparent; color: var(--primary-sage); border-color: color-mix(in srgb, var(--tertiary-sage) 70%, var(--primary-sage) 30%); box-shadow: none;
        }
        .activity-btn.secondary:hover { background-color: var(--hover-sage); }
        .activity-btn.secondary:focus-visible { outline: none; box-shadow: var(--ring); }
        .controls { margin-top: var(--space-7); text-align: center; display: grid; gap: var(--space-3); grid-auto-flow: row; }

        /* ------------------------------- Forms / inputs ----------------------------------*/
        .input-group { margin: var(--space-6) 0; }
        .input-group label { display: block; font-weight: 700; margin-bottom: var(--space-2); color: var(--primary-sage); letter-spacing: 0.2px; }
        input[type="text"], input[type="date"], textarea, select {
            width: 100%; min-height: var(--target-min); padding: 12px 14px; border-radius: 10px;
            border: 1px solid var(--tertiary-sage); background: #fff; font-size: 1rem; font-family: var(--font-body);
            color: var(--ink); box-shadow: 0 1px 0 rgba(255,255,255,0.6) inset; appearance: none; -webkit-appearance: none;
            transition: border-color var(--dur-2) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), background var(--dur-2) var(--ease-ambient);
        }
        input::placeholder, textarea::placeholder { color: color-mix(in srgb, var(--ink-muted) 60%, #fff 40%); opacity: 0.9; }
        input:focus-visible, textarea:focus-visible, select:focus-visible {
            outline: none; border-color: var(--secondary-sage); box-shadow: var(--ring);
            background: color-mix(in srgb, #fff 92%, var(--warm-cream) 8%);
        }
        input:disabled, textarea:disabled, select:disabled {
            background: color-mix(in srgb, #fff 85%, var(--warm-cream) 15%); color: var(--ink-muted); cursor: not-allowed;
        }
        input[type="date"] { -webkit-tap-highlight-color: transparent; }
        textarea { resize: vertical; }
        :root { accent-color: var(--primary-sage); }

        /* ------------------------------- Responsive / container queries ----------------------------------*/
        @media (min-width: 768px) {
            #app-wrapper { padding-inline: var(--space-7); }
            .controls { grid-auto-flow: column; justify-content: center; }
            .presentation-menu__content { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .presentation-menu__actions { justify-content: flex-start; }
        }
        @media (min-width: 1024px) {
            #activity-container { box-shadow: var(--shadow-3); }
            h1 { letter-spacing: 0.3px; }
            .presentation-header { padding: clamp(20px, 2.4vw, 32px) clamp(28px, 3.2vw, 48px); margin: calc(var(--space-6) * -1) calc(clamp(28px, 3.2vw, 48px) * -1) var(--space-5); }
            #slide-map-list { gap: var(--space-4); }
        }
        @media (max-width: 767px) {
            #app-wrapper { padding: var(--space-4); }
            #activity-container { padding: 24px; }
            h1 { font-size: clamp(1.75rem, 5vw, 2rem); }
            h2.rubric { font-size: var(--step--1); margin-bottom: 20px; }
            .slide-map-button { padding-inline: var(--space-3); }
            .presentation-header__topline { flex-direction: column; align-items: stretch; }
            .lesson-selector { width: 100%; }
            .lesson-selector select { width: 100%; min-width: 0; }
        }

        /* ------------------------------- Accessibility / motion / scroll ----------------------------------*/
        :focus-visible { outline: none; box-shadow: var(--ring); }
        @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; scroll-behavior: auto !important; } }
        ::selection { background: color-mix(in srgb, var(--secondary-sage) 30%, #fff 70%); color: var(--deep-forest); }
        html, body { overscroll-behavior-y: none; }

        /* ------------------------------- Scrollbars (subtle, optional) ----------------------------------*/
        *::-webkit-scrollbar { width: 10px; height: 10px; }
        *::-webkit-scrollbar-thumb { background: color-mix(in srgb, var(--primary-sage) 50%, var(--tertiary-sage) 50%); border-radius: 999px; border: 2px solid transparent; background-clip: padding-box; }
        *::-webkit-scrollbar-track { background: transparent; }

        /* ------------------------------- Dark mode (gentle, earthy) ----------------------------------*/
        @media (prefers-color-scheme: dark) {
            :root {
                --soft-white: #1E211C; --warm-cream: #23261F; --forest-shadow: #DDE6D4;
                --ink: #E9EFE5; --ink-muted: #AEB9AA; --border-sage: rgba(184, 197, 166, 0.25);
            }
            html, body {
                background: radial-gradient(1100px 900px at 15% 10%, rgba(156,175,136,0.06), transparent 60%),
                            radial-gradient(900px 900px at 85% 90%, rgba(122,132,113,0.08), transparent 65%),
                            linear-gradient(135deg, #191D18 0%, #1B1E19 100%);
            }
            #activity-container { background: color-mix(in srgb, #23261F 92%, #1B1E19 8%); border-color: rgba(184, 197, 166, 0.18); box-shadow: 0 12px 36px rgba(0,0,0,0.35); }
            .presentation-header { background: linear-gradient(180deg, rgba(31, 33, 28, 0.92) 0%, rgba(31, 33, 28, 0.6) 85%, transparent 100%); border-bottom-color: rgba(184, 197, 166, 0.2); }
            .presentation-menu { background: rgba(28, 31, 26, 0.88); border-color: rgba(184, 197, 166, 0.28); box-shadow: 0 16px 32px rgba(0,0,0,0.35); }
            .presentation-menu__summary { color: var(--forest-shadow); }
            .presentation-menu__summary-icon { color: color-mix(in srgb, var(--secondary-sage) 80%, #0F120E 20%); }
            .presentation-menu__hint { color: color-mix(in srgb, var(--ink-muted) 85%, #fff 15%); }
            .lesson-selector label { color: var(--forest-shadow); }
            .lesson-selector select { background: rgba(28, 31, 26, 0.85); border-color: rgba(184, 197, 166, 0.28); color: var(--forest-shadow); box-shadow: none; }
            a { color: color-mix(in srgb, var(--secondary-sage) 80%, #C7D3C0 20%); }
            .mc-question { background: linear-gradient(180deg, #20241E 0%, #191D18 100%); border-color: rgba(184, 197, 166, 0.20); box-shadow: 0 1px 0 rgba(255,255,255,0.03) inset, 0 10px 30px rgba(0,0,0,0.35); }
            .activity-btn { background: linear-gradient(180deg, color-mix(in srgb, var(--primary-sage) 80%, #0F120E 20%), var(--primary-sage)); box-shadow: 0 1px 0 rgba(255,255,255,0.08) inset, 0 8px 18px rgba(0,0,0,0.35); }
            .activity-btn:hover { background: linear-gradient(180deg, color-mix(in srgb, var(--forest-shadow) 80%, #0F120E 20%), var(--forest-shadow)); }
            input, textarea, select { background: #141713; border-color: rgba(184, 197, 166, 0.25); color: var(--ink); }
            .notes-dock-header { background: rgba(28, 31, 26, 0.78); border-color: rgba(184, 197, 166, 0.28); box-shadow: 0 12px 28px rgba(0,0,0,0.35); }
            .notes-dock-subtitle { color: color-mix(in srgb, var(--ink-muted) 85%, #fff 15%); }
            .slide-map-group__title { color: color-mix(in srgb, var(--secondary-sage) 70%, #C7D3C0 30%); }
            .slide-map-button { background: rgba(28, 31, 26, 0.75); border-color: rgba(184, 197, 166, 0.28); color: var(--forest-shadow); }
            .slide-map-button__number { background: color-mix(in srgb, var(--secondary-sage) 55%, #0F120E 45%); color: var(--soft-white); }
            .slide-map-button__subtitle { color: color-mix(in srgb, var(--ink-muted) 80%, #fff 20%); }
            .slide-map-item.is-active .slide-map-button { background: linear-gradient(180deg, color-mix(in srgb, var(--secondary-sage) 85%, #0F120E 15%), var(--secondary-sage)); color: var(--soft-white); border-color: color-mix(in srgb, var(--secondary-sage) 85%, #0F120E 15%); }
            .slide-map-item.is-active .slide-map-button__number { background: color-mix(in srgb, var(--soft-white) 15%, var(--forest-shadow) 85%); }
            .textbox-color-picker { background: rgba(28, 31, 26, 0.75); border-color: rgba(184, 197, 166, 0.28); }
            .textbox-color-picker__swatch { border-color: rgba(184, 197, 166, 0.28); }
            .textbox-color-picker__swatch.is-selected { box-shadow: 0 0 0 3px rgba(20, 23, 19, 0.85), 0 0 0 5px rgba(184, 197, 166, 0.35); }
        }

        /* ------------------------------- Slide-specific styles ----------------------------------*/
        /* Custom styles for the presentation content */
        .slide-content { margin-top: var(--space-6); }
        .slide-content img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: var(--radius);
            margin-bottom: var(--space-6);
        }

        /* Blueprint slide system (flexible layout-driven slides) */
        .blueprint-slide .controls { margin-top: var(--space-7); }
        .blueprint {
            display: flex;
            flex-direction: column;
            gap: var(--blueprint-gap, var(--space-5));
            width: 100%;
        }
        .blueprint-block {
            width: 100%;
        }
        .blueprint-block--mt-space-4 { margin-top: var(--space-4); }
        .blueprint-block--mt-space-5 { margin-top: var(--space-5); }
        .blueprint-block--mt-space-6 { margin-top: var(--space-6); }
        .blueprint-block--mt-space-7 { margin-top: var(--space-7); }
        .blueprint-block.animate-on-scroll { animation-duration: 600ms; }
        .blueprint--single-column {
            align-items: stretch;
        }
        .blueprint-align-center {
            align-items: center;
            text-align: center;
        }
        .blueprint-align-center .blueprint-block {
            max-width: min(100%, 760px);
        }
        .blueprint-align-left {
            align-items: stretch;
            text-align: left;
        }
        .blueprint-align-right {
            align-items: flex-end;
            text-align: right;
        }
        .blueprint-align-right .blueprint-block {
            max-width: min(100%, 760px);
        }
        .blueprint-media {
            margin: 0;
        }
        .blueprint-media img {
            width: 100%;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-1);
            margin: 0;
        }
        .blueprint-media figcaption {
            margin-top: var(--space-2);
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .blueprint-heading {
            margin: 0;
            color: var(--forest-shadow);
        }
        .blueprint-heading.slide-title {
            font-family: var(--font-display);
        }
        .blueprint-text {
            margin: 0;
        }
        .blueprint-list {
            margin: 0;
            padding-left: 1.25em;
            display: grid;
            gap: var(--space-2);
        }
        .blueprint-list--unordered {
            list-style: disc;
        }
        .blueprint-list--ordered {
            list-style: decimal;
        }
        .blueprint-list__item {
            line-height: 1.6;
        }
        .blueprint-list__item strong {
            display: inline-block;
            font-weight: 700;
            color: var(--forest-shadow);
        }
        .blueprint-list__description {
            display: inline;
        }
        .blueprint-definition-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: var(--space-3);
        }
        .blueprint-definition-list li {
            background: color-mix(in srgb, #ffffff 92%, var(--warm-cream) 8%);
            border-radius: var(--radius);
            border: 1px solid var(--border-sage);
            padding: var(--space-4);
        }
        .blueprint-definition-list strong {
            color: var(--primary-sage);
            font-weight: 700;
            display: block;
            margin-bottom: var(--space-2);
        }
        .blueprint-activity {
            background: color-mix(in srgb, #ffffff 92%, var(--warm-cream) 8%);
            border-radius: var(--radius);
            border: 1px solid var(--border-sage);
            padding: var(--space-4);
            display: grid;
            gap: var(--space-3);
            text-align: left;
        }
        .blueprint-align-center .blueprint-activity {
            text-align: center;
        }
        .blueprint-activity__title {
            margin: 0;
            font-family: var(--font-display);
            color: var(--forest-shadow);
        }
        .blueprint-activity__description {
            margin: 0;
        }
        .blueprint-activity__list {
            padding-left: 1.25em;
            margin: 0;
            display: grid;
            gap: var(--space-2);
        }
        .blueprint-grid {
            display: grid;
            gap: var(--space-4);
            grid-template-columns: var(--blueprint-grid-columns, repeat(auto-fit, minmax(180px, 1fr)));
        }
        .blueprint-grid__item {
            background: var(--soft-white);
            border-radius: var(--radius);
            border: 1px solid rgba(122, 132, 113, 0.18);
            padding: var(--space-4);
            display: grid;
            gap: var(--space-3);
        }
        .blueprint-grid__title {
            margin: 0;
            font-size: var(--step-0);
            font-weight: 700;
            color: var(--primary-sage);
        }
        .blueprint-gallery {
            display: grid;
            gap: var(--space-5);
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .blueprint-gallery__item {
            background: var(--soft-white);
            border-radius: var(--radius);
            border: 1px solid rgba(122, 132, 113, 0.16);
            box-shadow: var(--shadow-1);
            overflow: hidden;
        }
        .blueprint-gallery__item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .blueprint-gallery__body {
            padding: var(--space-4);
        }
        .blueprint-gallery__title {
            margin: 0 0 var(--space-1) 0;
            font-weight: 700;
            color: var(--forest-shadow);
        }
        .blueprint-gallery__subtitle {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .blueprint-radio-group {
            display: grid;
            gap: var(--space-3);
        }
        .blueprint-radio {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            border-radius: var(--radius);
            border: 1px solid var(--border-sage);
            background: var(--soft-white);
            cursor: pointer;
            transition: border-color var(--dur-1) var(--ease-ambient), box-shadow var(--dur-1) var(--ease-ambient);
        }
        .blueprint-radio:hover,
        .blueprint-radio:focus-within {
            border-color: var(--secondary-sage);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--secondary-sage) 20%, transparent);
        }
        .blueprint-radio input {
            width: 1.15rem;
            height: 1.15rem;
            margin: 0;
        }
        .blueprint-radio__text {
            font-weight: 600;
        }
        .blueprint-profiles {
            display: grid;
            gap: var(--space-5);
        }
        .blueprint-profile {
            display: grid;
            gap: var(--space-2);
        }
        .blueprint-profile__name {
            margin: 0;
            font-weight: 700;
            font-size: var(--step-1);
            color: var(--forest-shadow);
        }
        .blueprint-profile__meta {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .blueprint-profile__focus {
            margin: 0;
        }
        .blueprint-reporting {
            display: grid;
            gap: var(--space-6);
        }
        .blueprint-reporting__section {
            display: grid;
            gap: var(--space-3);
        }
        .blueprint-reporting__title {
            margin: 0;
            font-size: var(--step-1);
            font-family: var(--font-display);
            color: var(--primary-sage);
        }
        .blueprint-reporting__field {
            display: grid;
            gap: var(--space-2);
        }
        .blueprint-reporting__label {
            font-weight: 700;
            color: var(--primary-sage);
        }
        .blueprint-questions {
            list-style: disc;
            padding-left: 1.25em;
            display: grid;
            gap: var(--space-3);
            margin: 0;
        }
        .blueprint-spec {
            margin-top: var(--space-6);
            background: color-mix(in srgb, var(--soft-white) 90%, white 10%);
            border-radius: var(--radius);
            border: 1px dashed rgba(122, 132, 113, 0.35);
            padding: var(--space-3) var(--space-4);
        }
        .blueprint-spec summary {
            font-weight: 700;
            cursor: pointer;
        }
        .blueprint-spec__body {
            margin-top: var(--space-3);
            display: grid;
            gap: var(--space-3);
        }
        .blueprint-spec__section {
            display: grid;
            gap: var(--space-2);
        }
        .blueprint-spec__section h4 {
            margin: 0;
            font-size: var(--step--1);
            font-weight: 700;
            color: var(--primary-sage);
        }
        .blueprint-spec__section ul {
            margin: 0;
            padding-left: 1.25em;
            display: grid;
            gap: var(--space-1);
        }
        .activity-feedback {
            margin-top: var(--space-6);
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            border: 1px solid rgba(122, 132, 113, 0.16);
            border-radius: var(--radius);
            padding: clamp(20px, 3vw, 32px);
            display: grid;
            gap: var(--space-4);
        }
        .activity-feedback__summary {
            margin: 0;
            font-weight: 700;
            color: var(--forest-shadow);
        }
        .activity-feedback__list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: var(--space-4);
        }
        .activity-feedback__item {
            border-left: 4px solid color-mix(in srgb, var(--secondary-sage) 70%, var(--primary-sage) 30%);
            padding-left: var(--space-4);
        }
        .activity-feedback__item strong { color: var(--forest-shadow); }
        .activity-feedback__item p { margin: 0; }
        .activity-feedback__item p + p { margin-top: var(--space-2); }
        .activity-feedback__item.is-incorrect { border-left-color: #C76B5E; }
        .activity-feedback__item.is-correct { border-left-color: var(--secondary-sage); }

        /* Gap-fill activity */
        .gapfill-activity {
            display: grid;
            gap: var(--space-5);
        }
        .gapfill-paragraph {
            background: color-mix(in srgb, var(--warm-cream) 85%, white 15%);
            border: 1px solid rgba(122, 132, 113, 0.18);
            border-radius: var(--radius);
            padding: clamp(20px, 3vw, 32px);
            font-size: var(--step-1);
            line-height: 1.8;
        }
        .gapfill-gap {
            display: inline-flex;
            align-items: center;
            margin: 0 var(--space-1);
            border-radius: 10px;
            padding: 0 var(--space-1);
        }
        .gapfill-gap select {
            min-width: 140px;
            padding: 10px 16px;
            border-radius: 10px;
            border: 2px solid var(--tertiary-sage);
            background: #fff;
            font-weight: 600;
            color: var(--primary-sage);
            cursor: pointer;
            transition: border-color var(--dur-2) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient);
        }
        .gapfill-gap select:focus-visible {
            border-color: var(--secondary-sage);
            box-shadow: var(--ring);
            outline: none;
        }
        .gapfill-gap.is-correct select {
            border-color: color-mix(in srgb, var(--secondary-sage) 80%, var(--primary-sage) 20%);
            background: color-mix(in srgb, var(--soft-white) 85%, var(--secondary-sage) 15%);
        }
        .gapfill-gap.is-incorrect select {
            border-color: #C76B5E;
            background: color-mix(in srgb, #fff 85%, #F7D8D6 15%);
        }

        /* Ranking activity */
        .ranking-activity {
            display: grid;
            gap: var(--space-5);
        }
        .ranking-intro { margin: 0; font-size: var(--step-0); color: var(--ink-muted); }
        .ranking-list {
            list-style: none;
            counter-reset: ranking-counter;
            padding: 0;
            margin: 0;
            display: grid;
            gap: var(--space-4);
        }
        .ranking-item {
            counter-increment: ranking-counter;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
            padding: var(--space-4);
            padding-left: clamp(56px, 6vw, 72px);
            border: 1px solid rgba(122, 132, 113, 0.18);
            border-radius: var(--radius);
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            box-shadow: var(--shadow-1);
        }
        .ranking-item::before {
            content: counter(ranking-counter);
            position: absolute;
            left: clamp(16px, 2vw, 24px);
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border-radius: 999px;
            background: color-mix(in srgb, var(--secondary-sage) 85%, var(--primary-sage) 15%);
            color: var(--soft-white);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
        }
        .ranking-item.is-correct {
            border-color: color-mix(in srgb, var(--secondary-sage) 80%, var(--primary-sage) 20%);
            background: color-mix(in srgb, var(--soft-white) 85%, var(--secondary-sage) 15%);
        }
        .ranking-item.is-incorrect {
            border-color: #C76B5E;
            background: color-mix(in srgb, #fff 85%, #F7D8D6 15%);
        }
        .ranking-label { font-weight: 700; font-size: var(--step-0); color: var(--forest-shadow); }
        .ranking-controls { display: inline-flex; gap: var(--space-2); }
        .ranking-controls button {
            min-height: var(--target-min);
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--tertiary-sage);
            background: #fff;
            color: var(--primary-sage);
            cursor: pointer;
            font-weight: 600;
            transition: background var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
        }
        .ranking-controls button:hover { background: var(--hover-sage); }
        .ranking-controls button:focus-visible { outline: none; box-shadow: var(--ring); }

        /* Grouping activity */
        .grouping-activity {
            display: grid;
            gap: var(--space-5);
        }
        .grouping-grid {
            display: grid;
            gap: var(--space-4);
        }
        @media (min-width: 720px) {
            .grouping-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        .grouping-item {
            display: grid;
            gap: var(--space-2);
            border: 1px solid rgba(122, 132, 113, 0.18);
            border-radius: var(--radius);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
            padding: var(--space-4);
        }
        .grouping-item strong { font-size: var(--step-0); }
        .grouping-item.is-correct { border-color: color-mix(in srgb, var(--secondary-sage) 80%, var(--primary-sage) 20%); background: color-mix(in srgb, var(--soft-white) 85%, var(--secondary-sage) 15%); }
        .grouping-item.is-incorrect { border-color: #C76B5E; background: color-mix(in srgb, #fff 85%, #F7D8D6 15%); }

        /* Matching grid activity */
        .matching-activity { display: grid; gap: var(--space-5); }
        .matching-table-wrapper { overflow-x: auto; }
        .matching-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 520px;
        }
        .matching-table th,
        .matching-table td {
            padding: var(--space-3);
            border-bottom: 1px solid rgba(122, 132, 113, 0.16);
            text-align: center;
        }
        .matching-table thead th {
            text-transform: uppercase;
            letter-spacing: 0.4px;
            font-size: 0.85rem;
            color: var(--ink-muted);
        }
        .matching-table tbody th {
            text-align: left;
            color: var(--forest-shadow);
            font-weight: 700;
        }
        .matching-table tbody tr.is-correct { background: color-mix(in srgb, var(--soft-white) 85%, var(--secondary-sage) 15%); }
        .matching-table tbody tr.is-incorrect { background: color-mix(in srgb, #fff 85%, #F7D8D6 15%); }
        .matching-radio { display: inline-flex; align-items: center; justify-content: center; cursor: pointer; width: 28px; height: 28px; }
        .matching-radio input { display: none; }
        .matching-radio-indicator {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            border: 2px solid var(--tertiary-sage);
            transition: border-color var(--dur-2) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
            position: relative;
        }
        .matching-radio:hover .matching-radio-indicator { border-color: var(--primary-sage); }
        .matching-radio input:checked + .matching-radio-indicator {
            border-color: var(--primary-sage);
        }
        .matching-radio-indicator::after {
            content: "";
            position: absolute;
            inset: 4px;
            border-radius: inherit;
            background: var(--primary-sage);
            transform: scale(0);
            transition: transform var(--dur-2) var(--ease-ambient);
        }
        .matching-radio input:checked + .matching-radio-indicator::after { transform: scale(1); }

        @media (max-width: 767px) {
            .ranking-item { flex-direction: column; align-items: flex-start; }
            .ranking-controls { justify-content: flex-start; }
        }
        .slide-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: var(--space-6);
        }
        .slide-list li {
            position: relative;
            padding-left: var(--space-7);
            margin-bottom: var(--space-4);
            font-size: var(--step-1);
            line-height: 1.5;
        }
        .slide-list li::before {
            content: "";
            position: absolute;
            left: 0;
            top: var(--space-1);
            width: var(--space-3);
            height: var(--space-3);
            background-color: var(--primary-sage);
            border-radius: 50%;
        }
        .slide-list.smart li::before {
            content: attr(data-letter);
            background-color: var(--secondary-sage);
            color: var(--soft-white);
            font-weight: 700;
            font-size: var(--step--1);
            text-align: center;
            line-height: var(--space-7);
        }
        .process-flow {
            display: grid;
            gap: var(--space-4);
        }
        .process-step {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-sage);
            background: #fff;
        }
        .process-step-number {
            font-family: var(--font-display);
            font-size: var(--step-3);
            color: var(--primary-sage);
            font-weight: 700;
            flex-shrink: 0;
            width: 50px;
            text-align: center;
        }
        .process-step-content {
            font-size: var(--step-0);
        }
        .process-step-content strong { color: var(--forest-shadow); }

        /* Navigation controls styling */
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: var(--space-7);
        }
        .navigation button {
            width: 150px;
        }
        .navigation button:first-child { justify-content: flex-start; }
        .navigation button:last-child { justify-content: flex-end; }

        .slide-content p { margin-bottom: var(--space-4); }
        .slide-content ul { padding-left: var(--space-6); }
        .slide-content ul li { margin-bottom: var(--space-2); }
        
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-6);
        }
        .card {
            background: #fff;
            border: 1px solid var(--border-sage);
            border-radius: var(--radius);
            padding: var(--space-5);
            box-shadow: var(--shadow-1);
            text-align: center;
        }
        .card .icon {
            font-size: var(--step-3);
            color: var(--primary-sage);
            margin-bottom: var(--space-3);
        }
        .card h3 {
            font-size: var(--step-1);
            margin: 0;
        }
        .quiz-card {
            background: var(--warm-cream);
            border: 1px solid var(--border-sage);
            border-radius: var(--radius);
            padding: var(--space-5);
            margin-bottom: var(--space-5);
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        .quiz-question-text {
            font-weight: 700;
            font-size: var(--step-1);
            color: var(--forest-shadow);
            margin: 0;
        }
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .quiz-option {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            border: 1px solid rgba(122, 132, 113, 0.18);
            border-radius: var(--radius-sm);
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            transition: background var(--dur-2) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
        }
        .quiz-option:hover {
            background: var(--hover-sage);
            transform: translateY(-1px);
        }
        .quiz-option input[type="radio"] {
            margin-top: 4px;
        }
        .quiz-option span {
            flex: 1;
        }
        .activity-btn.quiz-btn {
            align-self: flex-start;
            background: linear-gradient(180deg, color-mix(in srgb, var(--secondary-sage) 92%, white 8%), var(--secondary-sage));
            border-color: var(--secondary-sage);
            color: var(--soft-white);
        }
        .activity-btn.quiz-btn:hover {
            background: linear-gradient(180deg, color-mix(in srgb, var(--forest-shadow) 88%, white 12%), var(--forest-shadow));
        }
        .quiz-feedback {
            margin: 0;
            font-weight: 600;
        }
        .quiz-feedback.correct {
            color: var(--secondary-sage);
        }
        .quiz-feedback.incorrect {
            color: #C4665A;
        }
        .quiz-feedback.notice {
            color: var(--forest-shadow);
        }
        .reflection-form {
            display: grid;
            gap: var(--space-5);
        }
        .reflection-field label {
            display: block;
            font-weight: 700;
            color: var(--forest-shadow);
            margin-bottom: var(--space-2);
        }
        .reflection-field textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--space-4);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(122, 132, 113, 0.28);
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            font-family: var(--font-body);
            font-size: var(--step-0);
            resize: vertical;
        }
        /* ------------------------------- Collaborative text boxes ----------------------------------*/
        #notes-dock {
            width: 100%;
            background: color-mix(in srgb, var(--soft-white) 90%, white 10%);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(122, 132, 113, 0.14);
            box-shadow: var(--shadow-1);
            padding: clamp(20px, 2.8vw, 32px);
            display: flex;
            flex-direction: column;
            gap: var(--space-5);
            min-height: 0;
        }
        .notes-dock-header {
            display: grid;
            gap: var(--space-2);
            padding: var(--space-4);
            border-radius: var(--radius);
            border: 1px solid rgba(122, 132, 113, 0.16);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
            box-shadow: var(--shadow-1);
        }
        .notes-dock-title {
            margin: 0;
            font-family: var(--font-display);
            font-size: var(--step-1);
            color: var(--forest-shadow);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .notes-dock-subtitle {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        #notes-panels {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            flex: 1 1 auto;
            min-height: 0;
        }
        .notes-panel {
            display: none;
            flex-direction: column;
            gap: var(--space-4);
            background: color-mix(in srgb, var(--soft-white) 96%, white 4%);
            border: 1px solid rgba(122, 132, 113, 0.14);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-1);
        }
        .notes-panel.active {
            display: flex;
        }
        .notes-panel-title {
            margin: 0;
            font-family: var(--font-display);
            font-size: var(--step-1);
            color: var(--forest-shadow);
        }
        .textbox-toolbar {
            margin-top: var(--space-6);
            margin-bottom: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(122, 132, 113, 0.18);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .textbox-swatch-group {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        .textbox-swatch-group button {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 2px solid rgba(62, 74, 58, 0.15);
            background: var(--swatch-color);
            cursor: pointer;
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient);
        }
        .textbox-swatch-group button:hover {
            transform: translateY(-1px);
            border-color: rgba(62, 74, 58, 0.3);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.15);
        }
        .textbox-swatch-group button:focus-visible {
            outline: none;
            box-shadow: var(--ring), 0 6px 12px rgba(62, 74, 58, 0.18);
        }
        .textbox-toolbar .toolbar-caption {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .notes-panel .textbox-toolbar {
            margin-top: 0;
            margin-bottom: 0;
        }
        .textbox-collection {
            display: grid;
            gap: var(--space-3);
        }
        .notes-panel .textbox-collection {
            min-width: 0;
        }
        .custom-textbox {
            position: relative;
            border-radius: var(--radius);
            padding: var(--space-4);
            box-shadow: var(--shadow-1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: #1F2B1B;
        }
        .custom-textbox .textbox-content {
            min-height: 80px;
            outline: none;
            font-family: var(--font-body);
            font-size: var(--step-0);
            line-height: 1.5;
        }
        .custom-textbox .textbox-content:empty::before {
            content: attr(data-placeholder);
            color: rgba(47, 58, 43, 0.5);
        }
        .textbox-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }
        .textbox-color-picker {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(122, 132, 113, 0.18);
            background: rgba(255, 255, 255, 0.65);
        }
        .textbox-color-picker__swatch {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid rgba(62, 74, 58, 0.18);
            background: var(--swatch-color);
            cursor: pointer;
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient);
        }
        .textbox-color-picker__swatch:hover {
            transform: translateY(-1px);
            border-color: rgba(62, 74, 58, 0.32);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.16);
        }
        .textbox-color-picker__swatch:focus-visible {
            outline: none;
            box-shadow: var(--ring), 0 6px 12px rgba(62, 74, 58, 0.2);
        }
        .textbox-color-picker__swatch.is-selected {
            border-color: rgba(62, 74, 58, 0.45);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8), 0 0 0 5px rgba(62, 74, 58, 0.25);
        }
        .textbox-remove-btn {
            border: none;
            background: transparent;
            color: var(--forest-shadow);
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .textbox-remove-btn:hover {
            color: #C4665A;
        }
        @media (max-width: 767px) {
            .textbox-toolbar {
                align-items: stretch;
            }
            .textbox-swatch-group {
                flex-wrap: wrap;
            }
            .textbox-actions {
                flex-direction: column;
                align-items: stretch;
            }
            .textbox-remove-btn {
                justify-content: center;
            }
        }
        @media (min-width: 992px) {
            #activity-shell {
                flex-direction: row;
                align-items: flex-start;
                gap: var(--space-7);
            }
            #activity-container {
                flex: 1 1 auto;
                max-width: none;
            }
            #notes-dock {
                flex: 0 0 clamp(280px, 30vw, 360px);
                position: sticky;
                top: clamp(1.5rem, 4vw, 3rem);
                max-height: calc(100vh - clamp(1.5rem, 4vw, 3rem));
                overflow: hidden;
            }
            #notes-panels {
                overflow: auto;
                padding-right: var(--space-1);
            }
        }
        .animate-on-scroll {
            opacity: 0;
        }
    </style>
</head>
<body>

    <a class="skip-link" href="#activity-container">Skip to presentation content</a>

    <div id="app-wrapper">
        <main id="activity-shell" role="main">
            <div id="activity-container">

            <header class="presentation-header" id="presentation-header">
                <div class="presentation-header__topline">
                    <div class="presentation-header__identity">
                        <p class="presentation-eyebrow" id="presentation-eyebrow">Instructional Session</p>
                        <p class="presentation-descriptor" id="presentation-descriptor">Choose a template to populate the slides.</p>
                    </div>
                    <div class="lesson-selector">
                        <label for="lesson-template">Lesson template</label>
                        <select id="lesson-template" aria-label="Select a lesson template"></select>
                    </div>
                </div>
                <details class="presentation-menu" id="notes-io-controls" open>
                    <summary class="presentation-menu__summary">
                        <span class="presentation-menu__summary-label">
                            <i class="fas fa-seedling presentation-menu__summary-icon" aria-hidden="true"></i>
                            Session tools
                        </span>
                        <span class="presentation-menu__summary-hint">Slide map &amp; notes backup</span>
                    </summary>
                    <div class="presentation-menu__content">
                        <section class="presentation-menu__card" aria-labelledby="presentation-notes-io-heading">
                            <div class="presentation-menu__card-text">
                                <h2 class="presentation-menu__heading" id="presentation-notes-io-heading">Save or load notes</h2>
                                <p class="presentation-menu__hint">Download your current slide text boxes or import a saved copy.</p>
                            </div>
                            <div class="presentation-menu__actions">
                                <button type="button" class="activity-btn secondary" id="save-notes-btn"><i class="fas fa-file-arrow-down"></i> Save Notes (JSON)</button>
                                <button type="button" class="activity-btn secondary" id="load-notes-btn"><i class="fas fa-file-arrow-up"></i> Load Notes (JSON)</button>
                            </div>
                            <input type="file" id="notes-file-input" accept="application/json" hidden>
                        </section>
                        <section class="presentation-menu__section" aria-labelledby="presentation-slide-map-heading">
                            <h2 class="presentation-menu__heading" id="presentation-slide-map-heading">Slide map</h2>
                            <nav id="slide-map" aria-label="Slide overview">
                                <ul id="slide-map-list"></ul>
                            </nav>
                        </section>
                    </div>
                </details>
            </header>

                <div id="slides-root" role="presentation"></div>

        </div>
        <aside id="notes-dock" aria-label="Collaborative slide notes workspace">
            <div class="notes-dock-header">
                <p class="notes-dock-title"><i class="fas fa-note-sticky" aria-hidden="true"></i> Slide Text Boxes</p>
                <p class="notes-dock-subtitle">Use the session tools foldout to save or load your notes at any time.</p>
            </div>
            <div id="notes-panels" aria-live="polite"></div>
        </aside>
    </main>
    </div>

    <script>
        const lessonLibrary = {
            mentoringOrientation: {
                id: "mentoring-orientation",
                label: "Mentoring orientation",
                meta: {
                    eyebrow: "Noor Community Mentoring",
                    descriptor: "An onboarding deck for project-based mentoring partnerships.",
                    pageTitle: "Mentoring Orientation â€“ Instructional Slides"
                },
                sections: [
                    { title: "Welcome & Community", slideKeys: ["welcome", "mentoring-benefits", "community-identity", "mentoring-definition"] },
                    { title: "Opportunities & Stories", slideKeys: ["mentoring-outcomes", "mission-quiz", "project-cv", "project-speaking"] },
                    { title: "Planning Framework", slideKeys: ["smart-framework", "smart-example", "journey-steps", "journey-quiz"] },
                    { title: "Commitment & Care", slideKeys: ["commitments", "commitment-quiz"] },
                    { title: "Next Steps", slideKeys: ["brainstorm", "reflection"] }
                ],
                slides: [
                    {
                        key: "welcome",
                        type: "hero",
                        title: "Welcome to the Noor Community Mentoring Program",
                        subtitle: "Building a supportive future, together.",
                        image: {
                            src: "https://images.pexels.com/photos/3184418/pexels-photo-3184418.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Diverse team collaborating in a bright, modern office"
                        },
                        nav: { hidePrev: true, nextLabel: "Start", nextIcon: "fas fa-play" }
                    },
                    {
                        key: "mentoring-benefits",
                        type: "content",
                        icon: "fas fa-cogs",
                        title: "Benefits of Mentoring (Soft Skills)",
                        image: {
                            src: "https://images.pexels.com/photos/1595385/pexels-photo-1595385.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A group of people collaborating and brainstorming around a table"
                        },
                        body: [
                            "Mentoring is a powerful tool for personal and professional growth. It can help you develop a wide range of soft skills that support success in any field."
                        ],
                        list: [
                            "Improved communication and interpersonal skills",
                            "Enhanced leadership and decision-making abilities",
                            "Increased confidence and self-awareness",
                            "Greater problem-solving and critical thinking skills"
                        ]
                    },
                    {
                        key: "community-identity",
                        type: "content",
                        icon: "fas fa-users",
                        title: "Who Are We?",
                        image: {
                            src: "https://images.pexels.com/photos/3183150/pexels-photo-3183150.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A diverse group of colleagues celebrating a success together"
                        },
                        body: [
                            "The Noor Community is an educational space dedicated to liberation through learning. We believe in solidarity and social justice.",
                            "Our goal is to create a safe environment where everyone can express themselves, develop their skills, and connect with others. We see learning and teaching as universal processes that empower all of us."
                        ]
                    },
                    {
                        key: "mentoring-definition",
                        type: "content",
                        icon: "fas fa-hands-helping",
                        title: "What Is Mentoring?",
                        image: {
                            src: "https://images.pexels.com/photos/5668859/pexels-photo-5668859.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A mentor guiding a mentee at a computer"
                        },
                        body: [
                            "Mentoring is a collaborative relationship where an experienced person supports another learner to develop skills and reach their goals.",
                            "Our approach centres trust and empowerment. Mentors act as guides who celebrate wins, ask thoughtful questions, and help you stay accountable to your project vision."
                        ]
                    },
                    {
                        key: "mentoring-outcomes",
                        type: "cards",
                        icon: "fas fa-lightbulb",
                        title: "What Becomes Possible?",
                        subtitle: "Mentoring can help you achieve concrete, practical outcomes.",
                        cards: [
                            { icon: "fas fa-file-alt", title: "CV & LinkedIn" },
                            { icon: "fas fa-microphone", title: "Public Speaking" },
                            { icon: "fas fa-award", title: "Grant Proposals" },
                            { icon: "fas fa-graduation-cap", title: "University Applications" }
                        ]
                    },
                    {
                        key: "mission-quiz",
                        type: "quiz",
                        icon: "fas fa-question-circle",
                        title: "Quick Check: Our Mission & Mentoring",
                        questions: [
                            {
                                id: "mission-q1",
                                prompt: "What is the Noor Community primarily committed to?",
                                options: [
                                    { value: "solidarity", label: "Building solidarity and working toward social justice through education." },
                                    { value: "competition", label: "Organising competitive events that reward the top performers only." },
                                    { value: "online-only", label: "Delivering self-paced online courses without community interaction." }
                                ],
                                answer: "solidarity",
                                correctFeedback: "Exactly! Our community centres solidarity and social justice.",
                                incorrectFeedback: "Review our visionâ€”connection and justice are at the heart of Noor Community."
                            },
                            {
                                id: "mission-q2",
                                prompt: "How does the mentoring relationship operate in this program?",
                                options: [
                                    { value: "hierarchy", label: "The mentor gives orders and the mentee follows a fixed set of tasks." },
                                    { value: "collaboration", label: "Mentor and mentee collaborate to reach the menteeâ€™s goals through trust and guidance." },
                                    { value: "assessment", label: "The mentor grades the mentee each week on quizzes and exams." }
                                ],
                                answer: "collaboration",
                                correctFeedback: "Yes! Mentoring here is a collaborative, empowering partnership.",
                                incorrectFeedback: "Rememberâ€”the mentor is a guide who supports, not a judge or taskmaster."
                            }
                        ]
                    },
                    {
                        key: "project-cv",
                        type: "story",
                        icon: "fas fa-user-tie",
                        title: "Project Story: Developing a CV",
                        quote: "\"I needed a strong CV to apply for work.\"",
                        image: {
                            src: "https://images.pexels.com/photos/590022/pexels-photo-590022.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A person writing a CV at a desk"
                        },
                        process: {
                            label: "The Process:",
                            text: "Laila partnered with her mentor to identify key skills, choose powerful action verbs, and organise her experience into a compelling narrative."
                        },
                        outcome: {
                            label: "The Outcome:",
                            text: "She now has a polished CV that highlights her strengths and feels confident applying for new opportunities."
                        }
                    },
                    {
                        key: "project-speaking",
                        type: "story",
                        icon: "fas fa-podium-star",
                        title: "Project Story: Public Speaking",
                        quote: "\"I was nervous about giving presentations.\"",
                        image: {
                            src: "https://images.pexels.com/photos/1181406/pexels-photo-1181406.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A person giving a presentation to an audience"
                        },
                        process: {
                            label: "The Process:",
                            text: "Mariam practised weekly with her mentor, using recordings to reflect on pacing, body language, and clarity."
                        },
                        outcome: {
                            label: "The Outcome:",
                            text: "She delivered a confident presentation and built a repeatable routine for future talks."
                        }
                    },
                    {
                        key: "smart-framework",
                        type: "content",
                        icon: "fas fa-bullseye",
                        title: "Create a Measurable Project",
                        image: {
                            src: "https://images.pexels.com/photos/853151/pexels-photo-853151.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A group of people working together to achieve a goal"
                        },
                        body: [
                            "Successful projects require clear goals. To make sure your project is effective, we use the SMART framework.",
                            "This approach keeps outcomes measurable and realistic for a three-month partnership."
                        ],
                        listStyle: "smart",
                        list: [
                            { letter: "S", text: "Specific" },
                            { letter: "M", text: "Measurable" },
                            { letter: "A", text: "Achievable" },
                            { letter: "R", text: "Relevant" },
                            { letter: "T", text: "Time-bound" }
                        ]
                    },
                    {
                        key: "smart-example",
                        type: "content",
                        icon: "fas fa-check-circle",
                        title: "Example: A SMART Goal",
                        image: {
                            src: "https://images.pexels.com/photos/598917/pexels-photo-598917.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A person writing in a notebook"
                        },
                        body: [
                            "Consider the broad goal: \"I want to improve my CV.\"",
                            "To make it SMART, add clear actions and a deadline: \"I will update my CV to describe three key skills with evidence and finish by the end of this month.\""
                        ]
                    },
                    {
                        key: "journey-steps",
                        type: "process",
                        icon: "fas fa-rocket",
                        title: "Project Journey Milestones",
                        subtitle: "Refine your idea, match with a mentor, and plan together.",
                        image: {
                            src: "https://images.pexels.com/photos/8386440/pexels-photo-8386440.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A person interacting with an AI assistant"
                        },
                        body: [
                            "Each mentoring partnership moves through three steady stages."
                        ],
                        steps: [
                            { title: "Step 1: AI Guide", description: "Use our planning tool to turn your idea into a detailed SMART proposal." },
                            { title: "Step 2: Mentor Matching", description: "We review your project and pair you with someone whose expertise aligns with your goals." },
                            { title: "Step 3: First Meeting", description: "You and your mentor set expectations and map out weekly tasks for the coming months." }
                        ]
                    },
                    {
                        key: "journey-quiz",
                        type: "quiz",
                        icon: "fas fa-route",
                        title: "Quick Check: Journey Steps",
                        questions: [
                            {
                                id: "journey-q1",
                                prompt: "What happens right after you submit your project proposal?",
                                options: [
                                    { value: "matching", label: "The team reviews it and pairs you with a mentor whose experience fits your goal." },
                                    { value: "presentation", label: "You immediately present your project to the whole community." },
                                    { value: "budget", label: "You complete reimbursement paperwork for supplies." }
                                ],
                                answer: "matching",
                                correctFeedback: "Correctâ€”the team reviews your plan and matches you with the right mentor.",
                                incorrectFeedback: "Not quite. Review the journey slides to see what happens post-submission."
                            },
                            {
                                id: "journey-q2",
                                prompt: "What is the focus of the first mentor meeting?",
                                options: [
                                    { value: "weekly-plan", label: "Co-creating detailed weekly steps and agreeing on expectations." },
                                    { value: "celebration", label: "Celebrating the final results of your project." },
                                    { value: "reporting", label: "Submitting monthly reports to the admin team." }
                                ],
                                answer: "weekly-plan",
                                correctFeedback: "Exactly! The first meeting sets the shared weekly plan.",
                                incorrectFeedback: "Check the milestone slideâ€”the first session is about planning, not reporting yet."
                            }
                        ]
                    },
                    {
                        key: "commitments",
                        type: "content",
                        icon: "fas fa-clock",
                        title: "Time Commitment & Boundaries",
                        image: {
                            src: "https://images.pexels.com/photos/4348403/pexels-photo-4348403.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A person working at a desk with a clock in the background"
                        },
                        list: [
                            { icon: "fas fa-calendar-alt", strong: "Project Duration:", text: "The project is designed to be completed in three months." },
                            { icon: "fas fa-hourglass-half", strong: "Mentor Time:", text: "Mentors allocate up to one hour each week for check-ins and feedback." },
                            { icon: "fas fa-plus-circle", strong: "Contingency:", text: "If needed, you can request a one-month extension to complete final pieces." }
                        ]
                    },
                    {
                        key: "commitment-quiz",
                        type: "quiz",
                        icon: "fas fa-user-shield",
                        title: "Quick Check: Commitments & Care",
                        questions: [
                            {
                                id: "care-q1",
                                prompt: "How long is each weekly mentoring session designed to last?",
                                options: [
                                    { value: "thirty", label: "About 30 minutes focused on reflection and planning." },
                                    { value: "sixty", label: "Exactly 60 minutes with required presentations." },
                                    { value: "drop-in", label: "No set timeâ€”mentees drop in and out at any point." }
                                ],
                                answer: "thirty",
                                correctFeedback: "Great! Weekly check-ins are focused, 30-minute conversations.",
                                incorrectFeedback: "Take another lookâ€”the program keeps meetings short and consistent."
                            },
                            {
                                id: "care-q2",
                                prompt: "What happens if a mentee misses three sessions in a row without an acceptable reason?",
                                options: [
                                    { value: "bonus", label: "They receive extra time with their mentor to catch up." },
                                    { value: "hold", label: "The project is placed on hold until the mentee is ready to re-engage." },
                                    { value: "replacement", label: "They are automatically assigned a new mentor." }
                                ],
                                answer: "hold",
                                correctFeedback: "Correctâ€”the project pauses so mentees can return when ready.",
                                incorrectFeedback: "Review the boundaries slide; consistency keeps the partnership active."
                            }
                        ]
                    },
                    {
                        key: "brainstorm",
                        type: "content",
                        icon: "fas fa-lightbulb",
                        title: "Next Steps: Brainstorming",
                        subtitle: "Letâ€™s surface your ideas and questions.",
                        image: {
                            src: "https://images.pexels.com/photos/3184465/pexels-photo-3184465.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A group of people brainstorming with sticky notes"
                        },
                        body: [
                            "Take a moment to share any project ideas already on your mind.",
                            "Weâ€™ll spend the next 20 minutes using the AI guide tool to draft initial proposals.",
                            "Bring forward any questions about the mentoring process or your concept."
                        ]
                    },
                    {
                        key: "reflection",
                        type: "reflection",
                        icon: "fas fa-pen-to-square",
                        title: "Reflection & Planning Notes",
                        fields: [
                            { id: "mentoring-idea", label: "Project idea I want to explore", placeholder: "Capture the community challenge or opportunity you care about." },
                            { id: "mentoring-smart", label: "First SMART-aligned step I can take", placeholder: "Draft a Specific, Measurable action you can complete soon." },
                            { id: "mentoring-questions", label: "Questions I want to ask my mentor", placeholder: "List the support, resources, or feedback you hope to receive." }
                        ],
                        nav: { nextAction: "restart", nextLabel: "Finish & Restart", nextIcon: "fas fa-check" }
                    }
                ]
            },
            eltLesson: {
                id: "elt-lesson-template",
                label: "ELT descriptive language lesson",
                meta: {
                    eyebrow: "English Language Teaching",
                    descriptor: "Reusable slide flow for communicative ELT lessons focused on descriptive language.",
                    pageTitle: "ELT Lesson Template â€“ Instructional Slides"
                },
                sections: [
                    { title: "Welcome & Objectives", slideKeys: ["elt-hero", "elt-objectives", "elt-warmups"] },
                    { title: "Language Focus", slideKeys: ["elt-vocabulary", "elt-vocab-quiz", "elt-modeling"] },
                    { title: "Lesson Flow", slideKeys: ["elt-lesson-flow", "elt-assessment"] },
                    { title: "Practice & Reflection", slideKeys: ["elt-group-work", "elt-reflection"] }
                ],
                slides: [
                    {
                        key: "elt-hero",
                        type: "hero",
                        title: "Exploring Descriptive Language",
                        subtitle: "An adaptable lesson template for upper-intermediate learners.",
                        image: {
                            src: "https://images.pexels.com/photos/3184298/pexels-photo-3184298.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Students collaborating at a table with notebooks"
                        },
                        nav: { hidePrev: true, nextLabel: "Begin", nextIcon: "fas fa-play" }
                    },
                    {
                        key: "elt-objectives",
                        type: "content",
                        icon: "fas fa-bullseye",
                        title: "Lesson Objectives",
                        image: {
                            src: "https://images.pexels.com/photos/3184328/pexels-photo-3184328.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Teacher leading a discussion with adult learners"
                        },
                        body: [
                            "Set clear language targets before class begins so everyone understands the journey.",
                            "Use this template to communicate goals in seconds."],
                        list: [
                            "Activate prior knowledge about vivid descriptions.",
                            "Practise using sensory adjectives and strong verbs.",
                            "Produce a short description that shows voice and detail."
                        ]
                    },
                    {
                        key: "elt-warmups",
                        type: "cards",
                        icon: "fas fa-sun",
                        title: "Warm-Up Options",
                        subtitle: "Choose a quick engagement to open class.",
                        cards: [
                            { icon: "fas fa-image", title: "Picture Prompt", description: "Display an image and ask learners to list adjectives." },
                            { icon: "fas fa-comments", title: "Two Truths", description: "Learners share two descriptive sentencesâ€”one must be imaginary." },
                            { icon: "fas fa-music", title: "Sound Walk", description: "Play ambient audio and brainstorm vocabulary for what is heard." },
                            { icon: "fas fa-lightbulb", title: "Word Association", description: "Start with a noun and build a descriptive chain together." }
                        ]
                    },
                    {
                        key: "elt-vocabulary",
                        type: "content",
                        icon: "fas fa-book-open",
                        title: "Vocabulary Focus",
                        image: {
                            src: "https://images.pexels.com/photos/5428832/pexels-photo-5428832.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Close-up of hands writing vocabulary notes"
                        },
                        body: [
                            "Model a short descriptive paragraph and highlight the language choices that make it vivid.",
                            "Encourage learners to notice collocations and the rhythm created by varied sentence lengths."
                        ],
                        list: [
                            "Contrast plain versus evocative adjectives.",
                            "Collect verb-noun partnerships that add energy.",
                            "Flag discourse markers that guide the reader." ]
                    },
                    {
                        key: "elt-vocab-quiz",
                        type: "quiz",
                        icon: "fas fa-spell-check",
                        title: "Quick Check: Vocabulary Moves",
                        questions: [
                            {
                                id: "elt-vocab-q1",
                                prompt: "Which sentence uses sensory detail most effectively?",
                                options: [
                                    { value: "plain", label: "The market was busy and people talked." },
                                    { value: "vivid", label: "The market buzzed with voices and citrus peels perfumed the air." },
                                    { value: "short", label: "The market was there." }
                                ],
                                answer: "vivid",
                                correctFeedback: "Yesâ€”the vivid option layers sound and smell to engage readers.",
                                incorrectFeedback: "Try again. Look for language that appeals to multiple senses."
                            },
                            {
                                id: "elt-vocab-q2",
                                prompt: "Why is it helpful to collect verbâ€“noun partnerships during the lesson?",
                                options: [
                                    { value: "variety", label: "They help learners vary phrasing and avoid repeating basic verbs." },
                                    { value: "length", label: "They guarantee every sentence is longer." },
                                    { value: "grammar", label: "They replace the need to review grammar structures." }
                                ],
                                answer: "variety",
                                correctFeedback: "Exactlyâ€”collocations give learners ready-to-use alternatives.",
                                incorrectFeedback: "Remember, collecting pairs supports expressive variety, not sentence length." }
                        ]
                    },
                    {
                        key: "elt-modeling",
                        type: "story",
                        icon: "fas fa-chalkboard-teacher",
                        title: "Teacher Modeling",
                        quote: "\"Letâ€™s paint the scene together.\"",
                        image: {
                            src: "https://images.pexels.com/photos/3184312/pexels-photo-3184312.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Teacher presenting vocabulary on a whiteboard"
                        },
                        process: {
                            label: "Approach:",
                            text: "The teacher thinks aloud while drafting a descriptive paragraph, highlighting word choice decisions." },
                        outcome: {
                            label: "Learner Impact:",
                            text: "Students see how to revise dull phrases and feel confident trying the routine themselves." }
                    },
                    {
                        key: "elt-lesson-flow",
                        type: "process",
                        icon: "fas fa-layer-group",
                        title: "Lesson Flow",
                        subtitle: "Structure the experience around gradual release.",
                        image: {
                            src: "https://images.pexels.com/photos/3184287/pexels-photo-3184287.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Learners working collaboratively at a table"
                        },
                        steps: [
                            { title: "Engage", description: "Activate prior knowledge with a warm-up and set the scene." },
                            { title: "Explore Language", description: "Analyse model texts, highlight vocabulary, and notice patterns." },
                            { title: "Guided Practice", description: "Co-construct sentences and offer quick feedback." },
                            { title: "Independent Production", description: "Learners craft their own description and share with peers." }
                        ]
                    },
                    {
                        key: "elt-assessment",
                        type: "content",
                        icon: "fas fa-clipboard-list",
                        title: "Assessment & Evidence",
                        image: {
                            src: "https://images.pexels.com/photos/1181370/pexels-photo-1181370.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Teacher reviewing student work with sticky notes"
                        },
                        body: [
                            "Collect lightweight evidence throughout the lesson to track growth and plan next steps."
                        ],
                        list: [
                            "Use observation checklists during guided practice.",
                            "Invite learners to submit a short exit description or voice note.",
                            "Facilitate peer feedback focusing on descriptive language goals." ]
                    },
                    {
                        key: "elt-group-work",
                        type: "content",
                        icon: "fas fa-users",
                        title: "Collaborative Practice",
                        subtitle: "Rotate roles so everyone speaks and supports.",
                        image: {
                            src: "https://images.pexels.com/photos/3182833/pexels-photo-3182833.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Small group of learners discussing around a table"
                        },
                        body: [
                            "Assign trios with roles: narrator, detail detective, and tone coach.",
                            "After each round, rotate roles and swap prompts to maximise practice." ]
                    },
                    {
                        key: "elt-reflection",
                        type: "reflection",
                        icon: "fas fa-pen-to-square",
                        title: "Teacher Planning Notes",
                        fields: [
                            { id: "elt-focus", label: "Focus language point", placeholder: "Note the adjectives, verbs, or discourse markers you want to emphasise." },
                            { id: "elt-context", label: "Real-life scenario", placeholder: "Describe the context or text type learners will connect to." },
                            { id: "elt-followup", label: "Follow-up idea", placeholder: "Capture homework, extension, or differentiation options." }
                        ],
                        nav: { nextAction: "restart", nextLabel: "Finish & Restart", nextIcon: "fas fa-check" }
                    }
                ]
            },
            curatorialWorkshop: {
                id: "echoes-of-palestine",
                label: "Echoes of Palestine â€“ Curatorial Workshop",
                meta: {
                    eyebrow: "Art & Negotiation Workshop",
                    descriptor: "A flexible lesson exploring curatorial negotiation and collective storytelling.",
                    pageTitle: "\"Echoes of Palestine\" â€“ Curatorial Workshop Slides"
                },
                sections: [
                    { title: "Lead-in", slideKeys: ["lead-in"] },
                    { title: "Pre-task Toolkit", slideKeys: ["pre-task-a", "pre-task-b", "pre-task-c"] },
                    { title: "Curatorial Task", slideKeys: ["the-task", "reporting", "reflection"] }
                ],
                slides: [
                    {
                        key: "lead-in",
                        type: "blueprint",
                        nav: { hidePrev: true },
                        layout: { type: "single-column", alignment: "center" },
                        media: {
                            src: "https://images.pexels.com/photos/164455/pexels-photo-164455.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Mural of a contemplative face painted on a city wall"
                        },
                        blocks: [
                            { type: "heading", tag: "h1", text: "What Makes Art Powerful?", isSlideTitle: true },
                            {
                                type: "activity",
                                title: "Activity: Think-Pair-Share",
                                description: "Think-Pair-Share",
                                ordered: true,
                                className: "blueprint-block--mt-space-7",
                                steps: [
                                    { title: "Think (1 minute)", description: "Look at the image. What story do you think the artist is trying to tell? What emotions does it make you feel?" },
                                    { title: "Pair (2 minutes)", description: "With a partner, discuss your interpretations. Did you see the same story? What elements of the artwork (colors, subject, style) led you to your interpretation?" },
                                    { title: "Share (3 minutes)", description: "Be prepared to share your pair's key ideas with the class." }
                                ]
                            }
                        ],
                        blueprintNotes: {
                            summary: "Design blueprint",
                            layout: "Single-column vertical flow with centered alignment for the hero image, title, and activity instructions.",
                            typography: [
                                "Title: h1 using var(--font-display) at var(--step-4) in var(--forest-shadow) with centered alignment.",
                                "Activity title: h3 display font at var(--step-2) in var(--forest-shadow).",
                                "Body text: var(--font-body) at var(--step-0) with 1.6 line height."
                            ],
                            components: [
                                "Image spans the full content width with var(--radius-lg) corners and var(--shadow-1) shadow.",
                                "Think-Pair-Share steps live in a padded activity block with clear ordered formatting."
                            ],
                            spacing: [
                                "Image margin-bottom var(--space-4).",
                                "Activity block margin-top var(--space-7).",
                                "List items maintain var(--space-2) spacing."
                            ]
                        }
                    },
                    {
                        key: "pre-task-a",
                        type: "blueprint",
                        layout: { type: "single-column", alignment: "left" },
                        blocks: [
                            { type: "heading", tag: "h3", text: "The Language of Art", isSlideTitle: true },
                            {
                                type: "definitionList",
                                items: [
                                    { term: "Medium", definition: "The materials used to create a work of art (e.g., oil on canvas, photography, sculpture)." },
                                    { term: "Theme", definition: "The main idea or message of the artwork (e.g., identity, resilience, memory)." },
                                    { term: "Symbolism", definition: "The use of objects or images to represent bigger ideas (e.g., a key representing lost homes)." },
                                    { term: "Style", definition: "The distinctive visual manner in which an artist creates (e.g., abstract, figurative, surreal)." },
                                    { term: "Narrative", definition: "The story that the artwork tells." }
                                ]
                            },
                            {
                                type: "activity",
                                title: "Activity: Become the Expert",
                                ordered: true,
                                className: "blueprint-block--mt-space-7",
                                steps: [
                                    { description: "In your group, each person will be assigned one or two terms." },
                                    { description: "Take two minutes to make sure you understand your term(s) and can explain them in your own words." },
                                    { description: "Take turns explaining your expert terms to your group. The other members should listen and can ask questions to clarify." }
                                ]
                            }
                        ],
                        blueprintNotes: {
                            summary: "Design blueprint",
                            layout: "Single-column layout with left-aligned text for readability.",
                            typography: [
                                "Main title uses h3 with var(--font-display) at var(--step-2).",
                                "Definition terms appear in bold with var(--primary-sage).",
                                "Activity heading set in var(--font-display) at var(--step-1)."
                            ],
                            components: [
                                "Definitions use an unordered list with strong terms followed by plain-language explanations.",
                                "Activity block styled as a lightly bordered card to distinguish instructions."
                            ],
                            spacing: [
                                "Definition entries carry var(--space-3) separation.",
                                "Activity box sits var(--space-7) below the list."
                            ]
                        }
                    },
                    {
                        key: "pre-task-b",
                        type: "blueprint",
                        layout: { type: "single-column", alignment: "left" },
                        blocks: [
                            { type: "heading", tag: "h3", text: "How to Be a Curator: Functional Language", isSlideTitle: true },
                            {
                                type: "grid",
                                columns: "repeat(auto-fit, minmax(160px, 1fr))",
                                items: [
                                    { title: "Expressing Opinion", list: ["I believe...", "From my perspective...", "What stands out is..."] },
                                    { title: "Agreeing", list: ["I see your point.", "That's a great choice.", "I agree with you."] },
                                    { title: "Politely Disagreeing", list: ["I see it differently.", "I understand, but...", "While that's strong, I'm not sure..."] },
                                    { title: "Making a Compromise", list: ["What if we include...?", "Can we agree on...?", "Let's go with that one, then."] }
                                ]
                            },
                            {
                                type: "activity",
                                title: "Activity: Choose the Title",
                                description: "With your group, you have 3 minutes to choose the best title for your upcoming exhibition. Use the functional language above to discuss the options and come to a consensus.",
                                name: "exhibition-title",
                                options: [
                                    { value: "option-a", label: "Option A: Fragments of a Homeland" },
                                    { value: "option-b", label: "Option B: Echoes of Palestine" },
                                    { value: "option-c", label: "Option C: The Olive and the Key" }
                                ],
                                className: "blueprint-block--mt-space-7"
                            }
                        ],
                        blueprintNotes: {
                            summary: "Design blueprint",
                            layout: "Top section uses a responsive grid, followed by a single-column activity section.",
                            typography: [
                                "Main title: h3 with var(--font-display) at var(--step-2).",
                                "Category headings: h4 with var(--primary-sage).",
                                "Activity instructions in var(--font-body) at var(--step-0)."
                            ],
                            components: [
                                "Language cards presented in softly bordered containers with padding.",
                                "Radio options styled with full-width clickable labels for quick decisions."
                            ],
                            spacing: [
                                "Grid gap set to var(--space-4).",
                                "Activity block begins after var(--space-7) separation.",
                                "Radio options spaced by var(--space-3)."
                            ]
                        }
                    },
                    {
                        key: "pre-task-c",
                        type: "blueprint",
                        layout: { type: "single-column", alignment: "left" },
                        blocks: [
                            { type: "heading", tag: "h3", text: "The \"Fragments of a Homeland\" Collective", isSlideTitle: true },
                            {
                                type: "profiles",
                                items: [
                                    { name: "Laila", meta: "Digital Artist, Gaza", focus: "Focuses on memory, nostalgia, and the resilience of youth." },
                                    { name: "Yousef", meta: "Painter/Sculptor, Ramallah", focus: "Focuses on connection to the land and cultural heritage." },
                                    { name: "Rania", meta: "Interdisciplinary Artist, London", focus: "Focuses on identity, exile, and life in the diaspora." }
                                ]
                            },
                            {
                                type: "activity",
                                title: "Activity: Rank & Justify",
                                ordered: true,
                                className: "blueprint-block--mt-space-7",
                                steps: [
                                    { title: "Individually (1 minute)", description: "Rank the artists (1, 2, 3) based on whose focus you find most compelling for an international audience." },
                                    { title: "With a Partner (3 minutes)", description: "Justify your #1 choice to your partner. Use the language of opinion to persuade them." }
                                ]
                            }
                        ],
                        blueprintNotes: {
                            summary: "Design blueprint",
                            layout: "Single-column layout foregrounding artist information before the task.",
                            typography: [
                                "Slide title uses h3 with var(--font-display) at var(--step-2).",
                                "Artist names set in bold var(--font-body) at var(--step-1).",
                                "Activity title uses var(--font-display) at var(--step-1)."
                            ],
                            components: [
                                "Artist bios presented in a stacked list with clear name, meta, and focus lines.",
                                "Ranking task instructions provided inside an activity card with ordered steps."
                            ],
                            spacing: [
                                "Each artist block separated by var(--space-5).",
                                "Activity section begins after var(--space-7)."
                            ]
                        }
                    },
                    {
                        key: "the-task",
                        type: "blueprint",
                        layout: { type: "single-column", alignment: "left" },
                        blocks: [
                            { type: "heading", tag: "h3", text: "Curating \"Echoes of Palestine\" (Group Negotiation)", isSlideTitle: true },
                            { type: "text", tag: "p", text: "In your curatorial groups, you must negotiate and select the three best artworks for the exhibition. You must all agree on the final selection and be able to justify your choices. Remember to use the functional language for negotiation." },
                            {
                                type: "gallery",
                                className: "blueprint-block--mt-space-6",
                                items: [
                                    {
                                        title: "Gaza Dreams",
                                        subtitle: "Laila",
                                        image: {
                                            src: "https://images.pexels.com/photos/14899381/pexels-photo-14899381.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                                            alt: "Child in a yellow jacket flying a kite",
                                            loading: "lazy"
                                        }
                                    },
                                    {
                                        title: "Inheritance",
                                        subtitle: "Yousef",
                                        image: {
                                            src: "https://images.pexels.com/photos/8582333/pexels-photo-8582333.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                                            alt: "Vintage key resting on a rustic surface",
                                            loading: "lazy"
                                        }
                                    },
                                    {
                                        title: "Fragmented City",
                                        subtitle: "Rania",
                                        image: {
                                            src: "https://images.pexels.com/photos/8149633/pexels-photo-8149633.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                                            alt: "Abstract painting with geometric city forms",
                                            loading: "lazy"
                                        }
                                    },
                                    {
                                        title: "The Storyteller",
                                        subtitle: "Yousef",
                                        image: {
                                            src: "https://images.pexels.com/photos/8001153/pexels-photo-8001153.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                                            alt: "Portrait of an elder with deep expression lines",
                                            loading: "lazy"
                                        }
                                    },
                                    {
                                        title: "Walled Garden",
                                        subtitle: "Laila",
                                        image: {
                                            src: "https://images.pexels.com/photos/3230137/pexels-photo-3230137.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                                            alt: "Open doorway leading to greenery beyond a wall",
                                            loading: "lazy"
                                        }
                                    },
                                    {
                                        title: "Unsent Letters",
                                        subtitle: "Rania",
                                        image: {
                                            src: "https://images.pexels.com/photos/1089578/pexels-photo-1089578.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                                            alt: "Rolled parchment letters tied with twine",
                                            loading: "lazy"
                                        }
                                    }
                                ]
                            }
                        ],
                        blueprintNotes: {
                            summary: "Design blueprint",
                            layout: "Single-column introduction that transitions into a responsive artwork grid.",
                            typography: [
                                "Main title uses h3 display styling at var(--step-2).",
                                "Scenario paragraph in var(--font-body) with 1.6 line height.",
                                "Artwork titles presented as bold h4 elements."
                            ],
                            components: [
                                "Gallery cards feature imagery with matching rounded corners and shadowed backgrounds.",
                                "Each card highlights title and artist attribution for quick reference."
                            ],
                            spacing: [
                                "Scenario paragraph separated from gallery by var(--space-6).",
                                "Gallery grid gap set to var(--space-5)."
                            ]
                        }
                    },
                    {
                        key: "reporting",
                        type: "blueprint",
                        layout: { type: "single-column", alignment: "left" },
                        blocks: [
                            { type: "heading", tag: "h3", text: "Our Selections for \"Echoes of Palestine\"", isSlideTitle: true },
                            { type: "text", tag: "p", text: "One member from each group will present your final selections and the curatorial statement to the class." },
                            {
                                type: "reporting",
                                className: "blueprint-block--mt-space-7",
                                sections: [
                                    {
                                        title: "Artwork 1",
                                        fields: [
                                            { label: "Artwork 1: (Image and Title)", type: "text", placeholder: "Paste the image link or note the artwork title." },
                                            { label: "Justification:", type: "textarea", minHeight: "100px", placeholder: "Summarize why this piece belongs in the exhibition." }
                                        ]
                                    },
                                    {
                                        title: "Artwork 2",
                                        fields: [
                                            { label: "Artwork 2: (Image and Title)", type: "text", placeholder: "Paste the image link or note the artwork title." },
                                            { label: "Justification:", type: "textarea", minHeight: "100px", placeholder: "Explain how this choice supports your theme." }
                                        ]
                                    },
                                    {
                                        title: "Artwork 3",
                                        fields: [
                                            { label: "Artwork 3: (Image and Title)", type: "text", placeholder: "Paste the image link or note the artwork title." },
                                            { label: "Justification:", type: "textarea", minHeight: "100px", placeholder: "Describe the story this piece contributes." }
                                        ]
                                    },
                                    {
                                        title: "Our Collective's Curatorial Statement",
                                        fields: [
                                            { label: "Statement", type: "textarea", minHeight: "150px", placeholder: "Capture the shared narrative your exhibition tells." }
                                        ]
                                    }
                                ]
                            }
                        ],
                        blueprintNotes: {
                            summary: "Design blueprint",
                            layout: "Single-column output slide structured for easy reporting.",
                            typography: [
                                "Main title uses h3 display styling at var(--step-2).",
                                "Section titles styled as h4 with var(--primary-sage).",
                                "Labels use bold var(--font-body)."
                            ],
                            components: [
                                "Each artwork section bundles text fields and justification textareas.",
                                "Final statement offers an expanded textarea to record the collective voice."
                            ],
                            spacing: [
                                "Artwork sections separated by var(--space-7).",
                                "Field groups maintain var(--space-2) internal spacing."
                            ]
                        }
                    },
                    {
                        key: "reflection",
                        type: "blueprint",
                        layout: { type: "single-column", alignment: "left" },
                        blocks: [
                            { type: "heading", tag: "h3", text: "Debriefing the Curatorial Process", isSlideTitle: true },
                            { type: "heading", tag: "h4", text: "Activity: Class Discussion", className: "blueprint-block--mt-space-4" },
                            { type: "text", tag: "p", text: "Be prepared to discuss the following questions as a class." },
                            {
                                type: "questions",
                                className: "blueprint-block--mt-space-5",
                                items: [
                                    "What were the most challenging aspects of the negotiation?",
                                    "Which artworks sparked the most debate, and why?",
                                    "How did your group's final selection represent a compromise or a consensus?",
                                    "What did this process teach you about the challenges and responsibilities of representing a collective voice through art?"
                                ]
                            }
                        ],
                        blueprintNotes: {
                            summary: "Design blueprint",
                            layout: "Clean single-column layout that keeps attention on reflective prompts.",
                            typography: [
                                "Slide title uses h3 display styling at var(--step-2).",
                                "Activity heading uses h4 with var(--font-display).",
                                "Question list uses var(--font-body) at var(--step-0) with 1.7 line height."
                            ],
                            components: [
                                "Reflection questions presented as a custom-bullet unordered list for clarity.",
                                "Introductory paragraph sets expectations before discussion."
                            ],
                            spacing: [
                                "Question list begins after var(--space-5) separation.",
                                "List items spaced by var(--space-3)."
                            ]
                        }
                    }
                ]
            },
            questionTypesShowcase: {
                id: "question-types-showcase",
                label: "Interactive question types",
                meta: {
                    eyebrow: "Mosaic Presenter",
                    descriptor: "Interactive templates converted from standalone activities.",
                    pageTitle: "Interactive Question Types â€“ Instructional Slides"
                },
                sections: [
                    { title: "Gap-fill dropdown", slideKeys: ["roman-gapfill"] },
                    { title: "Ordering task", slideKeys: ["writing-process-ranking"] },
                    { title: "Categorising language", slideKeys: ["discourse-grouping"] },
                    { title: "Multiple-choice grid", slideKeys: ["states-of-matter-grid"] }
                ],
                slides: [
                    {
                        key: "roman-gapfill",
                        type: "gapfill",
                        icon: "fas fa-landmark",
                        title: "The Roman Empire",
                        subtitle: "Fill in the gaps to complete each sentence.",
                        image: {
                            src: "https://images.pexels.com/photos/208636/pexels-photo-208636.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Exterior of the Roman Colosseum at sunset"
                        },
                        instructions: "Select the best answer in each dropdown before checking your work.",
                        paragraph: [
                            { type: "text", content: "The famous amphitheater in the center of the city, known for its gladiator contests, is called the " },
                            {
                                type: "gap",
                                id: "roman-gap-1",
                                answer: "Colosseum",
                                options: ["Colosseum", "Pantheon", "Forum"],
                                feedbackTitle: "The famous amphitheater is the Colosseum",
                                explanation: "The Colosseum was the largest amphitheater ever built and was used for gladiatorial contests and public spectacles."
                            },
                            { type: "text", content: ". The governing and advisory assembly of the aristocracy in the ancient Roman Republic was the " },
                            {
                                type: "gap",
                                id: "roman-gap-2",
                                answer: "Senate",
                                options: ["Assembly", "Senate", "Council"],
                                feedbackTitle: "The governing assembly was the Senate",
                                explanation: "The Senate was a permanent and powerful institution in the Roman government, composed of the most prominent men in Rome."
                            },
                            { type: "text", content: ". A " },
                            {
                                type: "gap",
                                id: "roman-gap-3",
                                answer: "legion",
                                options: ["battalion", "phalanx", "legion"],
                                feedbackTitle: "The largest Roman army unit was the legion",
                                explanation: "The legion was the backbone of the Roman military machine, known for its discipline and effectiveness in battle."
                            },
                            { type: "text", content: " was the largest unit of the Roman army. According to legend, the city of " },
                            {
                                type: "gap",
                                id: "roman-gap-4",
                                answer: "Rome",
                                options: ["Athens", "Carthage", "Rome"],
                                feedbackTitle: "The city founded by twins was Rome",
                                explanation: "The founding myth of Rome, involving twin brothers Romulus and Remus, is a cornerstone of Roman culture and history."
                            },
                            { type: "text", content: " was founded by the twin brothers Romulus and Remus in 753 BC." }
                        ]
                    },
                    {
                        key: "writing-process-ranking",
                        type: "ranking",
                        icon: "fas fa-list-ol",
                        title: "The Writing Process",
                        subtitle: "Arrange the stages from first to last.",
                        image: {
                            src: "https://images.pexels.com/photos/670723/pexels-photo-670723.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Writer planning ideas with a notebook and laptop"
                        },
                        instructions: "Move the stages until they are in the correct order, then check your work.",
                        items: [
                            {
                                id: "prewriting",
                                label: "Prewriting",
                                correctRank: 1,
                                explanation: "Prewriting is the first step, where you brainstorm ideas, research, and outline your topic before you begin writing."
                            },
                            {
                                id: "drafting",
                                label: "Drafting",
                                correctRank: 2,
                                explanation: "Drafting is the second stage. This is where you write the first version of your text, focusing on getting your ideas down on paper."
                            },
                            {
                                id: "revising",
                                label: "Revising",
                                correctRank: 3,
                                explanation: "Revising is the third stage. Here, you review the content, organization, and clarity of your draft, making significant changes to improve the overall piece."
                            },
                            {
                                id: "editing",
                                label: "Editing & Proofreading",
                                correctRank: 4,
                                explanation: "Editing & Proofreading is the fourth stage. After revising the big picture, you focus on correcting grammar, spelling, punctuation, and formatting errors."
                            },
                            {
                                id: "publishing",
                                label: "Publishing",
                                correctRank: 5,
                                explanation: "Publishing is the final stage, where you share your polished work with its intended audience."
                            }
                        ],
                        initialOrder: ["revising", "prewriting", "publishing", "drafting", "editing"],
                        checkLabel: "Check order",
                        resetLabel: "Reset order"
                    },
                    {
                        key: "discourse-grouping",
                        type: "grouping",
                        icon: "fas fa-language",
                        title: "Discourse Markers",
                        subtitle: "Categorise these linking words by their function.",
                        image: {
                            src: "https://images.pexels.com/photos/159775/books-college-library-learning-159775.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Stacks of books on a library table"
                        },
                        instructions: "Assign each linking word to the function it best represents.",
                        categories: [
                            { id: "addition", label: "Addition" },
                            { id: "contrast", label: "Contrast" },
                            { id: "consequence", label: "Consequence" }
                        ],
                        items: [
                            {
                                id: "however",
                                label: "However",
                                category: "contrast",
                                explanation: "'However' is used to introduce a statement that contrasts with or seems to contradict something that has been said previously."
                            },
                            {
                                id: "furthermore",
                                label: "Furthermore",
                                category: "addition",
                                explanation: "'Furthermore' adds another piece of information to the point you are making."
                            },
                            {
                                id: "therefore",
                                label: "Therefore",
                                category: "consequence",
                                explanation: "'Therefore' indicates that a statement is the logical consequence of the one that came before it."
                            },
                            {
                                id: "on-the-other-hand",
                                label: "On the other hand",
                                category: "contrast",
                                explanation: "'On the other hand' is used to present a contrasting point of view."
                            },
                            {
                                id: "as-a-result",
                                label: "As a result",
                                category: "consequence",
                                explanation: "'As a result' shows that the second statement is a result of the first."
                            },
                            {
                                id: "moreover",
                                label: "Moreover",
                                category: "addition",
                                explanation: "'Moreover' is used to introduce a piece of information that adds to or supports the previous one."
                            }
                        ]
                    },
                    {
                        key: "states-of-matter-grid",
                        type: "matching",
                        icon: "fas fa-table",
                        title: "States of Matter",
                        subtitle: "Match each state to its defining properties.",
                        image: {
                            src: "https://images.pexels.com/photos/590570/pexels-photo-590570.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Scientist working with a glowing plasma ball"
                        },
                        instructions: "For each state of matter, choose the property that best fits before checking your answers.",
                        columns: [
                            { id: "col-1", label: "Definite Shape & Volume" },
                            { id: "col-2", label: "Definite Volume" },
                            { id: "col-3", label: "Indefinite Shape & Volume" },
                            { id: "col-4", label: "Ionized Gas" }
                        ],
                        rows: [
                            {
                                id: "solid",
                                label: "Solid",
                                correctColumn: "col-1",
                                explanation: "A solid's particles are tightly packed in a fixed structure, giving it a definite shape and volume."
                            },
                            {
                                id: "liquid",
                                label: "Liquid",
                                correctColumn: "col-2",
                                explanation: "A liquid's particles can slide past one another, allowing it to take the shape of its container, but its volume remains constant."
                            },
                            {
                                id: "gas",
                                label: "Gas",
                                correctColumn: "col-3",
                                explanation: "A gas's particles are far apart and move randomly, allowing it to expand to fill any container, giving it an indefinite shape and volume."
                            },
                            {
                                id: "plasma",
                                label: "Plasma",
                                correctColumn: "col-4",
                                explanation: "Plasma is a superheated state of matter where atoms are stripped of their electrons, creating an ionized gas."
                            }
                        ]
                    }
                ]
            }
        };
        const textboxColorOptions = [
            { label: "Sunlit Sand", value: "#FDF5D6" },
            { label: "Mint Mist", value: "#E6F4F1" },
            { label: "Lavender Veil", value: "#F3E9FB" },
            { label: "Peach Glow", value: "#FFEDE5" },
            { label: "Sky Wash", value: "#E9F0FF" }
        ];

        const storageKeyBase = "instructional-slide-textboxes";
        let activeLessonKey = null;
        let activeLesson = null;
        let slides = [];
        let currentSlideIndex = 0;
        let slideNotes = {};
        const textboxContainers = {};
        const notesPanels = {};
        let notesPanelsHost = null;
        const slideMapButtons = [];
        let keyboardHandlerAttached = false;

        const slidesRoot = document.getElementById("slides-root");
        const presentationEyebrow = document.getElementById("presentation-eyebrow");
        const presentationDescriptor = document.getElementById("presentation-descriptor");
        const lessonSelector = document.getElementById("lesson-template");
        const slideMapList = document.getElementById("slide-map-list");
        const motionQuery = typeof window !== "undefined" && window.matchMedia ? window.matchMedia("(prefers-reduced-motion: reduce)") : null;
        let prefersReducedMotion = motionQuery ? motionQuery.matches : false;

        const highlightScope = document.getElementById("activity-container");
        const highlightToolbar = document.createElement("div");
        highlightToolbar.id = "highlight-toolbar";
        highlightToolbar.setAttribute("role", "group");
        highlightToolbar.setAttribute("aria-label", "Text annotation tools");
        highlightToolbar.setAttribute("aria-hidden", "true");
        highlightToolbar.hidden = true;

        const highlightToolbarButton = document.createElement("button");
        highlightToolbarButton.type = "button";
        highlightToolbarButton.className = "highlight-toolbar__btn";
        highlightToolbarButton.innerHTML = '<i class="fas fa-highlighter" aria-hidden="true"></i><span>Highlight &amp; annotate</span>';
        highlightToolbar.appendChild(highlightToolbarButton);
        document.body.appendChild(highlightToolbar);

        const annotationPopover = document.createElement("div");
        annotationPopover.className = "annotation-popover";
        annotationPopover.id = "annotation-popover";
        annotationPopover.setAttribute("role", "dialog");
        annotationPopover.setAttribute("aria-modal", "false");
        annotationPopover.setAttribute("aria-hidden", "true");
        annotationPopover.hidden = true;
        annotationPopover.setAttribute("tabindex", "-1");

        const annotationCloseButton = document.createElement("button");
        annotationCloseButton.type = "button";
        annotationCloseButton.className = "annotation-popover__close";
        annotationCloseButton.innerHTML = '<i class="fas fa-times" aria-hidden="true"></i><span class="visually-hidden">Close annotation</span>';

        const annotationBody = document.createElement("p");
        annotationBody.className = "annotation-popover__body";

        annotationPopover.appendChild(annotationCloseButton);
        annotationPopover.appendChild(annotationBody);
        document.body.appendChild(annotationPopover);

        const annotationComposer = document.createElement("form");
        annotationComposer.className = "annotation-composer";
        annotationComposer.id = "annotation-composer";
        annotationComposer.hidden = true;
        annotationComposer.setAttribute("aria-hidden", "true");
        annotationComposer.setAttribute("role", "dialog");
        annotationComposer.setAttribute("aria-modal", "false");
        annotationComposer.noValidate = true;

        const annotationComposerLabel = document.createElement("label");
        annotationComposerLabel.className = "annotation-composer__label";
        annotationComposerLabel.setAttribute("for", "annotation-composer-input");
        annotationComposerLabel.textContent = "Add an annotation";
        annotationComposerLabel.id = "annotation-composer-label";
        annotationComposer.setAttribute("aria-labelledby", "annotation-composer-label");

        const annotationComposerTextarea = document.createElement("textarea");
        annotationComposerTextarea.id = "annotation-composer-input";
        annotationComposerTextarea.className = "annotation-composer__input";
        annotationComposerTextarea.rows = 4;
        annotationComposerTextarea.placeholder = "Type your note hereâ€¦";

        const annotationComposerActions = document.createElement("div");
        annotationComposerActions.className = "annotation-composer__actions";

        const annotationComposerCancel = document.createElement("button");
        annotationComposerCancel.type = "button";
        annotationComposerCancel.className = "annotation-composer__btn annotation-composer__btn--secondary";
        annotationComposerCancel.textContent = "Cancel";

        const annotationComposerSubmit = document.createElement("button");
        annotationComposerSubmit.type = "submit";
        annotationComposerSubmit.className = "annotation-composer__btn annotation-composer__btn--primary";
        annotationComposerSubmit.textContent = "Save note";

        annotationComposerActions.appendChild(annotationComposerCancel);
        annotationComposerActions.appendChild(annotationComposerSubmit);

        annotationComposer.appendChild(annotationComposerLabel);
        annotationComposer.appendChild(annotationComposerTextarea);
        annotationComposer.appendChild(annotationComposerActions);
        document.body.appendChild(annotationComposer);

        let pendingSelectionRange = null;
        let activeAnnotationTarget = null;
        let composerActiveRange = null;

        if (motionQuery) {
            const updatePreference = (event) => {
                prefersReducedMotion = event.matches;
                const activeSlide = slides[currentSlideIndex];
                if (activeSlide) {
                    animateSlideContents(activeSlide);
                }
            };
            if (typeof motionQuery.addEventListener === "function") {
                motionQuery.addEventListener("change", updatePreference);
            } else if (typeof motionQuery.addListener === "function") {
                motionQuery.addListener(updatePreference);
            }
        }
        function isNodeWithinActiveSlide(node) {
            const activeSlide = slides[currentSlideIndex];
            if (!activeSlide || !node) {
                return false;
            }
            let current = node.nodeType === Node.ELEMENT_NODE ? node : node.parentNode;
            while (current) {
                if (current === activeSlide) {
                    return true;
                }
                current = current.parentNode;
            }
            return false;
        }

        function isInsideExistingHighlight(node) {
            if (!node) {
                return false;
            }
            const element = node.nodeType === Node.ELEMENT_NODE ? node : node.parentElement;
            return element ? Boolean(element.closest(".highlight-annotation")) : false;
        }

        function hideHighlightToolbar(options = {}) {
            const { clearSelection = true } = options;
            if (highlightToolbar.hidden) {
                return;
            }
            highlightToolbar.hidden = true;
            highlightToolbar.setAttribute("aria-hidden", "true");
            if (clearSelection) {
                pendingSelectionRange = null;
            }
        }

        function positionHighlightToolbar(range) {
            const rect = range.getBoundingClientRect();
            const top = window.scrollY + rect.top;
            const left = window.scrollX + rect.left + rect.width / 2;
            highlightToolbar.style.top = `${Math.max(top, 0)}px`;
            highlightToolbar.style.left = `${left}px`;
        }

        function isRangeAnnotatable(range) {
            if (!range || range.collapsed) {
                return false;
            }
            if (!isNodeWithinActiveSlide(range.startContainer) || !isNodeWithinActiveSlide(range.endContainer)) {
                return false;
            }
            if (isInsideExistingHighlight(range.startContainer) || isInsideExistingHighlight(range.endContainer)) {
                return false;
            }
            const fragment = range.cloneContents();
            if (fragment.querySelector && fragment.querySelector("p, li, div, section, article, ul, ol, table, tr, td, th, h1, h2, h3, h4, h5, h6, blockquote")) {
                return false;
            }
            return range.toString().trim().length > 0;
        }

        function showHighlightToolbar(range) {
            pendingSelectionRange = range.cloneRange();
            positionHighlightToolbar(range);
            highlightToolbar.hidden = false;
            highlightToolbar.setAttribute("aria-hidden", "false");
        }

        function positionAnnotationComposer(range) {
            const rect = range.getBoundingClientRect();
            const top = window.scrollY + rect.bottom + 12;
            const left = window.scrollX + rect.left + rect.width / 2;
            annotationComposer.style.top = `${Math.max(top, 0)}px`;
            annotationComposer.style.left = `${left}px`;
        }

        function openAnnotationComposer(range) {
            if (!range) {
                return;
            }
            composerActiveRange = range.cloneRange();
            positionAnnotationComposer(range);
            annotationComposer.hidden = false;
            annotationComposer.setAttribute("aria-hidden", "false");
            annotationComposerTextarea.value = "";
            window.requestAnimationFrame(() => {
                annotationComposerTextarea.focus({ preventScroll: true });
            });
        }

        function closeAnnotationComposer({ restoreToolbar = false, clearRange = true } = {}) {
            if (!annotationComposer.hidden) {
                annotationComposer.hidden = true;
                annotationComposer.setAttribute("aria-hidden", "true");
                annotationComposerTextarea.value = "";
            }
            if (clearRange) {
                composerActiveRange = null;
            }
            if (restoreToolbar && pendingSelectionRange) {
                showHighlightToolbar(pendingSelectionRange);
            }
        }

        function updateHighlightToolbar() {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) {
                hideHighlightToolbar();
                return;
            }
            const range = selection.getRangeAt(0);
            if (!isRangeAnnotatable(range)) {
                hideHighlightToolbar();
                return;
            }
            hideAnnotationPopover();
            showHighlightToolbar(range);
        }

        function hideAnnotationPopover() {
            if (annotationPopover.hidden) {
                return;
            }
            annotationPopover.hidden = true;
            annotationPopover.setAttribute("aria-hidden", "true");
            if (activeAnnotationTarget) {
                activeAnnotationTarget.setAttribute("aria-expanded", "false");
                activeAnnotationTarget = null;
            }
        }

        function positionAnnotationPopover(target) {
            const rect = target.getBoundingClientRect();
            const top = window.scrollY + rect.bottom + 12;
            const left = window.scrollX + rect.left + rect.width / 2;
            annotationPopover.style.top = `${top}px`;
            annotationPopover.style.left = `${left}px`;
        }

        function showAnnotationPopover(target) {
            const annotationText = target?.dataset?.annotation;
            if (!annotationText) {
                hideAnnotationPopover();
                return;
            }
            if (activeAnnotationTarget && activeAnnotationTarget !== target) {
                activeAnnotationTarget.setAttribute("aria-expanded", "false");
            }
            activeAnnotationTarget = target;
            annotationBody.textContent = annotationText;
            positionAnnotationPopover(target);
            annotationPopover.hidden = false;
            annotationPopover.setAttribute("aria-hidden", "false");
            target.setAttribute("aria-expanded", "true");
        }

        function toggleAnnotationPopover(target) {
            if (annotationPopover.hidden || target !== activeAnnotationTarget) {
                showAnnotationPopover(target);
            } else {
                hideAnnotationPopover();
            }
        }

        function applyAnnotation(range, annotationText) {
            if (!range) {
                return;
            }
            const trimmed = annotationText.trim();
            if (!trimmed) {
                return;
            }
            const workingRange = range.cloneRange();
            const highlight = document.createElement("mark");
            highlight.className = "highlight-annotation";
            highlight.tabIndex = 0;
            highlight.setAttribute("role", "button");
            highlight.setAttribute("aria-expanded", "false");
            highlight.setAttribute("aria-controls", "annotation-popover");
            highlight.setAttribute("aria-haspopup", "dialog");
            highlight.dataset.annotation = trimmed;
            const contents = workingRange.extractContents();
            highlight.appendChild(contents);
            workingRange.insertNode(highlight);
            highlight.normalize();
            if (highlight.parentNode) {
                highlight.parentNode.normalize();
            }
            const selection = window.getSelection();
            if (selection) {
                selection.removeAllRanges();
            }
            hideHighlightToolbar();
            window.requestAnimationFrame(() => {
                showAnnotationPopover(highlight);
                highlight.focus({ preventScroll: true });
            });
        }

        highlightToolbarButton.addEventListener("mousedown", (event) => {
            event.preventDefault();
        });

        highlightToolbarButton.addEventListener("click", () => {
            if (!pendingSelectionRange) {
                hideHighlightToolbar();
                closeAnnotationComposer();
                return;
            }
            const rangeToAnnotate = pendingSelectionRange.cloneRange();
            hideHighlightToolbar({ clearSelection: false });
            openAnnotationComposer(rangeToAnnotate);
        });

        annotationComposer.addEventListener("submit", (event) => {
            event.preventDefault();
            if (!composerActiveRange) {
                closeAnnotationComposer();
                hideHighlightToolbar();
                return;
            }
            const note = annotationComposerTextarea.value.trim();
            if (!note) {
                annotationComposerTextarea.focus({ preventScroll: true });
                return;
            }
            const rangeToAnnotate = composerActiveRange.cloneRange();
            closeAnnotationComposer();
            applyAnnotation(rangeToAnnotate, note);
        });

        annotationComposerCancel.addEventListener("click", () => {
            closeAnnotationComposer({ restoreToolbar: true });
        });

        annotationCloseButton.addEventListener("click", () => {
            hideAnnotationPopover();
            if (activeAnnotationTarget) {
                activeAnnotationTarget.focus({ preventScroll: true });
            }
        });

        document.addEventListener("selectionchange", () => {
            const activeElement = document.activeElement;
            if (!annotationComposer.hidden && annotationComposer.contains(activeElement)) {
                return;
            }
            closeAnnotationComposer();
            window.requestAnimationFrame(updateHighlightToolbar);
        });

        document.addEventListener("mousedown", (event) => {
            const isToolbar = highlightToolbar.contains(event.target);
            const isComposer = annotationComposer.contains(event.target);
            if (!isToolbar && !isComposer) {
                hideHighlightToolbar();
                closeAnnotationComposer();
            }
        });

        document.addEventListener("click", (event) => {
            if (!annotationPopover.hidden) {
                const isHighlight = event.target.closest?.(".highlight-annotation");
                const isPopover = annotationPopover.contains(event.target);
                if (!isHighlight && !isPopover) {
                    hideAnnotationPopover();
                }
            }
            if (!annotationComposer.hidden) {
                const isComposer = annotationComposer.contains(event.target);
                if (!isComposer && !highlightToolbar.contains(event.target)) {
                    closeAnnotationComposer();
                    hideHighlightToolbar();
                }
            }
        });

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                hideAnnotationPopover();
                hideHighlightToolbar();
                closeAnnotationComposer();
            }
        });

        if (highlightScope) {
            highlightScope.addEventListener("click", (event) => {
                const highlight = event.target.closest?.(".highlight-annotation");
                if (!highlight) {
                    return;
                }
                event.preventDefault();
                hideHighlightToolbar();
                toggleAnnotationPopover(highlight);
            });

            highlightScope.addEventListener("keydown", (event) => {
                if (event.key !== "Enter" && event.key !== " ") {
                    return;
                }
                const highlight = event.target.closest?.(".highlight-annotation");
                if (!highlight) {
                    return;
                }
                event.preventDefault();
                hideHighlightToolbar();
                toggleAnnotationPopover(highlight);
            });
        }

        window.addEventListener("scroll", () => {
            hideHighlightToolbar();
            hideAnnotationPopover();
            closeAnnotationComposer();
        }, true);

        window.addEventListener("resize", () => {
            hideHighlightToolbar();
            hideAnnotationPopover();
            closeAnnotationComposer();
        });
        function generateNoteId() {
            return `note-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
        }

        function createColorPicker(currentColor, onChange) {
            const palette = document.createElement("div");
            palette.className = "textbox-color-picker";
            palette.setAttribute("role", "group");
            palette.setAttribute("aria-label", "Change text box colour");
            const swatches = [];
            const updateSelection = (selectedColor) => {
                swatches.forEach((button) => {
                    const isActive = button.dataset.value === selectedColor;
                    button.classList.toggle("is-selected", isActive);
                    button.setAttribute("aria-pressed", isActive ? "true" : "false");
                });
            };
            textboxColorOptions.forEach((option) => {
                const swatchButton = document.createElement("button");
                swatchButton.type = "button";
                swatchButton.className = "textbox-color-picker__swatch";
                swatchButton.dataset.value = option.value;
                swatchButton.style.setProperty("--swatch-color", option.value);
                swatchButton.setAttribute("aria-label", option.label);
                swatchButton.title = option.label;
                swatchButton.setAttribute("aria-pressed", "false");
                swatchButton.addEventListener("click", () => {
                    if (typeof onChange === "function") {
                        onChange(option.value);
                    }
                    updateSelection(option.value);
                });
                palette.appendChild(swatchButton);
                swatches.push(swatchButton);
            });
            updateSelection(currentColor);
            return palette;
        }

        function getSlideLabel(slide, index) {
            const rawTitle = slide?.querySelector(".slide-title")?.textContent?.trim() || "";
            const label = rawTitle ? `${rawTitle}` : "";
            const prefix = `Slide ${index + 1}`;
            return label ? `${prefix}: ${label}` : prefix;
        }

        function isValidNotesData(data) {
            if (!data || typeof data !== "object" || Array.isArray(data)) {
                return false;
            }
            return Object.values(data).every((value) => Array.isArray(value) && value.every((note) => {
                return note && typeof note === "object" && "id" in note && "color" in note && ("content" in note || "text" in note);
            }));
        }

        function getStorageKey() {
            const suffix = activeLesson?.id ? `:${activeLesson.id}` : "";
            return `${storageKeyBase}${suffix}`;
        }

        function loadStoredNotes() {
            if (typeof window === "undefined" || !window.localStorage) {
                return {};
            }
            const stored = window.localStorage.getItem(getStorageKey());
            if (!stored) {
                return {};
            }
            try {
                const parsed = JSON.parse(stored);
                return isValidNotesData(parsed) ? parsed : {};
            } catch (error) {
                console.warn("Unable to parse stored slide notes.", error);
                return {};
            }
        }

        function persistNotes() {
            if (typeof window === "undefined" || !window.localStorage) {
                return;
            }
            try {
                window.localStorage.setItem(getStorageKey(), JSON.stringify(slideNotes));
            } catch (error) {
                console.warn("Unable to save slide notes.", error);
            }
        }

        function buildSlideMap() {
            if (!slideMapList) {
                return;
            }
            slideMapList.innerHTML = "";
            slideMapButtons.length = 0;
            slideMapList.setAttribute("role", "list");

            const slideMeta = slides.map((slide, index) => ({
                slide,
                index,
                id: slide.id || `slide-${index + 1}`,
                key: slide.dataset.slideKey || slide.id || `slide-${index + 1}`
            }));
            const slidesByKey = new Map(slideMeta.map((meta) => [meta.key, meta]));
            const usedIndices = new Set();
            const sectionDefinitions = Array.isArray(activeLesson?.sections) ? activeLesson.sections : [];

            const createSlideMapEntry = (slide, index) => {
                const listItem = document.createElement("li");
                listItem.className = "slide-map-item";

                const button = document.createElement("button");
                button.type = "button";
                button.className = "slide-map-button";
                const slideNumber = index + 1;
                const rawTitle = slide?.querySelector(".slide-title")?.textContent?.trim() || "";
                const cleanTitle = rawTitle.replace(/\s+/g, " ").trim();
                const colonIndex = cleanTitle.indexOf(":");
                const mainTitle = colonIndex > -1 ? cleanTitle.slice(0, colonIndex).trim() : cleanTitle;
                const subtitle = colonIndex > -1 ? cleanTitle.slice(colonIndex + 1).trim() : "";

                const numberSpan = document.createElement("span");
                numberSpan.className = "slide-map-button__number";
                numberSpan.textContent = slideNumber.toString().padStart(2, "0");

                const label = document.createElement("span");
                label.className = "slide-map-button__label";

                const titleSpan = document.createElement("span");
                titleSpan.className = "slide-map-button__title";
                titleSpan.textContent = mainTitle || `Slide ${slideNumber}`;
                label.appendChild(titleSpan);

                if (subtitle) {
                    const subtitleSpan = document.createElement("span");
                    subtitleSpan.className = "slide-map-button__subtitle";
                    subtitleSpan.textContent = subtitle;
                    label.appendChild(subtitleSpan);
                }

                const ariaLabelParts = [`Slide ${slideNumber}`];
                if (cleanTitle) {
                    ariaLabelParts.push(cleanTitle);
                }
                button.setAttribute("aria-label", `Go to ${ariaLabelParts.join(": ")}`);
                button.dataset.slideIndex = index;
                button.appendChild(numberSpan);
                button.appendChild(label);
                button.addEventListener("click", () => showSlide(index));

                listItem.appendChild(button);
                return { listItem, button };
            };

            const appendSection = (title, entries) => {
                if (!entries.length) {
                    return;
                }
                const sectionItem = document.createElement("li");
                sectionItem.className = "slide-map-group";

                const sectionTitle = document.createElement("h3");
                sectionTitle.className = "slide-map-group__title";
                sectionTitle.textContent = title;
                sectionItem.appendChild(sectionTitle);

                const sectionList = document.createElement("ol");
                sectionList.className = "slide-map-group__list";
                sectionList.setAttribute("role", "list");

                entries.forEach(({ slide, index }) => {
                    const { listItem, button } = createSlideMapEntry(slide, index);
                    sectionList.appendChild(listItem);
                    slideMapButtons.push(button);
                    usedIndices.add(index);
                });

                sectionItem.appendChild(sectionList);
                slideMapList.appendChild(sectionItem);
            };

            sectionDefinitions.forEach((section) => {
                let entries = [];
                if (Array.isArray(section.slideKeys)) {
                    entries = section.slideKeys.map((key) => slidesByKey.get(key)).filter(Boolean);
                } else if (Array.isArray(section.slideIndices)) {
                    entries = section.slideIndices.map((i) => slideMeta[i]).filter(Boolean);
                } else if (section.range && Array.isArray(section.range) && section.range.length === 2) {
                    entries = slideMeta.filter((meta) => meta.index >= section.range[0] && meta.index <= section.range[1]);
                }
                appendSection(section.title || "Slides", entries);
            });

            const remainingEntries = slideMeta.filter((meta) => !usedIndices.has(meta.index));
            if (remainingEntries.length) {
                appendSection("Additional slides", remainingEntries);
            }

            updateSlideMapIndicator(currentSlideIndex);
        }

        function updateSlideMapIndicator(index) {
            if (!slideMapButtons.length) {
                return;
            }
            slideMapButtons.forEach((button, buttonIndex) => {
                const listItem = button.parentElement;
                const isActive = buttonIndex === index;
                if (listItem) {
                    listItem.classList.toggle("is-active", isActive);
                }
                if (isActive) {
                    button.setAttribute("aria-current", "step");
                    if (listItem && typeof listItem.scrollIntoView === "function") {
                        try {
                            listItem.scrollIntoView({ behavior: prefersReducedMotion ? "auto" : "smooth", block: "nearest", inline: "nearest" });
                        } catch (error) {
                            if (!prefersReducedMotion) {
                                listItem.scrollIntoView();
                            }
                        }
                    }
                } else {
                    button.removeAttribute("aria-current");
                }
            });
        }

        function animateSlideContents(slide) {
            const elementsToAnimate = slide.querySelectorAll(".animate-on-scroll");
            elementsToAnimate.forEach((el, index) => {
                if (prefersReducedMotion) {
                    el.style.opacity = "1";
                    el.classList.remove("animate__animated", "animate__fadeInUp");
                    return;
                }
                el.classList.remove("animate__animated", "animate__fadeInUp");
                el.style.opacity = "0";
                void el.offsetWidth;
                setTimeout(() => {
                    el.classList.add("animate__animated", "animate__fadeInUp");
                    el.style.opacity = "1";
                }, index * 160);
            });
        }

        function handleKeyboardNavigation(event) {
            if (event.defaultPrevented) {
                return;
            }
            const target = event.target;
            const isFormField = target && (
                target.isContentEditable ||
                ["INPUT", "TEXTAREA", "SELECT", "BUTTON"].includes(target.tagName)
            );
            if (isFormField) {
                return;
            }
            if (event.key === "ArrowRight" || event.key === "PageDown") {
                event.preventDefault();
                nextSlide();
            } else if (event.key === "ArrowLeft" || event.key === "PageUp") {
                event.preventDefault();
                prevSlide();
            } else if (event.key === "Home") {
                event.preventDefault();
                showSlide(0);
            } else if (event.key === "End") {
                event.preventDefault();
                showSlide(slides.length - 1);
            }
        }
        function renderSlideTextboxes(slideId) {
            const container = textboxContainers[slideId];
            if (!container) {
                return;
            }
            container.innerHTML = "";
            const notes = Array.isArray(slideNotes[slideId]) ? slideNotes[slideId] : [];
            const panel = notesPanels[slideId];
            if (panel) {
                panel.classList.toggle("empty", notes.length === 0);
            }
            notes.forEach((note) => {
                if (!note.content && note.text) {
                    note.content = note.text;
                    delete note.text;
                }
                container.appendChild(createTextboxElement(slideId, note));
            });
        }

        function renderAllSlides() {
            if (!slides.length) {
                setupNotesIoControls();
                return;
            }
            if (!notesPanelsHost) {
                return;
            }
            slides.forEach((slide, index) => {
                const slideId = slide.dataset.slideId || slide.id || `slide-${index + 1}`;
                if (!Array.isArray(slideNotes[slideId])) {
                    slideNotes[slideId] = [];
                }
                renderSlideTextboxes(slideId);
            });
            const activeSlide = slides[currentSlideIndex];
            if (activeSlide) {
                activateNotesPanel(activeSlide.dataset.slideId);
            }
        }

        function activateNotesPanel(slideId) {
            Object.values(notesPanels).forEach((panel) => {
                panel.classList.remove("active");
                panel.setAttribute("aria-hidden", "true");
                panel.hidden = true;
            });
            const panel = notesPanels[slideId];
            if (panel) {
                panel.classList.add("active");
                panel.setAttribute("aria-hidden", "false");
                panel.hidden = false;
                if (notesPanelsHost) {
                    notesPanelsHost.scrollTop = 0;
                }
            }
        }

        function createTextboxElement(slideId, note) {
            const wrapper = document.createElement("div");
            wrapper.className = "custom-textbox";
            wrapper.dataset.noteId = note.id;
            wrapper.style.backgroundColor = note.color;

            const actions = document.createElement("div");
            actions.className = "textbox-actions";

            const colorPicker = createColorPicker(note.color, (newColor) => {
                if (!newColor || note.color === newColor) {
                    return;
                }
                note.color = newColor;
                wrapper.style.backgroundColor = newColor;
                persistNotes();
            });

            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.className = "textbox-remove-btn";
            removeButton.innerHTML = '<i class="fas fa-trash"></i> Remove';
            removeButton.addEventListener("click", () => {
                slideNotes[slideId] = (slideNotes[slideId] || []).filter((existing) => existing.id !== note.id);
                persistNotes();
                renderSlideTextboxes(slideId);
            });

            actions.appendChild(colorPicker);
            actions.appendChild(removeButton);

            const content = document.createElement("div");
            content.className = "textbox-content";
            content.contentEditable = "true";
            content.dataset.placeholder = "Type your notes here...";
            content.innerHTML = note.content || "";
            content.addEventListener("input", () => {
                note.content = content.innerHTML;
                persistNotes();
            });

            wrapper.appendChild(actions);
            wrapper.appendChild(content);
            return wrapper;
        }

        function setupNotesIoControls() {
            const saveButton = document.getElementById("save-notes-btn");
            const loadButton = document.getElementById("load-notes-btn");
            const fileInput = document.getElementById("notes-file-input");

            if (saveButton && !saveButton.dataset.initialized) {
                saveButton.addEventListener("click", () => {
                    const data = JSON.stringify(slideNotes, null, 2);
                    const blob = new Blob([data], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    const fileId = activeLesson?.id ? activeLesson.id : "lesson";
                    link.download = `${fileId}-slide-notes.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                });
                saveButton.dataset.initialized = "true";
            }

            if (loadButton && !loadButton.dataset.initialized) {
                loadButton.addEventListener("click", () => fileInput?.click());
                loadButton.dataset.initialized = "true";
            }

            if (fileInput && !fileInput.dataset.initialized) {
                fileInput.addEventListener("change", (event) => {
                    const file = event.target.files && event.target.files[0];
                    if (!file) {
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (loadEvent) => {
                        try {
                            const parsed = JSON.parse(loadEvent.target.result);
                            if (isValidNotesData(parsed)) {
                                slideNotes = parsed;
                                slides.forEach((slide, index) => {
                                    const slideId = slide.dataset.slideId || slide.id || `slide-${index + 1}`;
                                    if (!Array.isArray(slideNotes[slideId])) {
                                        slideNotes[slideId] = [];
                                    }
                                });
                                persistNotes();
                                renderAllSlides();
                            } else {
                                alert("The selected file does not contain valid notes data.");
                            }
                        } catch (error) {
                            alert("Unable to read that JSON file. Please check the format and try again.");
                        }
                    };
                    reader.onerror = () => {
                        alert("We could not read that file. Please try again with a different JSON export.");
                    };
                    reader.readAsText(file);
                    event.target.value = "";
                });
                fileInput.dataset.initialized = "true";
            }
        }

        function initializeTextboxes() {
            notesPanelsHost = document.getElementById("notes-panels");
            if (!notesPanelsHost) {
                setupNotesIoControls();
                return;
            }

            notesPanelsHost.innerHTML = "";
            for (const key of Object.keys(textboxContainers)) {
                delete textboxContainers[key];
            }
            for (const key of Object.keys(notesPanels)) {
                delete notesPanels[key];
            }

            slides.forEach((slide, index) => {
                const slideId = slide.id || `slide-${index + 1}`;
                slide.dataset.slideId = slideId;
                if (!Array.isArray(slideNotes[slideId])) {
                    slideNotes[slideId] = [];
                }

                const panel = document.createElement("section");
                panel.className = "notes-panel empty";
                panel.dataset.slideId = slideId;
                panel.setAttribute("aria-hidden", "true");
                panel.hidden = true;

                const heading = document.createElement("h3");
                heading.className = "notes-panel-title visually-hidden";
                const headingId = `notes-panel-title-${slideId}`;
                heading.id = headingId;
                heading.textContent = getSlideLabel(slide, index);
                panel.setAttribute("aria-labelledby", headingId);

                const toolbar = document.createElement("div");
                toolbar.className = "textbox-toolbar";

                const toolbarCaption = document.createElement("p");
                toolbarCaption.className = "toolbar-caption visually-hidden";
                toolbarCaption.textContent = "Add a new text box by choosing a colour.";

                const swatchGroup = document.createElement("div");
                swatchGroup.className = "textbox-swatch-group";

                textboxColorOptions.forEach((option) => {
                    const swatchButton = document.createElement("button");
                    swatchButton.type = "button";
                    swatchButton.className = "textbox-swatch";
                    swatchButton.style.setProperty("--swatch-color", option.value);
                    swatchButton.setAttribute("aria-label", `Add a ${option.label} text box`);
                    swatchButton.title = option.label;
                    swatchButton.addEventListener("click", () => {
                        const newNote = { id: generateNoteId(), color: option.value, content: "" };
                        slideNotes[slideId].push(newNote);
                        persistNotes();
                        renderSlideTextboxes(slideId);
                        const latestTextbox = textboxContainers[slideId]?.lastElementChild?.querySelector(".textbox-content");
                        if (latestTextbox) {
                            latestTextbox.focus();
                        }
                    });
                    swatchGroup.appendChild(swatchButton);
                });

                toolbar.appendChild(toolbarCaption);
                toolbar.appendChild(swatchGroup);

                const collection = document.createElement("div");
                collection.className = "textbox-collection";
                textboxContainers[slideId] = collection;

                panel.appendChild(heading);
                panel.appendChild(toolbar);
                panel.appendChild(collection);

                notesPanelsHost.appendChild(panel);
                notesPanels[slideId] = panel;

                renderSlideTextboxes(slideId);
            });

            setupNotesIoControls();
        }
        function createIconHeading(icon, text) {
            const heading = document.createElement("h1");
            heading.className = "slide-title";
            if (icon) {
                heading.innerHTML = `<i class="${icon}"></i> ${text}`;
            } else {
                heading.textContent = text;
            }
            return heading;
        }

        function createRubric(text) {
            const rubric = document.createElement("h2");
            rubric.className = "rubric";
            rubric.textContent = text;
            return rubric;
        }

        function createImageElement(image) {
            if (!image || !image.src) {
                return null;
            }
            const img = document.createElement("img");
            img.src = image.src;
            img.alt = image.alt || "";
            return img;
        }

        function createParagraph(text) {
            const paragraph = document.createElement("p");
            paragraph.textContent = text;
            paragraph.classList.add("animate-on-scroll");
            return paragraph;
        }

        function createListElement(items = [], style = "bullets") {
            if (!Array.isArray(items) || !items.length) {
                return null;
            }
            const list = document.createElement("ul");
            list.className = "slide-list";
            if (style === "smart") {
                list.classList.add("smart");
            }
            items.forEach((item) => {
                const li = document.createElement("li");
                li.classList.add("animate-on-scroll");
                if (style === "smart" && item && typeof item === "object" && item.letter) {
                    li.dataset.letter = item.letter;
                }
                if (typeof item === "string") {
                    li.textContent = item;
                } else if (item && typeof item === "object") {
                    const fragments = [];
                    if (item.icon) {
                        fragments.push(`<i class="${item.icon}"></i>`);
                    }
                    if (item.strong) {
                        fragments.push(`<strong>${item.strong}</strong>`);
                    }
                    if (item.text) {
                        fragments.push(item.text);
                    }
                    li.innerHTML = fragments.join(" ");
                }
                list.appendChild(li);
            });
            return list;
        }

        function createActivityControls({ onCheck, onReset, checkLabel = "Check answers", resetLabel = "Reset" } = {}) {
            const wrapper = document.createElement("div");
            wrapper.className = "activity-controls animate-on-scroll";

            let checkButton = null;
            if (typeof onCheck === "function") {
                checkButton = document.createElement("button");
                checkButton.type = "button";
                checkButton.className = "activity-btn";
                checkButton.textContent = checkLabel;
                checkButton.addEventListener("click", onCheck);
                wrapper.appendChild(checkButton);
            }

            let resetButton = null;
            if (typeof onReset === "function") {
                resetButton = document.createElement("button");
                resetButton.type = "button";
                resetButton.className = "activity-btn secondary";
                resetButton.textContent = resetLabel;
                resetButton.addEventListener("click", onReset);
                wrapper.appendChild(resetButton);
            }

            return { wrapper, checkButton, resetButton };
        }

        function createActivityFeedback(initialSummary = "Check your work to see detailed feedback.") {
            const wrapper = document.createElement("div");
            wrapper.className = "activity-feedback animate-on-scroll";

            const summary = document.createElement("p");
            summary.className = "activity-feedback__summary";
            summary.textContent = initialSummary;

            const list = document.createElement("ul");
            list.className = "activity-feedback__list";

            wrapper.appendChild(summary);
            wrapper.appendChild(list);

            return { wrapper, summary, list };
        }

        function formatOrdinal(value) {
            const number = Number(value);
            if (!Number.isFinite(number)) {
                return String(value);
            }
            const absValue = Math.abs(number);
            const suffix = absValue % 100 >= 11 && absValue % 100 <= 13
                ? "th"
                : { 1: "st", 2: "nd", 3: "rd" }[absValue % 10] || "th";
            return `${number}${suffix}`;
        }

        function shuffleArray(sourceArray = []) {
            const array = Array.from(sourceArray);
            for (let i = array.length - 1; i > 0; i -= 1) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        const BLUEPRINT_BLOCK_TYPES = new Set([
            "media",
            "heading",
            "text",
            "list",
            "definitionList",
            "activity",
            "grid",
            "profiles",
            "gallery",
            "reporting",
            "questions",
        ]);

        function validateBlueprintSlideConfig(config) {
            if (!config || typeof config !== "object") {
                if (typeof console !== "undefined" && console.warn) {
                    console.warn("[blueprint] Slide config is not an object.", config);
                }
                return;
            }
            const warnings = [];
            if (config.blocks !== undefined && !Array.isArray(config.blocks)) {
                warnings.push({ message: "Expected `blocks` to be an array.", context: config.blocks });
            } else if (Array.isArray(config.blocks)) {
                config.blocks.forEach((block, index) => {
                    if (typeof block === "string") {
                        return;
                    }
                    if (!block || typeof block !== "object") {
                        warnings.push({ message: `Block #${index + 1} is not an object.`, context: block });
                        return;
                    }
                    if (block.type && !BLUEPRINT_BLOCK_TYPES.has(block.type)) {
                        warnings.push({ message: `Block #${index + 1} uses unknown type \"${block.type}\".`, context: block });
                    }
                    if ((block.type === "heading" || block.type === "text") && !block.text && !block.html) {
                        warnings.push({ message: `Block #${index + 1} (${block.type}) is missing text content.`, context: block });
                    }
                    if (block.type === "activity" && block.steps && !Array.isArray(block.steps)) {
                        warnings.push({ message: `Activity block #${index + 1} expects an array of steps.`, context: block });
                    }
                });
            }

            if (warnings.length && typeof console !== "undefined") {
                const label = config.key || config.title || config.nav?.title || "blueprint slide";
                if (typeof console.groupCollapsed === "function") {
                    console.groupCollapsed(`[blueprint] ${label}: ${warnings.length} potential issue${warnings.length > 1 ? "s" : ""}`);
                    warnings.forEach((warning) => console.warn(warning.message, warning.context));
                    console.groupEnd();
                } else {
                    console.warn(`[blueprint] ${label}:`, warnings.map((warning) => warning.message).join("; "));
                }
            }
        }

        function createBlueprintMedia(media) {
            if (!media || !media.src) {
                return null;
            }
            const figure = document.createElement("figure");
            figure.className = "blueprint-block blueprint-media animate-on-scroll";
            if (media.className) {
                figure.classList.add(...media.className.split(/\s+/).filter(Boolean));
            }
            const img = document.createElement("img");
            img.src = media.src;
            img.alt = media.alt || "";
            img.loading = media.loading || "lazy";
            if (media.decoding) {
                img.decoding = media.decoding;
            }
            if (media.fit) {
                img.style.objectFit = media.fit;
            }
            if (media.height) {
                img.style.height = media.height;
            }
            if (media.width) {
                img.style.width = media.width;
            }
            if (media.imageClassName) {
                img.classList.add(...media.imageClassName.split(/\s+/).filter(Boolean));
            }
            if (media.imageStyle && typeof media.imageStyle === "object") {
                Object.entries(media.imageStyle).forEach(([property, value]) => {
                    if (value !== undefined && value !== null) {
                        img.style.setProperty(property, value);
                    }
                });
            }
            figure.appendChild(img);
            if (media.caption) {
                const caption = document.createElement("figcaption");
                caption.textContent = media.caption;
                figure.appendChild(caption);
            }
            if (media.figureStyle && typeof media.figureStyle === "object") {
                Object.entries(media.figureStyle).forEach(([property, value]) => {
                    if (value !== undefined && value !== null) {
                        figure.style.setProperty(property, value);
                    }
                });
            }
            return figure;
        }

        function appendBlueprintParagraphs(parent, paragraphs) {
            (Array.isArray(paragraphs) ? paragraphs : []).forEach((text) => {
                if (!text) {
                    return;
                }
                const paragraph = document.createElement("p");
                paragraph.className = "blueprint-text";
                paragraph.textContent = text;
                parent.appendChild(paragraph);
            });
        }

        function createBlueprintList(items, options = {}) {
            const { ordered = false, block = true, classes = [], itemClass = "blueprint-list__item" } = options;
            const tagName = ordered ? "ol" : "ul";
            const list = document.createElement(tagName);
            const classNames = ["blueprint-list", ordered ? "blueprint-list--ordered" : "blueprint-list--unordered", ...classes];
            if (block) {
                classNames.unshift("blueprint-block");
                classNames.push("animate-on-scroll");
            }
            list.className = classNames.join(" ");
            (Array.isArray(items) ? items : []).forEach((item) => {
                if (item === null || item === undefined) {
                    return;
                }
                const listItem = document.createElement("li");
                if (itemClass) {
                    listItem.classList.add(itemClass);
                }
                if (typeof item === "string") {
                    listItem.textContent = item;
                } else {
                    const title = item.title || item.term || item.label;
                    const text = item.text;
                    const description = item.description || item.body;
                    if (title) {
                        const strong = document.createElement("strong");
                        strong.textContent = title;
                        listItem.appendChild(strong);
                    }
                    const detail = description || text;
                    if (detail) {
                        if (listItem.childNodes.length) {
                            listItem.appendChild(document.createTextNode(" "));
                        }
                        const span = document.createElement("span");
                        span.className = "blueprint-list__description";
                        span.textContent = detail;
                        listItem.appendChild(span);
                    }
                    if (!title && !detail) {
                        listItem.textContent = String(item.value ?? "");
                    }
                }
                list.appendChild(listItem);
            });
            return list;
        }

        function createBlueprintOptions(block, config, index) {
            const options = Array.isArray(block?.options) ? block.options : [];
            if (!options.length) {
                return null;
            }
            const inputType = block.optionType === "checkbox" ? "checkbox" : "radio";
            const groupName = block.name || `${config?.key || "blueprint"}-options-${index}`;
            const wrapper = document.createElement("div");
            wrapper.className = "blueprint-radio-group";
            options.forEach((option, optionIndex) => {
                if (!option) {
                    return;
                }
                const label = document.createElement("label");
                label.className = "blueprint-radio";
                const input = document.createElement("input");
                input.type = inputType;
                input.value = option.value || `option-${optionIndex + 1}`;
                const optionId = option.id || `${groupName}-${inputType}-${optionIndex + 1}`;
                input.id = optionId;
                if (inputType === "checkbox") {
                    input.name = option.name || `${groupName}-${optionIndex}`;
                } else {
                    input.name = groupName;
                }
                const text = document.createElement("span");
                text.className = "blueprint-radio__text";
                text.textContent = option.label || option.text || input.value;
                label.appendChild(input);
                label.appendChild(text);
                wrapper.appendChild(label);
            });
            return wrapper;
        }

        function createBlueprintNotes(notes) {
            if (!notes) {
                return null;
            }
            const details = document.createElement("details");
            details.className = "blueprint-spec";
            const summary = document.createElement("summary");
            summary.textContent = typeof notes.summary === "string" ? notes.summary : "Blueprint details";
            details.appendChild(summary);
            const body = document.createElement("div");
            body.className = "blueprint-spec__body";
            const appendSection = (title, content) => {
                if (!content) {
                    return;
                }
                const section = document.createElement("div");
                section.className = "blueprint-spec__section";
                const heading = document.createElement("h4");
                heading.textContent = title;
                section.appendChild(heading);
                if (Array.isArray(content)) {
                    const list = document.createElement("ul");
                    content.forEach((item) => {
                        if (!item) {
                            return;
                        }
                        const li = document.createElement("li");
                        li.textContent = item;
                        list.appendChild(li);
                    });
                    section.appendChild(list);
                } else {
                    const paragraph = document.createElement("p");
                    paragraph.className = "blueprint-text";
                    paragraph.textContent = content;
                    section.appendChild(paragraph);
                }
                body.appendChild(section);
            };

            if (typeof notes === "string" || Array.isArray(notes)) {
                appendSection("Details", notes);
            } else {
                Object.entries(notes).forEach(([key, value]) => {
                    if (key === "summary") {
                        return;
                    }
                    const headingText = key.replace(/([A-Z])/g, " $1").replace(/^\w/, (char) => char.toUpperCase());
                    appendSection(headingText.trim(), value);
                });
            }

            if (!body.children.length) {
                return null;
            }
            details.appendChild(body);
            return details;
        }

        function createBlueprintBlock(block, config, index) {
            if (!block) {
                return null;
            }
            if (block.type === "media") {
                return createBlueprintMedia(block);
            }
            const alignment = block.alignment;
            switch (block.type) {
                case "heading": {
                    const tag = block.tag || (block.level ? `h${block.level}` : "h3");
                    const heading = document.createElement(tag);
                    heading.className = "blueprint-block blueprint-heading animate-on-scroll";
                    if (block.isSlideTitle) {
                        heading.classList.add("slide-title");
                    }
                    if (block.html) {
                        heading.innerHTML = block.html;
                    } else if (Array.isArray(block.text)) {
                        heading.textContent = block.text.join(" ");
                    } else {
                        heading.textContent = block.text || "";
                    }
                    if (alignment) {
                        heading.style.textAlign = alignment;
                    }
                    if (block.className) {
                        heading.classList.add(...block.className.split(/\s+/).filter(Boolean));
                    }
                    return heading;
                }
                case "text": {
                    const tag = block.tag || "p";
                    const paragraph = document.createElement(tag);
                    paragraph.className = "blueprint-block blueprint-text animate-on-scroll";
                    if (block.html) {
                        paragraph.innerHTML = block.html;
                    } else if (Array.isArray(block.text)) {
                        paragraph.textContent = block.text.join(" ");
                    } else {
                        paragraph.textContent = block.text || "";
                    }
                    if (alignment) {
                        paragraph.style.textAlign = alignment;
                    }
                    if (block.className) {
                        paragraph.classList.add(...block.className.split(/\s+/).filter(Boolean));
                    }
                    return paragraph;
                }
                case "list": {
                    const classes = block.className ? block.className.split(/\s+/).filter(Boolean) : [];
                    return createBlueprintList(block.items, { ordered: block.ordered, block: true, classes });
                }
                case "definitionList": {
                    const list = document.createElement("ul");
                    list.className = "blueprint-block blueprint-definition-list animate-on-scroll";
                    (Array.isArray(block.items) ? block.items : []).forEach((item) => {
                        if (!item) {
                            return;
                        }
                        const li = document.createElement("li");
                        const strong = document.createElement("strong");
                        strong.textContent = item.term || item.title || "";
                        li.appendChild(strong);
                        const paragraph = document.createElement("p");
                        paragraph.className = "blueprint-text";
                        paragraph.textContent = item.definition || item.description || item.text || "";
                        li.appendChild(paragraph);
                        list.appendChild(li);
                    });
                    return list;
                }
                case "activity": {
                    const activity = document.createElement("div");
                    activity.className = "blueprint-block blueprint-activity animate-on-scroll";
                    if (block.className) {
                        activity.classList.add(...block.className.split(/\s+/).filter(Boolean));
                    }
                    if (block.title) {
                        const titleTag = block.titleTag || "h3";
                        const title = document.createElement(titleTag);
                        title.className = "blueprint-activity__title";
                        title.textContent = block.title;
                        activity.appendChild(title);
                    }
                    const descriptions = Array.isArray(block.description)
                        ? block.description
                        : block.description
                            ? [block.description]
                            : [];
                    descriptions.forEach((desc) => {
                        if (!desc) {
                            return;
                        }
                        const description = document.createElement("p");
                        description.className = "blueprint-activity__description";
                        description.textContent = desc;
                        activity.appendChild(description);
                    });
                    appendBlueprintParagraphs(activity, block.body);
                    if (Array.isArray(block.steps) && block.steps.length) {
                        const stepList = createBlueprintList(block.steps, {
                            ordered: block.ordered !== false,
                            block: false,
                        });
                        stepList.classList.add("blueprint-activity__list");
                        activity.appendChild(stepList);
                    }
                    const optionsElement = createBlueprintOptions(block, config, index);
                    if (optionsElement) {
                        activity.appendChild(optionsElement);
                    }
                    return activity;
                }
                case "grid": {
                    const grid = document.createElement("div");
                    grid.className = "blueprint-block blueprint-grid animate-on-scroll";
                    if (block.columns) {
                        grid.style.setProperty("--blueprint-grid-columns", block.columns);
                    }
                    if (block.className) {
                        grid.classList.add(...block.className.split(/\s+/).filter(Boolean));
                    }
                    (Array.isArray(block.items) ? block.items : []).forEach((item) => {
                        if (!item) {
                            return;
                        }
                        const card = document.createElement("article");
                        card.className = "blueprint-grid__item";
                        if (item.title) {
                            const titleTag = item.titleTag || "h4";
                            const title = document.createElement(titleTag);
                            title.className = "blueprint-grid__title";
                            title.textContent = item.title;
                            card.appendChild(title);
                        }
                        if (Array.isArray(item.list) && item.list.length) {
                            const list = createBlueprintList(item.list, { ordered: false, block: false });
                            card.appendChild(list);
                        }
                        const descriptions = [];
                        if (Array.isArray(item.description)) {
                            descriptions.push(...item.description);
                        } else if (item.description) {
                            descriptions.push(item.description);
                        }
                        if (Array.isArray(item.body)) {
                            descriptions.push(...item.body);
                        } else if (item.body) {
                            descriptions.push(item.body);
                        }
                        descriptions.forEach((text) => {
                            if (!text) {
                                return;
                            }
                            const paragraph = document.createElement("p");
                            paragraph.className = "blueprint-text";
                            paragraph.textContent = text;
                            card.appendChild(paragraph);
                        });
                        grid.appendChild(card);
                    });
                    return grid;
                }
                case "profiles": {
                    const container = document.createElement("div");
                    container.className = "blueprint-block blueprint-profiles animate-on-scroll";
                    if (block.className) {
                        container.classList.add(...block.className.split(/\s+/).filter(Boolean));
                    }
                    (Array.isArray(block.items) ? block.items : []).forEach((item) => {
                        if (!item) {
                            return;
                        }
                        const profile = document.createElement("article");
                        profile.className = "blueprint-profile";
                        if (item.name) {
                            const name = document.createElement("p");
                            name.className = "blueprint-profile__name";
                            name.textContent = item.name;
                            profile.appendChild(name);
                        }
                        if (item.meta) {
                            const meta = document.createElement("p");
                            meta.className = "blueprint-profile__meta";
                            meta.textContent = item.meta;
                            profile.appendChild(meta);
                        }
                        if (item.focus) {
                            const focus = document.createElement("p");
                            focus.className = "blueprint-profile__focus";
                            focus.textContent = item.focus;
                            profile.appendChild(focus);
                        }
                        if (item.description) {
                            const descParagraphs = Array.isArray(item.description)
                                ? item.description
                                : [item.description];
                            descParagraphs.forEach((text) => {
                                if (!text) {
                                    return;
                                }
                                const paragraph = document.createElement("p");
                                paragraph.className = "blueprint-text";
                                paragraph.textContent = text;
                                profile.appendChild(paragraph);
                            });
                        }
                        container.appendChild(profile);
                    });
                    return container;
                }
                case "gallery": {
                    const gallery = document.createElement("div");
                    gallery.className = "blueprint-block blueprint-gallery animate-on-scroll";
                    if (block.className) {
                        gallery.classList.add(...block.className.split(/\s+/).filter(Boolean));
                    }
                    (Array.isArray(block.items) ? block.items : []).forEach((item) => {
                        if (!item) {
                            return;
                        }
                        const card = document.createElement("article");
                        card.className = "blueprint-gallery__item";
                        if (item.image && item.image.src) {
                            const img = document.createElement("img");
                            img.src = item.image.src;
                            img.alt = item.image.alt || "";
                            img.loading = item.image.loading || "lazy";
                            card.appendChild(img);
                        }
                        const body = document.createElement("div");
                        body.className = "blueprint-gallery__body";
                        if (item.title) {
                            const title = document.createElement("h4");
                            title.className = "blueprint-gallery__title";
                            title.textContent = item.title;
                            body.appendChild(title);
                        }
                        if (item.subtitle) {
                            const subtitle = document.createElement("p");
                            subtitle.className = "blueprint-gallery__subtitle";
                            subtitle.textContent = item.subtitle;
                            body.appendChild(subtitle);
                        }
                        const bodyParagraphs = [];
                        if (Array.isArray(item.description)) {
                            bodyParagraphs.push(...item.description);
                        } else if (item.description) {
                            bodyParagraphs.push(item.description);
                        }
                        if (Array.isArray(item.body)) {
                            bodyParagraphs.push(...item.body);
                        } else if (item.body) {
                            bodyParagraphs.push(item.body);
                        }
                        bodyParagraphs.forEach((text) => {
                            if (!text) {
                                return;
                            }
                            const paragraph = document.createElement("p");
                            paragraph.className = "blueprint-text";
                            paragraph.textContent = text;
                            body.appendChild(paragraph);
                        }
                        card.appendChild(body);
                        gallery.appendChild(card);
                    });
                    return gallery;
                }
                case "reporting": {
                    const reporting = document.createElement("div");
                    reporting.className = "blueprint-block blueprint-reporting animate-on-scroll";
                    if (block.className) {
                        reporting.classList.add(...block.className.split(/\s+/).filter(Boolean));
                    }
                    (Array.isArray(block.sections) ? block.sections : []).forEach((section, sectionIndex) => {
                        const sectionElement = document.createElement("section");
                        sectionElement.className = "blueprint-reporting__section";
                        if (section.title) {
                            const titleTag = section.titleTag || "h4";
                            const title = document.createElement(titleTag);
                            title.className = "blueprint-reporting__title";
                            title.textContent = section.title;
                            sectionElement.appendChild(title);
                        }
                        const sectionDescriptions = Array.isArray(section.description)
                            ? section.description
                            : section.description
                                ? [section.description]
                                : [];
                        sectionDescriptions.forEach((text) => {
                            if (!text) {
                                return;
                            }
                            const paragraph = document.createElement("p");
                            paragraph.className = "blueprint-text";
                            paragraph.textContent = text;
                            sectionElement.appendChild(paragraph);
                        });
                        (Array.isArray(section.fields) ? section.fields : []).forEach((field, fieldIndex) => {
                            const fieldWrapper = document.createElement("div");
                            fieldWrapper.className = "blueprint-reporting__field";
                            const fieldId = field.id || `${config?.key || "report"}-${sectionIndex + 1}-${fieldIndex + 1}`;
                            if (field.label) {
                                const label = document.createElement("label");
                                label.className = "blueprint-reporting__label";
                                label.setAttribute("for", fieldId);
                                label.textContent = field.label;
                                fieldWrapper.appendChild(label);
                            }
                            let input;
                            if (field.type === "textarea" || !field.type || field.type === "text-area") {
                                input = document.createElement("textarea");
                                if (field.rows) {
                                    input.rows = field.rows;
                                }
                                if (field.minHeight) {
                                    input.style.minHeight = field.minHeight;
                                }
                            } else {
                                input = document.createElement("input");
                                input.type = field.type;
                            }
                            input.id = fieldId;
                            if (field.placeholder) {
                                input.placeholder = field.placeholder;
                            }
                            fieldWrapper.appendChild(input);
                            sectionElement.appendChild(fieldWrapper);
                        });
                        reporting.appendChild(sectionElement);
                    });
                    return reporting;
                }
                case "questions": {
                    const list = document.createElement("ul");
                    list.className = "blueprint-block blueprint-questions animate-on-scroll";
                    if (block.className) {
                        list.classList.add(...block.className.split(/\s+/).filter(Boolean));
                    }
                    (Array.isArray(block.items) ? block.items : []).forEach((question) => {
                        if (!question) {
                            return;
                        }
                        const li = document.createElement("li");
                        if (typeof question === "string") {
                            li.textContent = question;
                        } else if (question.html) {
                            li.innerHTML = question.html;
                        } else {
                            li.textContent = question.text || "";
                        }
                        list.appendChild(li);
                    });
                    return list;
                }
                default:
                    return null;
            }
        }

        function renderBlueprintSlide(slideElement, config) {
            validateBlueprintSlideConfig(config);
            slideElement.classList.add("blueprint-slide");
            if (config?.key) {
                slideElement.dataset.blueprintKey = config.key;
            }
            const wrapper = document.createElement("div");
            wrapper.className = "blueprint";
            if (config?.className) {
                wrapper.classList.add(...config.className.split(/\s+/).filter(Boolean));
            }
            const layoutOptions = config?.layout || {};
            const layoutType = (layoutOptions.type || "single-column").toLowerCase();
            wrapper.classList.add(`blueprint--${layoutType}`);
            wrapper.dataset.blueprintLayout = layoutType;
            const requestedAlignment = (layoutOptions.alignment || layoutOptions.align || "left").toLowerCase();
            const alignment = ["center", "left", "right"].includes(requestedAlignment) ? requestedAlignment : "left";
            wrapper.classList.add(`blueprint-align-${alignment}`);
            wrapper.dataset.blueprintAlignment = alignment;
            if (layoutOptions.className) {
                wrapper.classList.add(...layoutOptions.className.split(/\s+/).filter(Boolean));
            }
            if (layoutOptions.gap) {
                wrapper.style.setProperty("--blueprint-gap", layoutOptions.gap);
            }
            if (layoutOptions.maxWidth) {
                wrapper.style.maxWidth = layoutOptions.maxWidth;
            }
            if (layoutOptions.minWidth) {
                wrapper.style.minWidth = layoutOptions.minWidth;
            }
            if (layoutOptions.minHeight) {
                wrapper.style.minHeight = layoutOptions.minHeight;
            }
            if (layoutOptions.background) {
                wrapper.style.background = layoutOptions.background;
            }
            if (layoutOptions.padding) {
                wrapper.style.padding = layoutOptions.padding;
            }
            if (layoutOptions.border) {
                wrapper.style.border = layoutOptions.border;
            }
            if (layoutOptions.borderRadius) {
                wrapper.style.borderRadius = layoutOptions.borderRadius;
            }
            if (layoutOptions.boxShadow) {
                wrapper.style.boxShadow = layoutOptions.boxShadow;
            }
            if (layoutOptions.style && typeof layoutOptions.style === "object") {
                Object.entries(layoutOptions.style).forEach(([property, value]) => {
                    if (value !== undefined && value !== null) {
                        wrapper.style.setProperty(property, value);
                    }
                });
            }
            if (config.media) {
                const mediaElement = createBlueprintMedia(config.media);
                if (mediaElement) {
                    wrapper.appendChild(mediaElement);
                }
            }
            const blockDefinitions = Array.isArray(config.blocks)
                ? config.blocks
                : config?.blocks
                    ? [config.blocks]
                    : [];
            blockDefinitions.forEach((block, index) => {
                const normalisedBlock = typeof block === "string"
                    ? { type: "text", text: block }
                    : block;
                const element = createBlueprintBlock(normalisedBlock, config, index);
                if (element) {
                    wrapper.appendChild(element);
                }
            });
            slideElement.appendChild(wrapper);
            const notes = createBlueprintNotes(config.blueprintNotes);
            if (notes) {
                slideElement.appendChild(notes);
            }
        }

        function renderHeroSlide(slideElement, config) {
            if (config.image) {
                const wrapper = document.createElement("div");
                wrapper.className = "animate-on-scroll";
                const img = createImageElement(config.image);
                if (img) {
                    wrapper.appendChild(img);
                    slideElement.appendChild(wrapper);
                }
            }
            if (config.title) {
                const wrapper = document.createElement("div");
                wrapper.className = "animate-on-scroll";
                wrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(wrapper);
            }
            if (config.subtitle) {
                const wrapper = document.createElement("div");
                wrapper.className = "animate-on-scroll";
                wrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(wrapper);
            }
        }

        function renderContentSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }
            (config.body || []).forEach((paragraph) => {
                content.appendChild(createParagraph(paragraph));
            });
            const list = createListElement(config.list, config.listStyle);
            if (list) {
                content.appendChild(list);
            }
            slideElement.appendChild(content);
        }

        function renderGapfillSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }

            const content = document.createElement("div");
            content.className = "slide-content gapfill-activity";

            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }

            if (config.instructions) {
                content.appendChild(createParagraph(config.instructions));
            }

            const paragraph = document.createElement("p");
            paragraph.className = "gapfill-paragraph animate-on-scroll";
            const segments = Array.isArray(config.paragraph) ? config.paragraph : [];
            const gaps = [];
            segments.forEach((segment, index) => {
                if (typeof segment === "string") {
                    paragraph.appendChild(document.createTextNode(segment));
                } else if (segment && segment.type === "text") {
                    paragraph.appendChild(document.createTextNode(segment.content || ""));
                } else if (segment && segment.type === "gap") {
                    const wrapper = document.createElement("span");
                    wrapper.className = "gapfill-gap";
                    const select = document.createElement("select");
                    const placeholder = document.createElement("option");
                    placeholder.value = "";
                    placeholder.textContent = segment.placeholder || "Select an option";
                    select.appendChild(placeholder);
                    (segment.options || []).forEach((option) => {
                        const optionElement = document.createElement("option");
                        if (typeof option === "string") {
                            optionElement.value = option;
                            optionElement.textContent = option;
                        } else if (option && typeof option === "object") {
                            optionElement.value = option.value;
                            optionElement.textContent = option.label || option.value;
                        }
                        select.appendChild(optionElement);
                    });
                    wrapper.appendChild(select);
                    paragraph.appendChild(wrapper);
                    gaps.push({
                        wrapper,
                        select,
                        data: {
                            id: segment.id || `${config.key || "gapfill"}-gap-${index + 1}`,
                            answer: segment.answer,
                            feedbackTitle: segment.feedbackTitle || segment.label,
                            explanation: segment.explanation
                        }
                    });
                }
            });
            content.appendChild(paragraph);

            const initialSummary = config.feedbackSummary || "Check your work to see detailed feedback.";
            const feedback = createActivityFeedback(initialSummary);

            const evaluate = () => {
                let attempted = 0;
                let correct = 0;
                feedback.list.innerHTML = "";
                gaps.forEach((gap) => {
                    const { wrapper, select, data } = gap;
                    wrapper.classList.remove("is-correct", "is-incorrect");
                    const value = select.value;
                    if (!value) {
                        return;
                    }
                    attempted += 1;
                    const isCorrect = value === data.answer;
                    if (isCorrect) {
                        correct += 1;
                    }
                    wrapper.classList.add(isCorrect ? "is-correct" : "is-incorrect");
                    const selectedLabel = select.options[select.selectedIndex]?.textContent || value;

                    const item = document.createElement("li");
                    item.className = `activity-feedback__item ${isCorrect ? "is-correct" : "is-incorrect"}`;

                    const title = document.createElement("p");
                    const strong = document.createElement("strong");
                    strong.textContent = data.feedbackTitle || `Blank ${data.id}`;
                    title.appendChild(strong);
                    item.appendChild(title);

                    const yourAnswer = document.createElement("p");
                    yourAnswer.innerHTML = `<strong>Your answer:</strong> ${selectedLabel}`;
                    item.appendChild(yourAnswer);

                    if (!isCorrect) {
                        const correctAnswer = document.createElement("p");
                        correctAnswer.innerHTML = `<strong>Correct answer:</strong> ${data.answer}`;
                        item.appendChild(correctAnswer);
                    }

                    if (data.explanation) {
                        const explanation = document.createElement("p");
                        explanation.textContent = data.explanation;
                        item.appendChild(explanation);
                    }

                    feedback.list.appendChild(item);
                });

                feedback.summary.textContent = attempted
                    ? `You answered ${correct} of ${attempted} correctly.`
                    : "Choose an answer for at least one blank to see feedback.";
            };

            const reset = () => {
                gaps.forEach((gap) => {
                    gap.wrapper.classList.remove("is-correct", "is-incorrect");
                    gap.select.value = "";
                });
                feedback.list.innerHTML = "";
                feedback.summary.textContent = initialSummary;
            };

            const controls = createActivityControls({
                onCheck: evaluate,
                onReset: reset,
                checkLabel: config.checkLabel || "Check answers",
                resetLabel: config.resetLabel || "Reset"
            });

            content.appendChild(controls.wrapper);
            content.appendChild(feedback.wrapper);

            slideElement.appendChild(content);
        }

        function renderRankingSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }

            const content = document.createElement("div");
            content.className = "slide-content ranking-activity";

            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }

            if (config.instructions) {
                const intro = document.createElement("p");
                intro.className = "ranking-intro animate-on-scroll";
                intro.textContent = config.instructions;
                content.appendChild(intro);
            }

            const list = document.createElement("ol");
            list.className = "ranking-list";

            const items = Array.isArray(config.items) ? config.items : [];
            const itemMap = new Map();
            items.forEach((item) => {
                if (item && item.id) {
                    itemMap.set(item.id, item);
                }
            });
            const correctOrder = items
                .slice()
                .sort((a, b) => (a.correctRank ?? 0) - (b.correctRank ?? 0))
                .map((item) => item.id);
            const initialOrder = Array.isArray(config.initialOrder) && config.initialOrder.length === correctOrder.length
                ? config.initialOrder.filter((id) => itemMap.has(id))
                : shuffleArray(correctOrder);
            const resolvedOrder = initialOrder.length === correctOrder.length ? initialOrder : correctOrder;

            const createListItem = (item) => {
                const li = document.createElement("li");
                li.className = "ranking-item animate-on-scroll";
                li.dataset.itemId = item.id;

                const label = document.createElement("span");
                label.className = "ranking-label";
                label.textContent = item.label;
                li.appendChild(label);

                const controls = document.createElement("div");
                controls.className = "ranking-controls";

                const moveUp = document.createElement("button");
                moveUp.type = "button";
                moveUp.textContent = "Move up";
                moveUp.setAttribute("aria-label", `Move ${item.label} up`);
                moveUp.addEventListener("click", () => {
                    const previous = li.previousElementSibling;
                    if (previous) {
                        list.insertBefore(li, previous);
                    }
                });

                const moveDown = document.createElement("button");
                moveDown.type = "button";
                moveDown.textContent = "Move down";
                moveDown.setAttribute("aria-label", `Move ${item.label} down`);
                moveDown.addEventListener("click", () => {
                    const next = li.nextElementSibling?.nextElementSibling;
                    if (next) {
                        list.insertBefore(li, next);
                    } else {
                        list.appendChild(li);
                    }
                });

                controls.appendChild(moveUp);
                controls.appendChild(moveDown);
                li.appendChild(controls);
                return li;
            };

            resolvedOrder.forEach((id) => {
                const item = itemMap.get(id);
                if (item) {
                    list.appendChild(createListItem(item));
                }
            });

            const baselineOrder = Array.from(list.children).map((child) => child.dataset.itemId);
            content.appendChild(list);

            const initialSummary = config.feedbackSummary || "Check your work to see detailed feedback.";
            const feedback = createActivityFeedback(initialSummary);

            const evaluate = () => {
                const itemsInDom = Array.from(list.children);
                let correct = 0;
                feedback.list.innerHTML = "";
                itemsInDom.forEach((element, index) => {
                    const itemId = element.dataset.itemId;
                    const item = itemMap.get(itemId);
                    if (!item) {
                        return;
                    }
                    element.classList.remove("is-correct", "is-incorrect");
                    const expectedId = correctOrder[index];
                    const isCorrect = expectedId === itemId;
                    if (isCorrect) {
                        correct += 1;
                    }
                    element.classList.add(isCorrect ? "is-correct" : "is-incorrect");

                    const detail = document.createElement("li");
                    detail.className = `activity-feedback__item ${isCorrect ? "is-correct" : "is-incorrect"}`;

                    const heading = document.createElement("p");
                    const strong = document.createElement("strong");
                    strong.textContent = item.label;
                    heading.appendChild(strong);
                    detail.appendChild(heading);

                    const yourAnswer = document.createElement("p");
                    yourAnswer.innerHTML = `<strong>Your order:</strong> ${formatOrdinal(index + 1)}`;
                    detail.appendChild(yourAnswer);

                    if (!isCorrect) {
                        const correctAnswer = document.createElement("p");
                        const targetPosition = item.correctRank ?? (correctOrder.indexOf(itemId) + 1);
                        correctAnswer.innerHTML = `<strong>Correct order:</strong> ${formatOrdinal(targetPosition)}`;
                        detail.appendChild(correctAnswer);
                    }

                    if (item.explanation) {
                        const explanation = document.createElement("p");
                        explanation.textContent = item.explanation;
                        detail.appendChild(explanation);
                    }

                    feedback.list.appendChild(detail);
                });

                const attempted = itemsInDom.length;
                feedback.summary.textContent = attempted
                    ? `You placed ${correct} of ${attempted} stages correctly.`
                    : "Reorder the stages to check your understanding.";
            };

            const reset = () => {
                baselineOrder.forEach((itemId) => {
                    const element = Array.from(list.children).find((child) => child.dataset.itemId === itemId);
                    if (element) {
                        element.classList.remove("is-correct", "is-incorrect");
                        list.appendChild(element);
                    }
                });
                feedback.list.innerHTML = "";
                feedback.summary.textContent = initialSummary;
            };

            const controls = createActivityControls({
                onCheck: evaluate,
                onReset: reset,
                checkLabel: config.checkLabel || "Check order",
                resetLabel: config.resetLabel || "Reset order"
            });

            content.appendChild(controls.wrapper);
            content.appendChild(feedback.wrapper);

            slideElement.appendChild(content);
        }

        function renderGroupingSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }

            const content = document.createElement("div");
            content.className = "slide-content grouping-activity";

            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }

            if (config.instructions) {
                content.appendChild(createParagraph(config.instructions));
            }

            const grid = document.createElement("div");
            grid.className = "grouping-grid";

            const categories = Array.isArray(config.categories) ? config.categories : [];
            const categoryMap = new Map();
            categories.forEach((category) => {
                if (category && category.id) {
                    categoryMap.set(category.id, category.label || category.id);
                }
            });

            const items = Array.isArray(config.items) ? config.items : [];
            const itemEntries = [];
            items.forEach((item, index) => {
                if (!item || !item.id) {
                    return;
                }
                const wrapper = document.createElement("div");
                wrapper.className = "grouping-item animate-on-scroll";

                const label = document.createElement("strong");
                label.textContent = item.label;
                wrapper.appendChild(label);

                const select = document.createElement("select");
                select.id = `${slideElement.id}-grouping-${index + 1}`;
                const placeholder = document.createElement("option");
                placeholder.value = "";
                placeholder.textContent = config.placeholder || "Choose a category";
                select.appendChild(placeholder);
                categories.forEach((category) => {
                    const option = document.createElement("option");
                    option.value = category.id;
                    option.textContent = category.label;
                    select.appendChild(option);
                });
                wrapper.appendChild(select);
                grid.appendChild(wrapper);
                itemEntries.push({ wrapper, select, item });
            });

            content.appendChild(grid);

            const initialSummary = config.feedbackSummary || "Check your work to see detailed feedback.";
            const feedback = createActivityFeedback(initialSummary);

            const evaluate = () => {
                let attempted = 0;
                let correct = 0;
                feedback.list.innerHTML = "";
                itemEntries.forEach(({ wrapper, select, item }) => {
                    wrapper.classList.remove("is-correct", "is-incorrect");
                    const value = select.value;
                    if (!value) {
                        return;
                    }
                    attempted += 1;
                    const isCorrect = value === item.category;
                    if (isCorrect) {
                        correct += 1;
                    }
                    wrapper.classList.add(isCorrect ? "is-correct" : "is-incorrect");

                    const detail = document.createElement("li");
                    detail.className = `activity-feedback__item ${isCorrect ? "is-correct" : "is-incorrect"}`;

                    const heading = document.createElement("p");
                    const strong = document.createElement("strong");
                    strong.textContent = item.label;
                    heading.appendChild(strong);
                    detail.appendChild(heading);

                    const yourAnswer = document.createElement("p");
                    yourAnswer.innerHTML = `<strong>Your category:</strong> ${categoryMap.get(value) || value}`;
                    detail.appendChild(yourAnswer);

                    if (!isCorrect) {
                        const correctAnswer = document.createElement("p");
                        correctAnswer.innerHTML = `<strong>Correct category:</strong> ${categoryMap.get(item.category) || item.category}`;
                        detail.appendChild(correctAnswer);
                    }

                    if (item.explanation) {
                        const explanation = document.createElement("p");
                        explanation.textContent = item.explanation;
                        detail.appendChild(explanation);
                    }

                    feedback.list.appendChild(detail);
                });

                feedback.summary.textContent = attempted
                    ? `You sorted ${correct} of ${attempted} items correctly.`
                    : "Choose a category for at least one item to see feedback.";
            };

            const reset = () => {
                itemEntries.forEach(({ wrapper, select }) => {
                    wrapper.classList.remove("is-correct", "is-incorrect");
                    select.value = "";
                });
                feedback.list.innerHTML = "";
                feedback.summary.textContent = initialSummary;
            };

            const controls = createActivityControls({
                onCheck: evaluate,
                onReset: reset,
                checkLabel: config.checkLabel || "Check categories",
                resetLabel: config.resetLabel || "Reset"
            });

            content.appendChild(controls.wrapper);
            content.appendChild(feedback.wrapper);

            slideElement.appendChild(content);
        }

        function renderMatchingSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }

            const content = document.createElement("div");
            content.className = "slide-content matching-activity";

            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }

            if (config.instructions) {
                content.appendChild(createParagraph(config.instructions));
            }

            const tableWrapper = document.createElement("div");
            tableWrapper.className = "matching-table-wrapper";
            const table = document.createElement("table");
            table.className = "matching-table animate-on-scroll";

            const columns = Array.isArray(config.columns) ? config.columns : [];
            const rows = Array.isArray(config.rows) ? config.rows : [];
            const columnMap = new Map(columns.map((column) => [column.id, column.label]));

            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");
            const blankHeader = document.createElement("th");
            blankHeader.scope = "col";
            blankHeader.textContent = "";
            headerRow.appendChild(blankHeader);
            columns.forEach((column) => {
                const th = document.createElement("th");
                th.scope = "col";
                th.textContent = column.label;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");
            const rowEntries = [];
            rows.forEach((row, rowIndex) => {
                const tr = document.createElement("tr");
                tr.dataset.correctColumn = row.correctColumn;

                const th = document.createElement("th");
                th.scope = "row";
                th.textContent = row.label;
                tr.appendChild(th);

                columns.forEach((column) => {
                    const td = document.createElement("td");
                    const label = document.createElement("label");
                    label.className = "matching-radio";

                    const input = document.createElement("input");
                    input.type = "radio";
                    input.name = `${slideElement.id}-row-${rowIndex + 1}`;
                    input.value = column.id;

                    const indicator = document.createElement("span");
                    indicator.className = "matching-radio-indicator";

                    label.appendChild(input);
                    label.appendChild(indicator);
                    td.appendChild(label);
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
                rowEntries.push({ row, element: tr });
            });
            table.appendChild(tbody);
            tableWrapper.appendChild(table);
            content.appendChild(tableWrapper);

            const initialSummary = config.feedbackSummary || "Check your work to see detailed feedback.";
            const feedback = createActivityFeedback(initialSummary);

            const evaluate = () => {
                let attempted = 0;
                let correct = 0;
                feedback.list.innerHTML = "";
                rowEntries.forEach(({ row, element }) => {
                    element.classList.remove("is-correct", "is-incorrect");
                    const selected = element.querySelector("input[type=\"radio\"]:checked");
                    if (!selected) {
                        return;
                    }
                    attempted += 1;
                    const isCorrect = selected.value === row.correctColumn;
                    if (isCorrect) {
                        correct += 1;
                    }
                    element.classList.add(isCorrect ? "is-correct" : "is-incorrect");

                    const detail = document.createElement("li");
                    detail.className = `activity-feedback__item ${isCorrect ? "is-correct" : "is-incorrect"}`;

                    const heading = document.createElement("p");
                    const strong = document.createElement("strong");
                    strong.textContent = row.label;
                    heading.appendChild(strong);
                    detail.appendChild(heading);

                    const yourAnswer = document.createElement("p");
                    yourAnswer.innerHTML = `<strong>Your answer:</strong> ${columnMap.get(selected.value) || selected.value}`;
                    detail.appendChild(yourAnswer);

                    if (!isCorrect) {
                        const correctAnswer = document.createElement("p");
                        correctAnswer.innerHTML = `<strong>Correct answer:</strong> ${columnMap.get(row.correctColumn) || row.correctColumn}`;
                        detail.appendChild(correctAnswer);
                    }

                    if (row.explanation) {
                        const explanation = document.createElement("p");
                        explanation.textContent = row.explanation;
                        detail.appendChild(explanation);
                    }

                    feedback.list.appendChild(detail);
                });

                feedback.summary.textContent = attempted
                    ? `You answered ${correct} of ${attempted} correctly.`
                    : "Select an answer for at least one row to see feedback.";
            };

            const reset = () => {
                rowEntries.forEach(({ element }) => {
                    element.classList.remove("is-correct", "is-incorrect");
                    element.querySelectorAll("input[type=\"radio\"]").forEach((input) => {
                        input.checked = false;
                    });
                });
                feedback.list.innerHTML = "";
                feedback.summary.textContent = initialSummary;
            };

            const controls = createActivityControls({
                onCheck: evaluate,
                onReset: reset,
                checkLabel: config.checkLabel || "Check answers",
                resetLabel: config.resetLabel || "Reset"
            });

            content.appendChild(controls.wrapper);
            content.appendChild(feedback.wrapper);

            slideElement.appendChild(content);
        }

        function renderCardsSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content card-container";
            (config.cards || []).forEach((cardConfig) => {
                const card = document.createElement("div");
                card.className = "card animate-on-scroll";
                if (cardConfig.icon) {
                    const icon = document.createElement("div");
                    icon.className = "icon";
                    icon.innerHTML = `<i class="${cardConfig.icon}"></i>`;
                    card.appendChild(icon);
                }
                if (cardConfig.title) {
                    const title = document.createElement("h3");
                    title.textContent = cardConfig.title;
                    card.appendChild(title);
                }
                if (cardConfig.description) {
                    const description = document.createElement("p");
                    description.textContent = cardConfig.description;
                    card.appendChild(description);
                }
                content.appendChild(card);
            });
            slideElement.appendChild(content);
        }

        function renderStorySlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.quote) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.quote));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }
            if (config.process) {
                const paragraph = document.createElement("p");
                paragraph.className = "animate-on-scroll";
                const strong = document.createElement("strong");
                strong.textContent = config.process.label || "Process:";
                paragraph.appendChild(strong);
                paragraph.appendChild(document.createTextNode(` ${config.process.text || ""}`));
                content.appendChild(paragraph);
            }
            if (config.outcome) {
                const paragraph = document.createElement("p");
                paragraph.className = "animate-on-scroll";
                const strong = document.createElement("strong");
                strong.textContent = config.outcome.label || "Outcome:";
                paragraph.appendChild(strong);
                paragraph.appendChild(document.createTextNode(` ${config.outcome.text || ""}`));
                content.appendChild(paragraph);
            }
            slideElement.appendChild(content);
        }

        function renderProcessSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }
            (config.body || []).forEach((paragraph) => {
                content.appendChild(createParagraph(paragraph));
            });
            const flow = document.createElement("div");
            flow.className = "process-flow";
            (config.steps || []).forEach((step, index) => {
                const stepElement = document.createElement("div");
                stepElement.className = "process-step animate-on-scroll";

                const number = document.createElement("div");
                number.className = "process-step-number";
                number.textContent = step.number ? String(step.number) : String(index + 1);
                stepElement.appendChild(number);

                const stepContent = document.createElement("div");
                stepContent.className = "process-step-content";
                if (step.title) {
                    const strong = document.createElement("strong");
                    strong.textContent = step.title;
                    stepContent.appendChild(strong);
                }
                if (step.description) {
                    const paragraph = document.createElement("p");
                    paragraph.textContent = step.description;
                    stepContent.appendChild(paragraph);
                }
                stepElement.appendChild(stepContent);
                flow.appendChild(stepElement);
            });
            content.appendChild(flow);
            slideElement.appendChild(content);
        }

        function renderQuizSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            (config.questions || []).forEach((question) => {
                const card = document.createElement("div");
                card.className = "quiz-card animate-on-scroll";

                const prompt = document.createElement("p");
                prompt.className = "quiz-question-text";
                prompt.textContent = question.prompt;
                card.appendChild(prompt);

                const optionsContainer = document.createElement("div");
                optionsContainer.className = "quiz-options";
                const groupName = question.id;
                const feedbackId = question.feedbackId || `${groupName}-feedback`;

                (question.options || []).forEach((option, index) => {
                    const label = document.createElement("label");
                    label.className = "quiz-option";

                    const input = document.createElement("input");
                    input.type = "radio";
                    input.name = groupName;
                    input.value = option.value;
                    input.id = `${groupName}-option-${index}`;

                    const span = document.createElement("span");
                    span.textContent = option.label;

                    label.appendChild(input);
                    label.appendChild(span);
                    optionsContainer.appendChild(label);
                });

                card.appendChild(optionsContainer);

                const button = document.createElement("button");
                button.type = "button";
                button.className = "activity-btn quiz-btn";
                button.textContent = "Check Answer";
                button.addEventListener("click", () => {
                    checkSingleChoice(groupName, feedbackId, question.answer, question.correctFeedback, question.incorrectFeedback);
                });
                card.appendChild(button);

                const feedback = document.createElement("p");
                feedback.className = "quiz-feedback";
                feedback.id = feedbackId;
                card.appendChild(feedback);

                content.appendChild(card);
            });
            slideElement.appendChild(content);
        }

        function renderReflectionSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content reflection-form";
            (config.fields || []).forEach((field, index) => {
                const wrapper = document.createElement("div");
                wrapper.className = "reflection-field animate-on-scroll";

                const label = document.createElement("label");
                const fieldId = field.id || `reflection-field-${index}`;
                label.setAttribute("for", fieldId);
                label.textContent = field.label || "Reflection";

                const textarea = document.createElement("textarea");
                textarea.id = fieldId;
                textarea.placeholder = field.placeholder || "";

                wrapper.appendChild(label);
                wrapper.appendChild(textarea);
                content.appendChild(wrapper);
            });
            slideElement.appendChild(content);
        }
        function createNavigationControls(index, total, config) {
            const navConfig = config?.nav || {};
            const controls = document.createElement("div");
            controls.className = "controls animate-on-scroll";
            let buttonsAdded = 0;

            const showPrev = !navConfig.hidePrev && index > 0;
            if (showPrev) {
                const prevButton = document.createElement("button");
                prevButton.type = "button";
                prevButton.className = "activity-btn secondary";
                const prevLabel = navConfig.prevLabel || "Back";
                const prevIcon = navConfig.prevIcon || "fas fa-arrow-left";
                prevButton.innerHTML = `<i class="${prevIcon}"></i> ${prevLabel}`;
                prevButton.addEventListener("click", () => {
                    prevSlide();
                });
                controls.appendChild(prevButton);
                buttonsAdded += 1;
            }

            const isLastSlide = index === total - 1;
            const hideNext = navConfig.hideNext || false;
            if (!hideNext) {
                const nextButton = document.createElement("button");
                nextButton.type = "button";
                const nextVariant = navConfig.nextVariant === "secondary" ? "secondary" : "";
                nextButton.className = `activity-btn ${nextVariant}`.trim();
                const nextAction = navConfig.nextAction || (isLastSlide ? "restart" : "next");
                const nextLabel = navConfig.nextLabel || (isLastSlide ? "Finish & Restart" : "Next");
                const nextIcon = navConfig.nextIcon || (isLastSlide ? "fas fa-check" : "fas fa-arrow-right");
                nextButton.innerHTML = nextVariant === "secondary"
                    ? `${nextLabel}`
                    : `${nextLabel} <i class="${nextIcon}"></i>`;
                nextButton.addEventListener("click", () => {
                    if (nextAction === "restart") {
                        showSlide(0);
                    } else {
                        nextSlide();
                    }
                });
                controls.appendChild(nextButton);
                buttonsAdded += 1;
            }

            if (!buttonsAdded) {
                return null;
            }
            return controls;
        }

        function buildSlideElement(config, index, total) {
            const slideElement = document.createElement("div");
            slideElement.className = "screen";
            slideElement.id = `slide-${index + 1}`;
            slideElement.dataset.slideKey = config.key || slideElement.id;

            switch (config.type) {
                case "blueprint":
                    renderBlueprintSlide(slideElement, config);
                    break;
                case "hero":
                    renderHeroSlide(slideElement, config);
                    break;
                case "gapfill":
                    renderGapfillSlide(slideElement, config);
                    break;
                case "ranking":
                    renderRankingSlide(slideElement, config);
                    break;
                case "grouping":
                    renderGroupingSlide(slideElement, config);
                    break;
                case "matching":
                    renderMatchingSlide(slideElement, config);
                    break;
                case "cards":
                    renderCardsSlide(slideElement, config);
                    break;
                case "story":
                    renderStorySlide(slideElement, config);
                    break;
                case "process":
                    renderProcessSlide(slideElement, config);
                    break;
                case "quiz":
                    renderQuizSlide(slideElement, config);
                    break;
                case "reflection":
                    renderReflectionSlide(slideElement, config);
                    break;
                case "content":
                default:
                    renderContentSlide(slideElement, config);
                    break;
            }

            const controls = createNavigationControls(index, total, config);
            if (controls) {
                slideElement.appendChild(controls);
            }
            return slideElement;
        }

        function renderSlidesFromLesson(lesson) {
            if (!slidesRoot) {
                return;
            }
            slidesRoot.innerHTML = "";
            const slideConfigs = Array.isArray(lesson?.slides) ? lesson.slides : [];
            slideConfigs.forEach((config, index) => {
                const slideElement = buildSlideElement(config, index, slideConfigs.length);
                slidesRoot.appendChild(slideElement);
            });
            slides = Array.from(slidesRoot.querySelectorAll(".screen"));
        }

        function renderLesson(lessonKey) {
            const availableLessons = Object.keys(lessonLibrary);
            if (!availableLessons.length) {
                return;
            }
            const resolvedKey = lessonLibrary[lessonKey] ? lessonKey : availableLessons[0];
            const lesson = lessonLibrary[resolvedKey];
            if (!lesson) {
                return;
            }
            activeLessonKey = resolvedKey;
            activeLesson = lesson;

            if (presentationEyebrow) {
                presentationEyebrow.textContent = lesson.meta?.eyebrow || lesson.label || "Instructional Session";
            }
            if (presentationDescriptor) {
                presentationDescriptor.textContent = lesson.meta?.descriptor || "Choose a template to populate the slides.";
            }
            if (typeof document !== "undefined") {
                const fallbackTitle = `${lesson.label || "Lesson"} â€“ Instructional Slides`;
                document.title = lesson.meta?.pageTitle || fallbackTitle;
            }

            hideHighlightToolbar();
            hideAnnotationPopover();
            closeAnnotationComposer();

            renderSlidesFromLesson(lesson);
            currentSlideIndex = 0;
            slideNotes = loadStoredNotes();
            initializeTextboxes();
            renderAllSlides();
            buildSlideMap();
            showSlide(0);

            if (lessonSelector && lessonSelector.value !== resolvedKey) {
                lessonSelector.value = resolvedKey;
            }
        }

        function populateLessonSelector() {
            if (!lessonSelector) {
                return;
            }
            if (!lessonSelector.dataset.initialized) {
                lessonSelector.addEventListener("change", (event) => {
                    renderLesson(event.target.value);
                });
                lessonSelector.dataset.initialized = "true";
            }
            lessonSelector.innerHTML = "";
            Object.entries(lessonLibrary).forEach(([key, lesson]) => {
                const option = document.createElement("option");
                option.value = key;
                option.textContent = lesson.label || key;
                lessonSelector.appendChild(option);
            });
        }

        function attachKeyboardNavigation() {
            if (keyboardHandlerAttached) {
                return;
            }
            try {
                document.addEventListener("keydown", handleKeyboardNavigation, { passive: false });
            } catch (error) {
                document.addEventListener("keydown", handleKeyboardNavigation);
            }
            keyboardHandlerAttached = true;
        }

        function showSlide(index) {
            if (!Number.isInteger(index) || index < 0 || index >= slides.length) {
                return;
            }
            slides.forEach((slide, i) => {
                slide.classList.toggle("active", i === index);
            });
            currentSlideIndex = index;
            hideHighlightToolbar();
            hideAnnotationPopover();
            const activeSlide = slides[index];
            if (activeSlide) {
                animateSlideContents(activeSlide);
                activateNotesPanel(activeSlide.dataset.slideId);
            }
            updateSlideMapIndicator(index);
        }

        function nextSlide() {
            if (currentSlideIndex < slides.length - 1) {
                showSlide(currentSlideIndex + 1);
            }
        }

        function prevSlide() {
            if (currentSlideIndex > 0) {
                showSlide(currentSlideIndex - 1);
            }
        }

        function updateQuizFeedback(feedbackId, message, status) {
            const feedback = document.getElementById(feedbackId);
            if (!feedback) {
                return;
            }
            feedback.textContent = message;
            feedback.classList.remove("correct", "incorrect", "notice");
            feedback.classList.add(status);
        }

        function checkSingleChoice(groupName, feedbackId, correctValue, successMessage, errorMessage) {
            const selected = document.querySelector(`input[name="${groupName}"]:checked`);
            if (!selected) {
                updateQuizFeedback(feedbackId, "Please choose an option before checking your answer.", "notice");
                return;
            }
            if (selected.value === correctValue) {
                updateQuizFeedback(feedbackId, successMessage, "correct");
            } else {
                updateQuizFeedback(feedbackId, errorMessage, "incorrect");
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            populateLessonSelector();
            const defaultLessonKey = lessonSelector?.value || Object.keys(lessonLibrary)[0];
            renderLesson(defaultLessonKey);
            attachKeyboardNavigation();
            const notesPanel = document.getElementById("notes-io-controls");
            if (notesPanel) {
                notesPanel.classList.add("animate__animated", "animate__fadeInDown");
                notesPanel.style.opacity = "1";
            }
        });
    </script>

</body>
</html>
